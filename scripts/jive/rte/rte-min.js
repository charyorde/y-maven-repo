window.BOOKMARKTYPE=2;jive.rte.RTE=function(j,a,p,q){var y=this;this.options=q=q||{};var f=null;if(typeof(a)=="object"){f=a;a=f.id}var v=false;var k=false;var F=false;var o=$j("#"+a);if(o.val()==""){o.val("<p></p>")}if(!q.rteLayout){q.rteLayout=new jive.rte.RTELayout({domExists:true,$editorPanel:o.parent(),rte:y})}q.theme_advanced_toolbar_container=q.rteLayout.getEditorPanel().get(0);var x=q.rteLayout.getUserTextarea().hide();var C=$j('<div class="rte_wrap tiny_mce_content"><div class="popOverContent"></div></div>').css({position:"absolute",top:0,left:0,width:"100%"});var i=$j("<div class='gutter'></div>");var w=$j("<div class='belowEditor'></div>");var J=$j('<div class="rte_wrap tiny_mce_content"><div class="superRichContent"></div></div>').css({position:"absolute",overflow:"hidden",top:0,left:0,width:"100%"});if(!$def(p)){p=0}var b=0;var D=0;var G=true;var H=null;var c=new $j.Deferred();function r(){if(!f){H=$j.extend({},jive.rte.settings(p),{mode:"exact",elements:a,oninit:function M(){t()},oninitFail:function L(){c.reject("rte initialization failed")}},y.options);try{if(typeof(window._editor_lang)!="undefined"){H.language=_editor_lang}if(!H.jive_image_picker_url&&typeof(window._jive_image_picker_url)!="undefined"){H.jive_image_picker_url=_jive_image_picker_url}}catch(N){console.log("error during rte construction",N)}if(typeof(tinyMCE)=="undefined"){c.reject("tinymce is undefined")}else{try{tinyMCE.init(H)}catch(K){c.reject(K)}}c.fail(function(O){console.log("tinyMCE.init failed: ",O);F=true;x.hide();o.show();o.height("200px")})}else{t()}}this.getSettings=function(){return H};this.isTextOnly=function(){return F};this.isMobileOnly=function(){return k};this.setMobileOnly=function(K){k=K};this.isDisabled=function(){return v};this.setDisabled=function(K){v=K};function s(K){if(j&&j[K]){return j[K]}return null}function u(){var K=[];$j.each(j||{},function(){if(this.teardown){var L=this.teardown();if(L){K.push(L)}}});return jive.conc.synchronize(K)}this.getImageService=function(){return s("imageService")};this.getLinkService=function(){return s("linkService")};this.getFormService=function(){return s("formService")};this.getEntitlementService=function(){return s("entitlementService")};this.getAttachmentService=function(){return s("attachmentService")};var I=true;var h=false;function B(){var K=t();if(K){var M=$j("iframe",K.getContentAreaContainer());b=M.outerHeight();D=M.outerWidth();J.css({height:y.getHeight()-y.getToolbarHeight()});var L=K.plugins.jivescroll;y.scrollRichContent(0,L.lastScrollY)}}this.scrollRichContent=function(L,K){this.getHiddenContainer().css("top",(-1*K)).css("left",(-1*L));this.getPopOverContainer().css("top",(-1*K)).css("left",(-1*L))};var g=false;function m(){if(!g){g=true;setTimeout(function(){B();g=false},0)}}q.rteLayout.addListener("resized",m);var A=true;function t(){if(!y.isTextOnly()&&G){if(!f){f=tinymce.get(a)}if(!$def(f)||!f){return null}G=false;$j("#"+a+"_tbl td.mceIframeContainer").prepend(J).append(C).append(i).closest("span.mceEditor").append(w);b=$j("iframe",t().getContentAreaContainer()).outerHeight();D=$j("iframe",t().getContentAreaContainer()).outerWidth();$j.each(f.plugins,function(){try{if(this.setRTE){this.setRTE(y)}}catch(K){console.log("Error calling setRTE in plugin",this.getInfo(),K)}});x.keyup(function(K){y.notifyOnKeyUp(K.keyCode)});x.change(function(K){y.notifyOnChange(K.keyCode)});f.onKeyUp.add(function(K,L){y.notifyOnKeyUp(L.keyCode)});f.onChange.add(function(K,L){y.notifyOnChange(L.keyCode)});f.onNodeChange.add(function(){y.notifyOnNodeChange()});(function(L){if(L.id==a){y.notifyInitFinished(y)}L.getContainer().childNodes[0].style.width="";var K=L.getBody();if(K.childNodes.length===0){K.appendChild(L.plugins.jivemacros.createEmptyPara())}if(tinymce.isIE){$j(window.document.body).find(".tiny_mce_content").addClass("ie");$j(L.getBody()).addClass("ie")}})(f);f.onBeginSpelling.add(function(){h=true});f.onEndSpelling.add(function(){h=false});f.theme.onResize.add(function(){if(A){A=false;y.resizeTo(y.getHeight());f.theme.onResize.dispatch()}else{A=true;y.notifyResized()}m()});f.plugins.html.registerToggleFunction(y.toggleEditorMode);c.resolve(y)}return f}this.isSpellChecking=function(){return h};this.toggleSpellChecker=function(){t().execCommand("mceSpellCheck")};this.closeAllDialogs=function(){var K=t();if(K){var N=K.windowManager.windows;var M=Object.keys(N);for(var L=0;L<M.length;L++){K.windowManager.close(null,N[M[L]].id)}K.plugins.jivemacros.removeDuplicateMacros(K,false);K.plugins.jivemacros.fixBodyParagraphs();return N}};this.getMacroForName=function(K){return window.jive.rte.macros.filter(function(L){return L.getName()==K}).first()||null};this.addMacro=function(O,L,P){var M=t();if(!M){return null}M.undoManager.add();if(M.selection.getNode().nodeName.toLowerCase()=="html"){var K=M.getBody();if(K.childNodes.length){K=K.childNodes[0]}M.selection.select(K);M.selection.collapse(true)}var Q=M.plugins.jivemacros.insertMacro(M,O,null,P);M.plugins.jivemacros.applyParameterSet(Q,O,L);M.plugins.jivemacros.validateMacroElements(Q);var N=y.getUIDForElement($j(Q));var R=y.getHiddenElementFor(N);O.refreshPosition(y,Q,R);O.refresh(y,Q);M.nodeChanged();return Q};this.applyParamSet=function(N,M,K){var L=t();if(!L){return null}L.plugins.jivemacros.applyParameterSet(N,M,K)};this.addTable=function(R,P){var K=t();if(!K){return null}var N="",M,L,O;N+="<table";for(M=0;M<R.length;M++){N+=" "+R[M].name+"='"+R[M].value+"'"}N+=">";N+="<tbody>";for(M=0;M<P.length;M++){var Q=P[M];N+="<tr>";if(M===0){for(L=0;L<Q.length;L++){O=Q[L];N+='<th align="center" valign="middle" style="background-color:#6690BC;"><font color="#ffffff"><strong>'+O+"</strong></font></th>"}}else{for(L=0;L<Q.length;L++){O=Q[L];N+="<td><p>"+O+(tinymce.isIE?"":'<br mce_bogus="1"/>')+"</p></td>"}}N+="</tr>"}N+="</tbody>";N+="</table>";K.execCommand("mceBeginUndoLevel");K.execCommand("mceInsertContent",false,N);K.addVisual();K.execCommand("mceEndUndoLevel");return true};this.getCurrentNode=function(){var K=t();if(!K){return null}return $j(K.selection.getNode())};this.destroy=function(){this.killYourself();this.teardownServices();$j(window).focus();if(f){tinyMCE.remove(f)}C.remove();J.remove();$j(this.getDOM()).parent().html("");$j(this.getTextArea()).remove();q.rteLayout.teardown()};this.teardownServices=function(){u()};this.getLang=function(M,L){var K=t();if(!K){return null}return K.getLang(M,L)};this.isReady=function(){if(y.isTextOnly()){return true}var K=t();return !!K};this.getReadyPromise=function(){return c.promise()};this.getDOM=function(){var K=t();if(!K){return null}return K.getContainer()};this.getID=function(){return a};this.setHTML=function(N){N=this.replaceWhiteSpace(N);if(y.isMobileOnly()){return x.val(N)}if(y.isTextOnly()){return o.val(N)}x.val(N);var L=t();var K=null;if(tinymce.isIE){K=document.activeElement;L.focus()}var M=L.setContent(N.replace(/>\n/g,">"));if(K){K.focus()}return M};this.getOriginalTextBox=function(){return o};this.getHTML=function(){if(y.isMobileOnly()){return x.val()}if(y.isTextOnly()){return o.val()}if(y.isDisabled()){return o.val()}var L=t();if(this.isHidden()){L.setContent(x.val().replace(/>\n/g,">"))}var K=L.getContent();if(($j.trim(K).length>0)&&K.indexOf("<body")!==0){K="<body>"+K+"</body>"}return K};this.replaceWhiteSpace=function(M){var L=[];var N=0;var K=-1;while((K=M.indexOf("  ",N))>=0){if(K<N){break}L.push(M.substring(N,K));L.push("&nbsp;");N=K+1}if(N<M.length){L.push(M.substring(N))}return L.join("")};this.show=function(){var K=t();if(!K){return null}K.show();y.notifyShowing()};this.getWindow=function(){var K=t();if(!K){return null}return K.getWin()};this.getDoc=function(){var K=t();if(!K){return null}return K.getDoc()};var e=null;this.getHiddenContainer=function(){if(e){return e}e=J.find("div.superRichContent");return e};var n=null;this.getPopOverContainer=function(){if(n){return n}n=C.find("div.popOverContent");return n};this.getGutter=function(){return i.get(0)};this.getBelowEditorArea=function(){return w.get(0)};this.getHiddenElementFor=function(K){var L=y.getHiddenContainer();var M=L.find("#"+K);if(M.length){return M}return null};var d=/\b_jivemacro_uid(\w+)\b/;this.getUIDForElement=function(L){var K=d.exec(L.attr("class"));if(K){return K[1]}return null};var z=new jive.ext.y.HashTable();this.getRTEElementFor=function(K){if(K){var L=z.get(K);if(L){if(L.length==1&&L.get(0).parentNode){return L}z.clear(K)}L=$j("._jivemacro_uid"+K,y.getBody());if(L.length==1){z.put(K,L)}if(L.length>0){return L}}return null};this.removeMacroWithUID=function(K){var M=z.get(K);if(M){M.remove()}z.clear(K);var L=y.getHiddenContainer();L.children("#"+K).remove()};this.setAttributeForMacroWithUID=function(K,L,M){var N=z.get(K);if(N){N.attr(L,M)}};this.generateUID=function(){return"_"+(new Date()).getTime()+Math.round(Math.random()*10000)};this.getBody=function(){var K=t();if(!K){return null}return K.getBody()};this.getTextArea=function(){return o};this.appendHTML=function(K){$j(this.getBody()).append(K)};this.insertHTMLAtCursor=function(K){if(K.indexOf("<body>")>=0){K=K.replace(/<body>/g,"")}if(K.indexOf("</body>")>=0){K=K.replace(/<\/body>/g,"")}if(!t().selection.getNode()||t().selection.getNode().nodeName.toLowerCase()=="body"){y.appendHTML(K)}else{$j(t().selection.getNode()).after(K)}};this.selection=function(){return t().selection.getRng(true)};this.focus=function(){try{var L=t();if(!L||L.destroyed){return}if(this.isHidden()){x.focus()}else{var K=y.getBody();L.focus();if(K.childNodes.length===0){K.appendChild(L.plugins.jivemacros.createEmptyPara());L.selection.select(K.childNodes[0].childNodes[0]);L.selection.collapse(true);return}else{if(K.childNodes.length==1){var P=K.childNodes[0];var M;if(P.childNodes.length==1&&(M=P.childNodes[0])&&M.nodeName.toLowerCase()=="br"){L.selection.select(M);L.selection.collapse(true);return}}}if(y.getCurrentNode()[0].nodeName.toLowerCase()=="body"){var N=y.getBody();while(N.nodeType==1&&N.childNodes.length>0){N=N.childNodes[0]}L.selection.select(N);L.selection.collapse(true)}}}catch(O){console.log(O)}};this.tinymceFocus=function(){t().focus()};this.collapseSelection=function(){var K=t(),L=K.selection.getNode();if(L&&!K.selection.isCollapsed()){y.focus();K.selection.collapse()}};this.select=function(L){var K=t();K.selection.select(L)};this.hide=function(){var K=t();if(K&&!K.destroyed){K.hide()}};this.isHidden=function(){return x.is(":visible")};this.resizeTo=function(K){q.rteLayout.resizeTo(K)};this.autoReposition=function(){q.rteLayout.reposition()};this.getHeight=function(){var L=$j(t().getContainer());var K=L.find("table:first").get(0);if(K){return $j(K).height()}else{return 100}};this.getToolbarHeight=function(){var L=$j(t().getContainer()).find("table:eq(0) > tbody > tr"),K=L.eq(0).find("td:first, th:first").height();if(L.length>2){K+=L.last().find("td:first, th:first").height()}return K};this.getContentAreaHeight=function(){return b};this.getContentAreaWidth=function(){if(!tinymce.isIE){return $j("iframe",t().getContentAreaContainer()).outerWidth()}return D};this.killYourself=function(){var K=t();if(!K){return}$j.each(K.plugins,function(){if(this.killYourself){this.killYourself()}})};this.toggleEditorMode=function(L){var M,K;if(L==a){if(y.isHidden()){M=x.height();x.hide();y.show();y.setHTML(x.val());y.focus();y.resizeTo(M);t().plugins.jivemacros.removeDuplicateMacros(t(),false);t().plugins.jivemacros.fixBodyParagraphs()}else{K=$j("#"+a+"_tbl");M=K.height();x.val(y.getHTML(true));y.hide();x.show();x.width("100%");o.hide();x.height(M);y.focus()}m();y.notifyDoneTogglingMode()}};this.i18n=function(L,M){if(typeof(M)=="undefined"){M=L}var K=t();return K.getLang(L,M)};var E=[];var l=[];this.addListener=function(K){if($def(K.onShow)){K.onShow()}E.push(K);if(y.initted&&K.initFinished){K.initFinished(y)}};this.addListenerAction=function(K){l.push(K)};this.executeListenerActions=function(){while(l.length>0){l[0]();l.splice(0,1)}};this.removeListener=function(L){for(var K=0;K<E.length;K++){if(E[K]==L){E.splice(K,1)}}};this.initted=false;this.notifyInitFinished=function(L){if(!y.initted){y.initted=true;for(var K=0;K<E.length;K++){E[K].initFinished(L)}y.executeListenerActions()}};this.notifyOnKeyUp=function(L){for(var K=0;K<E.length;K++){E[K].onKeyUp(L)}y.executeListenerActions()};this.notifyOnChange=function(){if(I){I=false;return}for(var K=0;K<E.length;K++){E[K].onChange()}y.executeListenerActions()};this.notifyResized=function(){for(var K=0;K<E.length;K++){E[K].onResize()}y.executeListenerActions()};this.notifyShowing=function(){for(var K=0;K<E.length;K++){E[K].onShow()}y.executeListenerActions()};this.notifyOnNodeChange=function(){for(var K=0;K<E.length;K++){E[K].onNodeChange()}y.executeListenerActions()};this.notifyDoneTogglingMode=function(){for(var K=0;K<E.length;K++){E[K].doneTogglingMode()}y.executeListenerActions()};jive.conc.nextTick(r)};