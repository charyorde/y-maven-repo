define(["jive.XhrStack"],function(Stack){function getEventDescriptor($target){var descriptors={container:{type:"container",objectId:$target.data("objectId")||$target.data("objectid"),objectType:$target.data("objectType")||$target.data("objecttype")},user:{type:"user",userId:$target.data("userid")||$target.data("userId")||$target.data("objectid")}};return $target.is(".jiveTT-hover-user")?descriptors.user:descriptors.container}$j(function(){(function(selector,timeout){$j(document.body).on("mouseenter",selector,function(e){var $target=$j(this),xy=[e.pageX,e.pageY],delay=("ontouchstart" in window)?0:750;if($target.closest("#j-main, .jive-modal").length>0){var descriptor=getEventDescriptor($target);descriptor.x=e.pageX;descriptor.y=e.pageY;window.clearTimeout(timeout);timeout=window.setTimeout(function(){$target.off(".cardHovering").trigger("cardShow",descriptor)},delay);$target.on("mousemove.cardHovering",function(e){xy=[e.pageX,e.pageY]});$target.one("mouseleave.cardHovering",function(){window.clearTimeout(timeout);$target.off(".cardHovering")})}})})("a.jiveTT-hover-user, a.jivecontainerTT-hover-container, img.jivecontainerTT-hover-container",undefined);(function($card,stack){var $body=$card.find(".j-js-note-body"),populate=$body.html.bind($body).aritize(1),request={abort:$j.noop},attachEvents=function($group){var timeout;$j(document.body).on("mousemove.cardHovered",function(e){var isContained=$group.is(e.target)||$group.find(e.target).length>0;if(!isContained&&!timeout){timeout=window.setTimeout(function(){$group.add(document.body).off(".cardHovered");$card.css("visibility","hidden").removeClass("snb-pinned").removeAttr("id");request.abort();var cardHiddenEvent=$j.Event("cardHidden",{relatedTarget:$card[0]});$group.not(".jive-tooltip2").trigger(cardHiddenEvent)},250)}else{if(isContained){window.clearTimeout(timeout);timeout=undefined}}})},showCard=function(xy,$target){$card.css({left:xy[0],top:xy[1]});var x=xy[0]+$card.outerWidth(),y=xy[1]+$card.outerHeight(),$win=$j(window),winX=$win.width()+$win.scrollLeft(),winY=$win.height()+$win.scrollTop(),barSize=16;if(x>winX){$card.css("left","-="+(x-winX+barSize))}if(y>winY){$card.css("top","-="+(y-winY+barSize))}var cardShownEvent=$j.Event("cardShown",{relatedTarget:$card[0]});$card.css("visibility","visible");$target.trigger(cardShownEvent,getEventDescriptor($target))};$j(document.body).on("cardShow",function(e,descriptor){var $target=$j(e.target),$container=$card.children(".jive-tooltip2-mid").removeClass("j-mini-modal-user j-mini-modal-place"),displayCard=showCard.curry([descriptor.x,descriptor.y],$target),ajaxOptions={data:{tooltip:true},dataType:"html",type:"GET"};switch(descriptor.type){case"user":$container.addClass("j-mini-modal-user");$card.attr("id","jive-note-user-body");var presenceRaw=$target.data("presence");var presenceObj=presenceRaw?eval(presenceRaw):null;presenceObj=presenceObj&&presenceObj.getPresencePostfix?presenceObj:null;$j.extend(true,ajaxOptions,{url:window.profileShortUrl,data:{userID:descriptor.userId,presencePostfix:presenceObj?presenceObj.getPresencePostfix():null,presence:presenceObj?presenceRaw:null}});break;case"container":$card.attr("id","jive-note-container-body");$container.addClass("j-mini-modal-place");ajaxOptions.data.container=descriptor.objectId;ajaxOptions.url=window.containerShortUrl;ajaxOptions.data.containerType=descriptor.objectType;break;default:throw new Error("Unrecognized card type.")}var loadingText=jive.shared.displayutil.cardLoading({type:descriptor.type}),errorText=jive.shared.displayutil.cardError({type:descriptor.type});attachEvents($card.add($target));$body.html(loadingText);request=$j.ajax(ajaxOptions);stack.add(request.then(populate).then(displayCard).fail(populate.curry(errorText)))})})($j("#jiveTT-note"),new Stack())})});