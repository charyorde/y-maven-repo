jive.namespace("JAF.CoreContainer");define("jive.JAF.CoreContainer.AppsContainerModel",["jive.JAF.CoreContainer.TokenProvider"],function(a){return jive.oo.Class.extend(function(b){jive.conc.observable(this);var d={};var c;this.init=function(e,f){c=this;this.commonContainer=e;this.options=f;this.tokenProvider=new a(c);this.tokenProvider.updateContainerSecurityToken();this.tokenProvider.addListener("container.token.refreshed",function(g){c.emit("container.token.refreshed",g)})};this.getApp=function(l,e){var k=d[l];var h;var j=new jive.conc.Promise();var f=this;if(k&&!k.outdated){j.emitSuccess(k)}else{var i=function(m){k=f.cacheApp(m,false,l);j.emitSuccess(k)};var g=function(p){var m=null;if(p.status==404){try{var n=JSON.parse(p.responseText);if(n.appUUID){m=k=f.cacheApp(n,true)}}catch(o){}}j.emitError(m)};if(e){h=jive.api.apps("instances/appinstance");$j.ajax({url:h+"/"+e,contentType:"application/json",dataType:"json",type:"GET",cache:false,success:i,error:g})}else{if(l){h=jive.api.apps("instances/my");$j.ajax({url:h+"/"+l,contentType:"application/json",dataType:"json",type:"GET",cache:false,success:i,error:g})}}}return j};this.getContainerSecurityToken=function(){var e=jive.api.apps("containersecuritytoken");var f=new jive.conc.Promise();$j.ajax({url:e,contentType:"application/json",dataType:"json",type:"GET",cache:false,success:function(g){f.emitSuccess(g)},error:function(g){f.emitError(g.status)}});return f};this.getAppsMarketApp=function(){var h=d.market;var f;var g=new jive.conc.Promise();var e=this;if(h){g.emitSuccess(h)}else{f=jive.api.apps("instances/market");$j.ajax({url:f,contentType:"application/json",dataType:"json",type:"GET",cache:false,success:function(i){h=e.cacheApp(i,true);g.emitSuccess(h)},error:function(i){g.emitError()}})}return g};this.cacheApp=function(h,f,g){h.appURL=h.src?decodeURIComponent(h.src).match(/url=(.*?)&/)[1]:null;var e=h.src?decodeURIComponent(h.src).match(/nocache=([01]{1})&/)[1]:"0";if(e==="1"){h.nocache=true}else{h.nocache=false}g=f?"market":(g?g:h.appUUID);h=d[g]=d[g]?$j.extend(d[g],h):h;delete h.outdated;return h};this.deleteApp=function(f,e,g){e=e||function(){};g=g||function(){};var h=jive.api.apps("instances/instance/"+f);$j.ajax({url:h,contentType:"application/json",dataType:"json",type:"DELETE",success:e,error:g})};this.refreshApp=function(g,e,f){e=e||function(){};f=f||function(){};$j.ajax({url:g,dataType:"json",type:"POST",success:e,error:f})};this.appRemove=function(g,h,e,f){e=e||function(){};f=f||function(){};$j.ajax({type:"PUT",url:jive.api.apps("instances/"+g+"/"+h),success:e,error:f})};this.acknowledgeThrottle=function(g,e,f){e=e||function(){};f=f||function(){};$j.ajax({type:"PUT",url:jive.api.apps("instances/throttle/violation/"+g),success:e,error:f})};this.appHide=function(g,e,f){e=e||function(){};f=f||function(){};$j.ajax({type:"PUT",url:jive.api.apps("instances/hide/"+g),success:e,error:f})}})});