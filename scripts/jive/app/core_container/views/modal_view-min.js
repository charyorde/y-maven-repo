define("jive.JAF.CoreContainer.ModalView",["jquery","jive.JAF.CoreContainer.AppsContainerView","jive.JAF.Alerts.AlertMainV2","jive.JAF.CoreContainer.CommentProvider"],function(d,b,c,a){return b.extend(function(f,i){jive.conc.observable(this);var j={LINK:"app.link.run",RTE:"app.rte.run",CONTENT:"app.content.run"};var g;var e;var h={width:0,height:0};this.init=function(m,n){i.init.call(this,m,n);this.commentContext=null;this.activityStreamContext=null;this.modalCommentProvider=new a();var l=this;this.modalCommentProvider.addListener("modifyRenderedContent",function(o,p){l.modifyRenderedContent(o,p)});this.resizeToLatest=function(){if(h.width){l.resizeContainerWidth(h.width,false)}if(h.height){l.resizeContainerHeight(h.height,false)}};d(window).bind("resize",this.resizeToLatest);d(window).bind("scroll",function(){l.recenterModal(false)});var k=null;l.appFrame={css:function(o,q){var p=o;if(arguments.length=2){p={};p[o]=q}k=d.extend(k||{},p)},animate:function(o){k=d.extend(k||{},o)},applyCSS:function(o){o.css(k);k=null}}};f.handleAppAlert=function(l){var m=l.getActiveAlert();var k=this;k.hideChromeNav();d(".j-modal-back-top").hide();f.revokeStaticModalDimensions();if(m.code==1000||m.code==1010){this.handleConfigurationDialog(l,{configureCallback:function(n){k.restoreChromeNav();k.restoreStaticDimensions()}});k.recenterModal(false);return}l.applyBlock();k.recenterModal(false);f.setStaticDimensions(650,280,false);l.addListener("app.block",function(n){l.routeActionClicks(n,function(){k.handleConfigurationDialog(l)},function(){k.closeModal()},function(){k.closeModal();var o=jive.apps.container.renderMessage({messageKey:"error.general"});k.sendNotification({severity:"error",message:o})},k)})};this.documentReady=function(){var k=this;d('li[name="os-action-link"] a').click(function(m){var l=d(m.target).closest("li");k.handleCreateActionSelect(l,j.LINK);m.preventDefault()});this.modalCommentProvider.addListeners()};this.getCommentContext=function(){return this.modalCommentProvider.getCommentContext()};this.getActivityStreamContext=function(){return this.modalCommentProvider.getActivityStreamContext()};this.getInboxEntryContext=function(){return this.modalCommentProvider.getInboxEntryContext()};this.getActionOriginEnum=function(){return j};this.handleCreateActionSelect=function(m,l){var k=m;this.fireActionEvent(l,{actionId:k.attr("actionid"),appURL:k.attr("appURL"),appInstanceUUID:k.attr("appInstanceUUID"),appUUID:k.attr("appUUID"),label:d.trim(k.find("a span.label").text()),selectionType:k.attr("selectionType"),selectionID:k.attr("selectionID"),view:k.attr("view")})};this.handleEditActionSelect=function(l,k){this.fireActionEvent(k,l)};f.fireActionEvent=function(k,l){this.emit(k,l)};this.handleEmbeddedView=function(n,m,k){var l=n;this.emit(m,{appUUID:l.attr("__appuuid"),isDevelopment:l.hasClass("j-apps-developerApp"),label:d.trim(l.text()),context:JSON.parse(l.attr("__context")||"{}"),view:l.attr("__view"),url:l.attr("__url")||"",embeddedID:k})};this.filterTitle=function(k,m){var l=(m?m:h.width)/8-9;k=k.length>l?(k.substring(0,l)+" ..."):k;return k};this.resetTitle=function(m,l){if(!(this.fullTitle||m||e)){return}var k=this.fullTitle?this.fullTitle:this.getRealTitle(m?m:e.jiveData.app);k=this.filterTitle(k,l);this.setModalTitle(k)};this.render=function(u,l,B,t,k,o){var x=this;var p=t||function(){};var r=o||{};var s=(l&&l.embeddedID)?l.embeddedID:"";var m=x.getEmbeddedContext(s);var v=function(){x.resetTitle(u);d("#jive-app-settings").focus();var C=g.find(".jive-modal-content")[0];if(m&&m.target.type&&m.target.type==="embed"){var D=x.renderAppEE_(C,u,m,function(F,E){e=F;F.jiveData=new JiveSiteData(x,u,r);F.jiveData.setGadgetMetaData(E);F.jiveData.setActionInfo(l);F.jiveData.setEEContext(m);x.renderModalCallback(E,F,u,p);x.registerModalEventHandlers();if(n){x.recenterModal()}},r);if(!D){e=x.commonContainer.newGadgetSite(C);e.jiveData=new JiveSiteData(x,u,r);e.jiveData.setSelection(B);e.jiveData.setActionInfo(l);e.jiveData.setEEContext(m)}}else{e=x.commonContainer.newGadgetSite(C);e.jiveData=new JiveSiteData(x,u,r);e.jiveData.setSelection(B);e.jiveData.setActionInfo(l);x.renderApp_(e,u,function(E){e.jiveData.setGadgetMetaData(E);x.renderModalCallback(E,e,u,p);x.registerModalEventHandlers();if(n){x.recenterModal()}},r)}x.enableSparkline(u)};if(!g){this.html=d(jive.apps.container.chromeApp({app:u}));var A=this.html.find("#j-app-modal-parent");var w=u.view;if(m&&m.target){w=m.target.view?m.target.view:"embedded"}var q=this.computeAppDimensions(u,w);var z=q.width;var y=q.height;var n=true;if(z>0){n=false;A.css({width:(z+"px")})}if(y>0){n=false;A.css({height:(y+"px")})}h.height=q.isMaximum?"max":y;h.width=q.isMaximum?"max":z;g=this.html.lightbox_me({closeSelector:".close",destroyOnClose:true,centered:true,modalCSS:{top:"0px"},onLoad:function(){jive.conc.nextTick(v.bind(x))},onClose:function(){g=null;x.closeApp_(true,true);x.rendered=false;if(typeof k==="function"){k()}}})}else{v();this.restoreStaticDimensions()}};this.setTitle=function(k){this.fullTitle=k;this.setModalTitle(this.filterTitle(k))};f.registerModalEventHandlers=function(){var k=this;if(d.browser.msie&&d.browser.version<8){k.appFrame.css({marginBottom:0})}d(".j-modal-gear-top").unbind("click").click(function(l){k.hideChromeNav();var m=d(l.currentTarget).attr("data-appuuid");k.emit("app.services.show",m);l.preventDefault()});d(".j-modal-refresh-top").unbind("click").click(function(l){k.emit("app.services.refresh",l.currentTarget);l.preventDefault()})};f.restoreChromeNav=function(){d(".j-modal-gear-top").show();d(".j-modal-refresh-top").show();d(".j-modal-back-top").hide();f.setSparklineVisibility(true)};f.hideChromeNav=function(){d(".j-modal-gear-top").hide();d(".j-modal-refresh-top").hide();d(".j-modal-back-top").show();f.setSparklineVisibility(false)};this.maximizeApp=function(){var k=this;this.resizeMax(false)};this.resizeMax=function(k){this.resizeContainerHeight("max",k);this.resizeContainerWidth("max",k)};this.getRenderedApp=function(){return e?e.jiveData.app:null};this.reload=function(l){if(!e){return}var k=e.jiveData;this.closeApp_(false,false);k.app.view=k.getAppView();this.render(k.app,k.getActionInfo(),k.getSelection(),function(m){l(m,k.getActionInfo())},null,k.viewParams)};this.closeModal=function(k){k=k||{};this.closeApp_(true,true);this.html.find(".close").click();g=null;this.rendered=false;if(typeof(k.navigateTo)!="undefined"){var l=k.navigateTo;if(!(/^http(s)?\:\/\//i.test(l))){if(!l.startsWith("/")){l="/"+l}if(!l.startsWith(window._jive_base_url)){l=window._jive_base_url+l}}window.location.href=l}};this.closeApp_=function(k,l){if(k){this.emit("app.chrome.close")}if(e){this.commonContainer.closeGadget(e)}e=null;if(l){this.html.find("#j-app-modal-parent").css({width:"",height:""});h={width:0,height:0};this.appStaticDimensions=null;this.notPrimary=false;this.fullTitle=null}};f.getChromeHeight=function(){if(!this.rendered){return 43}var k=this.html.outerHeight();var l=this.appFrame.height();return k-l};f.getChromeWidth=function(){if(!this.rendered){return 10}var l=this.html.outerWidth();var k=this.appFrame.width();return l-k};this.getMaximumHeight=function(){return d(window).height()-f.getChromeHeight()};this.getMaximumWidth=function(){return d(window).width()-f.getChromeWidth()};this.resizeContainerHeight=function(p,k){k=!(d.browser.msie&&d.browser.version<9)&&k;if(this.notPrimary){return}if(p!=="max"&&p<this.bounds.minHeight){p=this.bounds.minHeight}var l=d("#j-app-modal-parent iframe").height();if(l===p){return}if(p!=="max"&&p>this.bounds.maxHeight){p="max"}var n=f.getChromeHeight(),r=this.bounds.minHeight,q=this.getMaximumHeight();var o=p==="max";if(o){p=q}h.height=o?"max":p;var s=this;var m;k=k&&p<(q/2);if(k){d("#j-app-modal-parent")[k?"animate":"css"]({height:(p+"px")},{duration:100,queue:false});m=Math.min(Math.max(p,r),q);s.lastResizeTs=new Date().getTime();s.html.animate({position:"fixed",top:"50%",marginTop:d(s.html).outerHeight()/-2},{duration:100,queue:false});s.html.animate({marginTop:(m/-2)-n/2},{duration:100,queue:false});s.appFrame.animate({height:m},{duration:100,queue:false})}else{d("#j-app-modal-parent").css({height:(p+"px")});m=Math.min(Math.max(p,r),q);s.lastResizeTs=new Date().getTime();s.html.css({position:"fixed",top:"50%",marginTop:d(s.html).outerHeight()/-2});s.html.css({marginTop:(m/-2)-n/2});s.appFrame.css({height:m})}};this.resizeContainerWidth=function(r,l){l=!(d.browser.msie&&d.browser.version<9)&&l;if(this.notPrimary){return}if(r!=="max"&&r<this.bounds.minWidth){r=this.bounds.minWidth}var m=d("#j-app-modal-parent iframe").width();if(m===r){return}if(r!=="max"&&r>this.bounds.maxWidth){r="max"}var n=this.bounds.minWidth,p=this.getMaximumWidth();var o=r==="max";if(o){r=p}h.width=o?"max":r;var k=this;var q=d(k.html).outerWidth();if(l){d("#j-app-modal-parent")[l?"animate":"css"]({width:(r+"px")},{duration:100,queue:false});modalWidth=Math.min(Math.max(r,n),p);k.lastResizeTs=new Date().getTime();k.html.animate({position:"fixed",left:"50%",marginLeft:d(k.html).outerWidth()/-2},{duration:100,queue:false});k.html.animate({marginLeft:(modalWidth/-2)-4},{duration:100,queue:false});k.appFrame.animate({width:modalWidth},{duration:100,queue:false});k.resetTitle()}else{d("#j-app-modal-parent").css({width:(r+"px")});modalWidth=Math.min(Math.max(r,n),p);k.lastResizeTs=new Date().getTime();k.html.css({position:"fixed",left:"50%",marginLeft:q/-2});k.html.css({marginLeft:(modalWidth/-2)-4});k.appFrame.css({width:modalWidth});k.resetTitle()}};f.renderModalCallback=function(m,n,p,l){var k=this;var q=l||function(){};if(m.error){}else{var o=g.find("iframe");if(k.appFrame.applyCSS){k.appFrame.applyCSS(o)}k.appFrame=o;k.appFrame.removeData();if(p.marketFeatureAvailable){k.appFrame.data("hasMarketFeature",true);d(".j-modal-gear-top").hide()}if(p.actionHeight===9999&&p.actionWidth===9999){k.appFrame.css({height:k.getMaximumHeight(),width:k.getMaximumWidth});k.resetTitle()}else{if(p.actionHeight&&p.actionWidth){k.appFrame.css({height:k.boundedHeight(p.actionHeight?p.actionHeight:0),width:k.boundedWidth(p.actionWidth)})}}k.rendered=true;q.call(k,n)}};this.requestNavigateTo=function(q,k,m,l,r){var o=this;if(m.indexOf("canvas")==0){var n=q.url;if(m||l){var p=[];if(m){p.push(m)}else{p.push("canvas")}if(l&&Object.keys(l).length>0){p.push(JSON.stringify(l))}n+="#"+p.join(":")}window.location=n}else{q.view=m;k.jiveData=new JiveSiteData(o,q,l);this.renderApp_(k,q,function(s){o.renderModalCallback(s,k,q,r)},l)}};this.scrollIntoView=function(q,p){var l=p||{};var n=l.bottomOffset;var k=l.verticalAlignment==null?"bottom":l.verticalAlignment;var o=d("#"+q).parents(".js-app-chrome");var m;if(k==="top"){m=-8}else{if(k==="center"||k==="middle"){m=(20+o.height()-d(window).height())/2}else{if(isFinite(k)){m=Number(k)}else{n=isFinite(n)?Number(n):0;m=5-n+o.height()-d(window).height()}}}d.scrollTo(o,{duration:500,offset:{left:0,top:m}})};f.restoreAppIframe=function(){var k=this;this.html.find(".j-app-modal-content").remove();f.restoreStaticDimensions();d("#j-app-modal-parent iframe").css({display:"block"});this.recenterModal(false)};f.resizeModal=function(k,n,m){m=!(d.browser.msie&&d.browser.version<9)&&m;var l=this.html.find(".j-app-modal-content");this.html.css({position:"fixed",top:"50%",marginTop:this.html.outerHeight()/-2,left:"50%",marginLeft:this.html.outerWidth()/-2});this.html[m?"animate":"css"]({marginLeft:n/-2,marginTop:k/-2},{duration:300,queue:false});l[m?"animate":"css"]({width:n,height:k},{duration:300,queue:false})};f.recenterModal=function(k){f.recenter(d("#jive-modal-appAction"),k)};this.invokeSettings=function(k){var l=this;f.invokeNonPrimarySurface(l,function(){f.revokeStaticModalDimensions();l.hideChromeNav();d("#j-app-modal-parent iframe").css({display:"none"});var m=k.createUI();d("#j-app-modal-parent").append(m);l.resizeModal(550,600,false);l.resetTitle(null,500);k.activate()})};this.destroySettings=function(){this.notPrimary=false;this.restoreChromeNav();this.restoreAppIframe();this.resetTitle()};this.invokeCredentials=function(l){var k=this;f.invokeNonPrimarySurface(k,function(){k.hideChromeNav();f.revokeStaticModalDimensions();d("#j-app-modal-parent iframe").css({display:"none"});var m=l.createUI();d("#j-app-modal-parent").append(m);d(".j-modal-back-top").hide();k.resizeModal(200,540,true);k.resetTitle(null,480);l.activate()})};this.destroyCredentials=function(){this.notPrimary=false;this.restoreChromeNav();this.restoreAppIframe();this.resetTitle()};this.invokeOauthDance=function(l){var k=this;f.invokeNonPrimarySurface(k,function(){k.hideChromeNav();f.revokeStaticModalDimensions();d("#j-app-modal-parent iframe").css({display:"none"});d(".j-modal-back-top").hide();var q=l.getApp();var p=new c(q);var o={appTitle:q.title,code:2060,message:"",creator:"",errorMessage:"",iconSrc:q.iconSrc};var m=d("#j-app-modal-parent");var n=p.applyBlock(m,q,o);k.recenterModal(false);l.launch_popup(d(n));l.addListener("popup.closed",function(){d(n).remove();k.restoreChromeNav();k.restoreAppIframe();f.restoreStaticDimensions();k.notPrimary=false;l.invokeCallback()})})};f.invokeNonPrimarySurface=function(k,l){if(k.notPrimary){return false}k.notPrimary=true;f.delayedRunner(l,150,function(){var m=new Date().getTime();return(!k.lastResizeTs||m-k.lastResizeTs>300)})};f.setSparklineVisibility=function(k){var l=d(".j-app-sparkline");if(this.sparklineEnabled&&k){l.show()}else{l.hide()}};f.revokeStaticModalDimensions=function(k,m){k=!(d.browser.msie&&d.browser.version<9)&&k;var l=d("#j-app-modal-parent");this.appStaticDimensions={width:l.width()+"px",height:l.height()+"px"};l[k?"animate":"css"]({width:"",height:""},300,m||function(){})};f.restoreStaticDimensions=function(k,l){if(this.appStaticDimensions){f.setStaticDimensions(this.appStaticDimensions.width,this.appStaticDimensions.height,k)}};f.setStaticDimensions=function(m,k,l){l=!(d.browser.msie&&d.browser.version<9)&&l;var n=d("#j-app-modal-parent");if(l){n.animate({width:m,height:k},300,callback||function(){})}else{n.width(m).height(k)}};this.modifyRenderedContent=function(k,o){var m=this;d(document).off("click.embeddedAppArtifact").on("click.embeddedAppArtifact","a.jive_macro_appEmbeddedView",function(s){var r=d(this);var q=m.buildEmbedContext(r);var u=r.attr("__appuuid")||"";var t=r.attr("__action_id")||"";var p=r.attr("id")||String(Math.random());m.setEmbeddedContext(p,q);m.setEmbeddedContext("latest",q);if(u.length==36&&q.target&&q.target.type=="embed"){s.preventDefault();m.handleEmbeddedView(r,j.CONTENT,p)}});var l=this.getEmbeddedExperienceToShowOnLoad();if(l){var n=k.find(".jive_macro_appEmbeddedView").filter("#"+l);if(n.length>1){n=d(n[0])}if(n.length==1){jive.conc.nextTick(function(){n.click()})}}};f.getEmbeddedExperienceToShowOnLoad=function(){if(typeof this.embeddedExperienceToShowOnLoad==="undefined"){this.embeddedExperienceToShowOnLoad="";var k=/^#([a-zA-Z0-9_-]+)$/.exec(window.location.hash||"");if(!k){k=/[?&]ee=([a-zA-Z0-9_-]+)(&|$)/.exec(window.location.search)}this.embeddedExperienceToShowOnLoad=k?k[1]:null}return this.embeddedExperienceToShowOnLoad};f.buildEmbedContext=function(p){var k={};var q=p.attr("__view")||p.attr("__context")?"embed":p.attr("href")?"url":"none";switch(q){case"embed":var r=p.attr("__view")||"embedded";k.target={type:"embed",view:r};var o=p.attr("__context");if(o){k.target.context=JSON.parse(o)}break;case"url":k.target={type:"url",url:p.attr("href")};break}var n=p.hasClass("jive-link-app-preview")?"image":"text";switch(n){case"image":var l=p.find("> img");k.display={type:"image",previewImage:l.attr("src")};var m=l.attr("title");if(m){k.display.label=m}break;case"text":k.display={type:"text",label:p.text()||""};if(p.hasClass("jive-link-app-icon")){k.display.icon=p.attr("__icon")}break}k.actionId=p.attr("__action_id")||"";k.jive=JSON.parse(p.attr("data-jive-context")||"{}");return k};this.computeAppDimensions=function(p,l){var o=i.computeAppDimensions.call(this,p,l);var m=o.isMaximum,n=o.width,k=o.height;if(m){k=this.getMaximumHeight();n=this.getMaximumWidth()}else{if(n){n=this.boundedWidth(n)}if(k){k=this.boundedHeight(k)}}n=n<this.bounds.minWidth?this.bounds.minWidth:n;k=k<this.bounds.minHeight?this.bounds.minHeight:k;return{height:k,width:n,isMaximum:m}}})});