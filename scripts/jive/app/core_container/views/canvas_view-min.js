define("jive.JAF.CoreContainer.CanvasView",["jquery","jive.JAF.CoreContainer.AppsContainerView","jive.JAF.Alerts.AlertMainV2","jive.JAF.CoreContainer.NavigateApp"],function(d,a,b,c){return a.extend(function(e,g){jive.conc.observable(this);var h={CANVAS:"app.canvas.run"};var i;var f=new c();this.init=function(k,l){var j=this;g.init.call(this,k,l)};this.getActionOriginEnum=function(){return h};e.handleAppAlert=function(l){var k=this;var j=function(){var n=l.getApp();if(!n.configurationError){k.renderModal(n,function(){k.emit("app.canvas.modal.close")});k.handleConfigurationDialog(l,{modalWidth:650,modalHeight:500,configureCallback:function(o){if(o){k.closeModal()}}})}};l.applyBlock();var m=l.getActiveAlert();if(m.code==1000||m.code==1010){j()}else{k.hideChromeNav()}l.addListener("app.block",function(n){l.routeActionClicks(n,function(){j()},function(){window.location=window._jive_base_url+"/"},function(){var o=jive.apps.container.renderMessage({messageKey:"error.general"});k.sendNotification({severity:"error",message:o})},k)})};this.render=function(l,s,k,o){var p=d(".j-app-canvas")[0];var r=this;var m=f.addActionQueueItemToViewParams(s);var q=f.getCanvasAppInfoFromUrl();if(q!==null){var n=(m!==null)?m:{};f.setCanvasToken({appInfo:q,view:l.view,params:n})}if(k){this.renderAppEE_(p,l,k,function(u,t){i=u;u.jiveData=new JiveSiteData(r,l,m);u.jiveData.setEEContext(k);u.jiveData.setGadgetMetaData(t);var v=d(u.getActiveGadgetHolder().getIframeElement());v.attr("width","100%");if(l.marketFeatureAvailable){v.data("hasMarketFeature",true)}o.call(u)})}else{i=this.commonContainer.newGadgetSite(p);var j=i;j.jiveData=new JiveSiteData(this,l);this.loadAppIframe(l,j,m,o)}d("#j-canvas-app-refresh-btn").unbind("click").click(function(t){r.emit("app.services.refresh",t.currentTarget);t.preventDefault()});d("#j-canvas-app-delete-btn").unbind("click").click(function(t){r.emit("app.delete",l,function(){window.location=window._jive_base_url+"/"},function(){r.displayRefreshMsg(false)});t.preventDefault()});e.enableSparkline(l);d("#j-canvas-app-preference-btn").unbind("click").click(function(t){r.emit("app.services.show",l);t.preventDefault()})};this.getRenderedApp=function(){return i&&i.jiveData?i.jiveData.app:null};this.reload=function(){if(!i){return}var j=i.jiveData;this.commonContainer.closeGadget(i);j.app.view=j.getAppView();this.render(j.app,j.viewParams,j.getEEContext())};this.setTitle=function(k){if(!i){return}this.altTitle=k;var j=i.jiveData;d(".js-canvas-app-title").text(k||j.app.title||"")};this.requestNavigateTo=function(n,l,j,m,o){var k=this;k.loadAppIframe(n,l,m,o)};this.loadAppIframe=function(m,l,j,n){var k=this;k.renderApp_(l,m,function(p){l.jiveData=new JiveSiteData(k,m,j);l.jiveData.setGadgetMetaData(p);var o=d(l.getActiveGadgetHolder().getIframeElement());o.attr("width","100%");if(m.marketFeatureAvailable){o.data("hasMarketFeature",true)}else{if(d.browser.msie&&d.browser.version<8){o.attr("scrolling","no")}else{o.removeAttr("scrolling")}o.attr("overflow","auto")}if(n){n(p)}},j)};this.resizeContainerHeight=function(k,j,l){var m=d(l.getActiveGadgetHolder().getIframeElement());if(k==="max"){k=this.getMaximumHeight()}m[j?"animate":"css"]({height:(k+"px")},{duration:300,queue:false})};this.maximizeApp=function(j){this.resizeContainerHeight("max",false,j)};this.getMaximumHeight=function(){return d(window).height()};this.getMaximumWidth=function(){return d(window).width()};this.scrollIntoView=function(p,o){var k=o||{};var m=k.bottomOffset;var j=k.verticalAlignment==null?"bottom":k.verticalAlignment;var n=d("#"+p).parents(".j-app-canvas");var l;if(j==="top"){l=-8}else{if(j==="center"||j==="middle"){l=(20+n.height()-d(window).height())/2}else{if(isFinite(j)){l=Number(j);if(l<0){if(n.offset().top){l=-n.offset().top}}}else{m=isFinite(m)?Number(m):0;l=m+n.height()-d(window).height()-d(".j-canvas-preference-container").height()-15}}}d.scrollTo(n,{duration:500,offset:{left:0,top:l}})};this.renderModal=function(n,l){var j=this;this.html=d(jive.apps.container.canvasConfigurationModal({app:n}));var m=function(s,q){var o=j.getRealTitle(s,q);var p=(d("#j-app-modal-parent").width()/8)-8;o=o.length>p?o.substring(0,p)+" ...":o;j.setModalTitle(o);var r=d(window).height()+d(document).scrollTop()-(d("#jive-canvas-modal").offset().top+d("#jive-canvas-modal").outerHeight())<0;if(r){e.recenter(k,false)}};var k=this.html.lightbox_me({closeSelector:".close",destroyOnClose:true,centered:true,modalCSS:{top:"0px"},onLoad:function(){m(n,j.altTitle)},onClose:l||function(){}})};this.invokeSettings=function(l,n){this.renderModal(n);var k=l.createUI();d("#j-app-modal-parent").append(k);var j=550;var m=600;d("#j-app-modal-parent").css({height:j,width:m});l.activate()};this.destroySettings=function(){this.closeModal()};this.invokeCredentials=function(l){var k=this;this.renderModal(l.getApp(),function(){k.emit("app.canvas.modal.close")});var j=l.createUI();d("#j-app-modal-parent").append(j);l.activate();this.resizeModal(260,600,false)};this.destroyCredentials=function(){this.closeModal()};this.resizeModal=function(j,l,k){d("#j-app-modal-parent").css({height:j,width:l})};this.invokeOauthDance=function(l){var j=this;var k=d(".j-app-canvas");d(".j-app-canvas iframe").hide();var p=l.getApp();var o=new b(p,k);var n={appTitle:p.title,code:2060,message:"",creator:"",errorMessage:"",iconSrc:p.iconSrc};var m=o.applyBlock(k,p,n);l.launch_popup(d(m));l.addListener("popup.closed",function(){d(m).remove();d(".j-app-canvas iframe").show();l.invokeCallback()})};e.closeModal=function(){if(this.html&&this.html.find&&this.html.find("a.close")){this.html.find("a.close").click()}};this.restoreChromeNav=function(){d(".j-canvas-app-chromeopts").show()};this.hideChromeNav=function(){d(".j-canvas-app-chromeopts").hide()};this.handleAppsMarketInstall=function(m){var k=f.getCanvasAppInfoFromUrl();var l=f.getCanvasToken();var j=null;if(l!==null&&l.hasOwnProperty("appInfo")&&l.appInfo==k){if(k!==null&&k===m.appUUID||k===m.appPath){m.view=l.view;j=l.params;if(typeof m.view==="undefined"||m.view===null){m.view="canvas"}if(!i){return}this.commonContainer.closeGadget(i);this.render(m,j)}}f.setCanvasToken({})}})});