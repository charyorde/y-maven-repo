define("jive.AppFileUploader",["jquery"],function(a){return $Class.extend({init:function(e,d,b,c,f){this.app=e;this.key=d;this.callback=f;this.element=null;this.token=c;this.options=a.extend({showTitle:false,showDescription:false,dialogTitle:this.app.title,submitText:"Upload",core:false,validExtensions:[]},b||{});this.showDialog()},showDialog:function(){var e=this;a("body").append('<div class="jive-modal" id="app-upload-modal-content" style="display:none;"></div>');this.element=a("#app-upload-modal-content");var c=this.options||{};if(typeof c.actionUrl==="undefined"){var b="";if(this.token){b=encodeURIComponent(this.token)}c.actionUrl=c.actionUrl||"/social/rpc?responseFormat=html"+(b?"&st="+b:"")}var d=a(jive.apps.base.renderAppDataUploadPopup({options:c}));this.element.html(d).lightbox_me({closeSelector:".close",destroyOnClose:true}).find("iframe").bind("load",function(){e.handleIframeLoad()}).end().find("input[type=submit]").click(function(){if(e.isValid()){e.setRequestParams()}else{return false}})},isValid:function(){if(this.isFileBlank()){this.showError("File is required!");return false}else{if(this.isFileExtensionInvalid()){this.showError("File is invalid. Valid extensions: "+this.options.validExtensions.join(", "));return false}}return true},isFileBlank:function(){return this.element.find("input[type=file]").val()===""},isFileExtensionInvalid:function(){return this.options.validExtensions.length>0&&a.inArray(a(this.element.find("input[type=file]").val().split(".")).last()[0],this.options.validExtensions)==-1},showError:function(b){this.element.find("div.jive-error-box").show().find("span.message").html(b)},hideError:function(){this.element.find("div.jive-error-box").hide()},setRequestParams:function(){this.element.find("input[name=request]").val(JSON.stringify(this.generateRequestParams()))},generateRequestParams:function(){var d=[{method:"appdata.uploadContent",params:{appId:"@app",userId:["@viewer"],groupId:"@self",fields:[this.key],data:{}},id:"key"}];var c={url:"@field:file"};if(this.options.showTitle){var e=a("#app-upload-modal-content input[name=title]").val();if(e.length>0){c.title=e}}if(this.options.showDescription){var b=a("#app-upload-modal-content textarea[name=description]").val();if(b.length>0){c.description=b}}d[0]["params"]["data"][this.key]=c;return d},handleIframeLoad:function(){var f="jive-modal-file-upload-iframe";var d=document.getElementById(f);var h;var b=null;try{if(d.contentDocument){h=d.contentDocument}else{if(d.contentWindow){h=d.contentWindow.document}else{h=window.frames[f].document}}}catch(e){b=e}var c={};if(b!==null){var g='{"code":"4005","message":"Access denied to object"}';c=JSON.parse(g)}else{if(h.location.href=="about:blank"){return}else{c={}}}var i;if(this.options.core===true){i=c;this.callback(i);a("#app-upload-modal-content").trigger("close")}else{if(a.isArray(c)&&c[0]["result"]&&c[0]["result"]){var j=this.getValue(c[0]["result"]);if(j&&j[this.key]){i=j[this.key];this.callback(JSON.parse(i));a("#app-upload-modal-content").trigger("close")}}}},getValue:function(c){var b=null;a.each(c,function(d,e){b=e});return b}})});