jive.namespace("Apps");jive.Apps.RteArtifacts=jive.oo.Class.extend(function(b){var i=CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/skins/default/img/progress.gif";var f=450;var h="OpenSocial/2.5";var g="legacy";this.init=function(){};b.showMessage=function(l,k){$j("<p/>").html(l).message({style:k})};this.buildArtifactMarkup=function(v,z){var m=v?v[osapi.container.GadgetSite.RPC_ARG_KEY]:null;var o=m.jiveData.app;var y=z.artifactJson;var r=z.rteBound;b.makeArtifactURLsAbsolute(y,o,z.suppressImageUpload);var t=b.normalizeArtifact(y);var l=t.icon;var q=t.previewImage;var x=l||q;if(console){console.log("imageUrl",x)}var u=this;var s=function(K,H){if(!K){v.callback({error:"No artifactJson metadata was provided"});return}var I=m.getActiveGadgetHolder().getGadgetInfo();var C=I.modulePrefs.features.actions;var A;if(C&&C.params&&C.params["action-contributions"]){var F=C.params["action-contributions"];for(var E=0;E<F.length;++E){var M=F[E].replace(/\n/mg,"");var D=M.match(/id="(.+?)"/);A=D?D[1]:null;if(A&&A==z.actionId){break}}}if(!A){v.callback({error:"App does not define action "+z.actionId});return}if(!m){u.showMessage("Error occured, app site missing");v.callback({error:"Application framework error"});return}var N=m.jiveData;var J=u.createArtifact({ed:document,appUUID:N.app.appUUID,appInstanceUUID:N.app.appInstanceUUID,data:K,rteBound:r});var G=$j(J);var L=G.wrap("<span></span>").parent().html();if($j.browser.msie){if($j.browser.version<9){L=L.replace(/<\w[^>]*>/g,function(O){return O.replace(/(\w+=)([-.\w]+)/g,'$1"$2"')});L=L.replace(/(<IMG((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\s*>)/g,"$1</IMG>")}else{var B=function(O,P){var Q=G.attr(P);if(Q){var R=Q.replace(/\"/g,"&quot;");O=O.replace(P+"='"+Q+"'",P+'="'+R+'"')}return O};L=B(L,"_context")}}v.callback({markup:L,error:H})};if(z.suppressImageUpload||!x){s(y);return}var n=l?b.uploadArtifactIcon(l,o.appInstanceUUID):undefined;var p=q?b.uploadArtifactImage(q):undefined;var k=n||p;if(!k){var w="Error uploading iconUrl or previewImage.";u.showMessage(w);if(console){console.log(w)}s(y,w);return}k.addCallback(function(A){A=A||x;if(l){b.updateIcon(y,A)}else{b.updatePreviewImage(y,A)}s(y)}).addErrback(function(A){var B="Could not upload "+x;u.showMessage(B);if(console){console.log(B,A)}s(y,B)})};b.isProxiedUrl=function(k){return k.startsWith(gadgets.io.getProxyUrl().split("?")[0])};b.makeRelativeAppResourceUrl=function(k,m){var l=m.appURL?m.appURL.match(/.*\//)[0]:"";if(k.match(/^http/)===null&&k.match(/^\/\//)===null){return l+k}return null};this.makeArtifactURLsAbsolute=function(l,q,k){var m=function(s){var r=b.makeRelativeAppResourceUrl(s,q);if(r){return r}else{if(s.match(/^\/\//)){if(typeof gadgets!="undefined"){var v=gadgets.io.getProxyUrl();var u=v.match(/^https?:(\/\/.+)\?/);if(u&&u.length>1){u[1]=u[1].substring(0,2)+".*"+u[1].substring(2);if(s.match("^"+u[1])){var t=s.match(/url=(.+)&?/);if(t&&t.length>1){return t[1]}}}}}}};var p=b.normalizeArtifact(l);var o=p.previewImage;if(o){o=m(o)||o;if(!k&&!b.isProxiedUrl(o)){o=gadgets.io.getProxyUrl(o)}b.updatePreviewImage(l,o)}var n=p.icon;if(n){n=m(n)||n;if(!k&&!b.isProxiedUrl(n)){n=gadgets.io.getProxyUrl(n)}b.updateIcon(l,n)}if(console){console.log(l)}};b.updatePreviewImage=function(l,k){if(b.deduceArtifactFormatType(l)==h){l.previewImage=k}else{l.display.previewImage=k}};b.updateIcon=function(k,l){if(b.deduceArtifactFormatType(k)==h){k.preferredExperience.display.icon=l}else{k.display.icon=l}};b.deduceArtifactFormatType=function(k){return k.preferredExperience?h:g};b.normalizeArtifact=function(l){var p=b.deduceArtifactFormatType(l);if(p==h){var o=l.preferredExperience;var k=o.target.type;k=k==="gadget"?"embed":k;o.display=o.display||{};o.target=o.target||{};var n=o.display.type;var m=n=="image"?o.display.altText:o.display.label;return{hasPreviewImage:n=="image"&&l.previewImage,hasIcon:n=="text"&&Boolean(o.display.icon),linkType:k||"none",label:m||l.actionLabel,icon:o.display.icon,previewImage:l.previewImage,url:l.url,view:o.target.view,context:l.context,artifactFormatType:p}}else{l.display=l.display||{};l.target=l.target||{};return{hasPreviewImage:l.display.type=="image",hasIcon:l.display.type=="text"&&Boolean(l.display.icon),linkType:l.target.type||"none",label:l.display.label||l.actionLabel,icon:l.display.icon,previewImage:l.display.previewImage,url:l.target.url,view:l.target.view,context:l.target.context,artifactFormatType:p}}};b.extractFileName=function(k){return b.isProxiedUrl(k)?k.match(/.*\%2F(.+)/)[1]:k.match(/.*\/(.+)/)[1]};this.createArtifact=function(m){var x=m.rte,p=m.ed,D=m.appUUID,E=m.actionId,J=m.data,C=m.editedContentBean,n=m.appInstanceUUID,k=m.rteBound;var q=x||k;var G=q?function(M){return"__"+M}:function(M){return"_"+M};J=J||{};J.actionLabel=m.actionLabel;var s=b.normalizeArtifact(J);var u=s.hasPreviewImage;var B=s.hasIcon;var A=s.linkType;var v=s.label;var H=s.icon;var z=s.previewImage;var o=s.url;var y=s.view;var l=s.context;var L=x?p.getDoc():p;var r=$j(L.createElement("a"));r.attr("jivemacro","appEmbeddedView");r.attr("__jive_macro_name","appEmbeddedView");r.attr("href",A=="url"?o:"javascript:;");if(x){if(u){var F=(C&&C.attachmentConfigActionBean)?C.attachmentConfigActionBean.canAttach:true;var I=b.extractFileName(z);var w=$j(p.dom.create("img")).attr("src",i).attr("alt",I);r.append(w);var t=$j(p.dom.create("img")).attr("src",z).attr("alt",I).addClass("jiveImage").hide();r.append(t);t.load(function(){t.unbind();j(t);w.unbind().remove();t.show();jive.conc.nextTick(function(){if(F&&e(t)){c(t,x,p).addCallback(function(M){z=M.attr("src");r.attr("__previewImage",z)})}})});r.addClass("jive-link-app-preview")}else{if(B){var F=(C&&C.attachmentConfigActionBean)?C.attachmentConfigActionBean.canAttach:true;r.text(v);r.css("background-image","url('"+H+"')");r.addClass("jive-link-app-icon");r.attr("__icon",H);var I=b.extractFileName(H);var t=$j(p.dom.create("img")).attr("src",H).attr("alt",I).hide();jive.conc.nextTick(function(){if(F&&e(t)){d(t,x,p,n).addCallback(function(M){H=M.attr("src");r.attr("__icon",H);r.css("background-image","url('"+H+"')")})}});r.append($j(p.dom.create("span")).addClass("j-ui-elem").addClass("j-app-link"))}else{r.text(v);r.addClass("jive-link-app");r.append($j(x?p.dom.create("span"):L.createElement("span")).addClass("j-ui-elem").addClass("j-app-link"))}}}else{if(u){var I=b.extractFileName(z);r.attr(G("previewImage"),z);r.addClass("jive-link-app-preview");var K=$j(L.createElement("img"));K.attr("src",z).attr("alt",I).addClass("jiveImage");r.append(K)}else{if(B){r.text(v);if(!$j.browser.msie){r.css("background-image","url('"+H+"')")}r.addClass("jive-link-app-icon");r.attr(G("icon"),H);r.append($j(L.createElement("span")).addClass("j-ui-elem").addClass("j-app-link"))}else{r.text(v);r.addClass("jive-link-app");r.append($j(L.createElement("span")).addClass("j-ui-elem").addClass("j-app-link"))}}}if(v){r.attr("title",v)}r.attr(G("appUUID"),D);r.attr(G("action_id"),E);if(A=="embed"){r.attr(G("view"),y||"embedded");r.attr(G("context"),JSON.stringify(l||{}))}if(o){r.attr(G("url"),o)}r.attr("modifiedTitle","true");r.addClass("jive_macro");r.addClass("jive_macro_appEmbeddedView");return r[0]};this.parseSelectionContextFromArtifact=function(n){var m=n.attr("__context");var t=n.attr("__view");var l=n.attr("__url");var o=n.attr("__previewImage")?"image":"text";var u=n.attr("__title");var p=n.attr("__previewImage");var v=n.text().trim()||"";var s=n.attr("__icon");var r=null;switch(o){case"image":r={type:"image",previewImage:p};if(u){r.label=u}break;case"text":r={type:"text",label:v};if(s){r.icon=s}break}var k=(m||t)?"embed":"url";var q=null;switch(k){case"embed":q={type:"embed",view:t||"embedded"};if(m){q.context=JSON.parse(m)}if(l){q.url=l}break;case"url":q={type:"url",url:l||""};break}return{display:r,target:q}};this.uploadArtifactIcon=function(l,k){var m=b.extractFileName(l);var n=jive.api.apps("instances/"+k+"/attach_image")+"?name="+m;return a(n,l)};this.uploadArtifactImage=function(k){var l=b.extractFileName(k);var m=jive.rest.url("/rteImages")+"?name="+l+"&objectId=-1&objectType=-1";return a(m,k)};function j(m){var k=m.width();if(k>f){var n=f/k;var l=Math.round(n*k);m.attr("width",l)}}function e(m){var k=m.attr("src");if(k.match(/^\/[^\/]/)){return 0}var l="(https?:)?//"+location.hostname+(location.port?":"+location.port:"");if(!k.match("^"+l)){return true}return b.isProxiedUrl(k)?1:0}function d(n,m,l,k){var o=jive.api.apps("instances/"+k+"/attach_image");return c(n,m,l,o)}function c(k,l,r,p){var m=l.getImageService();var s=k.attr("alt");var t=k.attr("src");function o(){if(console){console.log("Image REST request failed for %s",s,arguments)}k.remove()}var n=new jive.conc.Promise();var u=l.getFormService();var q=u.setFormEnabled(false,r.getLang("jiveimage.please_wait"));m.createFromImageSrc(s,b.isProxiedUrl(t)?t:encodeURI(t),p).addCallback(function(v){k.load(function(){var w=$j(this);w.css({width:w.width()+"px",height:w.height()+"px","max-width":"","max-height":""})});k.attr("src",v.url);jive.conc.nextTick(function(){r.nodeChanged()});n.emitSuccess(k)}).addErrback(function(){o();n.emitError()}).always(function(){u.setFormEnabled(q)});return n}function a(o,k){var n=new jive.conc.Promise();var l={url:o,contentType:"application/x-www-form-urlencoded",processData:false,data:"url="+b.isProxiedUrl(k)?k:encodeURIComponent(k)};var m={contentType:"application/json; charset=utf-8"};$j.ajax($j.extend({type:"POST",dataType:"json",success:function(p,r,q){if(!p||!p.url){n.emitError()}else{n.emitSuccess(p.url)}},error:function(p){n.emitError(p)},timeout:30000},m,l));return n}});