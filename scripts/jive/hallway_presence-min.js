jive.NubUpdater=function(c,b,e,d){d=d||"";var a=list_template.clone();this.tab_type=b;a.find("h6.jive-nub-title-text").text(e);a.find("li.jive-nub-title").addClass(d);a.css("width",$j("#jive-eim-nub").width()-5+"px");this.update=function(f){a.find("ul").append(f)};this.notify=function(){var f=a.find("li.jive-nub-item").length;var g=c.find("a.jive-instance-name").hasClass("j-active");if(g){a.show()}else{a.hide()}if(f<1){a.find(".jive-instance-menu").append("<li class='jive-nub-item'>"+hallwayi18nMap.get("eim.hallway.none.online")+"</li>")}c.find(".jive-instance-menu-wrapper").remove();c.append(a);c.find(".counter").html(""+f+"");resizeMenu()}};jive.CombinedNubUpdater=function(a,c){this.getChatMap=function(d){return c.get(d)["chatMap"]};this.getNubUpdater=function(d){return c.get(d)["nubUpdater"]};this.getConnectionsCount=function(){return c.get("connections")["count"]};this.getPagescrapeCount=function(){return c.get("pagescrape")["count"]};this.getIdsToFilter=function(){return a};this.getDetailFor=function(e){var d=this.getChatMap("pagescrape").get(e);if(!d){d=this.getChatMap("connections").get(e)}return d};this.update=function(d,e){if(this.getChatMap("pagescrape").get(d)){this.getNubUpdater("pagescrape").update(e)}if(this.getChatMap("connections").get(d)){this.getNubUpdater("connections").update(e.clone(true))}};this.notify=function(){this.getNubUpdater("connections").notify();this.getNubUpdater("pagescrape").notify();if(b){b()}};var b;this.setPostNotify=function(d){b=d}};jive.Monitor=function(e){var a=0;var d=this;var b=0;var c;this.check=function(){var g=d.isTimedOut();var f=d.isDone();if(f||g){clearInterval(c);e.notify()}};this.start=function(){b=new Date().getTime();c=setInterval(this.check,1000)};this.add=function(){a++};this.dec=function(){a--};this.isDone=function(){return a<1};this.isTimedOut=function(){return new Date().getTime()-b>30000}};jive.HallwayPresence=function(e){var h=null;var c=new Date().getTime();this.start=function(){if(!e){return}if(!e.fn_process_tabs){return}if(e.fn_start_sentry){e.fn_start_sentry(i,d)}else{i()}};function j(){var n=new jive.ext.y.HashTable();var m=0;$j("a[data-externalId]").each(function(){var q=$j(this);var p=q.attr("data-externalId");var o=q.attr("data-online");var r=e.fn_max_pagescrapes?e.fn_max_pagescrapes():500;if(m<=r&&p&&o=="true"&&!n.get(p)&&(e.fn_externalid_sentry?e.fn_externalid_sentry(p):true)){n.put(p,p);m++}});$j("#this-page-tab").find(".counter").text(m)}function a(u,o,s){var t=new jive.ext.y.HashTable();var r=new Array();for(var q=0;q<=u.length;q++){var n=u[q];var m=o.get(n)["name"];if(!m){m=s.get(n)["name"]}if(m&&!t.get(m)){t.put(m,n);r.push(m)}}r.sort();var p=new Array();for(var q=0;q<r.length;q++){var m=r[q];if(m){var n=t.get(m);if(n){p.push(n)}}}return p}function l(){var n=new Date().getTime();if(n-c>3600000){return}h=new Date().getTime();var t=new Array();var q=new jive.ext.y.HashTable();var p=0;$j("a[data-externalId]").each(function(){var w=$j(this);var v=w.attr("data-externalId");var u=w.text();var A=w.attr("data-username");var x=w.attr("data-avatarId");var z=u.replace(/^\s+|\s+$/g,"");if(!z){u=$j(this).find("img").attr("alt")}var y=e.fn_max_pagescrapes?e.fn_max_pagescrapes():500;if(p<=y&&v&&u&&!q.get(v)&&(e.fn_externalid_sentry?e.fn_externalid_sentry(v):true)){q.put(v,{name:u,username:A,avatarid:x});t.push(v);p++}});var s=new jive.ext.y.HashTable();var r="connections_"+_jive_effective_user_id;var o;if(e.local_store){e.local_store.get(r,function(x,y){if(x&&y!=undefined&&y!=""){y=y+"";var B=y.split("^",2);var A=B[0];var w=B[1];var v=eimServiceInfo.lastConnectionUpdateTs;if((v-A)<=0){try{var u=JSON.parse(w);e.fn_parse_connections(u.connection,s,t);o=true}catch(z){e.local_store.set(r,undefined)}}}})}if(!o){var m=jive.rest.url(e.fn_connections_url()+_jive_effective_user_id+"?ts="+(eimServiceInfo.lastConnectionUpdateTs?eimServiceInfo.lastConnectionUpdateTs:(new Date().getTime())));$j.getJSON(m,function(w){if(w){e.fn_parse_connections(w.connection,s,t);var v=eimServiceInfo.lastConnectionUpdateTs;var u=JSON.stringify(w);u=v+"^"+u;if(e.local_store){e.local_store.set(r,u)}b(t,s,q)}})}else{b(t,s,q)}}function b(s,r,o){var m=s.length;s=a(s,r,o);var n=new jive.NubUpdater($j("#connections-tab"),"connections",hallwayi18nMap.get("eim.hallway.online.yourconnections"),undefined);var p=new jive.NubUpdater($j("#this-page-tab"),"page",hallwayi18nMap.get("eim.hallway.online.thispage"),"jive-instance-menu-page");var q=new jive.ext.y.HashTable();q.put("connections",{chatMap:r,count:m,nubUpdater:n});q.put("pagescrape",{chatMap:o,count:m,nubUpdater:p});e.fn_process_tabs(s,q)}function d(){var n;if(e.local_store){e.local_store.get("_dismiss_set",function(o,p){n=o&&p=="true"})}if(!n){var m=nub_tab_template.clone();m.find(".jive-instance-name").remove();m.append("<div style='margin-left:15px;margin-top:11px;margin-right: 20px;'>"+hallwayi18nMap.get("eim.hallway.unavailable")+" <a href='#' id='dismiss'>("+hallwayi18nMap.get("eim.hallway.unavailable.close")+")</a></div>");m.show();$j(".jive-eim-tabs").append(m);m.find("a#dismiss").click(function(){$j(".jive-eim-tabs").hide();if(e.local_store){e.local_store.set("_dismiss_set","true")}})}}jive.HallwayPresence.get_list_item_clone=function(m,q,n){var p=list_item_template.clone(true);var o=hallwayi18nMap.get("base_url");if(o=="/"){o=""}p.find(".presence-name").html(m);p.find(".jive-avatar").attr("src",o+"/people/"+q+"/avatar/16.png?a="+n);return p};function k(n){var m=list_template.clone();n.find(".jive-instance-menu-wrapper").remove();n.append(m);var p=hallwayi18nMap.get("base_url");if(p=="/"){p=""}var o='<img src="'+p+'/images/jive-icon-working-16x16.gif" />';m.find(".jive-instance-menu").append("<li class='jive-nub-item'>"+o+"<span style='margin-top:2px'>"+hallwayi18nMap.get("eim.hallway.working")+"</span></li>")}function f(){return eimServiceInfo.on_demand&&eimServiceInfo.on_demand=="true"}function g(){return eimServiceInfo.preloading&&eimServiceInfo.preloading=="true"}function i(){if(e.local_store){e.local_store.set("_dismiss_set","")}var r=f();var p=$j("<li class='jive-nub-tab '><span class='jive-nub-label'><strong class='font-color-meta'>"+hallwayi18nMap.get("eim.hallway.online")+"</strong></span></li>'");p.show();$j(".jive-eim-tabs").append(p);var n="";if(!r){n="  (<span class='counter'>"+(eimServiceInfo.connection_counts?eimServiceInfo.connection_counts:0)+"</span>)"}var q=nub_tab_template.clone(true).find(".jive-instance-name").html(hallwayi18nMap.get("eim.hallway.connections")+n).end().show().attr("id","connections-tab").appendTo($j(".jive-eim-tabs"));var o=nub_tab_template.clone(true).find(".jive-instance-name").html(hallwayi18nMap.get("eim.hallway.thispage")+(r?"":"  (<span class='counter'>0</span>)")).end().show().attr("id","this-page-tab").appendTo($j(".jive-eim-tabs"));var m=function(){$j("#jive-eim-nub .j-active").removeClass("j-active");var s=$j(this).parent().find(".jive-instance-menu-wrapper");if(s.is(":visible")){s.css({width:$j("#jive-eim-nub").width()-5+"px"});s.find(".jive-instance-menu-container").animate({top:s.height()+"px"},200,function(){s.hide()})}else{var u=new Date().getTime();if(u-c>3600000){alert("Please refresh the page to use the chatbar.");return}var t=$j(this).parent();t.find("a.jive-instance-name").addClass("j-active");$j(".jive-instance-menu-wrapper").hide();s.show();s.css({height:s.height(),width:$j("#jive-eim-nub").width()-5+"px",bottom:$j("#jive-eim-nub .jive-eim-tabs").outerHeight()+1+"px"});s.find(".jive-instance-menu-container").css("top",s.height()+"px").animate({top:"0px"},200);if(f()||!h){l()}if($j.browser.msie){s.find(".jive-nub-item").each(function(){var v=$j(this);v.hide();v.show()})}}resizeMenu();return false};q.find("a.jive-instance-name").click(m);o.find("a.jive-instance-name").click(m);if(!r&&g()){setTimeout(l,eimServiceInfo.initial_load_interval?eimServiceInfo.initial_load_interval:2500)}else{if(!g()){setTimeout(j,3500)}}k(q);k(o);if(!r){if(eimServiceInfo.refresh_interval){setInterval(l,eimServiceInfo.refresh_interval)}}}};function resizeMenu(){var c=$j(".jive-instance-menu:visible");var a=$j("#jive-eim-nub").outerHeight()+$j(".jive-instance-menu-container:visible").outerHeight();var b=getFullHeight(c);if(!c.data("original_height")){c.data("original_height",b)}var d=$j(window).height()-a;if(d<0){c.height(c.height()+d+"px")}else{c.height(Math.min(c.height()+d,c.data("original_height")))}c.closest(".jive-instance-menu-wrapper").height(c.closest(".jive-instance-menu-container").height())}function getFullHeight(a){return a.outerHeight()+parseInt(a.css("margin-bottom"))+parseInt(a.css("margin-top"))}$j(function(){resizeMenu();$j(window).resize(function(){resizeMenu()})});