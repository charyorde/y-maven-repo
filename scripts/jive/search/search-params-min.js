jive.namespace("search");jive.search.SearchParams=jive.oo.Class.extend(function(b){jive.conc.observable(this);var f=jQuery;var h=/([^\(]*)\((.*)\)/;var g={q:"",facet:"content",sort:"relevanceDesc"};var e={content:{validParams:["count","startIndex","sort"],validFilters:["search","type","after","tag","author","place"]},people:{validParams:["facet","count","startIndex","sort"],validFilters:["search","nameonly"]},places:{validParams:["facet","count","startIndex","sort"],validFilters:["search","type","tag"]}};var a={q:"search"};var d={};function c(i,j){return i+"("+j+")"}b.init=function(i){this.params={};this.filters={};if(i){this.setUrlParams(i,{silent:true})}this.addListener("changing",function(k,j){if(k==="facet"){this.clear({keep:["q","search","facet"]});this.updateAll=true}else{if(k==="q"){this.updateAll=true}}})};b.changed=function(l,k,j){if((j&&j.silent)){return}this.emit("changing",l,k);d[l]=k;if(this._timeout){return}var i=this;this._timeout=setTimeout(function(){i._timeout=null;i.emit("change",d);d={}},0)};this.getFormattedFilter=function(i){var j=a[i]||i;var k=this.filters[i]||this.params[i];if(this.getParam("facet")==="content"&&j==="type"&&k==="discussion"){k+=",message"}if(k){if(j==="search"){k=k.replace(/([(),\\])/g,"\\$1")}return c(j,k)}else{return""}};this.getSearchParams=function(){var l=[],j={filter:l},m=this.getParam("facet"),k=e[m],i=this;Object.keys(this.params).forEach(function(n){var o=a[n]||n;if(k.validParams.indexOf(o)!==-1){j[o]=i.params[n]}else{if(k.validFilters.indexOf(o)!==-1){l.push(i.getFormattedFilter(n))}}});Object.keys(this.filters).forEach(function(n){var o=a[n]||n;if(k.validFilters.indexOf(o)!==-1){l.push(i.getFormattedFilter(n))}});return j};this.getUrlParams=function(){var l=[],j={},m=this.getParam("facet"),k=e[m],i=this;Object.keys(this.params).forEach(function(n){var o=a[n]||n;if(k.validParams.indexOf(o)!==-1||k.validFilters.indexOf(o)!==-1){j[n]=i.params[n]}});Object.keys(this.filters).forEach(function(n){var o=a[n]||n;if(k.validFilters.indexOf(o)!==-1){l.push(c(o,i.filters[n]))}});if(l.length){j.filter=l}return j};this.setUrlParams=function(o,j){var n=this;var p={};var m={};if(o.filter){var l=$j.isArray(o.filter)?o.filter:[o.filter];l.forEach(function(q){var i=q.match(h);m[i[1]]=true;n.setFilter(i[1],i[2],j)})}for(var k in o){if(o.hasOwnProperty(k)&&k!=="filter"){p[k]=true;this.setParam(k,o[k],j)}}for(k in this.filters){if(this.filters.hasOwnProperty(k)){if(!m[k]){this.removeFilter(k)}}}for(k in this.params){if(this.params.hasOwnProperty(k)){if(!p[k]){this.removeParam(k)}}}};this.getParam=function(i){return this.params[i]||g[i]};this.setParam=function(j,k,i){if(!k||k===g[j]){this.removeParam(j,i)}else{if(this.params[j]!==k){this.params[j]=k;this.changed(j,k,i)}}};this.removeParam=function(j,i){if(this.params[j]===undefined){return}delete this.params[j];this.changed(j,g[j],i)};this.clearParams=function(k){var j=k&&k.keep||[];for(var l in this.params){if(this.params.hasOwnProperty(l)&&j.indexOf(l)===-1){delete this.params[l];this.changed(l,g[l],k)}}};this.getFilter=function(i){return this.filters[i]||g[i]};this.setFilter=function(j,k,i){if(!k||k===g[j]){this.removeFilter(j,i)}else{if(this.filters[j]!==k){if(j==="search"){this.updateAll=true}this.filters[j]=k;this.changed(j,k,i)}}};this.removeFilter=function(j,i){if(this.filters[j]===undefined){return}delete this.filters[j];this.changed(j,g[j],i)};this.clearFilters=function(k){var j=k&&k.keep||[];for(var l in this.filters){if(this.filters.hasOwnProperty(l)&&j.indexOf(l)===-1){delete this.filters[l];this.changed(l,g[l],k)}}};this.clear=function(i){this.clearParams(i);this.clearFilters(i)};this.getUpdateAll=function(){var i=this.updateAll;this.updateAll=false;return i};this.matches=function(i){return JSON.stringify(i)===JSON.stringify(this.getUrlParams())}});