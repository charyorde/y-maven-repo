jive.Csv=$Class.extend({init:function(a){var b=this;this.elements={instructionsBody:$j("#import-csv-body"),uploadedErrorMessage:$j("#upload-csv-error"),uploadedBody:$j("#uploaded-csv-body"),emailsBody:$j("#select-emails-body"),fileName:$j("#uploaded-csv-fileName"),sampleName:$j("#uploaded-csv-sample-name"),sampleEmail:$j("#uploaded-csv-sample-email"),nameSelect:$j("#uploaded-csv-name-select"),emailSelect:$j("#uploaded-csv-email-select"),currentList:$j("#jive-current-members-list"),emailsList:$j("#select-emails-list"),importFriends:$j("#import-friends"),importCancel:$j("#import-cancel"),containerType:$j("#container-type"),containerId:$j("#container-id")};$j("#csv").change(function(){b.handleSubmit.bind(b);$j(this).closest("form").submit()});$j("#uploadForm").click(this.uploadForm.bind(this));$j("#show-emails-button").click(this.selectCsv.bind(this));this.elements.importFriends.click(this.doImport.bind(this));this.elements.importCancel.click(this.doCancel.bind(this));this._importCallback=a.importCallback||null;this._cancelCallback=a.cancelCallback||null;this._emailLink=a.emailLink},handleSubmit:function(){},processUploadError:function(a){this.reset();this.elements.uploadedErrorMessage.text(a).show()},processResult:function(e,b,d){b=$j.makeArray(b);d=$j.makeArray(d);this.elements.fileName.text(e);this.elements.sampleName.text(d[0]);this.elements.sampleEmail.text("("+d[1]+")");this.elements.nameSelect.text("");this.elements.emailSelect.text("");var a=function(g,f,j,h){var i=$j("<option/>").val(j).text(j);if(h==f){i.prop("selected",true)}g.append(i)};var c=this;b.forEach(a.partial(this.elements.nameSelect,0));this.elements.nameSelect.change(function(){c.elements.sampleName.text(d[this.selectedIndex])});b.forEach(a.partial(this.elements.emailSelect,1));this.elements.emailSelect.change(function(){c.elements.sampleEmail.text("("+d[this.selectedIndex]+")")});this.elements.instructionsBody.hide();this.elements.uploadedBody.show()},uploadForm:function(a){a.preventDefault();a.stopPropagation();csvWindow.reset()},selectCsv:function(a){a.preventDefault();a.stopPropagation();$j("#upload-form-submit").attr("src",this._emailLink+"?nameColumn="+this.elements.nameSelect.val()+"&emailColumn="+this.elements.emailSelect.val()+"&containerType="+this.elements.containerType.val()+"&containerID="+this.elements.containerId.val())},selectEmails:function(c,b){$j("#select-emails-list-text").hide();c=$j.makeArray(c);b=$j.makeArray(b);c.forEach(function(d){var e="select-email-"+d.email;this.elements.emailsList.append($j("<li/>").append($j("<input/>").attr("type","checkbox").attr("id",e)).append($j("<label/>").attr("for",e).append($j("<strong/>").text(d.name)).append($j("<span/>").text(" ("+d.email+")"))))}.bind(this));if(c.length===0){$j("#select-emails-list-text").show()}else{$j("#jive-select-emails-scroller").addClass("jive-select-emails-scroller-tall")}if(b.length>0){b.forEach(function(d){this.elements.currentList.append($j("<li/>").append($j("<strong/>").text(d.name)).append($j("<span/>").text(" ("+d.email+")")))}.bind(this));$j("#jive-select-emails-scroller").removeClass("jive-select-emails-scroller-tall");$j("#jive-current-members").show()}else{$j("#jive-current-members").hide()}var a=function(g,f){var d=this.elements.emailsList.find('[type="checkbox"]');if(g){d.prop("checked",true)}else{d.prop("checked",false)}f.preventDefault();f.stopPropagation()};$j("#select-emails-all").click(a.bind(this,true));$j("#select-emails-none").click(a.bind(this,false));$j("#two").addClass("selected");$j("#one").removeClass("selected");this.elements.uploadedBody.hide();this.elements.emailsBody.show();$j("#upload-form-submit").attr("src","")},doImport:function(b){if($j.isFunction(this._importCallback)){var a=this.elements.emailsList.find('[type="checkbox"]:checked').map(function(){return this.id.replace("select-email-","")});this._importCallback(Array.prototype.slice.call(a,0));this.reset();this._clearCallbacks()}b.preventDefault();b.stopPropagation()},doCancel:function(a){if($j.isFunction(this._cancelCallback)){this._cancelCallback();this.reset();this._clearCallbacks()}a.preventDefault();a.stopPropagation()},reset:function(){this.elements.uploadedBody.hide();this.elements.emailsBody.hide();this.elements.uploadedErrorMessage.hide();this.elements.emailsList.children().remove();this.elements.currentList.children().remove();$j("#upload-form").each(function(){this.reset()});this.elements.instructionsBody.show();$j("#upload-form-submit").removeAttr("src");$j("#one").addClass("selected");$j("#two").removeClass("selected");$j("#upload-form-submit").attr("src","");generateFormToken($j("#upload-form"),"csv.upload")},_clearCallbacks:function(){this._importCallback=null;this._cancelCallback=null}});var csvWindow;var doImport=function(b,f){var a=function(h){var g=new Array();if(h.length){h.forEach(function(i){g.push({id:-1,email:i,displayName:i,avatar:f,entitled:true})});if(g.length>0){b.setUsers(g)}}e.close()};var c=function(){e.close()};if(!csvWindow){var d={emailLink:emailLink,importCallback:a,cancelCallback:c};csvWindow=new jive.Csv(d)}else{csvWindow._importCallback=a;csvWindow._cancelCallback=c}generateFormToken($j("#upload-form"),"csv.upload");var e=new jive.gui.smallWindowPanel((importCsvTitle||"Import Contacts"),$j("#jive-import-csv-container")[0],"large");e.setBackAction(function(){e.close();csvWindow.reset();csvWindow._clearCallbacks()});e.show()};function jiveHideInstructions(a){$j("#"+a).hide();$j("#jive-exportinfo-links").show()}function jiveShowInstructions(a){$j("#jive-exportinfo-links").hide();$j("#"+a).show()}function generateFormToken(b,a){b.find('[name="jive.token.name"]').remove();b.find('[name="'+a+'"]').remove();jive.util.securedPost(a).addCallback(function(c){b.append('<input type="hidden" name="jive.token.name" value="'+c["jive.token.name"]+'"/>');b.append('<input type="hidden" name="'+c["jive.token.name"]+'" value="'+c[a]+'"/>')})};