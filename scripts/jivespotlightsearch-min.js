define("JiveSpotlightSearch",["jive.XhrStack"],function(A){$j.fn.searchType=function(){var B=$j(this).closest("ul");if(B.hasClass("j-content-results")){return"content"}else{if(B.hasClass("j-people-list")){return"people"}else{return"places"}}};return jive.oo.Class.extend({init:function(C,F,G,B){var E=this;var D=this.metrics=new jive.search.SearchMetrics("spotlight-search");this.spotlightSearchContainer=C;this.spotlightSearchInput=C.find("input.jive-userbar-search-field");this.spotlightSearchResultsContainer=C.find(".j-spotlight-results");this.spotlightSearchURL=F;this.containerType=G;this.containerID=B;this.containerSearch=false;this.spotlightSearchInputHasFocus=false;this.spinner={};this.queue=new A();this.queue.addListener("success",this.showResults.bind(this));this.queue.addListener("error",this.handleAborts.bind(this));this.spotlightSearchIndex=0;this.spotlightSearchInput.bind("keyup",this.observeSpotlightSearchQuery.bind(this));this.spotlightSearchInput.bind("blur",this.onBlur.bind(this));this.spotlightSearchResultsContainer.delegate(".jive-spotlight-global-search","click",this.executeGlobalSpotlightSearch.bind(this));this.spotlightSearchResultsContainer.delegate(".jive-spotlight-container-search","click",this.executeContainerSpotlightSearch.bind(this));this.spotlightSearchResultsContainer.delegate(".jive-spotlight-viewall","click",function(J){var I=$j(this).data("filterContainer");var H=$j(this).data("currentUser");E.viewAllResults(I,H);J.preventDefault()});this.spotlightSearchResultsContainer.delegate("ul a","click",function(J){var H=$j(this).closest("li").prevAll().length;var I=$j(this).searchType();D.setChoice(I,H)})},observeSpotlightSearchQuery:function(B){switch(B.keyCode){case $j.keyCode.UP:this.selectIndex(this.spotlightSearchIndex-1);return false;case $j.keyCode.DOWN:this.selectIndex(this.spotlightSearchIndex+1);return false;case $j.keyCode.ENTER:this.clearSpotlightSearchEvent();$j.stop(B,true,true);if(this.spotlightSearchIndex>0){this.loadSelectedIndex()}return false;case $j.keyCode.ESCAPE:this.clearSpotlightSearch();return false;case $j.keyCode.LEFT:case $j.keyCode.RIGHT:case $j.keyCode.TAB:case $j.keyCode.HOME:case $j.keyCode.END:case $j.keyCode.PAGE_UP:case $j.keyCode.PAGE_DOWN:return false}this.clearSpotlightSearchEvent();this.spotlightSearchEvent=setTimeout(this.executeSpotlightSearch.bind(this),800)},onBlur:function(){this.spotlightSearchInputHasFocus=false;setTimeout(this.clearSpotlightSearch.bind(this),250)},clearSpotlightSearch:function(){if(!this.spotlightSearchInputHasFocus){this.spotlightSearchResultsContainer.trigger("close")}},executeSpotlightSearch:function(){var C=$j(this.spotlightSearchInput).val(),E=this.spotlightSearchResultsContainer;if((C.match(/[^\s]/g)||[]).length>2){C=$j.trim(C).replace(/\s+/g," ").substr(0,128);while(C.length>2&&C.match(/\s\w$/)){C=$j.trim(C.substring(0,C.length-2))}if(C.length>2){C=C+"*"}else{return }this.spinner=new jive.loader.LoaderView({showLabel:false,size:"small"});this.spinner.appendTo(E);var B={containerType:this.containerType,containerID:this.containerID,filterContainer:this.containerSearch,query:$j.trim(C)+"*"};this.queue.add($j.get(this.spotlightSearchURL,B,"html"));var D={filter:["search("+B.query+")"],count:B.filterContainer?10:5};this.metrics.addQuery(new jive.search.SearchMetricsQuery("/api/core/v3/content?"+$j.param(D)),"content");if(!B.filterContainer){this.metrics.addQuery(new jive.search.SearchMetricsQuery("/api/core/v3/people?"+$j.param(D)),"people");this.metrics.addQuery(new jive.search.SearchMetricsQuery("/api/core/v3/places?"+$j.param(D)),"places")}}else{this.clearSpotlightSearch()}this.spotlightSearchIndex=0},executeContainerSpotlightSearch:function(){this.containerSearch=true;this.spotlightSearchInputHasFocus=true;setTimeout(this.executeSpotlightSearch.bind(this),50);$j(this.spotlightSearchInput).focus()},executeGlobalSpotlightSearch:function(){this.containerSearch=false;this.spotlightSearchInputHasFocus=true;setTimeout(this.executeSpotlightSearch.bind(this),50);$j(this.spotlightSearchInput).focus()},viewAllResults:function(B,D){var C=$j(this.spotlightSearchInput).val();if(C.length<=0){return }C=C+"*";$j(this.spotlightSearchInput).val(C);this.submitQuery()},selectIndex:function(C){if(C>0){var D=$j(".spotlight-index-"+C).addClass("hover").get(0);if(D){$j(".jive-spotlight-search li.hover:not(.spotlight-index-"+C+")").removeClass("hover");var B=$j(D);var E=$j(window).scrollTop();if(!((B.offset().top+B.height()>=E)&&(B.offset().top<=E+$j(window).height()))){D.scrollIntoView(false)}this.spotlightSearchIndex=C}}else{$j(".jive-spotlight-search li.hover").removeClass("hover");$j(this.spotlightSearchInput)[0].scrollIntoView(false);this.spotlightSearchIndex=0}},loadSelectedIndex:function(){var B=$j(".spotlight-index-"+this.spotlightSearchIndex)[0];if(B&&$j(B).children("a")[0]){location.href=$j(B).children("a")[0].href}},submitQuery:function(){if(this.containerSearch){if(this.containerType==3||this.containerType==2020){this.spotlightSearchInput.find("input[name=userID]").val(this.containerID)}else{this.spotlightSearchInput.find("input[name=containerType]").val(this.containerType);this.spotlightSearchInput.find("input[name=container]").val(this.containerID)}}this.spotlightSearchContainer.find("form").submit()},clearSpotlightSearchEvent:function(){if(this.spotlightSearchEvent){clearTimeout(this.spotlightSearchEvent)}},showResults:function(B){var F=this.spotlightSearchResultsContainer.html(B),E=function(){if(this.spinner){this.spinner.getContent().remove();this.spinner.destroy()}}.bind(this);E();F.trigger("close");F.popover({context:this.spotlightSearchContainer.find(".j-search-left"),closeOnClick:false,closeOtherPopovers:true,putBack:true,destroyOnClose:false,focusPopover:false,onClose:E});var D=this.metrics;var C=new Date().getTime();D.forEachCurrent(function(G){G.setReturnedDate(C)});this.spotlightSearchResultsContainer.find("ul").each(function(){var H=$j(this).searchType();var G=$j(this).find("a").map(function(){return $j(this).data()}).toArray();var I=D.getQuery(H);if(I){I.addResults(G)}})},handleAborts:function(D,B,C){if(C==="abort"){this.metrics.forEachCurrent(function(E){E.abort()})}}})})