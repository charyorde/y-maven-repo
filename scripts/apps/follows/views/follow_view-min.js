jive.namespace("FollowApp");jive.FollowApp.FollowView=jive.AbstractView.extend(function(a){var c=jQuery,b=jive.FollowApp;jive.conc.observable(this);this.init=function(f,e){var d=this;this.i18n=e.i18n;this.options=e;this.addFollowLinkID="#jive-link-"+f+"-startFollowing";this.followingLinkID="#jive-link-"+f+"-following";c(document).ready(function(){if(d.options.objectID){c(d.addFollowLinkID+", "+d.followingLinkID).click(function(i){var h=c(this),g=h.hasClass("j-button-follow");d.manageAssociations(d.options.objectType,d.options.objectID,h,$j(d.addFollowLinkID),$j(d.followingLinkID),h.closest(".j-js-follow-controls"));i.preventDefault()})}else{c("body").off("click.followbtn").on("click.followbtn",".start-follow a, .following a",function(k){var j=this,h=$j(this),g=h.closest(".j-js-follow-controls"),i=h.attr("data-objecttype"),n=h.attr("data-objectid");if(h.parent().hasClass("start-follow")){var m=h,l=h.parent().siblings(".following").find("a")}else{l=h,m=h.parent().siblings(".start-follow").find("a")}d.manageAssociations(i,n,h,m,l,g);k.preventDefault()})}});jive.switchboard.removeListener("follow.create",d.followCreated).addListener("follow.create",d.followCreated);jive.switchboard.removeListener("follow.destroy",d.followDestroyed).addListener("follow.destroy",d.followDestroyed)};this.followCreated=function(g){var h=$j(".js-browse-thumbnail[data-object-type="+g.objectType+"][data-object-id="+g.objectID+"]"),d=$j(".js-browse-item[data-object-type="+g.objectType+"][data-object-id="+g.objectID+"]");if(h.length){e=h.find('[data-command="showFollowers"]');f=e.data("count");f=f+1;if(e.length){e.data("count",f);e.text(f)}}else{if(d.length){var e=d.find('.j-td-followers [data-command="showFollowers"]'),f=e.data("count");f=f+1;if(e.length){e.data("count",f);e.text(f)}}}};this.followDestroyed=function(g){var h=$j(".js-browse-thumbnail[data-object-type="+g.objectType+"][data-object-id="+g.objectID+"]"),d=$j(".js-browse-item[data-object-type="+g.objectType+"][data-object-id="+g.objectID+"]");if(h.length){e=h.find('[data-command="showFollowers"]');f=e.data("count");f=f-1;if(e.length){e.data("count",f);e.text(f)}}else{if(d.length){var e=d.find('.j-td-followers [data-command="showFollowers"]'),f=e.data("count");f=f-1;if(e.length){e.data("count",f);e.text(f)}}}};this.updateBrowseFollowUI=function(d,h){var i=$j(".js-browse-thumbnail[data-object-type="+h.objectType+"][data-object-id="+h.objectID+"]"),e=$j(".js-browse-item[data-object-type="+h.objectType+"][data-object-id="+h.objectID+"]");if(i.length){f=i.find('[data-command="showFollowers"]');g=f.data("count");g=d?g+1:g-1;if(f.length){f.data("count",g);f.text(g)}}else{if(e.length){var f=e.find('.j-td-followers [data-command="showFollowers"]'),g=f.data("count");g=d?g+1:g-1;if(f.length){f.data("count",g);f.text(g)}}}};this.manageAssociations=function(f,k,h,j,i,d){var e=this,g=d.data("streamsassoc");e.emitP("manageAssociations",f,k,g).addCallback(function(o){var q=o[0],r=q.streams;j.hide();var n=0;for(var m=0,l=r.length;m<l;m++){if(r[m].selected){n++}}var p=d.data("streamsassoc");if(n!=p){d.data("streamsassoc",n);i.find(".j-js-streams-assoc-count").replaceWith(jive.people.profile.streamsAssociatedCount({count:n,renderLocation:d.data("location")}))}i.show();h.closest("#jiveTT-note").addClass("snb-pinned");e.$streamsMenu=$j(jive.eae.activitystream.builder.followInStreamsMenu({objectID:k,objectType:f,streams:r,removeAllAssnI18nKey:"eae.activitystream.builder.followlink.removeall"}));e.$streamsMenu.popover({context:d,darkPopover:false,destroyOnClose:true,putBack:false,onLoad:function(){e.$streamsMenu.delegate("a.j-js-remove-all-assns","click",function(s){e.emitP("removeAllAssociations",f,k).addCallback(function(){i.hide();j.show();d.data("streamsassoc",0);e.$streamsMenu.trigger("close")});s.preventDefault()});e.$streamsMenu.delegate("input","change",function(x){var t=$j(this),w=t.closest(".j-js-follow-in-streams-menu"),v=t.val(),u=t.is(":checked"),s=w.find("label.j-js-stream-option.selected").length;e.emitP("setItemAssociation",f,k,v,u,s).addCallback(function(y){if(u){t.closest("label").addClass("selected")}else{t.closest("label").removeClass("selected")}var A=e.$streamsMenu.find(".j-js-stream-option"),z=0;A.each(function(){if($j(this).hasClass("selected")){z++}});d.data("streamsassoc",z);if(z==0){i.hide();i.find(".j-js-streams-assoc-count").replaceWith(jive.people.profile.streamsAssociatedCount({count:z,renderLocation:d.data("location")}));j.show()}else{i.find(".j-js-streams-assoc-count").replaceWith(jive.people.profile.streamsAssociatedCount({count:z,renderLocation:d.data("location")}));i.show();j.hide()}})});e.$streamsMenu.delegate(".j-js-close","click",function(){e.$streamsMenu.trigger("close")})},onClose:function(){var s=i.closest("#jiveTT-note");if(s.length){s.removeClass("snb-pinned");$j(document).bind("mousemove.follow-in",function(t){if(!$j(t.target).closest("#jiveTT-note").length){s.trigger("mouseout")}$j(document).unbind("mousemove.follow-in")})}}})})};this.displayConfirmation=function(d){if(d){$j("<p />").html(d).message({style:"success"})}};this.updateYourProjects=function(e,d){if(d){c("#sidebar-yourprojects-row-"+e).show().effect("highlight",{},5000)}else{c("#sidebar-yourprojects-row-"+e).fadeOut("slow")}};this.tearDown=function(){var d=this;jive.switchboard.removeListener("follow.create",d.followCreated);jive.switchboard.removeListener("follow.destroy",d.followDestroyed)};a.createSpinner=function(d,e){d.addClass("font-color-meta-light")};a.destroySpinner=function(d){d.removeClass("font-color-meta-light")}});