jive.namespace("FollowUserApp");jive.FollowUserApp.ProfileFollowView=jive.AbstractView.extend(function(a){var c=jQuery,b=jive.FollowApp;this.init=function(e){var d=this;d.bidirectional=e.bidirectional;d.message=function(h,k,g){g=c.extend({showClose:true,style:"success"},g||{});var j={follow:e.i18n.startFollowingMessage,pending:e.i18n.pendingConnectionMessage,unfollow:e.i18n.stopFollowingMessage},i=j[h].replace("{0}",k);c(i).message(g)};$j("body").delegate("a.js-follow, a.js-following","click",function(j){var g=$j(this),i=g.closest("div.js-follow-user-link"),h=i.attr("data-userid");d.$parentContainer=i;d.bidirectional=d.$parentContainer.attr("data-bidirectional")=="true";d.manageAssociations(h,g,i,function(k){if(!k){i.find(".js-follow").hide();i.find(".js-pending").show();d.message("pending",i.attr("data-displayname"),{style:"info"})}});j.preventDefault()});jive.switchboard.addListener("follow.user",function(l){var g=".js-follow-user-link[data-userid="+l.id+"]",n=[];$j(g).each(function(){var r=$j(this),q=r.attr("data-follower-count")*1;n.push(r.attr("data-displayname"));r.attr("data-follower-count",++q).find(".js-follower-count").text(q);var o=r.closest(".js-browse-row"),s=r.closest(".js-browse-thumbnail");if(o.length){var p=o.find(".j-td-followers .j-user-follow-info");if(p.length){p.data("count",q);p.text(q)}}else{if(s.length){p=s.find('.j-user-info .j-user-follow-info[data-command="showFollowers"]');if(p.length){p.data("count",q);p.text(q)}}}});var h=$j(".js-follow-user-link[data-userid="+window._jive_effective_user_id+"]");if(h.length){var j=h.closest(".js-browse-row"),m=h.closest(".js-browse-thumbnail");if(j.length){var i=j.find(".j-td-following .j-user-follow-info"),k=i.data("count")*1;++k;if(i.length){i.data("count",k);i.text(k)}}else{if(m.length){i=m.find('.j-user-info .j-user-follow-info[data-command="showConnections"]');k=i.data("count")*1;++k;if(i.length){i.data("count",k);i.text(k)}}}}if(n.length>0){jive.switchboard.emit("follow.user.complete",l)}});jive.switchboard.addListener("unfollow.user",function(l){var g=".js-follow-user-link[data-userid="+l.id+"]",n=[];$j(g).each(function(q){var s=$j(this),r=s.attr("data-follower-count")*1;n.push(s.attr("data-displayname"));s.attr("data-follower-count",--r).find(".js-follower-count").text(r).end();var o=s.closest(".js-browse-row"),t=s.closest(".js-browse-thumbnail");if(o.length){var p=o.find(".j-td-followers .j-user-follow-info");if(p.length){p.data("count",r);p.text(r)}}else{if(t.length){p=t.find('.j-user-info .j-user-follow-info[data-command="showFollowers"]');if(p.length){p.data("count",r);p.text(r)}}}$j(".js-connection-labels-menu[data-userid='"+q+"'] .js-label-option").removeClass("selected").find("input:checked").prop("checked",false)}.partial(l.id));var h=$j(".js-follow-user-link[data-userid="+window._jive_effective_user_id+"]");if(h.length){var j=h.closest(".js-browse-row"),m=h.closest(".js-browse-thumbnail");if(j.length){var i=j.find(".j-td-following .j-user-follow-info"),k=i.data("count")*1;--k;if(i.length){i.data("count",k);i.text(k)}}else{if(m.length){i=m.find('.j-user-info .j-user-follow-info[data-command="showConnections"]');k=i.data("count")*1;--k;if(i.length){i.data("count",k);i.text(k)}}}}if(n.length>0){}});function f(j,g){var i=j.closest(".js-follow-user-link").attr("data-userid");var k=d.getMenu(i);var h=k.clone();h.delegate("a.js-label-option","click",function(o){var m=c(this),n=m.find(":checkbox"),l=n.val();if(n.is(":checked")){n.prop("checked",false);m.removeClass("selected");d.emitP("removeLabel",i,l).addErrback(function(){n.prop("checked",true);m.addClass("selected")})}else{n.prop("checked",true);m.addClass("selected");d.emitP("addLabel",i,l).addErrback(function(){n.prop("checked",false);m.removeClass("selected")})}o.preventDefault()});h.popover({context:j,darkPopover:true,destroyOnClose:true,onClose:g})}c(document).delegate("a.js-connection-label-btn","click",function(h){var g=c(this);if(!g.hasClass("active")){g.addClass("active");f(g,function(){jive.conc.nextTick(function(){g.removeClass("active")})})}h.preventDefault()})};this.manageAssociations=function(f,e,h,i){var d=this,g=h.data("streamsassoc");d.emitP("manageAssociations","3",f,g).addCallback(function(p){var m=p[0];if(m.approved){var s=m.streams;if(m.addedRelationship){s[0].selected=true}var r=0;for(var n=0,o=s.length;n<o;n++){if(s[n].selected){r++}}h.closest("#jiveTT-note").addClass("snb-pinned");var l=h.find(".js-follow"),k=h.find(".js-following"),j=h.find("a.js-connection-label-btn");if(r!=g){h.data("streamsassoc",r);k.find(".j-js-streams-assoc-count").replaceWith(jive.people.profile.streamsAssociatedCount({count:r,renderLocation:h.data("location")}))}e.hide();k.show();if(j.length){j.show()}var q="eae.activitystream.builder.followlink.removeall";if(d.bidirectional){q="profile.friends.remove.link"}d.$streamsMenu=$j(jive.eae.activitystream.builder.followInStreamsMenu({objectID:f,objectType:"3",streams:s,removeAllAssnI18nKey:q}));d.$streamsMenu.popover({context:h,darkPopover:false,destroyOnClose:true,putBack:false,closeOnClickSelector:"body, .js_lb_overlay",onLoad:function(){d.$streamsMenu.delegate("a.j-js-remove-all-assns","click",function(v){var t=$j(this),u=t.closest(".j-js-follow-in-streams-menu");var w=$j(".js-connection-labels-menu[data-userid='"+u.data("objectid")+"'] .js-label-option.selected").map(function(){return $j(this).attr("data-list-id")}).toArray();d.emitP("removeAllAssociations",u.data("objecttype"),u.data("objectid"),w).addCallback(function(){l.show();k.hide();j.hide();d.$streamsMenu.trigger("close");h.data("streamsassoc",0)});v.preventDefault()});d.$streamsMenu.delegate("input","change",function(z){var w=$j(this),v=w.closest(".j-js-follow-in-streams-menu"),y=w.val(),u=v.data("objecttype"),A=v.data("objectid"),x=w.is(":checked"),t=v.find("label.j-js-stream-option.selected").length;d.emitP("setItemAssociation",u,A,y,x,t).addCallback(function(C){var B=t;if(x){w.closest("label").addClass("selected");B++}else{w.closest("label").removeClass("selected");B--;if(t==1&&u==3&&A==window._jive_current_user.ID){l.show();k.hide()}}k.find(".j-js-streams-assoc-count").replaceWith(jive.people.profile.streamsAssociatedCount({count:B,renderLocation:h.data("location")}));h.data("streamsassoc",B)})});d.$streamsMenu.delegate(".j-js-close","click",function(){d.$streamsMenu.trigger("close")})},onClose:function(){var t=k.closest("#jiveTT-note"),u=k.closest(".j-js-recommendation");if(t.length){t.removeClass("snb-pinned");$j(document).bind("mousemove.follow-in",function(v){if(!$j(v.target).closest("#jiveTT-note").length){t.trigger("mouseout")}$j(document).unbind("mousemove.follow-in")})}else{if(u.length){u.fadeOut(400,function(){var v=k.closest(".j-js-recommendation-people-module");u.remove();if(!v.find("li.j-js-recommendation").length){v.fadeOut("fast")}})}}}})}if(i){i(m.approved)}})};this.addLabelItem=function(d){var e=$j("#j-browse-item-grid .j-js-friend-list-chooser-container");e.find(".j-js-friend-list-chooser").each(function(){d.userID=$j(this).closest(".js-connection-labels-menu").attr("data-userid");$j(this).append(jive.people.profile.friendListChooserLabel(d))});if(!e.is(":visible")){$j("#j-browse-item-grid .js-following").addClass("j-split-button notlast");e.show()}};this.updateLabelItem=function(d){$j(".js-label-option[data-list-id='"+d.listID+"']").each(function(){var e=$j(this);d.selected=e.hasClass("selected");d.userID=e.closest(".js-connection-labels-menu").attr("data-userid");e.replaceWith(jive.people.profile.friendListChooserLabel(d))})};this.removeLabelItem=function(d){$j(".js-label-option[data-list-id='"+d+"']").remove()};this.apply=function(e,d){this.getMenuItem(d,e.id).addClass("selected").find(":checkbox").prop("checked",true)};this.unapply=function(e,d){this.getMenuItem(d,e.id).removeClass("selected").find(":checkbox").prop("checked",false)};a.getMenu=function(d){return c(".js-connection-labels-menu[data-userid='"+d+"']")};a.getMenuItem=function(e,d){return c(".js-connection-labels-menu[data-userid='"+e+"'] a.js-label-option[data-list-id='"+d+"']")};a.createSpinner=function(d){d.addClass("font-color-meta-light")};a.destroySpinner=function(d){d.removeClass("font-color-meta-light")}});