define("jive.ActionQueue.Main",["jquery","jive.ActionQueue.ActionQueueTabView"],function(b,a){return jive.oo.Class.extend(function(c){this.init=function(e){this.userId=window._jive_effective_user_id;var d=this;d.actionQueueService=new jive.ActionQueue.ListSource();d.tabsView=new a({selector:"#j-actions-page-tabs"});d.currentTab=e.currentTab;d.userId=window._jive_effective_user_id;d.$contentArea=b("#j-actions-page-content");d.tabsView.addListener("switchTabs",function(f){d.spinner=new jive.loader.LoaderView();d.spinner.prependTo("#j-dynamic-pane");if(f.attr("id")=="jive-aq-pending"){jive.locationState.setState({},"","actions")}else{if(f.attr("id")=="jive-aq-archived"){jive.locationState.setState({},"","actions/archived")}else{if(f.attr("id")=="jive-tasks"){jive.locationState.setState({},"","actions/tasks")}}}});if(d.currentTab=="jive-tasks"){d.initializeTaskView(d.currentTab)}else{if(d.currentTab=="jive-aq-archived"){d.archived=true}else{d.archived=false}d.queueView=new jive.ActionQueue.ListView({selector:"#j-action-queue"});d.attachQueueListeners()}};this.attachGlobalEventListeners=function(){var d=this;this.aqPollHandler=function(e){d.autoUpdate(e)};this.actionTakenHandler=function(f,e){d.decrementTabCount("jive-aq-pending",1);d.queueView.actionTaken(f,e)};this.taskCompleteHandler=function(e){d.decrementTabCount("jive-tasks",1)};this.taskIncompleteHandler=function(e){d.decrementTabCount("jive-tasks",-1)};jive.ActivityStream.activityNotifier.addListener("activityStream.poll",this.aqPollHandler);jive.switchboard.addListener("actions.actionTaken",this.actionTakenHandler).addListener("tasks.taskComplete",this.taskCompleteHandler).addListener("tasks.taskIncomplete",this.taskIncompleteHandler)};this.loadView=function(e,f){var d=this;if(e=="jive-tasks"){d.initializeTaskView(e,f)}else{d.initializeActionView(e,f)}};this.initializeTaskView=function(i,n){var j=this;j.$contentArea.html('<div id="jive-inbox-task-container"></div>');var h=jive.app.url({path:"/edit-task!complete.jspa"}),l=jive.app.url({path:"/edit-task!incomplete.jspa"}),d=jive.app.url({path:"/edit-task!take.jspa"}),f=jive.app.url({path:"/edit-task!delete.jspa"}),e=jive.app.url({path:"/view-task-list.jspa?owner="+j.userId}),k=jive.eae.actionqueue.jsI18nHelper({key:"task.delete.confirm.msg"}),m=jive.eae.actionqueue.jsI18nHelper({key:"task.list.unauth"}),g=jive.eae.actionqueue.jsI18nHelper({key:"task.list.error"});jivetasklist=new JiveTaskList("jive-inbox-task-container",h,l,d,f,e,k,m,g);jivetasklist.addListener("overdueTaskComplete",function(o){jive.switchboard.emit("tasks.taskComplete",o)}).addListener("overdueTaskIncomplete",function(o){jive.switchboard.emit("tasks.taskIncomplete",o)});b("#jive-inbox-task-container").load(e,function(){if(j.spinner){j.spinner.getContent().remove();j.spinner.destroy();j.spinner=null}});j.tabsView.selectTab(i);j.currentTab="jive-tasks";if(n){n.emitSuccess()}};this.initializeActionView=function(e,f){var d=this;if(e=="jive-aq-archived"){d.archived=true}d.actionQueueService.initializeView(e).addCallback(function(h){var g=b(jive.eae.actionqueue.actionsContent(h));d.$contentArea.html(g);d.queueView=new jive.ActionQueue.ListView({selector:"#j-action-queue"});d.attachQueueListeners();d.spinner.getContent().remove();d.spinner.destroy();if(f){f.emitSuccess()}});d.tabsView.selectTab(e);d.currentTab=e};this.attachQueueListeners=function(){var d=this;d.queueView.addListener("performAction",function(h,f,g){var e=new jive.ActionQueue.ActionResult(d.userId,h,f,g);d.actionQueueService.performAction(e).addCallback(function(i){jive.switchboard.emit("actions.actionTaken",h,i)})}).addListener("actionCompleted",function(e,f){d.actionQueueService.getMore(e,1,d.dismissed).addCallback(function(g){f.emitSuccess(g)})}).addListener("loadMore",function(e,f){d.actionQueueService.getMore(e,10,d.archived).addCallback(function(g){f.emitSuccess(g)})});d.queueView.postRender()};this.autoUpdate=function(e){var d=this;if(e.newActivityCounts.actions&&e.newActivityCounts.actions[0]&&b("#j-action-queue").length){if(b("#jive-aq-pending").hasClass("j-sub-selected")){d.actionQueueService.list().addCallback(function(f){d.queueView.refresh(f)})}}b("#jive-aq-pending .j-js-update-indicator").replaceWith(jive.eae.actionqueue.aqTabCount({count:e.fullCounts.actions}))};this.decrementTabCount=function(e,g){var i=b("#"+e),d=i.find(".j-js-update-indicator"),f=parseInt(d.data("count"),10),h=f-g;if(h<0){h=0}if(h==0){d.hide()}d.replaceWith(jive.eae.actionqueue.aqTabCount({count:h}))}})});