jive.namespace("draft");jive.draft.View=jive.AbstractView.extend(function(b,c){var d=jQuery,a,e;this.init=function(f){c.init.call(this,f);this.options=d.extend({pushStateEnabled:true},f);a=this;a.locationState=new jive.LocationState();d(function(){var h=a.getContent();var g=a.serializeForm();h.data("autosave",g);a.emit("display");d("#autosave-prompt .use-draft").live("click",function(k){var j=d(k.target).closest(".jive-draft");var i=j.data("draft");a.emit("restore",i);jive.switchboard.emit("draft.destroy",i.id)});d("#autosave-prompt .destroy-draft").live("click",function(k){var j=d(k.target).closest(".jive-draft");var i=j.data("draft");a.emit("destroy",i.id);jive.switchboard.emit("draft.destroy",i.id)});a.unpause();window.setInterval(function(){a.emit("keepalive")},f.keepaliveInterval*1000);d(window).unload(function(){a.removeFromWorkingDrafts(h.data("autosave").id)});jive.switchboard.addListener("draft.destroy",function(i){a.destroy(i)})})};this.pause=function(){if(e){clearTimeout(e);e=null}};this.unpause=function(){if(!e){e=setTimeout(a.save,a.options.interval*1000)}};this.save=function(){var i=new Date().getTime();function h(){var l=(new Date().getTime()-i);e=setTimeout(a.save,Math.min(Math.max(l*20,a.options.interval*1000),a.options.interval*50000))}var f=a.serializeForm();if(f.body.length===0){h();return}var j=a.getContent();var g=j.data("autosave");var k=f.body!=g.body||f.subject!=g.subject||JSON.stringify(f.properties)!=JSON.stringify(g.properties);if(!k){h();return}if(g.id){f.id=g.id;a.emitP("save",f).always(h)}else{a.emitP("create",f).always(h)}};b.serializeForm=function(){var f={};var g=a.getContent().toObject({mode:"all"})[0];f.objectType=a.options.objectType;f.draftObjectType=a.options.draftObjectType;f.draftObjectID=a.options.draftObjectID;f.subject=d("#"+a.options.subject).val();f.body=a.getRTE()?a.getRTE().getHTML():"";f.properties={};d.each(a.options.properties,function(j,h){f.properties[h]=g[h]});return f};b.getRTE=function(){return window.editor.get(a.options.editorId)};this.saved=function(h,l){try{var k=a.getContent();k.data("autosave",h);a.addToWorkingDrafts(h.id);if(a.options.pushStateEnabled){a.updatePushState(h.id)}a.updateFormDraftID(k,h.id);var j=d(jive.content.draftlastsaved({date:new Date()}));var g=d(a.getRTE().getBelowEditorArea());var f=g.find(".last-saved");if(f.length){f.replaceWith(j)}else{j.hide().appendTo(g).fadeIn();a.getRTE().autoReposition()}l.emitSuccess(h)}catch(i){if(l){l.emitError(i)}}};this.display=function(k){var g=a.locationState.getState().draftID;if(g){var j=false;d.each(k,function(m,l){if(l.id==g){a.emit("restore",l);j=true}});if(j){return}}var h=[];d.each(k,function(m,l){if(!a.isWorkingDraft(l.id)){h.push(l)}});if(h.length===0){return}var i=a.getContent();var f=d(jive.content.drafts({drafts:h}));f.find(".jive-draft").each(function(l){d(this).data("draft",h[l])});f.hide().insertBefore(i).fadeIn()};this.restore=function(g){var f=a.getContent();js2form(f[0],g.properties);a.getRTE().setHTML(g.body);d("#"+a.options.subject).val(g.subject);f.trigger("restore",g);a.addToWorkingDrafts(g.id);a.updateFormDraftID(f,g.id);f.data("autosave",g);d("#autosave-prompt").fadeOut(function(){d(this).remove()});if(a.options.pushStateEnabled){a.updatePushState(g.id)}};this.destroy=function(j){var f=d("#autosave-prompt");if(f.length===0){return}var h=d("#draft-"+j);if(h.length===0){return}var i=f.find(".jive-draft").length>1;var g=i?h:f;g.fadeOut(function(){d(this).remove()})};b.updateFormDraftID=function(g,h){var f=g.find("input#draftID");if(f.length===0){f=d("<input />",{id:"draftID",name:"draftID",type:"hidden"});f.appendTo(g)}f.val(h)};b.updatePushState=function(f){a.locationState.pushState({draftID:f})};b.addToWorkingDrafts=function(g){var f=a.getWorkingDrafts();if(!a.isWorkingDraft(g)){f.push(g)}if(typeof(localStorage)!="undefined"){localStorage.setItem("workingDrafts",f)}};b.removeFromWorkingDrafts=function(g){var f=a.getWorkingDrafts();f.splice(f.indexOf(String(g)),1);if(typeof(localStorage)!="undefined"){localStorage.setItem("workingDrafts",f)}};b.isWorkingDraft=function(f){return d.inArray(String(f),a.getWorkingDrafts())>-1};b.getWorkingDrafts=function(){if(typeof(localStorage)=="undefined"){return[]}var f=localStorage.getItem("workingDrafts");return f?f.split(","):[]}});