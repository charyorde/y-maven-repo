jive.namespace("content.polls");jive.content.polls.Main=jive.content.common.Main.extend(function(a,b){this.init=function(c){this.options=$j.extend({pollID:c.actionBean.pollID,description:c.actionBean.body,objectID:c.actionBean.pollID,objectType:18,edit:false,formActionContainer:"#jive-compose-buttons",resourceType:"polls",unloadURL:"/unload",multipartFormFilter:"[name != 'image']",autoSave:{properties:["endsDays","endsMode","activeMode","options"]}},c);this.options.rteOptions=$j.extend({preset:"poll",height:200},this.options.rteOptions);if(this.options.edit){this.options=$j.extend({suffix:"/"+this.options.pollID,ajaxType:"PUT"},this.options)}var d=this;this.options.pollOptions=this.buildOpts(c.actionBean.pollOptionsBean.options);if(!this.options.dieFTLdie){b.init.call(this,this.options)}this.optionSource=new jive.content.polls.OptionSource(this.options);this.optionListView=new jive.content.polls.OptionListView(".jive-poll-option-list",this.options);this.pollView=new jive.content.polls.PollView("#jive-body");this.optionListView.addListener("moveOption",function(f,e){d.optionMoved(f,e)}).addListener("removeOption",function(e){d.optionRemoved(e)}).addListener("newOption",function(){d.optionAdded()});this.pollView.addListener("restoreOptions",function(e){var f=d.buildOpts(e);d.optionListView.removeOptions();$j.each(f,function(g,h){d.optionSource.newOption({success:function(i){i.index=g;i.displayIndex=g+1;d.optionListView.addContent(i);$j("#opt-"+i.id).val(h.text)},error:function(j){var i=jive.json.parse(j.responseText);d.optionListView.displayError(i.message)}})});d.optionListView.updateOptions()});if(this.options.dieFTLdie){this.renderForm($j("#jive-poll-description .jive-rte"))}this.renderOptions()};a.buildOpts=function(e){var d=this;var c=new Array();$j.each(e,function(f,h){var g=d.buildPollOption(this);c.push(g)});return c};a.buildPollOption=function(d){var c={id:"j-polloption-meta-image-"+d.id,view:jive.content.polls.ImageMetaView,container:"j-polloption-meta-image-container-"+d.id,service:jive.content.polls.ImageMetaSource,attachmentdata:this.buildPollOptionAttachmentData(d)};return{id:d.id,index:d.index,text:d.text,displayIndex:d.displayIndex,objectType:d.objectType,meta:[c]}};a.buildPollOptionAttachmentData=function(d){var c=[];$j.each(d.contentMeta,function(e,g){var f={objectType:this.objectType,fullImageUrl:this.fullImageUrl,imageThumbnailUrl:this.imageThumbnailUrl,thumbnailWidth:this.thumbnailWidth,thumbnailHeight:this.thumbnailHeight};if(this.id){f.id=this.id}c.push(f)});return c};a.optionMoved=function(e,c){var f;this.optionSource.get(e,function(g){f=g});var d=this;this.optionSource.move(f,c,{success:function(g){d.optionListView.setContent(g,false)},error:function(h){var g=jive.json.parse(h.responseText);d.optionListView.displayError(g.message)}})};a.optionRemoved=function(d){var e;this.optionSource.get(d,function(f){e=f});var c=this;this.optionSource.remove(e,{success:function(f){c.optionListView.removeOption(d);c.optionListView.setContent(f,false)},error:function(g){var f=jive.json.parse(g.responseText);c.optionListView.displayError(f.message,d)}})};a.optionAdded=function(){var c=this;this.optionSource.newOption({success:function(d){c.optionListView.addContent(d)},error:function(e){var d=jive.json.parse(e.responseText);c.optionListView.displayError(d.message)}})};a.renderOptions=function(){var c=this;this.optionSource.getAll(function(d){c.optionListView.setContent(d,true)})};a.renderForm=function(c){if(this.rteView){this.rteView.killYourself();this.rteView.destroy()}$element=$j("<textarea id='wysiwygtext'></textarea>");c.append($element);$element.val(this.options.description);var e=$j.extend({$element:$element,isEditing:this.options.description.length>0},this.options.rteOptions);this.rteView=new jive.rte.RTEWrap(e);var d=this;$j("#jive-post-bodybox [name=name]").keydown(function(g){var f=g.keyCode;if(f==9&&!g.shiftKey){d.rteView.focus();return false}});$j("#pollform").submit(function(){$j(".js-poll-save").prop("disabled",true).removeClass("j-btn-callout");d.removeDraft=false;$j("#jive-poll-description [name=description]").val(d.rteView.getHTML());var f=$j("#pollform");$j("#jive-post-bodybox").find(":input[name]").each(function(){if($j(this).attr("type")=="radio"||$j(this).attr("type")=="checkbox"){if($j(this).is(":checked")){f.append($j("<input/>").attr("type","hidden").attr("name",$j(this).attr("name")).val($j(this).val()))}}else{f.append($j("<input/>").attr("type","hidden").attr("name",$j(this).attr("name")).val($j(this).val()))}});return true})}});