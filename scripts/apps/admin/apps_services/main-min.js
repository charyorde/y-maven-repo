jive.namespace("admin.apps.services");jive.admin.apps.services.Main=jive.oo.Class.extend(function(a){var b=jive.admin.apps.services;this.init=function(){var c=this;this.actionsView=null;this.entryView=null;this.filtersView=null;this.filtersViewShowing=false;this.headersView=null;this.listView=null;this.tagsView=null;this.authStyleSource=null;this.groupSource=null;this.serviceSource=null;this.userSource=null;$j(document).ready(function(){c.actionsView=c.buildActionsView();c.entryView=null;c.filtersView=null;c.headersView=null;c.listView=c.buildListView();c.tagsView=null;c.authStyleSource=new b.AuthStyleSource();c.groupSource=new b.GroupSource();c.serviceSource=new b.ServiceSource();c.userSource=new b.UserSource();c.actionsView.render();c.listView.render();c.authStyleSource.findAll(function(d){c.authStyles=d;c.populateServices()})})};a.buildActionsView=function(){var c=this;var d=new b.ActionsView();d.addListener("add-service",function(f){var e=c.serviceSource.create();c.entryView=c.buildEntryView(e);c.headersView=c.buildHeadersView(e);c.listView.hide();c.entryView.render();c.populateHeaders(e,-1);c.headersView.render();c.entryView.show()});d.addListener("filter-services",function(f){if(!c.filtersViewShowing){var e=c.userSource.getUser(c.serviceSource.getUserFilter());c.filtersView=c.buildFiltersView(c.serviceSource.getTagFilter(),e);c.filtersView.render();$j("#render-filters-div").show();$j("#filter-services").addClass("adding");c.filtersViewShowing=true}else{$j("#filter-services").removeClass("adding");$j("#render-filters-div").hide();c.filtersViewShowing=false;c.serviceSource.setTagFilter([]);c.serviceSource.setUserFilter(-1);c.populateServices()}c.actionsView.setFilterTooltip(c.filtersViewShowing)});return d};a.buildEntryView=function(e){var d=this;var c=[];if(e.groups){c=d.groupSource.getGroups(e.groups)}var g=[];if(e.owners){g=d.userSource.getUsers(e.owners)}var h=[];if(e.users){h=d.userSource.getUsers(e.users)}var f=new b.EntryView(e,d.authStyles,c,g,h);f.addListener("cancel-service",function(i){d.entryView.hide();d.populateServices();d.listView.show()});f.addListener("save-service",function(j){if(d.entryView.validate()){var i=j.service;d.entryView.populate(i);d.serviceSource.save(i,function(k){if(k){alert(k)}else{d.entryView.hide();d.populateServices();d.listView.show()}})}});f.addListener("test-service",function(j){if(d.entryView.validate()){var i=j.service;d.entryView.populate(i);d.serviceSource.save(i,function(k){if(k){alert(k)}else{d.serviceSource.test(i,function(l){d.entryView.testResults(l)})}})}else{d.entryView.testResults("Cannot test until validation errors have been fixed")}});return f};a.buildFiltersView=function(f,e){var c=this;var d=new b.FiltersView(f,e);d.addListener("remove-filter",function(i){var h=c.serviceSource.getTagFilter();h=c.removeTag(h,i.tag);c.serviceSource.setTagFilter(h);c.populateServices();var g=c.userSource.getUser(c.serviceSource.getUserFilter());c.filtersView=c.buildFiltersView(c.serviceSource.getTagFilter(),g);c.filtersView.render()});d.addListener("tag-chooser",function(i){var g=c.serviceSource.getUniqueTags();var h=c.serviceSource.getTagFilter();c.tagsView=c.buildTagsView(g,h);c.tagsView.render()});d.addListener("user-chooser",function(g){c.serviceSource.setUserFilter(g.userID);c.populateServices()});return d};a.buildHeaderView=function(f,d,e){var c=this;var g=new b.HeaderView(f,d,e);if(e){g.addListener("edit-header-cancel",function(h){c.populateHeaders(d,-1);c.headersView.setAddFocus()});g.addListener("edit-header-save",function(h){d.headers[f].name=g.getEditName();d.headers[f].value=g.getEditValue();c.populateHeaders(d,-1);c.headersView.setAddFocus()})}else{g.addListener("edit-header",function(h){c.populateHeaders(d,f);c.headersView.setEditFocus()});g.addListener("remove-header",function(j){var h=confirm("Are you sure you want to header '"+d.headers[j.index].name+"'?");if(h){var i=d.headers.slice(0,j.index);var k=d.headers.slice(j.index+1);d.headers=i.concat(k);c.populateHeaders(d,-1)}})}return g};a.buildHeadersView=function(d){var c=this;var e=new b.HeadersView(d);e.addListener("add-header",function(f){e.showAddHeaderRow()});e.addListener("add-header-add",function(f){var g={name:$j("#settings-add-header-name").val(),value:$j("#settings-add-header-value").val()};f.service.headers.push(g);c.populateHeaders(f.service,-1);e.hideAddHeaderRow()});e.addListener("add-header-cancel",function(f){e.hideAddHeaderRow()});return e};a.buildItemView=function(e,d){var c=this;var f=new b.ItemView(e,d);f.addListener("delete-service",function(i){var h=confirm("Are you sure you want to remove this service?");if(h){var g=i.service;c.serviceSource.remove(g,function(j){if(j){alert(j)}c.populateServices()})}});f.addListener("edit-service",function(g){c.entryView=c.buildEntryView(g.service);c.headersView=c.buildHeadersView(g.service);c.listView.hide();c.entryView.render();c.populateHeaders(g.service,-1);c.headersView.render();c.entryView.show()});f.addListener("update-enabled",function(g,h){g.service.enabled=g.enabled;c.serviceSource.updateEnabled(g.service,function(){h.emitSuccess()})});return f};a.buildListView=function(){var c=this;var d=new b.ListView();return d};a.buildTagsView=function(d,f){var c=this;var e=new b.TagsView(d,f);e.addListener("select-tags",function(h){c.serviceSource.setTagFilter(h.selectedTags);c.populateServices();var g=c.userSource.getUser(c.serviceSource.getUserFilter());c.filtersView=c.buildFiltersView(c.serviceSource.getTagFilter(),g);c.filtersView.render()});return e};a.populateHeaders=function(d,f){var c=this;c.headersView.erase();var e=0;$j(d.headers).each(function(g,i){var h=c.buildHeaderView(g,d,g==f);c.headersView.append(h.getContent());g++});c.headersView.showNoHeadersMessage(d)};a.populateServices=function(){var c=this;c.listView.erase();var d=0;c.serviceSource.findAll(function(e){$j(e).each(function(g,f){var h=c.buildItemView(g,f);c.listView.append(h.getContent());g++})})};a.removeTag=function(d,c){var e=[];$j(d).each(function(f,g){if(!(c==g)){e.push(g)}});return e}});