jive.namespace("UserGroupPicker");jive.UserGroupPicker.View=jive.oo.Class.extend(function(b){var e=new jive.UserGroupPicker.SelectGroupsView();jive.conc.observable(this);function f(g,i){var h=false;$j(g).each(function(j,k){if(i.id==-1){h=h||(k.displayName==i.displayName)}else{h=h||(k.id==i.id&&k.objectType==i.objectType)}});return h}function d(g){return{displayName:g.displayName,id:g.id,enabled:g.enabled,objectType:g.objectType,name:g.name,entitled:g.entitled,avatarID:g.avatarID,excluded:(typeof(g.excluded)!="undefined"?g.excluded:false)}}function c(h){var g={displayName:h.displayName,id:h.id,objectType:h.objectType,style:h.style,groups:[],excluded:(typeof(h.excluded)!="undefined"?h.excluded:false)};$j(h.groups).each(function(i,j){g.groups.push(d(j))});return g}function a(g){if(typeof innerShiv!="undefined"){return innerShiv(g)}else{return g}}this.setSelectedGroups=function(g){if(!g){g=[]}var j=this;$j(g).each(function(i,k){if(!f(j.selectedGroups,k)){j.selectedGroups.push(d(k))}});for(var h=0;h<this.selectedGroups.length;h++){if(!f(g,this.selectedGroups[h])){this.selectedGroups.splice(h,1);h--}}this.refreshSelectedGroupsDisplayAndHiddenInput()};this.setSelectedLists=function(g){if(!g){g=[]}var j=this;$j(g).each(function(i,k){if(!f(j.selectedLists,k)){j.selectedLists.push(c(k))}});for(var h=0;h<this.selectedLists.length;h++){if(!f(g,this.selectedLists[h])){this.selectedLists.splice(h,1);h--}}this.refreshSelectedGroupsDisplayAndHiddenInput()};this.val=function(){return this.$valueStore.val()};this.init=function(q,h){var n=this;this.$input=q;this.urls={groupAutocomplete:_jive_base_url+"/group-autocomplete.jspa",browseModal:_jive_base_url+"/group-autocomplete-modal.jspa"};this.showNoPicker=false;this.options=h;this.groupStore=new jive.ext.y.HashTable();this.listStore=new jive.ext.y.HashTable();this.selectedGroups=[];this.selectedLists=[];q.addClass("jive-chooser-input jive-form-textinput-variable");q.before("<input type='hidden'/>");this.$valueStore=q.prev();this.$valueStore.attr("name",q.attr("name"));q.removeAttr("name");var j=$j('<div class="jive-chooser-list j-result-list j-people-list j-rc4 clearfix"></div>');q.before(j.hide());this.$chooser=$j('<div class="jive-chooser-autocomplete j-result-list j-rc4"></div>');$j("body").append(this.$chooser.hide());var i=this.options.permissionsMessage;if(i){q.before(i.hide())}function t(x){var v=x.groups;if(v.length>0){var w=v.length;for(var u=0;u<v.length;u++){$j.ajax({url:_jive_base_url+"/__services/v2/rest/groups/"+v[u].groupID,dataType:"json",success:function(y){console.log("success");w--;if(y&&!f(n.selectedGroups,y)){n.selectedGroups.push(y);n.refreshSelectedGroupsDisplayAndHiddenInput()}if(w==0){e.close();n.emit("selectedGroupssChanged",{groups:n.selectedGroups,grouplists:n.selectedLists})}},error:function(){w--;if(w==0){e.close();n.emit("selectedGroupssChanged",{groups:n.selectedGroups,grouplists:n.selectedLists})}}})}}}function l(){e.setOptions(n.options).addListener("select",t).open();return false}if(n.options.groupAllowed){n.$browse=$j(jive.UserGroupPicker.soy.renderModalBrowseButton({plural:n.options.multiple}));q.after(n.$browse);n.$browse.click(l)}var g="";this.refreshSelectedGroupsDisplayAndHiddenInput=function(){var u=[];var w=[];var v=true;$j(n.selectedGroups).each(function(x,y){v=v&&y.entitled;if(!f(u,y)&&!y.excluded){u.push(y);if(y.id==-1){w.push(y.name)}else{if(n.options.valueIsUserGroupName){w.push(y.name)}else{w.push(y.id)}}}});$j(n.selectedLists).each(function(x,y){if(!y.excluded){$j(y.groups).each(function(z,A){v=v&&A.entitled;if(!f(u,A)){u.push(A);if(A.id==-1){w.push(A.name)}else{if(n.options.valueIsUserGroupName){w.push(A.name)}else{w.push(A.id)}}}})}});if(i){if(v){i.hide()}else{i.show()}}this.$valueStore.val(w.join(","));if(n.selectedLists.length||n.selectedGroups.length){if(n.options.multiple){j.html(jive.UserGroupPicker.soy.renderSelectedGroupsList({results:{groups:n.selectedGroups,groupLists:n.selectedLists},message:n.options.message,disabled:n.options.disabled})).show()}else{j.html(jive.UserGroupPicker.soy.renderSelectedGroup({results:{groups:n.selectedGroups,groupLists:n.selectedLists},disabled:n.options.disabled})).show();if(n.selectedGroups.length){q.hide();n.$browse.hide()}}j.find("li").each(function(){var y=$j(this);y.find("a.showConnections").click(function(){y.find(".js-grouped-users-popover").popover({context:$j(this),putBack:true,destroyOnClose:false,container:j.closest(".j-modal")});return false});function x(z){return function(){var C=y.attr("data-list-id");if(C){if(n.showNoPicker){n.selectedGroupLists=n.selectedGroupLists.map(function(D){if(D.id==C){D.excluded=z}return D})}else{n.selectedGroupLists=n.selectedGroupLists.filter(function(D){return D.id!=C})}}var A=y.attr("data-group-id");if(A&&A!=-1){if(n.showNoPicker){n.selectedGroups=n.selectedGroups.map(function(D){if(D.id==A){D.excluded=z}return D})}else{n.selectedGroups=n.selectedGroups.filter(function(D){return D.id!=A})}}else{var B=y.attr("data-group-name");if(B){n.selectedGroups=n.selectedGroups.filter(function(D){return D.name!=B})}}n.emit("selectedGroupsChanged",{groups:n.selectedGroups,groupLists:n.selectedLists});n.refreshSelectedGroupsDisplayAndHiddenInput()}}y.find("em a.add").click(x(false));y.find("em a.remove").click(x(true))})}else{j.html("");j.hide();n.show()}};this.clickTheSelectedGroup=function(){var u=n.$chooser.find("li.hover a").attr("data-group-id");var x=n.$chooser.find("li.hover a").attr("data-list-id");n.$chooser.val("");if(u){var w=n.groupStore.get(u);if(w&&!f(n.selectedGroups,w)){n.selectedGroups.push(w);n.emit("selectedGroupsChanged",{groups:n.selectedGroups,groupLists:n.selectedLists})}}else{if(x){var v=n.listStore.get(x);if(v&&!f(n.selectedLists,v)){n.selectedLists.push(v);n.emit("selectedGroupsChanged",{groups:n.selectedGroups,groupLists:n.selectedLists})}}}q.focus();n.refreshSelectedGroupsDisplayAndHiddenInput();o()};this.highlightRow=function(u){n.$chooser.find("li.hover").removeClass("hover");u.addClass("hover")};this.highlightFirst=function(){n.$chooser.find("li.hover").removeClass("hover");n.$chooser.find("li:first").addClass("hover")};function k(){if(n.$chooser.find("li.hover").next().length){n.$chooser.find("li.hover").removeClass("hover").next().addClass("hover")}else{if(n.$chooser.find("li.hover").parent("ul").nextAll("ul:first").length){n.$chooser.find("li.hover").removeClass("hover").parent("ul").nextAll("ul:first").find("li:first").addClass("hover")}}}function s(){if(n.$chooser.find("li.hover").prev().length){n.$chooser.find("li.hover").removeClass("hover").prev().addClass("hover")}else{if(n.$chooser.find("li.hover").parent("ul").prevAll("ul:first").length){n.$chooser.find("li.hover").removeClass("hover").parent("ul").prevAll("ul:first").find("li:last").addClass("hover")}}}function o(u){n.$chooser.hide();if(!u){q.val("")}}function r(){if(g!=q.val()&&q.val().length){g=q.val();n.emit("autocompleteRequest",g)}else{if(g.length&&q.val().length){n.highlightFirst();n.$chooser.css({left:n.$input.offset().left,top:n.$input.offset().top+n.$input.height()+10});n.$chooser.show()}}return true}function p(u){switch(u.keyCode){case $j.ui.keyCode.UP:s();return false;case $j.ui.keyCode.DOWN:k();return false;case $j.ui.keyCode.ENTER:n.clickTheSelectedGroup();return false;case $j.ui.keyCode.ESCAPE:o();return false;case $j.ui.keyCode.LEFT:case $j.ui.keyCode.RIGHT:case $j.ui.keyCode.HOME:case $j.ui.keyCode.END:case $j.ui.keyCode.PAGE_UP:case $j.ui.keyCode.PAGE_DOWN:return false}return true}var m=true;q.keydown(function(u){return m=p(u)}).keypress(function(){return m}).keyup(function(u){if(m){r()}return m});q.blur(function(){setTimeout(function(){o(true)},250)}).focus(function(){r()});this.setSelectedGroups(n.options.startingGroups.groups);this.setSelectedLists(n.options.startingGroups.groupLists)};this.setDisabled=function(g){this.options.disabled=g;this.refreshSelectedGroupsDisplayAndHiddenInput()};this.hide=function(){this.$input.hide();if(this.$browse){this.$browse.hide()}};this.show=function(){if(!this.showNoPicker){this.$input.show();if(this.$browse){this.$browse.show()}}else{this.hide()}};this.setNoPicker=function(g){this.showNoPicker=g;this.show()};this.autocompleteResponse=function(g){var h=this;$j(g.groups).each(function(j,k){h.groupStore.put(k.id,k)});$j(g.groupLists).each(function(j,k){h.listStore.put(k.id,k)});var i;if(!this.options.groupAllowed&&!this.options.listAllowed){i=jive.UserGroupPicker.soy.pleaseEnterValidName()}else{i=jive.UserGroupPicker.soy.noUserGroupsMatchMessage()}this.$chooser.html(jive.UserGroupPicker.soy.renderGroupsList({results:g,noResultsMessage:i})).show();this.$chooser.css({left:this.$input.offset().left,top:this.$input.offset().top+this.$input.height()+10});this.highlightFirst();this.$chooser.find("a").mouseover(function(){h.highlightRow($j(this).parent("li"))}).click(function(){h.clickTheSelectedGroup();return false})}});