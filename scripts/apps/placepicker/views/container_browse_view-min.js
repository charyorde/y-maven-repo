jive.namespace("Placepicker");jive.Placepicker.ContainerBrowseView=jive.AbstractView.extend(function(a){var b=jQuery;a.init=function(c){this.containerStack=new Array();c=c||{};this.filterGroup=c.filterGroup||"placePicker";this.followLinks=c.followLinks||false;this.parent=c.parent||null;this.closeOnSelect=c.closeOnSelect||false;this.hideUserContainer=c.hideUserContainer||false};this.render=function(e){var f=new jive.conc.Promise(),c=this;c.rootCommunity=e.rootCommunity;c.showRootCommunity=e.showRootCommunity;c.contentType=e.contentType;c.modal=b(jive.placepicker.browseContainers(e));c.modal.delegate(".js-target-container","click",function(j){var h=b(this).data("objecttype");var i=b(this).data("objectid");var g=$j(this).find(".js-container-title").text();c.emit("container",{targetContainerType:h,targetContainerID:i,targetContainerName:g});if(c.closeOnSelect){c.modal.trigger("close")}if(!c.followLinks){j.preventDefault()}});var d=function(){c.setupSubspaceHandlers(c.modal);var g=c.serviceArgs("following");c.showSpinner();c.emitP("browseLoad",g).addCallback(function(i){var j=b(jive.placepicker.containerList(jQuery.extend({emptyKey:"browse.places.empty.message"},i)));c.addListToAccordionSection(c.modal.find(".j-places-list").first(),j,true);var h=c.modal.find(".j-accordion-container").accordion({changestart:function(n,o){if(o.newContent.find("li").length==0){var m=o.newHeader.find(".js-accordion-link");var l=c.serviceArgs(m.data("placefilter"));c.setupAccordionSection(o.newHeader.next(),l,true)}}});var k=new jive.Placepicker.ContainerSearchView(c.modal.find("input[name=container-filter]"),c.modal.find(".js-place-picker-content"));c.proxyListener(k,"search")}).always(function(){c.hideSpinner()})};c.modal.lightbox_me({closeSelector:".close",destroyOnClose:true,onLoad:d,showOverlay:true,parentLightbox:b(c.parent).closest(".jive-modal:visible")});return f};this.close=function(){if(this.modal){this.modal.trigger("close")}};a.setupAccordionSection=function(d,g,i){var c=this;var f=c.isSpacesSection(g.filterID);var e=c.isFollowingSection(g.filterID);if(f){g=c.setupSpaceArgs(g);d.data("containerType",g.containerType);d.data("containerID",g.containerID);if(c.isRootCommunity(g)){var h=c.rootCommunityList();return c.addListToAccordionSection(d,h,i)}}var j=null;if(e){j="browse.places.empty.message"}c.showSpinner(d);c.emitP("browseLoad",g).addCallback(function(l){c.hideSpinner(d);if(f){if(c.isRootCommunityChildren(g)&&!c.showRootCommunity){l.containerName=null}}var k=b(jive.placepicker.containerList(jQuery.extend({showSubspaces:f,emptyKey:j},l)));return c.addListToAccordionSection(d,k,i)})};a.addScroller=function(d){var c=this;d.endlessScroll({fireDelay:false,callback:function(){var i=b(this).find("li").size();if(i%20==0){var g=b(this).prev().find("a");var f=g.data("placefilter");var h=c.serviceArgs(f,i);var e=b(this).data("containerID");var j=b(this).data("containerType");if(e>-1){h=b.extend({containerType:j,containerID:e},h)}c.emitP("browseLoad",h).addCallback(function(l){var k=b(jive.placepicker.moreContainers(b.extend({showSubspaces:c.isSpacesSection(f)},l)));d.find("ul").append(k)})}}})};a.setupSubspaceHandlers=function(d){var c=this;c.containerStack.push({containerType:c.rootCommunity.type,containerID:-1});d.delegate(".js-child-spaces","click",function(h){var g=b(this).closest(".j-places-list").prev(".j-accordion-toggle").find(".js-accordion-link");var e=g.data("placefilter");var f=b.extend({containerType:b(this).data("objecttype"),containerID:b(this).data("objectid")},c.serviceArgs(e));c.containerStack.push({containerType:b(this).data("parent-objecttype"),containerID:b(this).data("parent-objectid")});c.setupAccordionSection(b(this).closest(".j-places-list"),f,false);h.preventDefault()});d.delegate(".js-parent-container","click",function(h){var g=b(this).closest(".j-places-list").prev(".j-accordion-toggle").find(".js-accordion-link");var e=g.data("placefilter");var j=c.containerStack.pop();if(c.isRootCommunity(j)){var i=c.rootCommunityList();c.addListToAccordionSection(b(this).closest(".j-places-list"),i,false)}else{var f=b.extend({containerType:j.containerType,containerID:j.containerID},c.serviceArgs(e));c.setupAccordionSection(b(this).closest(".j-places-list"),f,false)}h.preventDefault()})};a.flatFind=function(d,c){return d.find("*").andSelf().filter(c)};a.isSpacesSection=function(c){return c=="space"};a.isFollowingSection=function(c){return c=="following"};a.isRootCommunityChildren=function(d){var c=this;return d.containerType==c.rootCommunity.type&&d.containerID==c.rootCommunity.id};a.isRootCommunity=function(d){var c=this;return d.containerType==c.rootCommunity.type&&d.containerID==-1};a.setupSpaceArgs=function(d){var c=this;if(!d.containerType&&!d.containerID){if(c.showRootCommunity){d.containerType=c.rootCommunity.type;d.containerID=-1}else{d.containerType=c.rootCommunity.type;d.containerID=c.rootCommunity.id}}return d};a.addListToAccordionSection=function(d,e,f){var c=this;d.html(e);d.show();if(f){c.addScroller(d)}};a.serviceArgs=function(d,f){var c=this;var e=c.isSpacesSection(d)?"spaceOrder":"subject";return{filterGroupID:c.filterGroup,filterID:d,start:f?f:0,sortKey:e,numResults:20}};a.rootCommunityList=function(){var c=this;return b(jive.placepicker.containerList({showSubspaces:true,containers:[c.rootCommunity],contentType:c.contentType,containerType:-1,containerID:-1}))};a.createSpinner=function(c){this.$spinner=b(jive.shared.soy.loading());if(c){c.append(this.$spinner)}};a.destroySpinner=function(c){if(this.$spinner){this.$spinner.remove()}}});