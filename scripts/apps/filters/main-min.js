jive.namespace("Filters");jive.Filters.Main=jive.Paginated.extend(function(b){var c=jive.Filters,e;jive.conc.observable(this);b.init=function(g){var f=this;this.extraParams=g.extraParams;this.guest=g.guest;this.targetUserID=g.targetUserID;this.browseViewID=g.browseViewID;this.archetypeID=g.archetypeID||this.browseViewID;this.token=g.token||"";this.fromQuest=g.fromQuest;this.questStep=g.questStep;this.initPagination(jQuery.extend({},g.extraParams,{filterID:g.filterGroup.defaultFilterID,itemView:g.itemViewID,userID:g.targetUserID,numResults:g.pageSize}),{locationState:g.locationState,viewClass:g.viewClass,scrollTo:".j-bigtab-nav"});this.itemSource=g.itemSource;this.userPrefSource=g.userPrefSource;this.filterGroup=new c.FilterGroup(g.filterGroup.filters);this.filterView=new c.FilterView({objectTypes:this.filterGroup.applied(this.getState().filterID).objectTypes()});this.listView=new (g.itemGridClass||c.ItemGridView)({itemViewID:g.itemViewID,noResults:g.noResults,noResultTemplateConfig:g.noResultTemplateConfig,archetypeID:g.archetypeID,omitIcons:g.omitIcons,baseSelector:g.baseSelector});this.navView=new c.SecondaryNavView(null,g.filterGroup.defaultFilterID,g.guest);this.searchView=new jive.TypeaheadInput("#js-browse-controls input[name=query]",{delay:function(i){var h=i.length;return h<2?700:Math.floor(4000/(h*h)+400)},minLength:2});this.navView.addListener("navSelect",function(h,k){var i=f.filterGroup.applied(f.getState().filterID),j=h.filter(function(m){var l=i.find(function(n){return n.id==m});return !(l&&l.nested)});jive.localexchange.emit("browse.filter.change",{filterID:j});f.pushState({filterID:j,start:e,sortKey:e,sortOrder:e,containerType:e,containerID:e,query:e}).addErrback(function(){k.emitError()})});this.filterView.addListener("applyFilters",function(h){f.applyFilters(h)});this.navView.addListener("setDefaultFilter",function(h,i){f.saveDefaultFilterSetting(h);i.emitSuccess()});this.filterView.addListener("value",function(h,m){var j=f.getState().filterID,k=f.filterGroup.applied(j),l=k.unset(h),i=f.sortFilters(l.getLeafIDs()),n=k.set(h,m);f.pushState({filterID:f.sortFilters(n.getLeafIDs(),i),start:e})});this.filterView.addListener("applySort",function(h,i){f.pushState({sortKey:h,sortOrder:i,start:e})});this.listView.addListener("toggleItemView",function(h){f.saveItemViewSetting(h)});this.searchView.addListener("change",function(h){f.pushState({query:h,start:e})});this.searchView.addListener("clear",function(){f.pushState({query:e,start:e})});jive.localexchange.viewupdatesource=true};b.applyFilters=function(g){var f=this;f.pushState({filterID:f.mergeFilters(g),start:e})};b.loadPage=function(k,m){var i=this.getContent(k),g=this.filterGroup.applied(k.filterID),l=g.getRoot(),j=new jive.conc.Promise(),f=this;if(this.lastLoadPagePromise){this.lastLoadPagePromise.cancel()}if(this.lastDataReadyPromise){this.lastDataReadyPromise.cancel()}this.lastLoadPagePromise=j;this.lastDataReadyPromise=i;if(k.itemView){f.listView.setItemViewID(k.itemView)}f.navView.activate(l.id,g.map(function(n){return n}).filter(function(n){return n.nested}).map(function(n){return n.id})[0]);var h=i.map(function(n){return $j.extend(n,{filterGroup:f.filterGroup.applied(k.filterID),rootFilter:g.getRoot(),filterIDs:f.sortFilters(g.getIDs()),sorts:g.getSorts()})});jive.localexchange.emit("view.update.start");i.addCallback(function(n){f.dataReadyCallback(k,j,n)}).addErrback(function(){j.emitError()}).always(function(){jive.localexchange.emit("view.update.stop")});if(m||this.navChanged(l,k)){this.listView.update(h)}else{this.listView.updateWithMerge(i)}return j};b.dataReadyCallback=function(k,j,h){delete this.lastLoadPagePromise;delete this.lastDataReadyPromise;if(h.filters){this.filterGroup=new c.FilterGroup(h.filters)}h.browseViewID=this.browseViewID;var f=this.filterGroup.applied(k.filterID),l=f.getRoot(),i=this.sortFilters(f.getIDs()),g=f.getSorts();j.emitSuccess(h.pageNumber,h.pageNumber+(h.hasNext?1:0));this.searchView.val(k.query||"");this.filterView.setObjectTypes(f.objectTypes());this.filterView.render(l,i,h.sortKey||k.sortKey,g,h.itemViewID);this.emit("navSelect",l.id);this.toggleRSSLink(true);this.bindRSSLink(k)};b.getContent=function(i){var f=this;var g=this.getState().itemView;var h=new jive.conc.Promise();this.itemSource.findAll(jQuery.extend({filterGroupID:this.browseViewID,token:f.token,itemViewID:g},i)).addCallback(function(k){f.token=k.token;f.appendQuestInfo(f.fromQuest,f.questStep,k);var j=f.filterGroup.applied(f.getState().filterID),l=j.getRoot();if(k.prop&&k.prop.resultCounts){a(k.prop.resultCounts,l)}if(!k.itemViewModified||!k.itemViewID){h.emitSuccess($j.extend(k,{itemViewID:g}))}else{h.emitSuccess(k)}}).addErrback(function(){h.emitError.apply(h,arguments)});return h};function a(g,f){if(g.hasOwnProperty(f.id)){f.resultCount=g[f.id]}if(f.children){$j.each(f.children,function(h,j){a(g,j)})}}b.removeGridItem=function(g){var f=this;if(!f.listView.removeItem(g)){f.loadPage(f.getState(),false).addCallback(function(h){f.listView.removeItem(g)})}};b.saveItemViewSetting=function(g){if(this.browseViewID){var f="browse."+this.archetypeID+".itemviewtoggle";if(!this.guest){this.userPrefSource.setUserProperty({userID:"current",propName:f,propValue:g})}this.pushState({itemView:g})}else{throw"No browseViewID option has been specified for this view."}};b.saveDefaultFilterSetting=function(g){if(this.browseViewID){if(!this.guest){var f="browse."+this.browseViewID+".defaultfilter";this.userPrefSource.setUserProperty({userID:"current",propName:f,propValue:g})}}else{throw"No browseViewID option has been specified for this view."}};b.navChanged=function(g,k){var h=this.navTab,j=this.lastPage,i=this.lastItemView,f;if(!h||typeof j=="undefined"||!i){f=this.normalized(this.lastState);h=this.filterGroup.applied(f.filterID).getRoot().id;j=f.start;i=f.itemView}this.navTab=g.id;this.lastPage=k.start;this.lastItemView=k.itemView;return h!=g.id||j!=k.start||i!=k.itemView};b.mergeFilters=function(j){var f=this.getState().filterID,i=this.filterGroup.applied(f),m=i.getRoot().children.filter(function(o){return !o.nested&&o.exclusive}).map(function(o){return o.id})[0],k=(j.add||[]).filter(function(o){return o!=m}),h=(j.remove&&j.remove.length>0)?i.filter(function(o){return j.remove.every(function(p){return o.id!=p})}):i,n=this.sortFilters(h.getLeafIDs()),l=this.filterGroup.applied(f.concat(k)),g=(j.remove&&j.remove.length>0)?l.filter(function(o){return j.remove.every(function(p){return o.id!=p})}):l;return this.sortFilters(g.getLeafIDs(),n)};function d(j,h,f){var g=h.indexOf(j),i;if(g>-1){return g}else{i=(h.map(function(l,k){return[f.get(l),k]}).filter(function(l){var k=l[0];return f.parentOf(k,j)||f.childOf(k,j)})[0]||[])[1];return typeof i!="undefined"?i:999}}b.sortFilters=function(g,h){h=h||this.getState().filterID;var f=this.filterGroup;return g.sort(function(j,i){var l=d(j,h,f),k=d(i,h,f);return l-k})};b.toggleRSSLink=function(f){if(f){jQuery(".js-rss-link").show()}else{jQuery(".js-rss-link").hide()}};b.bindRSSLink=function(i){var g={userID:i.userID,containerType:i.containerType,containerID:i.containerID,query:i.query,filterID:i.filterID};var h=$j(".js-content-feed-link[data-base-url]");var f;if(h.length>0){f=$j.param.querystring(h.data("base-url"),g);$j(".js-content-feed-link").attr("href",f)}};b.appendQuestInfo=function(h,f,k){if(!h){return}for(var g in k.items){var j=k.items[g];j.link=j.link+"?fromQ="+h+"&sqtep="+f}}});jive.Filters.isLegacyBrowser=function(){var a=$j.browser.msie,b=parseInt($j.browser.version)<8;return !!(a&&b)};