jive.namespace("Filters");jive.Filters.ItemGridView=jive.AbstractView.extend(function(b){var d=jQuery;b.fadeInOnMergeDuration=200;b.sortDuration=400;b.sortEasing="easeInOutQuint";b.fadeOutOnMergeDuration=200;d("body").addClass(jQuery.browser.webkit?"webkit":"other");var c=window.styleMedia&&window.styleMedia.matchMedium("(-webkit-transform-3d)");this.init=function(g){var f=d(this.primary).closest("form"),e=this;this.noResultTemplateConfig=g.noResultTemplateConfig;this.noResults=g.noResults;this.baseSelector=g.baseSelector||"#j-browse-item-grid";this.$itemGrid=d(this.baseSelector);this.$itemToggle=d("#j-item-view-toggle");this.$navLinks=d("li.j-browse-filter-group-item");this.$containerNav=d("#jive-body > nav.j-bigtab-nav");this.$moreResultsAvailable=d("#j-more-search-results-available");this.archetypeID=g.archetypeID;this.omitIcons=g.omitIcons;this.content=this.$itemGrid;this.$navLinks.find("a").click(function(h){e.$itemToggle.show()});d("#j-item-view-toggle a.js-updatable-link").click(function(h){var i=$j(this).data("item-view-id");e.setItemViewID(i);e.emit("toggleItemView",e.itemViewID);h.preventDefault()});this.prepareThumbs();this.prepareDetails();if(!g.noInitVGrid){this.initVGrid()}};this.setItemViewID=function(e){var f;if(this.itemViewID!=e){this.itemViewID=e;f=d("#j-item-view-toggle a.js-updatable-link");f.removeClass("j-active");f.filter(".js-link-thumbnails").toggleClass("j-active",e=="thumb");f.filter(".js-link-details").toggleClass("j-active",e=="detail");f.filter(".js-link-hierarchy").toggleClass("j-active",e=="hierarchy")}};b.toggleHierarchyView=function(e){var f=d(".j-link-hierarchy").parent();if(e){f.show()}else{f.hide()}};this.update=function(g,f){var e=this;this.showSpinner({size:"small",context:d("#j-browse-filters")});g.addCallback(function(h){e.itemsView=h;e.setItemViewID(h.itemViewID);e.toggleHierarchyView(e.itemsView.hierarchyViewSupported);if(e.noResultTemplateConfig){e.noResultTemplateConfig.data.filterIDs=h.filterIDs}if(h.items.length<1&&e.noResults){e.renderNoResults()}else{if(e.itemViewID=="thumb"){e.renderThumbs(f)}else{if(e.itemViewID=="detail"){e.renderDetails()}else{if(e.itemViewID=="hierarchy"){e.renderHierarchy()}}}}e.displayMoreSearchResultsMessage(h)}).always(function(){e.hideSpinner()})};this.updateWithMerge=function(e){return this.update(e,true)};this.removeItem=function(k){var e=this;if(e.itemsView&&e.itemsView.items){var j=e.itemsView;var h=false;for(var f=0;f<j.items.length;f++){var g=j.items[f];if(g.id==k.id&&g.type==k.type){j.items.splice(f,1);h=true;break}}if(h){e.itemsView.items=j.items;var l=new jive.conc.Promise();e.updateWithMerge(l);l.emitSuccess(j);$j(".js-pop").hide()}return h}return false};b.addArchetype=function(e){if(this.archetypeID&&!e.archetypeID){return d.extend(e,{archetypeID:this.archetypeID})}else{return e}};b.renderThumbs=function(h){var g=d(jive.browse.grid.itemGrid(d.extend(this.addArchetype(this.itemsView),{itemViewID:"thumb",noResultTemplateConfig:this.noResultTemplateConfig}))),e=this.$itemGrid.find(".js-browse-thumbnail"),f=g.find(".js-browse-thumbnail");if(jive.Filters.isLegacyBrowser()){h=false}if(h&&e.length>0&&f.length>0){this.mergeThumbs(f,e,this.prepareThumbs.bind(this))}else{this.replaceThumbs(g,this.prepareThumbs.bind(this))}};b.prepareThumbs=function(){var e=this;jive.conc.nextTick(this.resizeHeaders.bind(this));jive.conc.nextTick(this.resizePreviews.bind(this));this.$itemGrid.delegate(".j-card-flipper, .j-back-btn","click",function(h){var i=d(this).closest(".card"),g=d(this).hasClass("j-card-flipper");if(d.browser.webkit&&!c){var f=150;setTimeout(function(){i.find(".card-back").toggle(g);i.find(".card-front").toggle(!g)},f)}i.toggleClass("flipped",g);h.preventDefault()})};b.prepareDetails=function(){var f=this;function e(i){var h=d(this);jive.conc.nextTick(function(){h.trigger("close")})}function g(i){i.preventDefault();var h=$j(this),j={};j[h.data("cur-loc-param-name")]=window.location.href;window.location.href=$j.param.querystring(h.attr("href"),j)}this.$itemGrid.delegate(".j-browse-action-button","click",function(j){var i=$j(this),h=i.closest(".j-td-actions").find(".j-js-browse-actions-container");h.popover({context:$j(this),darkPopover:true,destroyOnClose:false,putBack:true});if(!h.data("haveClickEventsBeenAttached")){h.data("haveClickEventsBeenAttached",true);h.find("a.share-link, a.j-js-create-direct-message").click(e);h.find("a.js-link-cur-loc-param").click(g)}j.preventDefault()})};b.resizeHeaders=function(){var e=this.truncateText;this.$itemGrid.find("header.js-thumb-header").each(function(){if(d(this).find(".js-header-text").length<1){return true}var f=d(this);var g=d(this).find("a");var h=d(this).find(".js-header-text");f.find("h4").css("padding-right",Math.max(10,f.find(".j-thumb-title-meta").outerWidth()+6)+"px");if(g.outerHeight()>f.outerHeight()||h.outerWidth()>g.outerWidth()){g.closest("h4").addClass("shrunk")}var i=h.text();e(h,g,i);if(h.outerHeight()<20){g.addClass("j-single-line")}})};b.resizePreviews=function(){var e=this.truncateText;this.$itemGrid.find("article").each(function(){var g=d(this);var f=g.find("span");var h=d(this).text();e(f,g,h)})};b.truncateText=function(e,f,g){return jive.util.fitTextWithinNode(g,e,f)};b.renderDetails=function(){var f=this.itemsView.items.length<1&&this.noResults?d.extend({},this.itemsView,{noResults:this.noResults()}):this.itemsView;var e=d(jive.browse.grid.itemGrid(d.extend(this.addArchetype(f),{noResultTemplateConfig:this.noResultTemplateConfig})));this.updateItemGrid(e)};b.renderNoResults=b.renderDetails;b.renderHierarchy=function(){var e=this;var j=false;if(this.itemsView.containerID){this.$itemGrid.find(".j-loading-container").remove();var f=this.$itemGrid.find('.j-hierarchy-item[data-object-id="'+this.itemsView.containerID+'"]');if(f.length>0){var k=f.find(".j-hierarchy-child-holder");if(!k.data("children-loaded")){var i=this.itemsView.parentIDChain;var g=e.getNestedItems(this.itemsView.items,i);k.append(jive.browse.grid.hierarchyItems({items:g,omitIcons:e.omitIcons}));k.attr("data-children-loaded",true)}j=true}}if(!j){var h=d(jive.browse.grid.itemGrid(this.addArchetype(this.itemsView)));this.updateItemGrid(h)}};b.getNestedItems=function(f,g){var e=this;$j(f).each(function(h,i){return $j(g).each(function(j,k){if(i.id==k){f=e.getNestedItems(i.prop.childInfo.children,g);return false}return true})});return f};b.replaceThumbs=function(e,f){this.updateItemGrid(e);f()};b.mergeThumbs=function(t,y,l){var x=this.getThumbGrid(),h=t.toArray(),z=y.toArray(),s=[],q=h.length,k=z.length,v={},p={},f=false,o,g,r,w,u=0,n=this;for(w=0;w<q;w+=1){o=h[w];r=o.getAttribute("data-object-type")+";"+o.getAttribute("data-object-id");v[r]=w+1}for(u=0;u<k;u+=1){g=z[u];r=g.getAttribute("data-object-type")+";"+g.getAttribute("data-object-id");if(v[r]){p[r]=true}else{s.push(g);if(!f){n.fadeOut(d(g),n.fadeOutOnMergeDuration,m);f=true}else{n.fadeOut(d(g),n.fadeOutOnMergeDuration)}}}if(!f){m()}function m(){var C,j,A,E,B=s.length==k,D=q+k+600;for(C=0;C<q;C+=1){j=h[C];E=j.getAttribute("data-object-type")+";"+j.getAttribute("data-object-id");if(!p[E]){A=s.shift();if(A){d(A).replaceWith(j)}else{x.append(j)}n.transparentize(d(j))}}n.refreshVGrid().then(function(){if(!B){x.vgsort(function(G,F){var i=G.getAttribute("data-object-type")+";"+G.getAttribute("data-object-id"),J=F.getAttribute("data-object-type")+";"+F.getAttribute("data-object-id"),I=v[i]||D,H=v[J]||D;return I-H},n.sortEasing,n.sortDuration)}setTimeout(e,B?0:n.sortDuration)})}function e(){var j;for(j=0;j<s.length;j+=1){d(s[j]).detach()}l();n.fadeIn(x.find(".js-browse-thumbnail"),n.fadeInOnMergeDuration);setTimeout(function(){for(j=0;j<s.length;j+=1){d(s[j]).remove()}},2000)}};b.updateItemGrid=function(e){this.destroyVGrid();this.$itemGrid.html(e);this.initVGrid()};b.getThumbGrid=function(){return this.$itemGrid.find(".j-browse-thumbnails")};b.initVGrid=function(){if(!jive.Filters.isLegacyBrowser()){var e=this.getThumbGrid();if(e.length>0){e.vgrid({easeing:this.sortEasing,duration:this.sortDuration,delay:0})}}};b.refreshVGrid=function(){var e=this.getThumbGrid(),f=new $j.Deferred();if(e.length>0){e.vgrefresh(null,0,0,f.resolve.bind(f))}return f.promise()};b.destroyVGrid=function(){var e=this.getThumbGrid();if(e.length>0){e.vgdestroy()}};var a=d.browser.msie&&parseFloat(d.browser.version)<9;b.transparentize=function(f,e){e=typeof e=="undefined"?1:e;if(!a){f.css("opacity",1-e)}else{f.css("visibility",e==1?"hidden":"visible")}};b.opacify=function(e){if(!a){e.css("opacity",1)}else{e.css("visibility","visible")}};b.fadeOut=function(e,f,g){if(!a){e.animate({opacity:0},f,g)}else{this.transparentize(e);if(g){jive.conc.nextTick(g)}}};b.fadeIn=function(e,f,g){if(!a){e.animate({opacity:1},f,g)}else{this.opacify(e);if(g){jive.conc.nextTick(g)}}};b.displayMoreSearchResultsMessage=function(e){this.$moreResultsAvailable.html(jive.browse.grid.moreSearchResultsAvailable(e))}});define("jive.filters.ItemGridView",function(){return jive.Filters.ItemGridView});