jive.namespace("Filters");jive.Filters.FilterView=jive.oo.compose(jive.AbstractView,jive.Collapsable).extend(function(a){var c=jQuery,b=jive.Filters;a.primary="#j-browse-filters";a.secondary="#j-browse-child-filter-list";a.init=function(d){this.setObjectTypes(d.objectTypes);this.bindFilterHandlers();this.bindSortHandlers();this.initSearchBox();this.preventEnterSubmit();this.enabled=true;this.collapsable({availableWidth:function(){var e=c(this.primary+" .js-browse-filter-toggle-set").parent(),f=c("#j-item-view-toggle");return e.width()-f.width()},element:this.primary+" .js-browse-filter-toggle-set li",shrinkable:".js-shrinkable"});jive.localexchange.addListener("browse.filter.change",function(e){this.enabled=e.filterID.indexOf("recommended")===-1;this.pauseUpdates(!this.enabled);c(a.primary).parent().toggle(this.enabled)}.bind(this))};this.setObjectTypes=function(d){this.objectTypes=d};a.bindFilterHandlers=function(){var h=c("#j-browse-filters"),i=h.find("select.js-browse-filter"),f=$j("#js-browse-controls").find("a.js-browse-filter"),k=h.find("span.js-browse-filter-toggle"),g=h.find("span.js-browse-filter-boolean"),l=h.find("span.js-browse-filter-tags"),d=h.find("span.js-browse-filter-datepicker"),e=h.find("a.js-remove-filter"),j=this;i.each(function(){c(this).data("lastValue",c(this).val())});i.change(function(){var m=c(this).val(),n=c(this).data("lastValue");j.emit("applyFilters",{add:[m],remove:n?[n]:[]});c(this).data("lastValue",m)});f.click(function(p){var m=c(this).data("filter-id"),o=c(this).closest(".js-browse-filter-toggle-set").find("a.js-browse-filter"),n=o.toArray().map(function(q){return c(q).data("filter-id")}).filter(function(q){return q!=m});j.emit("applyFilters",{add:[m],remove:n});p.preventDefault()});k.each(function(){j.initToggleFilter(this)});g.each(function(){j.initBooleanFilter(this)});l.each(function(){j.initTagFilter(this)});d.each(function(){j.initDateRange(this)});e.click(function(n){var m=c(this).parent().find(".j-browse-filter").val();j.emit("applyFilters",{add:[],remove:[m]});n.preventDefault()})};this.bindSortHandlers=function(){var d=this;c("#j-sort").change(function(){var e=c(this).val();var f=c(this).find(":selected").data("sort-order");d.emit("applySort",e,f)})};this.render=function(h,f,d,e,g){c(this.primary).parent().toggle(this.enabled);if(this.enabled){this.updateControls(h,f,e,d,g);this.updateSearchBox(h)}};a.updateControls=function(f,d,h,g,i){var e,l,j=arguments,k=this;if(!this.skipUpdates){clearTimeout(this.pendingControlsUpdateTimeout);delete this.pendingControlsUpdate;this.tearDownFilters();e=c("#js-browse-controls");l=c(jive.browse.filter.filters({filters:[f],appliedFilterIDs:d,sorts:h,appliedSortKey:g,urlParams:c.deparam.querystring(),urlPath:window.location.pathname,itemViewID:i}));l.find(".js-placeholder").each(function(){c(this).replaceWith(e.find(c(this).data("selector")))});e.replaceWith(l);this.recollapse();this.bindFilterHandlers();this.bindSortHandlers()}else{this.pendingControlsUpdate=function(){k.updateControls.apply(k,j)}}};a.pauseUpdates=function(e){var d=this.pendingControlsUpdate;this.skipUpdates=e;if(!e&&d){clearTimeout(this.pendingControlsUpdateTimeout);this.pendingControlsUpdateTimeout=setTimeout(d,333)}};a.updateSearchBox=function(d){var e=c(".j-browse-search");if(d&&d.searchable){e.show()}else{e.hide()}};a.initSearchBox=function(){var e=c("#js-browse-controls input[name=query]"),d=this;e.focus(function(){d.pauseUpdates(true)}).blur(function(){d.pauseUpdates(false)})};a.preventEnterSubmit=function(){c("#js-browse-controls").live("submit",function(d){d.preventDefault()})};a.initToggleFilter=function(f){var e=c(f).data("filter-id"),d=this;c(f).find("input").change(function(){var g=c(this).is(":checked")?c(this).val():[];d.emit("value",e,g)})};a.initBooleanFilter=function(f){var e=c(f).data("filter-id"),d=this;c(f).find("input").change(function(){d.emit("value",e,c(this).val())})};a.initTagFilter=function(f){var e=c(f).data("filter-id"),h=c(f).find("input"),d=this;var g=new b.TagAutocomplete(h,{objectTypes:this.objectTypes}).addListener("change",function(i){d.emit("value",e,i)}).addListener("focus",function(){d.pauseUpdates(true)}).addListener("blur",function(){d.pauseUpdates(false)});this.registerTeardown(function(){g.removeListener("change")})};a.initDateRange=function(i){var g=c(i).data("filter-id"),h=c(i).find("[name=min]"),e=c(i).find("[name=max]"),d=h.data("date")||"",j=e.data("date")||"",f=this;this.initDatePicker(h,function(k){d=k.date.getTime();f.emit("value",g,[d,j])});this.initDatePicker(e,function(k){j=k.date.getTime();f.emit("value",g,[d,j])})};a.initDatePicker=function(h,f){var e=c(h),i=e.attr("id"),g=e.data("date")?new Date(e.data("date")):null,d=this;Zapatec.Calendar.bootstrap({inputField:i,button:i+"_button",date:g,showsTime:false,step:1,onUpdate:f});define(["Zapatec.Calendar"],function(j){if(g){c("#"+i).val(g.print(j._TT.DEF_DATE_FORMAT))}})};a.registerTeardown=function(d){this.teardowns=this.teardowns||[];this.teardowns.push(d)};a.tearDownFilters=function(){(this.teardowns||[]).forEach(function(d){d()});this.teardowns=[]}});