define("jive.component.AutoSearchView",["jquery","jive.component.autosearch.SearchSource","jive.component.autosearch.ActivitySource","jive.component.autosearch.ContentSource","jive.component.autosearch.PeopleSource","jive.component.autosearch.PlaceSource","jive.component.list","jive.component.PopupView","jive.component.ProgressMeterView","jive.conc.FreshActionQueue"],function(d,b,j,m,a,f,g,h,i,e){var l={};l.init=function(){var n=d(document);d("input[data-component='autosearch']").placeHeld();n.on("focus.autosearchview","input[data-component='autosearch']",function(p){var q=d(this);q.parent().addClass("focused");var o=q.view(k);if(!(o.getPopup().getState()=="visible")){o.renderView();o.loadViewContent()}});jive.switchboard.addListener("bookmark.create",function(q){var p=d("#j-spotlight-search");p.addClass("j-bookmark-created");p.append(jive.autosearch.overlay({type:"bookmark"}));var o=p.find(".j-tooltip");o.fadeIn(250);setTimeout(function(){p.removeClass("j-bookmark-created");o.fadeOut(250,function(){d(this).remove()})},1500)})};var k=jive.oo.Class.extend(function(n){n.init=function(u){this.$element=d(u);this.loadingQueue=new e();this.searchSource=new b();this.activitySource=new j();this.contentSource=new m();this.peopleSource=new a();this.placeSource=new f();this.bookmarkSource=new jive.BookmarkSource();this.metrics=new jive.search.SearchMetrics("spotlight-search");this.$element.attr("maxlength",250);if(this.$element.data("container")){var v=this.$element.data("container").split(":");this.containerType=parseInt(v[0]);this.containerId=parseInt(v[1]);this.containerBrowseId=parseInt(this.$element.data("container-browseid"));this.filterType="place";this.filter=["/places/"+this.containerBrowseId];this.displayName=this.$element.data("container-name");this.forceFiltered=true}else{this.containerType=jive.global.containerType;this.containerId=jive.global.containerID;this.containerBrowseId=jive.global.containerBrowseId}if(this.containerType==3){this.peopleSource.get(this.containerId).addCallback(function(w){if(w){o("people",w);this.filterType="author";this.filter=new RegExp("/[^/]*/[^/]*$").exec(w.resources.self.ref);this.displayName=w.displayName}}.bind(this))}else{if(this.containerType!=2020){this.placeSource.get(this.containerBrowseId).addCallback(function(w){if(w&&!(w.type=="space"&&w.parent==null)){this.filterType="place";this.filter=new RegExp("/[^/]*/[^/]*$").exec(w.resources.self.ref);this.displayName=w.name}}.bind(this))}}var t=this;this.input=new jive.TypeaheadInput(u);this.input.addListener("change",t.change.bind(t));this.input.addListener("clear",t.clear.bind(t));this.$element.on("keyup",function(w){t.key(w.which)});this.$element.on("keydown",function(w){if(w.which==d.keyCode.TAB){t.getPopup().hide()}});var s=d("[data-type='clear'][data-field='"+this.$element.get(0).id+"']");s.on("click",function(w){t.$element.focus();t.$element.val("");t.setView(null);t.renderView();t.loadViewContent();d(this).removeClass("j-active")});var r=d("[data-type='search'][data-field='"+this.$element.get(0).id+"']");r.on("click",function(w){t.navigateToSearchPage()});this.$element.on("click",function(x){x.stopPropagation();var y=d(this);y.parent().addClass("focused");var w=y.view(k);if(!(w.getPopup().getState()=="visible")){w.renderView();w.loadViewContent()}});this.$element.on("blur",function(w){d(this).parent().removeClass("focused")})};this.toString=function(){return"[object AutoSearchView]"};n.getCurrentView=function(){var r=this.currentView;if(r==null){r=this.getDefaultView()}return r};n.getDefaultView=function(){var r=this.getAvailableViews();if(r.frequent){return"frequent"}else{if(r.bookmarks){return"bookmarks"}else{return null}}};this.getPopupElement=function(){var t=this.$element.data("popupElement");if(!t){var r=this.$element.data("popup");var s;if(r){s=d("#"+r)}else{s=d(jive.autosearch.spotlightPopup());this.$element.after(s)}t=s.get(0);this.$element.data("popupElement",t)}return t};n.getSearchTerm=function(){return this.$element.val()};this.activateItem=function(u){var r=d(u);if(!r.hasClass("more")&&this.getCurrentView()=="all"||this.getCurrentView()=="filtered"){var s=r.closest("[data-component='listitem']").prevAll("[data-component='listitem']").length;var t=r.closest("div[data-type]").attr("data-type");this.metrics.setChoice(t,s,r.get(0).href)}};this.getPopup=function(){return d(this.getPopupElement()).view(c)};this.hidePopup=function(){this.getPopup().hide()};this.showPopup=function(t){var r=this.getPopup();if(!d(this.getPopupElement()).is(":visible")||t){var s=this.anchor?d(this.anchor):null;if(s==null){s=this.$element.data("popup-anchor");s=s?d("#"+s):this.$element}this.getPopup().show(this.$element.get(0),s)}};this.setAnchor=function(r){this.anchor=r};n.getListElement=function(){var r=d(this.getPopupElement());return r.find("[data-component='list']").get(0)};n.specify=function(r,t,s){return t.pipe(function(u){return{type:r,params:s,data:u}})};n.loadFrequentlyViewed=function(){var r=[];r.push(this.specify("content",this.activitySource.queryFrequent("content",10)));r.push(this.specify("people",this.activitySource.queryFrequent("people",10)));r.push(this.specify("places",this.activitySource.queryFrequent("places",10)));return r};n.loadBookmarks=function(){var r=new d.Deferred();this.contentSource.query({type:"favorite",author:"/people/"+_jive_current_user.ID},10).then(function(s){r.resolve(s)});return[this.specify("content",r)]};n.loadHistory=function(){var r=[];r.push(this.specify("content",this.activitySource.queryRecent("content",10)));r.push(this.specify("people",this.activitySource.queryRecent("people",10)));r.push(this.specify("places",this.activitySource.queryRecent("places",10)));return r};n.executeSearch=function(){var r=[];r.push(this.performSearchQuery("content"));if(this.getCurrentView()!="filtered"){r.push(this.performSearchQuery("people"));r.push(this.performSearchQuery("places"))}return r};n.performSearchQuery=function(u){var s=d.trim(this.getSearchTerm())+"*";var t=null;if(this.getCurrentView()=="filtered"){t={};t[this.filterType]=this.filter}var r=u=="content"?"contents":u;var w=this.searchSource.createParams(s,t,"relevanceDesc",10);var v=new jive.search.SearchMetricsQuery("/api/core/v3/search/"+r+"?"+d.param(w));this.metrics.addQuery(v,r);return this.specify(u,this.searchSource.query(r,s,t,"relevanceDesc",10).then(this.processSearchResult.bind(this,v)),{searchTerm:s,filterType:this.filterType,filter:this.filter})};n.processSearchResult=function(s,r){s.setReturnedDate(new Date().getTime());s.addResults(r.list.map(p))};function p(r){return{id:r.id,type:r.type}}this.deleteBookmark=function(s){var r=new jive.conc.Promise();this.bookmarkSource.destroy(s).addCallback(function(){jive.switchboard.emit("bookmark.destroy",jQuery.extend({},{id:s}));r.emitSuccess()});return r};function o(s,r){if(r.type=="favorite"&&r.favoriteObject.type!="url"){r=r.favoriteObject;r.displayExternalAccess=(!_jive_current_user.partner)&&r.visibleToExternalContributors}if(s=="content"){if(r.published){r.publishedDate=q(r.published).getTime()}if(r.updated){r.updatedDate=q(r.updated).getTime()}if(r.author&&!r.author.displayName){r.author.displayName=r.author.name.formatted||r.author.jive.username}if(r.type=="file"&&r.binaryURL){r.extension=r.binaryURL.split(".").slice(-1).join(".").toLowerCase()}if(!r.subject&&r.highlightSubject){r.subject=r.highlightSubject}if(!r.subject&&r.parentContent){r.subject=r.parentContent.name}r.subject=d("<div>"+r.subject+"</div>").text();r.displayExternalAccess=(!_jive_current_user.partner)&&r.visibleToExternalContributors}else{if(s=="people"){if(r.jive&&r.jive.profile&&r.jive.profile instanceof Array){d(r.jive.profile).each(function(t,u){if(u.jive_label=="Title"){r.title=u.value}else{if(u.jive_label=="Department"){r.department=u.value}}})}if(!r.displayName){r.displayName=r.name.formatted||r.jive.username}r.displayExternalContributor=(!_jive_current_user.partner)&&r.jive&&r.jive.externalContributor}else{r.displayExternalAccess=(!_jive_current_user.partner)&&r.visibleToExternalContributors}}}function q(u){var r=u.replace(/\+\d+/,"Z");var t=new Date(r);if(isNaN(t.getTime())){var s=r.replace(/-/,"/").replace("T"," ").replace(/\.\d+Z/," GMT");t=new Date(s)}return t}n.getAvailableViews=function(){var r={bookmarks:!this.$element.is("[data-hidetypes~='bookmarks']"),frequent:!this.$element.is("[data-hidetypes~='frequent']"),recent:!this.$element.is("[data-hidetypes~='recent']"),all:!this.$element.is("[data-hidetypes~='all']"),filtered:this.filterType?!this.$element.is("[data-hidetypes~='filtered']"):false};return r};this.renderView=function(){var s=this.getCurrentView();if(s){var r=d(this.getPopupElement());r.empty();r.append(jive.autosearch.spotlightView({view:s,availableViews:this.getAvailableViews(),filterDisplayName:this.displayName,communityName:this.$element.attr("data-community-name")}));this.showPopup()}else{this.hidePopup()}};n.startLoad=function(){var r=d(this.getPopupElement());var s=r.find("[data-component='loadingpanel']");var t=r.find("[data-component='progressmeter']");if(s.length){t=s.find("[data-component='progressmeter']")}t.each(function(u,v){d(v).view(i).start()})};n.endLoad=function(){var r=d(this.getPopupElement());var s=r.find("[data-component='progressmeter']");s.each(function(t,u){d(u).view(i).stop()})};this.loadViewContent=function(){var u=this.getCurrentView();var t;this.startLoad();switch(u){case"frequent":t=this.loadFrequentlyViewed();break;case"recent":t=this.loadHistory();break;case"bookmarks":t=this.loadBookmarks();break;case"all":case"filtered":t=this.executeSearch();break}if(t&&t.length){var s=this;var r=d.trim(this.getSearchTerm())+"*";this.loadingQueue.push(d.when.apply(d,t)).then(function(){s.processResult(u,r,Array.prototype.slice.call(arguments))})}};n.processResult=function(r,s,t){if(r==this.getCurrentView()){this.endLoad();var u={view:r,searchTerm:s,filterType:this.filterType,filter:this.filter,results:{}};if(t!=null){t.forEach(function(v){if(v&&v.data&&v.data.list){v.data.list.forEach(function(w){o(v.type,w)});u.results[v.type]=v.data.list}})}d(this.getListElement()).empty().append(jive.autosearch.results(u));this.showPopup(true)}else{}};this.setView=function(r){this.currentView=r};this.key=function(z){switch(z){case d.keyCode.LEFT:case d.keyCode.RIGHT:case d.keyCode.HOME:case d.keyCode.END:case d.keyCode.PAGE_UP:case d.keyCode.PAGE_DOWN:case d.keyCode.TAB:return false}var t=this.getPopup();if(z==d.keyCode.ENTER){var y=this.getListElement();var v=y?d(y).view(g.ListView).getSelectedElement():null;if(v!=null&&t.getState()=="visible"){var x=d(v).find("a:first");var s=x.attr("href");if(s=="#"){x.click()}else{window.location=s}}else{this.navigateToSearchPage()}return false}var w=this.getCurrentView();if(t.getState()=="visible"){var r=d(this.getListElement()).view(g.ListView);switch(z){case d.keyCode.UP:r.incriment(-1);return false;case d.keyCode.DOWN:r.incriment(1);return false;case d.keyCode.ESCAPE:t.hide();return false}var u=d("[data-type='clear'][data-field='"+this.$element.get(0).id+"']");if(this.getSearchTerm().length){u.addClass("j-active")}else{u.removeClass("j-active")}}};n.change=function(){var r=this.getCurrentView();if(r!="all"&&r!="filtered"){if(this.forceFiltered){this.setView("filtered")}else{this.setView("all")}this.renderView()}this.loadViewContent()};n.clear=function(){var r=this.getCurrentView();if(r=="all"||r=="filtered"){this.setView(null);this.renderView()}this.loadViewContent()};this.navigateToSearchPage=function(){var r={};if(this.getSearchTerm().length>0){r.q=this.getSearchTerm()}if(this.getCurrentView()=="filtered"){r[this.filterType]=this.filter}window.location=_jive_base_url+"/search.jspa?"+d.param(r)}});k.toString=function(){return"[wrapper AutoSearchView]"};k.getBindName=function(){return"AutoSearchView"};var c=h.extend(function(n){n.init=function(p){this.$element=d(p);var o=this;this.$element.on("click","[data-component='popup'] [data-component='button'][data-view]",function(r){r.preventDefault();var s=d(this);if(!s.hasClass("j-active")){var q=d(o.getTrigger()).view(k);q.setView(s.data("view"));q.renderView();q.loadViewContent()}});this.$element.on("click","[data-component='button'][data-command='more']",function(q){q.preventDefault();var r=d(this);r.closest("ol").find("li.j-inactive").removeClass("j-inactive");r.closest("li").addClass("j-inactive")});this.$element.on("click","[data-component='button'][data-command='remove']",function(t){t.preventDefault();var u=d(this);var q=d(u.closest("[data-component='popup']").view(c).getTrigger());var s=u.closest("[data-component='listitem']");var r=q.view(k);var v=u.data("id");r.deleteBookmark(v).addCallback(function(){s.fadeOut("fast",function(){s.remove()})})});this.$element.on("click","[data-component='popup'] ol [data-component='listitem'] a",function(s){var r=d(this);var q=d(r.closest("[data-component='popup']").view(c).getTrigger());q.view(k).activateItem(this)});this.$element.on("click",function(s){var r=o.getTrigger();var q=d(window).scrollTop();d(r).focus();d(window).scrollTop(q)})}});c.toString=function(){return"[wrapper AutoSearchPopupView]"};c.getBindName=h.getBindName.bind(c);l.init();return k});