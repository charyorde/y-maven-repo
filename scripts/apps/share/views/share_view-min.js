jive.namespace("ShareApp");jive.ShareApp.ShareView=jive.oo.Class.extend(function(a){jive.conc.observable(this);this.init=function(){this.recipients=[];this.options={}};a.submitShare=function(g,c,e,f){var b=this;var d={message:$j("#jive-send-content-not-message").val(),recipients:b.buildRecipientArray(),subject:$j("#jive-send-content-not-subject").val()};d.message=d.message.replace(/</g,"&lt;").replace(/>/g,"&gt;");b.emitP("share",c,g,d).addCallback(function(){$j(jive.soy.share.shareConfirmation({objectName:f})).message({style:"success"});e.trigger("close");if(b.recipients.some(function(h){return h.id!==window._jive_current_user.ID})){jive.dispatcher.dispatch("trial.share.created");jive.dispatcher.dispatch("trial.updatePercentComplete")}b.recipients=[]}).addErrback(function(i){var h=i?$j("<p>"+i+"</p>"):$j(jive.error.rest.soy.errorUpdating({href:window.location}));h.message({showClose:true,style:"error"});e.find("input, button").prop("disabled",false)})};a.buildRecipientArray=function(){var b=this;var c=[];this.checkExternalUsers(this.userPicker.getSelectedUsersAndLists(true));return this.recipients.map(function(d){return{identifier:d.email,notified:d.notified}})};a.checkExternalUsers=function(d){var b=this;$j("#jive-include-attach-div").hide();d.users.forEach(function(e){if(e.id==-1||!e.entitled){$j("#jive-include-attach-div").show()}});this.recipients=this.recipients.filter(function(e){return d.users.some(function(f){return f.email===e.email})});var c=this.addedRecipients(d.users);this.recipients=this.recipients.concat(c)};a.addedRecipients=function(c){var b=this;return c.filter(function(d){return !b.recipients.some(function(e){return d.email===e.email})}).map(function(d){return $j.extend({},d,{notified:false})})};a.recipient=function(b){return this.recipients.filter(function(c){return c.email===b})};a.notifyUser=function(b,c){this.recipient(b).forEach(function(d){d.notified=c});$j(".js-notify-user").toggle();$j(".js-unnotify-user").toggle()};this.openShareModal=function(d,c){var b=this;b.emitP("prepareShare",c,d).addCallback(function(h){if(!b.open){b.open=true;if(h.invitationsEnabled){b.options.invitationsEnabled=true}b.recipients=[];if(h.secretGroup){$j(jive.soy.share.secretGroupMessage()).message({showClose:true,style:"error"})}else{var f=$j(jive.soy.share.share(h));f.lightbox_me({destroyOnClose:true,centered:true,onLoad:function(){f.find("input:visible:first").focus();jive.dispatcher.dispatch("trial.share.modal.loaded")},onClose:function(){b.cleanupModal()}});f.find("form").submit(function(){$j(this).find("input,button").prop("disabled",true);b.submitShare(d,c,f,h.objectNameCapital);return false});var e=new jive.UserPicker.Main({multiple:true,listAllowed:true,emailAllowed:h.externallyShareable,message:"",object:{objectID:d,objectType:c},entitlement:"VIEW",$input:$j("#share-users"),canInvitePartners:h.attachmentAvailable,canInviteJustPartners:false,canInvitePreprovisioned:true,relatedMessage:$j(jive.soy.share.usersNotRelated()),userMessages:[b.getUserPermissionsMessage(h)],listMessages:[b.getListPermissionsMessage(h)],placeholder:" "});e.addListener("selectedUsersChanged",function(i){b.checkExternalUsers(i)});b.userPicker=e;var g=$j("body");g.delegate(".js-notify-user","click",function(i){b.notifyUser($j(this).data("user-identifier"),true);i.preventDefault()});g.delegate(".js-unnotify-user","click",function(i){b.notifyUser($j(this).data("user-identifier"),false);i.preventDefault()})}}}).addErrback(function(f){var e=f?$j("<p>"+f+"</p>"):$j(jive.error.rest.soy.errorFinding({href:window.location}));e.message({showClose:true,style:"error"})})};a.cleanupModal=function(){var b=this;$j(".js-userpicker-user-msg").trigger("close");var c=$j("body");c.undelegate(".js-notify-user","click");c.undelegate(".js-unnotify-user","click");b.open=false};a.getUserPermissionsMessage=function(c){var b=this;return{type:"warn",render:function(d){d.notified=b.recipient(d.email).some(function(f){return f.notified});var e=$j.extend({user:d},c);return jive.soy.share.userWithoutPermission(e)}}};a.getListPermissionsMessage=function(c){var b=this;return{type:"warn",render:function(){return jive.soy.share.listWithoutPermission(c)}}}});