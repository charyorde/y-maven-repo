define("jive.Announcements.Edit.Main",["jive.CoreV3.Deferred"],function(a){return function b(p){function c(t,v,A,u,z,r,w,y,s){var x=new osapi.jive.corev3.contents.Announcement();x.type="announcement";x.author=t;x.content={text:v,type:"text/html"};if(A){x.parent=A}x.status=u;x.subject=z;x.publishDate=r;x.endDate=w;x.subjectURI=y;if(s){x.image=s}return x}var d=new a();var n=$j(".js-announcement.js-edit");var q=n.find(".js-announcementForm");var j=new jive.Announcements.Edit.View($j.extend({$scope:n},p));j.addListener("resolve",k);j.addListener("hteInitFinished",function(){n.on("change","*",f);setInterval(function r(){var s=j.getBody();if(r.lastText&&r.lastText!=s){f()}r.lastText=s},2000);j.addListener("dataChange",function(){f()});f()});j.addListener("imageUploadSuccess",function(r){j.setImage(r.images[0].url);j.updateImageToken(r.tokenName,r.tokenValue)});j.addListener("cancelClicked",function(){d.getObject(p.containerType,p.containerId).pipe(function(r){window.location=r.resources.html.ref})});j.addListener("disabledField",function(r){j.validationEffectPass(r)});h();if(p.announcementId>=0){d.getObject(p.announcementType,p.announcementId).done(function(r){j.initView($j.extend({announcement:r},p))})}else{var e=new osapi.jive.corev3.contents.Announcement();e.subject="";j.initView($j.extend({announcement:e},p))}var g=new jive.rte.LinkService();var i=new jive.Announcements.ImageResolverService({containerType:p.announcementType});$j.tools.validator.localize(_jive_locale,{"*":jive.i18n.getMsg("content.validation.any"),":email":jive.i18n.getMsg("content.validation.email"),":number":jive.i18n.getMsg("content.validation.number"),":url":jive.i18n.getMsg("content.validation.url"),"[max]":jive.i18n.getMsg("content.validation.max"),"[min]":jive.i18n.getMsg("content.validation.min"),"[required]":jive.i18n.getMsg("content.validation.required")});$j.tools.validator.addEffect("announcementEdit",j.validationEffectError,j.validationEffectPass);q.validator({lang:_jive_locale,messageClass:"jive-error-message",inputEvent:"change",effect:"announcementEdit",formEvent:null});var m=new jive.rte.FormService({$form:q,formSubmitHandler:function(r){r.preventDefault();o().pipe(function(s){if(typeof s.update==="function"){return d.runQuery(s.update())}else{s.minor=!j.getNotification();return d.runQuery(osapi.jive.corev3.announcements.create(s,{minor:s.minor}))}}).done(function(s){l();window.location=s.resources.html.ref})}});function o(){return d.getObject(p.containerType,p.containerId).pipe(function(v){var s=v.resources.self.ref;var u=j.getImage();var t=j.getSubjectURI();if(p.announcementId==-1){var r=c("@me",j.getBody(),s,"published",j.getSubject(),j.getStartDate(),j.getEndDate(),t,u);r.sortKey=Math.round(new Date().getTime()/10000);return r}else{return d.getObject(p.announcementType,p.announcementId).pipe(function(w){w.content.type="text/html";w.content.text=j.getBody();w.endDate=j.getEndDate();w.parent=s;w.publishDate=j.getStartDate();w.status="published";w.subject=j.getSubject();w.subjectURI=t;w.image=u;return w})}})}function f(){o().done(function(r){j.updatePreview(r)})}function h(){$j(window).on("beforeunload.editAnnouncement",function(){if(j.isFormDirty()){return""}})}function l(){$j(window).off("beforeunload.editAnnouncement")}function k(t){var v=new jive.loader.LoaderView({size:"big"});v.prependTo(n);var r=m.setFormEnabled(false);var s=g.resolve(t).deferred().then(function(w){var x=w.title;x=$j("<div></div>").html(x).text();if(x.length>120){x=x.substring(0,120)+"\u2026"}j.setSubject(x)},function(w){console.log("resolveLink failed",w);j.setSubject(t)});var u=i.get("",{contentUrl:t}).deferred().done(function(w){if(w.length){j.setImage(w[0])}}).fail(function(w){console.log("image resolution failed",w)});$j.when(s,u).always(function(){m.setFormEnabled(r);v.destroy();v.getContent().remove()});j.setSubjectURI(t)}}});