jive.namespace("Announcements.Edit");jive.Announcements.Edit.View=function editView(b){var a=b.$scope;jive.conc.observable(this);var d=this;var e=null;function f(h){d[h]=function g(){if(!e){console.log("not initialized when attempting to call "+h);throw new Error("The view is not yet initialized")}return e[h].apply(e,arguments)}}f("getImage");f("setImage");f("getSubject");f("setSubject");f("getSubjectURI");f("setSubjectURI");f("getStartDate");f("getEndDate");f("getBody");f("getNotification");f("updateImageToken");f("updatePreview");f("isFormDirty");this.initView=function c(j){a.find(".js-editControls").html(jive.announcements.announcementEditControls({announcement:j.announcement}));var o=a.find(".js-announcementForm");var D=a.find(".js-includeLink");var y=a.find(".js-subjectURI");var C=a.find(".js-subject");var i=a.find(".js-includeImage");var r=a.find(".imagePreview");var G=a.find(".js-notification");var q=a.find(".js-file-input");var z=/^https?:\/\/(?:[^:]+:[^@])?[\w\.]+(?::\d+)?\S*$/;if(j.isModerated){$j("#jive-moderation-box").show()}else{$j("#jive-moderation-box").hide()}a.find("button[name='cancel']").click(function(){d.emit("cancelClicked")});function v(I){if(I.originalEvent.clipboardData||I.originalEvent.dataTransfer){var J=(I.originalEvent.clipboardData||I.originalEvent.dataTransfer).getData("Text");if(z.test(J)){d.emit("resolve",J);return false}}else{jive.conc.nextTick(n)}}function n(){var I=y.val();if(z.test(I)){d.emit("resolve",I)}else{var J="http://"+I;if(z.test(J)){y.val(J);d.emit("resolve",J)}}}C.on("paste",v);y.on("paste",v).on("change",n);D.on("change",function(){if(D.is(":checked")){y.prop("disabled",false);$j(".js-uri-wrapper").show();C.addClass("js-linkInput")}else{y.prop("disabled",true);$j(".js-uri-wrapper").hide();C.removeClass("js-linkInput");d.emit("disabledField",y)}});i.on("change",function(){if(i.is(":checked")){r.removeClass("disabled")}else{r.addClass("disabled")}});var A=a.find(".js-body");var k=new jive.hte.HTE(A,{});var t=new $j.Deferred();k.addListener("initFinished",function(){d.emit("hteInitFinished");t.resolve()});var h=a.find(".js-publishDate");var m=a.find(".js-endDate");var H=604800000;function u(N){function M(P){var O=String(P);while(O.length<2){O="0"+O}return O}function L(O){if(O>=0){return Math.floor(O)}return Math.ceil(O)}var K=-N.getTimezoneOffset();var I=L(K/60);var J=I>=0?"+":"-";I=Math.abs(I);K=Math.abs(K%60);return J+M(I)+M(K)}var B=new $j.Deferred();define(["Zapatec.Calendar"],function(){function J(O,M,L){if(M==null||isNaN(M)||M<0){M=new Date().getTime()}var N={inputField:O,button:O+"_button",date:new Date(M),step:1,onUpdate:function(P){L.val(P.date.getTime())},firstDay:0,weekNumbers:false};Zapatec.Calendar.setup(N);$j("#"+O).val(new Date(M).print(Zapatec.Calendar._TT.DEF_DATE_FORMAT))}var K=parseInt(h.val());var I=parseInt(m.val());if(isNaN(K)||K<0){K=new Date().getTime();h.val(K)}if(isNaN(I)||I<0||I<K){I=K+H;m.val(I)}J("publishDate",K,h);J("endDate",I,m);B.resolve()});var p=a.find(".imageUploadForm").ajaxForm({dataType:"json",success:function(I){d.emit("imageUploadSuccess",I)},beforeSerialize:function(I){I.find("input[name='objectId']").val(j.announcementId)}}).find("input[type='file']").change(function(){$j(this).parent("form").submit()});var E=(function(){if($j.browser.msie){return function I(){var K=q.children(":visible");p.css({opacity:"0",position:"absolute","z-index":1,outline:"none"}).width(50).height(50);q.children().unbind("mousemove.fileCatch");K.bind("mousemove.fileCatch",function(L){var M={left:L.pageX-25,top:L.pageY-25};p.offset(M)})}}else{return function J(){var K=q.children(":visible");p.css({opacity:"0",position:"absolute","z-index":1}).offset(K.offset()).width(K.outerWidth()).height(K.outerHeight())}}})();d.addListener("_resetFileInputPosition",E);E();r.load(function(){E();d.emit("dataChange")});D.change();i.change();$j.when(t,B).done(function(){F()});function l(){var I=o.serialize();I+="&imageUrl="+encodeURIComponent(r.attr("src"));I+="&editorBody="+encodeURIComponent(k.getValue());return I}function F(){if(F.origVal){console.log("orig: "+F.origVal);console.log("new:  "+l());return l()!=F.origVal}else{F.origVal=l()}return false}e={};e.getImage=function(){var I=r.attr("src");if(I=="/images/blank.gif"||!i.is(":checked")){I=null}return I};e.setImage=function(I){r.attr("src",I);i.prop("checked",true);r.parent().show();a.find(".js-no-image-link").hide();E()};e.getSubject=function(){return C.val()};e.setSubject=function(I){C.val(I);d.emit("dataChange")};e.getSubjectURI=function(){var I=y.val();if(!D.is(":checked")){I=""}return I};e.setSubjectURI=function(I){y.val(I);D.prop("checked",true).change();d.emit("dataChange")};e.getStartDate=function s(){var I=new Date(parseInt(h.val()));return I.print("%Y-%m-%d")+"T00:00:00.000"+u(I)};e.getEndDate=function g(){var I=new Date(parseInt(m.val()));return I.print("%Y-%m-%d")+"T23:59:59.000"+u(I)};e.getBody=function(){return k.getValue()};e.getNotification=function(){return G.prop("checked")};e.updateImageToken=function(I,K){var J=a.find(".imageUploadForm");J.find("input[name='jive.token.name']").val(I);J.find("input[name='"+I+"']").val(K)};e.updatePreview=function(J){var I=jive.announcements.announcementCard({announcement:J});a.find(".js-preview-box").html(I)};e.isFormDirty=F;var w=$j(".js-preview-wrapper");var x=w.offset().top;$j(window).scroll(function(){if(x-$j(this).scrollTop()<=0){w.addClass("fixed")}else{w.removeClass("fixed")}})};this.validationEffectError=function(h,g){$j.each(h,function(i){var j=$j(this.input).prev();if(!j.is(".js-error-container")){j=$j("<div class='js-error-container'></div>")}else{j.children().remove()}$j.each(this.messages,function(){j.append(jive.error.form.fieldError({msg:this}))});$j(this.input).before(j);if(i===0){$j.scrollTo(j,800)}});if(h.length>0){d.emit("_resetFileInputPosition")}};this.validationEffectPass=function(g){var h=0;g.each(function(){var i=$j(this).prev().filter(".js-error-container");h+=i.length;i.remove()});if(h>0){d.emit("_resetFileInputPosition")}}};