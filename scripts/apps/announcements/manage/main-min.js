define("jive.Announcements.Manage.Main",["jive.CoreV3.Deferred"],function(a){return function(q){var f=new a();var n=[];var o=[];var m={};function l(s,r){return r.sortKey-s.sortKey}function h(s,r){return s.publishDate.localeCompare(r.publishDate)}function k(u){var r=new Date().getTime();for(var t=0;t<u.length;++t){var s=jive.model.DateUtil.parseISODateTime(u[t].endDate);if(r<s){u[t].endDateTime=s;n.push(u[t])}else{o.push(u[t])}m[u[t].resources.self.ref]=u[t]}n.sort(l);g(n);o.sort(h);d(o)}function d(t){var s=new Date().getTime();var r=jive.announcements.expiredAnnouncementList({announcements:t,containerId:q.containerId,containerType:q.containerType,now:s});var u=$j(".js-expiredAnnouncements .js-announcement-list").html(r);u.find(".js-announcement-subjectURI").click(function(){return false});u.find(".js-expireLink").on("click",j);u.find(".js-deleteLink").on("click",i)}function g(t){var r=new Date().getTime();var u=jive.announcements.activeAnnouncementList({announcements:t,containerId:q.containerId,containerType:q.containerType,now:r});var s=$j(".js-activeAnnouncements .js-announcement-list").html(u);s.find(".js-announcement-subjectURI").click(function(){return false});b(s);s.find(".js-expireLink").on("click",j);s.find(".js-deleteLink").on("click",i)}var p=new jive.loader.LoaderView({size:"big"});p.prependTo($j(".js-activeAnnouncements"));f.getObject(q.containerType,q.containerId).pipe(function(r){return f.runQuery(r.getAnnouncements({count:100}))}).pipe(f.slurp).pipe(k,function(){console.log("getAnnouncements failed: ",arguments)}).always(function(){p.destroy();p.getContent().remove()});function e(){var s=[];var r=new Date();$j(".js-announcement-list .js-announcement").each(function(t){var u=$j(this).data("ref");var v=m[u];if(v.endDateTime&&v.endDateTime>r){v.sortKey=-t;s.push(v)}});f.updateAll(s).done(function(){n=Array.prototype.slice.call(arguments,0);n.sort(l);$j.each(n,function(){this.endDateTime=jive.model.DateUtil.parseISODateTime(this.endDate);m[this.resources.self.ref]=this})}).fail(function(){console.log("update failed: ",arguments)})}function c(r){if(r==null){r=2000}if(c.timeoutId!=null){clearTimeout(c.timeoutId)}c.timeoutId=setTimeout(e,r)}function b(r){var s=r.find(".js-announcements");s.sortable({update:function(t,u){c()},forcePlaceholderSize:true,placeholder:"j-card-placeholder",tolerance:"pointer",items:".js-announcement-item"}).disableSelection()}$j(".js-tab-bar a").click(function(){var r=$j(this).closest(".js-tab-bar").find(".js-tab");r.removeClass("active");r.each(function(){$j("#"+$j(this).data("for")).hide()});var s=$j(this);s.addClass("active");$j("#"+s.data("for")).show();return false});$j("a.active.js-tab").click();function j(r){var v=$j(r.target).closest(".js-announcement-item").find(".js-announcement");var u=m[v.data("ref")];var t=jive.model.DateUtil.formatToISODateTime(new Date(new Date().getTime()-2000));var s=jive.model.DateUtil.formatToISODateTime(new Date(new Date().getTime()-1000));u.publishDate=t;u.endDate=s;f.runQuery(u.update()).done(function(w){n=$j.map(n,function(x){if(x.resources.self.ref==w.resources.self.ref){return null}return x});v.closest(".js-announcement-item").remove();o.push(w);o.sort(h);d(o)});return false}function i(r){var u=$j(r.target).closest(".js-announcement-item").find(".js-announcement");var s=u.data("ref");var t=m[s];f.runQuery(t.destroy()).done(function(){delete m[s];n=$j.map(n,function(v){if(v.resources.self.ref==s){return null}return v});o=$j.map(o,function(v){if(v.resources.self.ref==s){return null}return v});u.closest(".js-announcement-item").remove()});return false}}});