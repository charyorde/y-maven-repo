jive.namespace("invite");define("jive.invite.Main",["jquery"],function(A){return jive.oo.Class.extend(function(B){var C=jive.invite;this.init=function(E,N,T,K,O,H,J,Q,M,P,S,R,L,F,G){var I=this;this.container=E;this.canInvitePartners=H;this.canInviteJustPartners=J;this.canInvitePreprovisioned=Q;this.invitePreprovisionedDomainRestricted=M;this.view=new C.InviteView(E,N,T,K,O,H,J,Q,M,P,S,R,L,F);this.view.addListener("submit",function(W,Y,U,V,X){I.processInvites(W,Y,U,V,X)});this.hasErrors=false;this.trackingID=G};B.processInvites=function(O,G,M,H,L){var I=this;I.source=new jive.invite.InviteSource({trackingID:this.trackingID||null,gids:H,spids:L});var K=this.view;this.resetErrors();K.startProgress();var N=[];var J=G.length+M.length;var F=0;var E=0;G.forEach(function(R,T){if(-1==$j.inArray(R.userName,N)){N.push(R.userName);var P=false;var U=false;var S=R.identifier;var Q=D(I.container,O,_jive_effective_user_id,R);I.source.save(Q).addErrback(function(X,W,V){if(W==4004){U=true}else{P=true;if(V!=400){I.source.showGenericSaveError()}I.addError(S,X,W)}}).always(function(){if(U){E++}else{F++}J--;I.completeTask(S,P);if(J==0){I.complete(F,E)}}).addCallback(function(){jive.switchboard.emit("invitation.create",Q)})}else{J--}});M.forEach(function(S,R){var P=S.users.length;var T=false;var Q=S.identifier;S.users.forEach(function(V,W){if(-1==$j.inArray(V.userName,N)){N.push(V.userName);var X=false;var U=D(I.container,O,_jive_effective_user_id,V);I.source.save(U).addErrback(function(a,Z,Y){if(Z==4004){X=true}else{T=true;if(Y!=400){I.source.showGenericSaveError()}I.addError(Q,a,Z,true)}}).always(function(){if(X){E++}else{F++}P--;if(P==0){J--;I.completeTask(Q,T,true)}if(J==0){I.complete(F,E)}}).addCallback(function(){jive.switchboard.emit("invitation.create",U)})}else{P--;if(P==0){J--}}})})};function D(G,H,F,I){var E={};E.body=H;E.inviter={};E.inviter.id=F;E.user={};if(I.id>0){E.user.username=I.userName}else{E.email=I.userName}E.object={};E.object.objectType=G.type;E.object.id=G.id;return E}B.complete=function(E,F){this.view.setProgress(100);if(this.hasErrors){$j(jive.invite.error()).message({style:"error"})}else{$j(jive.invite.success({containerName:this.container.name,memberCount:E,existingCount:F})).message({style:"success"});this.view.close()}};B.resetErrors=function(){this.hasErrors=false;this.view.clearErrors()};B.addError=function(H,F,E,G){this.hasErrors=true;this.view.addErrorMessage(F,H,G)};B.completeTask=function(G,E,F){this.view.reportComplete(G,E,F)}})})