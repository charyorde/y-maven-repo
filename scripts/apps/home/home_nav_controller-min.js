jive.namespace("HomeNav");define("jive.HomeNav.Controller",["jquery","jive.ActivityStream.BuilderController"],function(b,a){return jive.oo.Class.extend(function(c){this.init=function(e){var d=this;d.buildingStream={};d.selectedLinkID=e.selectedLinkID;d.sysDefaultHomeNavView=e.sysDefaultHomeNavView;d.onbIntroModalType=e.onbIntroModalType;d.instanceName=e.instanceName;d.mode="";if(d.selectedLinkID=="jive-nav-link-activity"||b("#"+d.selectedLinkID).hasClass("j-js-as-nav-item")){d.mode="activity"}else{if(d.selectedLinkID=="jive-nav-link-communications"){d.mode="communications"}else{if(d.selectedLinkID=="jive-nav-link-actions"){d.mode="actions"}else{if(d.selectedLinkID=="jive-nav-link-dashboard"){d.mode="dashboard"}else{if(d.selectedLinkID=="jive-nav-link-moderation"){d.mode="moderation"}else{if(d.selectedLinkID=="jive-nav-link-get-started"){d.mode="onboarding"}}}}}}d.streamService=new jive.ActivityStream.StreamSource();d.actionsService=new jive.ActionQueue.ListSource();d.builderService=new jive.ActivityStream.BuilderServices();d.onboardingService=new jive.Onboarding.Source();d.locationState=jive.locationState;d.supportPushState=!!(window.history&&window.history.pushState);e.supportPushState=d.supportPushState;d.locationState.addListener("change",d.loadView.bind(d)).addListener("noChange",d.loadView.bind(d));d.linksView=new jive.HomeNav.LinksView(e);d.linksView.postRender();d.linksView.addListener("loadView",function(f,g,i){var h={};if(f=="all"||f=="custom"||f=="watches"||f=="connections"){if(f!="all"){h={streamSource:f,streamID:g}}d.locationState.setState(h,"","activity")}else{if(f=="communications"){d.locationState.setState(h,"","inbox")}else{if(f=="actions"){d.locationState.setState(h,"","actions")}else{if(f=="moderation"){d.locationState.setState(h,"","moderation")}else{if(f=="dashboard"){d.locationState.setState(h,"","welcome")}else{if(f=="onboarding"){d.locationState.setState(h,"","get-started")}}}}}}i.emitSuccess()}).addListener("loadBuilderView",function(f,g){d.loadBuilderView(f).addCallback(function(h){if(f=="new"){var i={streamSource:"custom",streamID:h.configuration.id,newStream:true};d.locationState.setState(i,"","activity")}g.emitSuccess()})}).addListener("closeBuilder",function(f){b("body").removeClass("j-stream-building");d.spinner=new jive.loader.LoaderView();d.spinner.appendTo(d.getDynamicPaneArea());jive.ActivityStream.GlobalBuilderController.closeBuilder();d.loadActivityStream(d.buildingStream.configuration.source,d.buildingStream.configuration.id);d.buildingStream={};f.emitSuccess()}).addListener("pin",function(f,g){d.builderService.pinHomeNav(f,g)}).addListener("deleteStream",function(f,g){d.builderService.deleteStream(f,g)}).addListener("saveStreamName",function(f,g){d.builderService.modifyConfig(f).addCallback(function(h){g.emitSuccess(h)})});this.accessibility=new jive.Accessibility({scope:d.linksView.getContent(),otherActions:[jive.Accessibility.focusRingAction(d.linksView.getContent())]});b(document).ready(function(){jive.conc.nextTick(function(){var f=d.locationState.getEphemeralState(),g="";if(Object.keys(f).length&&f.nPLoc){g=f.nPLoc;delete f.nPLoc;d.locationState.setState(f,"",g);d.linksView.forceUpdateSelectedNavItem(f,g)}})});if(e.showOnbIntroModal){d.showOnboardingIntroModal(false)}};this.loadView=function(j,h,f){var e=this,k,i=new jive.conc.Promise();if(e.loadViewPromise){e.loadViewPromise.cancel()}e.loadViewPromise=i;if(j.nPLoc){k=j.nPLoc}else{k=f.split("/").slice(-1)[0];var d=k.indexOf("?");if(d==-1){d=k.indexOf("#")}if(d!=-1){k=k.substring(0,d)}}if(e.spinner){e.spinner.getContent().remove();e.spinner.destroy()}if(k=="activity"&&!j.newStream){var g="all";if(j.streamSource){g=j.streamSource}if(e.mode=="builder"){b("body").removeClass("j-stream-building");e.linksView.setEditMode(false);e.buildingStream={};jive.ActivityStream.GlobalBuilderController.closeBuilder()}e.loadActivityStream(g,j.streamID||0,e.loadViewPromise)}else{if(e.mode=="builder"&&!j.newStream){b("body").removeClass("j-stream-building");e.linksView.setEditMode(false);e.buildingStream={};jive.ActivityStream.GlobalBuilderController.closeBuilder()}if(k=="inbox"){e.loadCommunications(e.loadViewPromise)}else{if(k.indexOf("actions")!=-1||k=="tasks"||k=="archived"){e.loadActions(k,e.loadViewPromise);k="actions"}else{if(k=="moderation"){e.loadModeration()}else{if(k=="welcome"){e.loadDashboard(e.loadViewPromise)}else{if(k=="get-started"){if(e.linksView.getViewItem("onboarding").length){e.loadOnboarding(e.loadViewPromise)}else{jive.locationState.setState({},"","activity");b("html, body").animate({scrollTop:0},"fast")}}}}}}}e.linksView.forceUpdateSelectedNavItem(j,k)};this.activityStreamControllerInitialized=function(){var d=this;jive.switchboard.emit("activity.stream.controller.initialized");jive.ActivityStream.GlobalActivityStreamController.addListener("clearUpdates",function(e,f){d.linksView.clearUpdates(e,f)}).addListener("loadBuilderView",function(e){d.loadBuilderView(e)})};this.loadBuilderView=function(e){var d=this;d.spinner=new jive.loader.LoaderView();d.spinner.appendTo(d.getDynamicPaneArea());if(!jive.ActivityStream.GlobalBuilderController){jive.ActivityStream.GlobalBuilderController=new a();jive.ActivityStream.GlobalBuilderController.addListener("removeStream",function(g){d.linksView.removeDeletedStream(g)})}var f=new jive.conc.Promise();f.addCallback(function(g){d.mode="builder";b("body").addClass("j-stream-building");d.buildingStream=g;d.linksView.postBuilderLoad(g);if(d.spinner){d.spinner.getContent().remove();d.spinner.destroy()}});jive.ActivityStream.GlobalBuilderController.loadStream(e,f);return f};this.loadActivityStream=function(e,f,g){var d=this;d.spinner=new jive.loader.LoaderView();d.spinner.prependTo(d.getDynamicPaneArea());if(d.mode!="activity"){d.streamService.initializeView(e,f,g).addCallback(function(i){var h=b(jive.home.dynamicPaneContents(i));d.getDynamicPaneArea().html(h);d.linksView.clearUpdates(e,f);if(d.spinner){d.spinner.getContent().remove();d.spinner.destroy()}d.updatePageTitle(i.streamDisplayName);jive.dispatcher.dispatch("activity.stream.view.initialized");if(jive.partner&&jive.partner.actionPage){jive.partner.actionPage.loadGroups()}d.mode="activity"})}else{g.addCallback(function(h){d.updatePageTitle(h.streamDisplayName);if(d.spinner){d.spinner.getContent().remove();d.spinner.destroy()}d.mode="activity"});jive.ActivityStream.GlobalActivityStreamController.loadStream(e,f,e!="all",g)}};this.loadCommunications=function(e){var d=this;d.spinner=new jive.loader.LoaderView();d.spinner.prependTo(d.getDynamicPaneArea());d.streamService.initializeView("communications",0,e).addCallback(function(g){var f=b(jive.inbox.dynamicPaneContents(g));d.getDynamicPaneArea().html(f);d.spinner.getContent().remove();d.spinner.destroy();if(g.pollCounts){jive.switchboard.emit("activityStream.poll",g.pollCounts)}d.mode="communications"});d.updatePageTitle(jive.i18n.getMsg("nav.bar.inbox.link"))};this.loadActions=function(g,f){var d=this;var e="jive-aq-pending";if(g.indexOf("tasks")!=-1){e="jive-tasks"}else{if(g.indexOf("archived")!=-1){e="jive-aq-archived"}}if(d.mode!="actions"){d.spinner=new jive.loader.LoaderView();d.spinner.prependTo(d.getDynamicPaneArea());d.actionsService.initializeView(e,f).addCallback(function(i){var h=b(jive.eae.actionqueue.actionsDynamicPane(i));d.getDynamicPaneArea().html(h);d.updatePageTitle(jive.i18n.getMsg("nav.bar.actions.link"));d.spinner.getContent().remove();d.spinner.destroy();d.mode="actions"})}else{f.addCallback(function(){d.updatePageTitle(jive.i18n.getMsg("nav.bar.actions.link"));d.mode="actions"});jive.ActionQueue.Controller.loadView(e,f)}};this.loadModeration=function(){var e=this;e.spinner=new jive.loader.LoaderView();e.spinner.prependTo(e.getDynamicPaneArea());var d=b(jive.moderation.moderationDynamicPane());e.getDynamicPaneArea().html(d);e.spinner.getContent().remove();e.spinner.destroy();e.mode="moderation";e.updatePageTitle(jive.i18n.getMsg("inbox.moderation.tab"))};this.loadDashboard=function(f){var d=this;d.spinner=new jive.loader.LoaderView();d.spinner.prependTo(d.getDynamicPaneArea());var e=d.getDynamicPaneArea().safelyLoad(jive.app.url({path:"/welcome-dynamic.jspa"}),{},function(h,i,g){if(i!="abort"&&(g.status==401||g.status==403||g.status==4026||g.status===0)){location.reload()}d.mode="dashboard"});f.addCancelback(function(){e.abort()});d.updatePageTitle(jive.i18n.getMsg("userbar.welcome.gtitle"))};this.loadOnboarding=function(e){var d=this;d.spinner=new jive.loader.LoaderView();d.spinner.prependTo(d.getDynamicPaneArea());d.onboardingService.initializeView(e).addCallback(function(g){var f=b(jive.onboarding.dynamicPaneContents({viewData:g}));d.getDynamicPaneArea().html(f);d.spinner.getContent().remove();d.spinner.destroy();d.mode="onboarding"});d.updatePageTitle(jive.i18n.getMsg("onboarding.page.title"))};this.updatePageTitle=function(d){document.title=document.title.replace(/(\(.*\)\s*|^)(.*?)(\s\||$)/,"$1"+d+"$3")};this.decrementNewCount=function(d,e){this.linksView.decrementNavCount(d,e)};this.hideView=function(d){this.linksView.hideView(d)};this.showOnboardingIntroModal=function(e){var d=this,f=b(jive.onboarding.introModal({type:d.onbIntroModalType,userDisplayName:window._jive_current_user.displayName,instanceName:d.instanceName,redisplay:e}));f.lightbox_me({destroyOnClose:true,centered:true,onLoad:function(){f.on("click","#j-onb-accept",function(g){g.preventDefault();if(d.mode!="onboarding"){d.locationState.setState({},"","get-started")}f.trigger("close");b("html, body").animate({scrollTop:0},"fast")}).on("click","#j-onb-default",function(g){g.preventDefault();if(d.onbIntroModalType=="new_user"){d.onboardingService.newUserExploreOnOwn();b("#"+d.sysDefaultHomeNavView+" a").click()}f.trigger("close");b("html, body").animate({scrollTop:0},"fast");var h=b(jive.onboarding.postExploreOnMyOwnTip({instanceName:d.instanceName}));h.popover({context:b("#jive-nav-link-get-started"),position:"right"})})}})};this.getDynamicPaneArea=function(){return b("#j-dynamic-pane")}})});