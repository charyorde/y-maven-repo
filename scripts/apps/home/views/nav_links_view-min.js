jive.namespace("HomeNav");jive.HomeNav.LinksView=jive.AbstractView.extend(function(a){this.init=function(c){var b=this;this.editMode=false;this.pollingEnabled=c.pollingEnabled;this.canPin=c.canPin;this.supportPushState=c.supportPushState;this.maxCustomStreams=c.maxCustomStreams;this.lastEditNameSuccess=true};this.getContent=function(){return $j("#j-home-side-nav")};this.setEditMode=function(d){var b=this,c=b.getContent();if(d==false){b.endStreamNameEditing();c.find("li.editing").removeClass("editing")}this.editMode=d};this.postRender=function(c){var b=this,d=b.getContent();jive.ActivityStream.activityNotifier.addListener("activityStream.poll",function(e){b.updateCounts(e)});jive.switchboard.addListener("inbox.read",function(){b.decrementNavCount("communications",1)}).addListener("inbox.unread",function(){b.decrementNavCount("communications",-1)}).addListener("inbox.markAllRead",function(){b.decrementNavCount("communications",10000)}).addListener("actions.actionTaken",function(){b.decrementNavCount("actions",1)}).addListener("tasks.taskComplete",function(){b.decrementNavCount("actions",1)}).addListener("tasks.taskIncomplete",function(){b.decrementNavCount("actions",-1)}).addListener("onboarding.state.update",function(e){b.updateOnboardingProgress(e)});d.delegate(".j-js-pin-stream","click",function(f){b.pin($j(this).closest("li"));f.stopPropagation();f.preventDefault()}).delegate(".j-js-stream-options","click",function(f){b.streamConfigMenu($j(this));f.preventDefault()}).delegate(".j-js-edit-stream","click",function(h){if(b.lastEditNameSuccess&&!b.creatingNewStream){b.creatingNewStream=true;b.endStreamNameEditing();b.setEditMode(false);var f=$j(this).closest("li"),g=f.data("streamid");if(!f.hasClass("j-max-streams-reached")){b.emitP("loadBuilderView",g).addCallback(function(){b.creatingNewStream=false})}}h.preventDefault()}).delegate(".j-js-done-building","click",function(f){f.preventDefault();if(b.lastEditNameSuccess){b.endStreamNameEditing();b.setEditMode(false);b.emitP("closeBuilder")}}).delegate(".j-js-side-nav-link","click",function(j){var f=$j(this),h=f.closest("li"),l=h.attr("id"),g="",i="",k=true;j.preventDefault();if(b.lastEditNameSuccess){b.endStreamNameEditing();b.setEditMode(false);if(l=="jive-nav-link-dashboard"){g="dashboard"}else{if(l=="jive-nav-link-activity"){g="all";i="0"}else{if(l=="jive-nav-link-communications"){g="communications"}else{if(l=="jive-nav-link-actions"){g="actions"}else{if(l=="jive-nav-link-moderation"){g="moderation"}else{if(l=="jive-nav-link-get-started"){g="onboarding"}else{g=h.data("source");i=h.data("streamid")}}}}}}if(g){b.emitP("loadView",g,i).addCallback(function(){b.updateSelectedNavItem(h)})}}})};this.editStreamName=function(f,e){var b=this,g=$j(jive.welcome.streamNameEditForm({streamName:f.find(".j-js-nav-stream-name").text()})),d=f.find(".j-js-as-nav-link");if(f.data("source")!="connections"){d.hide();d.after(g);var c=g.find(".j-js-stream-name-input");if(e){c.focus();c.select()}c.unbind().bind("keypress",function(h){if(h.which=="13"){h.preventDefault()}}).bind("blur",function(h){b.lastEditNameSuccess=b.saveStreamName(h,false)})}else{f.find("a.j-js-as-nav-link").hide();f.find("span.js-conns-display-name").show()}};this.saveStreamName=function(h,l){var g=this,i=g.getContent(),k=i.find(".j-js-stream-name-input"),j=k.val(),c=k.closest("li"),d=c.find(".j-js-as-nav-link"),b=d.find(".j-js-nav-stream-name").text(),f={};if(!k.length){return true}if(!j||!$j.trim(j)){$j("<p>"+jive.eae.activitystream.builder.jsI18nHelper({key:"eae.activitystream.builder.displayname.blankerror"})+"</p>").message({style:"error"});h.stopImmediatePropagation();return false}else{if(j.indexOf("|")!=-1||j.indexOf("(")!=-1||j.indexOf(")")!=-1){$j("<p>"+jive.eae.activitystream.builder.jsI18nHelper({key:"eae.activitystream.builder.displayname.badcharacters"})+"</p>").message({style:"error"});h.stopImmediatePropagation();return false}else{if(b!=j){f.name=j;f.id=c.data("streamid");f.source=c.data("source");f.receiveEmails=$j("#stream-builder .j-js-emails").hasClass("on");g.emitP("saveStreamName",f).addCallback(function(e){if(e.message&&e.message=="name-not-unique"){$j("<p>"+jive.eae.activitystream.builder.jsI18nHelper({key:"api.core.v3.error.duplicate_stream",param1:'"'+j+'"'})+"</p>").message({style:"error"})}else{if(e.message&&e.message=="name-too-long"){$j("<p>"+jive.eae.activitystream.builder.jsI18nHelper({key:"api.core.v3.error.invalid_name_length",param1:""+e.param1})+"</p>").message({style:"error"})}else{d.find(".j-js-nav-stream-name").text(j);if(l){g.endStreamNameEditing()}}}})}else{if(l){g.endStreamNameEditing()}}return true}}};this.endStreamNameEditing=function(){var b=this,g=b.getContent(),e=g.find(".j-js-stream-name-input"),d=e.closest("form"),c=e.closest("li"),f=c.find(".j-js-as-nav-link");if(d.length){f.show();d.remove()}else{c=g.find("li[data-source=connections]");c.find("span.js-conns-display-name").hide();c.find("a.j-js-as-nav-link").show()}};this.streamConfigMenu=function(f){var b=this,c=f.closest("li"),g=c.data("streamid"),e=c.hasClass("pinned"),d=c.data("source")!="connections",h=$j(jive.welcome.navConfigMenuPopover({canDelete:d,canPin:(!e&&b.canPin)}));h.delegate(".j-js-pin-stream","click",function(i){b.pin(c);h.trigger("close");i.preventDefault()}).delegate(".j-js-edit-stream","click",function(j){var i=c.data("streamid");b.emitP("loadBuilderView",i).addCallback(function(){c.addClass("editing")});h.trigger("close");j.preventDefault()}).delegate(".j-js-delete-stream","click",function(j){var i=$j(jive.eae.activitystream.builder.deleteStreamModal({streamID:g}));i.lightbox_me({destroyOnClose:true,centered:true,onLoad:function(){i.delegate("#stream-delete-submit-button","click",function(m){var l=$j(this),k=l.data("id");b.emitP("deleteStream",k).addCallback(function(n){b.removeDeletedStream(n);i.trigger("close")});m.preventDefault()})}});h.trigger("close");j.preventDefault()});h.popover({context:f,darkPopover:true})};this.postBuilderLoad=function(d){var b=this,f=b.getContent();b.editMode=true;if(d.configuration.newStream){var g=$j(jive.welcome.activityStreamNavItem({id:d.configuration.id,url:"#",name:d.configuration.name,source:d.configuration.source,canPin:b.canPin,pollingEnabled:b.pollingEnabled}));var h=f.find("li[data-streamid=new]");f.find("li.j-js-as-nav-item").removeClass("editing");g.addClass("editing");h.before(g);b.updateSelectedNavItem(g);b.editStreamName(g,true);var e=f.find("li.j-js-as-nav-item").length-1;if(e>=b.maxCustomStreams){h.addClass("j-max-streams-reached")}}else{var c=f.find("li[data-streamid="+d.configuration.id+"]");c.addClass("editing");b.updateSelectedNavItem(c);b.editStreamName(c,false)}};this.removeDeletedStream=function(i){var c=this,h=c.getContent(),f=h.find("li[data-streamid="+i.deletedStream.configuration.id+"]");if(f.next().data("streamid")!="new"){f.next().find("a.j-js-as-nav-link").click()}else{f.prev().find("a.j-js-as-nav-link").click()}f.remove();h.find("li.j-js-side-nav-item").removeClass("pinned");var b=i.pinnedHomeNavView.split(":")[0],e=i.pinnedHomeNavView.split(":")[1],d;if(e=="0"){d=h.find("li[data-source="+b+"]")}else{d=h.find("li[data-source="+b+"][data-streamid="+e+"]")}d.addClass("pinned");var g=h.find("li.j-js-as-nav-link").length;if(g<c.maxCustomStreams){$j("#jive-nav-link-new").removeClass("j-max-streams-reached")}};this.updateStreamName=function(c){var b=this,d=b.getContent();d.find("li[data-streamid="+c.id+"] .j-js-nav-stream-name").text(c.name)};this.forceUpdateSelectedNavItem=function(g,f){var b=this,d=b.getContent(),c;if(f=="activity"){var e=g.streamSource;if(e=="all"||!e){c=$j("#jive-nav-link-activity")}else{if(e=="connections"){c=$j("#jive-nav-link-connections")}else{if(e=="watches"){c=$j("#jive-nav-link-watches")}else{c=d.find("li[data-streamid="+g.streamID+"][data-source="+e+"]")}}}}else{if(f=="inbox"){f="communications"}else{if(f.indexOf("actions")!=-1){f="actions"}else{if(f=="welcome"){f="dashboard"}}}c=$j("#jive-nav-link-"+f)}if(!c.hasClass("selected")){b.updateSelectedNavItem(c)}};this.updateSelectedNavItem=function(c){var b=this,d=b.getContent();d.find(".j-js-side-nav-item").removeClass("selected");c.addClass("selected")};this.clearUpdates=function(d,f){var b=this,e=b.getContent(),g="";if(d=="connections"||d=="watches"){g="#jive-nav-link-"+d}else{if(d=="custom"){g="#jive-nav-link-custom-"+f}}if(g){var c=e.find(g+" .j-js-update-indicator");if(c.length){c.replaceWith(jive.welcome.updateIndicator({type:"gauge",count:0}))}}};this.pin=function(c){var b=this,d=b.getContent();b.emitP("pin",c.attr("id")).addCallback(function(){d.find("li.j-js-side-nav-item").removeClass("pinned");c.addClass("pinned");var e="";if(c.hasClass("j-js-as-nav-item")){e=c.find(".j-js-nav-stream-name").text()}else{e=c.find(".nav-link").text()}$j(jive.welcome.pinnedMessage({streamName:e})).message()})};this.updateCounts=function(e){var b=this,d=b.getContent();$j.each(e.newActivityCounts,function(i,j){if(i=="connections"||i=="watches"||i=="custom"){$j.each(j,function(m,l){if(l){var n="";if(i=="connections"||i=="watches"){n="#jive-nav-link-"+i}else{n="#jive-nav-link-"+i+"-"+m}var k=d.find(n+" .j-js-update-indicator");if(k.length){k.replaceWith(jive.welcome.updateIndicator({type:"gauge",count:l}))}}})}});var h=d.find("#jive-nav-link-actions .j-js-update-indicator");if(h.length){var g=e.fullCounts.actions+e.fullCounts.overdueTasks;h.replaceWith(jive.welcome.updateIndicator({type:"count",count:g,extraCssClasses:"j-sidenav-count j-navbadge-count j-ui-elem"}))}var c=d.find("#jive-nav-link-communications .j-js-update-indicator");if(c.length){c.replaceWith(jive.welcome.updateIndicator({type:"count",count:e.fullCounts.communications.unreadCount,extraCssClasses:"j-sidenav-count j-navbadge-count j-ui-elem"}))}var f=d.find("#jive-nav-link-moderation .j-js-update-indicator");if(f.length){f.replaceWith(jive.welcome.updateIndicator({type:"count",count:e.fullCounts.moderations,extraCssClasses:"j-sidenav-count j-navbadge-count j-ui-elem"}))}};this.decrementNavCount=function(f,i){var b=this,g=b.getContent(),c=g.find("li[data-source="+f+"]"),d=c.find(".j-js-update-indicator"),e=parseInt(d.attr("data-count")),h=e-i;if(e<=50||i>1000){if(h<0){h=0}d.replaceWith(jive.welcome.updateIndicator({type:"count",count:h,extraCssClasses:"j-sidenav-count j-navbadge-count j-ui-elem"}))}};this.updateOnboardingProgress=function(c){var b=this,d=b.getContent();d.find("#j-onb-nav-progress").replaceWith(jive.welcome.onboardingNavProgress({percentComplete:c.percentComplete,questData:c.quests}))};this.hideView=function(c){var b=this,d=b.getViewItem(c);if(d.length){if(d.hasClass("selected")){jive.locationState.setState({},"","activity");$j("html, body").animate({scrollTop:0},"fast")}d.remove()}};this.getViewItem=function(d){var b=this,c=b.getContent();return c.find("li[data-source="+d+"]")}});