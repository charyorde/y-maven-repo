jive.namespace("MicroBlogging");if(!jive.MicroBlogging.StatusInputs){jive.MicroBlogging.StatusInputs=jive.StatusInput.StatusInputs.extend({_docReadyInit:function(a){this._container.find(".jive-js-statusinput").each(function(d,b){var f=$j(b).attr("id"),e=this.emit.bind(this,"characterLenMsg"),c=this.emit.bind(this,"atMentionFinished");this.statusInputs[f]=new jive.MicroBlogging.StatusInput(b,a).addListener("characterLenMsg",e).addListener("atMentionFinished",c)}.bind(this))}});jive.MicroBlogging.StatusInput=jive.StatusInput.StatusInput.extend({init:function(a,b){this._super(a,b);this._focusOnRdy=b.focusOnRdy;this._allowTagCreation=b.allowTagCreation==undefined?true:b.allowTagCreation;var d=this;if(b.defaultValue){d._container.prev(".jive-js-statusinput-default").hide()}else{var e=0;function c(){if(e==0){e=$j(d._container).height()}}}this._container.bind("click",function(f){d._container.trigger("focus")});this._container.bind("focus",function(f){d._container.prev(".jive-js-statusinput-default").hide();$j("#j-js-mb-success").hide();if(!b.doNotAnimate){c();d._container.animate({minHeight:Math.max(e*2.2,15)},150);d._container.addClass("j-mb-focused")}d._container.attr("contentEditable",true);d.emit("focus")});this._container.prev().click(function(){d._container.focus()})},triggerOnFocusAnimation:function(){if(this._focusOnRdy){this._container.trigger("focus")}},_initDD:function(a){this._dd=new jive.MicroBlogging.StatusInputDropDown(this._container,a)},_initDDHandlers:function(){this._super();var a=this;this._dd.addListener("friendsLinkClicked",function(){a._showFriendsList(true)});this._dd.addListener("historyLinkClicked",function(){a._showHistoryList(true)})},_getTokens:function(){return jive.MicroBlogging.StatusInput.Tokens},_getPatterns:function(){return jive.MicroBlogging.StatusInput.Patterns},_showFriendsList:function(a){var b=this;this._actionQueue.push(this._obtainFriendsData(a)).then(function(c){b._dd.renderFriendsData(c);if(a){b._dd.selectItem(0)}})},_showHistoryList:function(a){var b=this;this._actionQueue.push(this._obtainHistoryData(a)).then(function(c){b._dd.renderHistoryData(c);if(a){b._dd.selectItem(0)}})},_showTagsList:function(b){var a=this;this._actionQueue.push(this._obtainTagsData(b)).then(function(c){a._dd.renderTagsData(c,b)})},_obtainFriendsData:function(a){return this._obtainData(jive.rest.url("/emention/friends"))},_obtainHistoryData:function(a){return this._obtainData(jive.rest.url("/emention/history"))},_obtainTagsData:function(a){return this._obtainData(jive.rest.url("/tags/search?query="+encodeURIComponent(a)+"*"))},handleAtMentionButtonClick:function(){this._super();if(this._selection==null){this._container.append(document.createTextNode("@"));this._selection=new jive.Selection(this._container[0].lastChild,false,1)}else{var d=this._selection.getRangeStartContainer();var c=" @ ";var b=document.createTextNode(c);var a=Math.min(c.length,2);if(!$j.browser.msie&&d.tagName&&d.tagName.toLowerCase()=="br"){$j(b).insertBefore(d);this._selection.moveToNodeAndCollapse(b,true,a);this._container.focus()}else{this._container.focus();this._selection=new jive.Selection();this._selection.insertNodeAtRange(b,a)}}this._showFriendsList()},swapLinkFor:function(a,c){function b(g,e,f){if(g.nodeType==3){var d=null;var k=g.nodeValue;if(k.indexOf(e)<0){return}if(k.indexOf(e)==0){g.nodeValue=k.substring(e.length);g.parentNode.insertBefore($j(c)[0],g);d=g}else{if(k.indexOf(e)==(k.length-e.length)){g.nodeValue=k.substring(0,k.indexOf(e));g.parentNode.insertBefore($j(c)[0],g);g.parentNode.insertBefore(g,g.previousSibling);d=$j(c)[0]}else{var l=k.substring(0,k.indexOf(e));var m=k.substring(k.indexOf(e)+e.length);g.nodeValue=m;g.parentNode.insertBefore(document.createTextNode(l),g);g.parentNode.insertBefore($j(c)[0],g);d=g}}if(d.nodeType==3&&d.nodeValue.length>1){var j=document.createTextNode(d.nodeValue.substring(1));d.nodeValue=d.nodeValue.substring(0,1);g.parentNode.insertBefore(j,d);g.parentNode.insertBefore(d,j)}jive.Selection.moveCursorAfter(d)}if(g.nodeType==1){if(g.nodeName.toLowerCase()=="a"){return}else{for(var h=0;h<g.childNodes.length;h++){b(g.childNodes[h],e,f)}}}}b(this._container[0],a,c)}});(function(a){var b={mention:"^@([^@ ]+)?",tags:"^#([^# ]+)?",youtubeURL:"https?\\://(?:[\\w\\-]+\\.)?youtube\\.com/watch\\S*[&?]v=([^&\\s]+)\\S*",imageURL:"https?\\://\\S+(\\.png|\\.jpg|\\.gif|\\.jpeg)",linkURL:"https?\\://\\S+"};a.Patterns=b;a.Tokens={mention:{regExp:new RegExp(b.mention,"i"),keypress:function(d,c){var e=this;if(c&&c.length>=2){this._actionQueue.push(this._obtainSearchData(c)).then(function(f){e._dd.renderSearchData(f)})}else{this._showFriendsList()}}},tags:{regExp:new RegExp(b.tags,"i"),keypress:function(d,c){if(c&&c.length>=2){this._showTagsList(c)}else{this._dd.renderTagsData()}}},youtubeURL:{regExp:new RegExp(b.youtubeURL,"i"),keypress:function(c,d){this.emit("youtubeURLMatch",c);this.emit("linkURLMatch",c);this._dd.hide()}},imageURL:{regExp:new RegExp(b.imageURL,"i"),keypress:function(d,f,e){if(!$j(e).parent().attr("data-jive-statusinputImageURL")){this.emit("imageURLMatch",d);var c={href:d};c["data-jive-statusinputadd"]=true;c["data-jive-statusinputImageURL"]=true;this._selection.replaceWordAtRange(d,null,{tag:"a",attrs:c});this._focus(true)}this._dd.hide()}},linkURL:{regExp:new RegExp(b.linkURL,"i"),complete:function(c,d){if(!$j(d).parent().attr("data-jive-statusinputImageURL")){this.emit("linkURLMatch",c)}this._dd.hide()}}}})(jive.MicroBlogging.StatusInput)};