jive.namespace("MicroBlogging");jive.MicroBlogging.CommonView=jive.AbstractView.extend(function(a,b){this.init=function(c){b.init.call(this,c);this.idPostfix=c.idPostfix;this.maxCharCount=c.maxCharCount;this.statusInput=null;this.attachmentsView=null;this.$waitingViewElem=null;this.$formElem=null;this.$imageFormElem=null;this.mobileUI=c.mobileUI||jive.rte.mobileUI;this.atMentionBtn=c.atMentionBtn;this.imagesEnabled=c.imagesEnabled||window._jive_images_enabled||false;this.imgAttachmentBtn=c.imgAttachmentBtn;this.submitBtn=c.submitBtn;this.cancelBtn=c.cancelBtn;if(c.supportAttachments==undefined){this.supportAttachments=true}else{this.supportAttachments=c.supportAttachments}this.doNotAnimate=!!c.doNotAnimate;this.allowTagCreation=c.allowTagCreation};this.postRender=function(){var c=this;if(this.mobileUI&&this.atMentionBtn.length){this.atMentionBtn.remove()}this.createFormElem();this.createWaitingViewElem();this.createWatingView();this.createActionContainer();this.statusInput=new jive.MicroBlogging.StatusInput(this.getContent().find(".jive-js-statusinput"),{maxCharCount:this.maxCharCount,idPostfix:this.idPostfix,focusOnRdy:true,doNotAnimate:this.doNotAnimate,allowTagCreation:this.allowTagCreation,i18n:{}});this.statusInput.addListener("escapeKeyPress",function(){c.emit("cancel");c.resetStatusInput()}).addListener("characterLenMsg",c.handleCharacterLenMsg.bind(c)).addListener("atMentionFinished",c.handleAtMentionResult.bind(c));this.atMentionBtn.click(function(d){c.handleAtMentionClick(d,$j(this))});if(this.imgAttachmentBtn&&this.imagesEnabled){this.imgAttachmentBtn.jiveFileButton({name:"image"}).bind("choose",function(f,g){var d=c._getMetaImageContainer().find("form");d.prepend(g);d.submit()})}this._getMetaImageContainer().find("form").submit(function(){var d=$j(this);if(d.find("input[type=file]").val()==""){return false}c.handleImageURLMatch(null);return false});this.submitBtn.click(function(d){c.handleSubmitClick(d)});if(this.cancelBtn){this.cancelBtn.click(function(d){c.attachmentsView.removeAllAttachments();c.attachmentsView.reset();c.resetStatusInput();c.emit("cancel")})}this.statusInput.addListener("linkURLMatch",function(d){c.handleLinkURLMatch(d)}).addListener("imageURLMatch",function(d){if(!c.supportAttachments){return}c.handleImageURLMatch(d)}).addListener("youtubeURLMatch",function(d){if(!c.supportAttachments){return}c.handleYoutubeURLMatch(d)}).addListener("focus",function(d){c.handleFocus(d)});this.attachmentsView=new jive.MicroBlogging.AttachmentView(this._getAttachmentsViewOptions());this.attachmentsView.addListener("removeImage",function(e,d){if(!c.supportAttachments){return}c.emitP("removeImage",e).addCallback(function(f){d.emitSuccess(f)}).addErrback(function(g,f){d.emitError(g,f)})})};this.getStatusInput=function(){return this.statusInput};this.focus=function(){this.statusInput._focus()};this.createWaitingViewElem=function(){throw"createWaitingViewElem method is abstract. Need to implmenet in subclass"};this.createWatingView=function(){this.waitingView=new jive.shared.FormWaitingView(this.$waitingViewElem)};this.enableForm=function(){this.waitingView.enableForm()};this.disableForm=function(){this.waitingView.disableForm()};this.createFormElem=function(){throw"createFormElem method is abstract. Need to implement in subclass"};this.createActionContainer=function(){this.$actionContainer=this.$formElem.find("[id^=status-input-actions-]")};this.handleAtMentionClick=function(d,c){this.statusInput.handleAtMentionButtonClick();this.emit("atMentionClick");d.stopPropagation()};this.handleAtMentionResult=function(){return null};this.handleCharacterLenMsg=function(d){var f=arguments[1]||{},c=this.$formElem.eq(0).find(".j-js-status-input-characters-remaining"),e=({ok:{msg:""},warning:{msg:jive.wall.charLenErrors({error:false,numChars:f.charLeft}),className:"warning"},error:{msg:jive.wall.charLenErrors({error:true,numChars:f.charOver}),className:"danger"}})[d];c.html(e.msg).removeClass("warning danger");if(d!=="ok"){c.addClass(e.className)}};this.handleLinkURLMatch=function(d){var c=this;this.emitP("linkURLMatch",d).addCallback(function(f,e){c.renderResolvedLink(e,f)}).addErrback(function(f,e){c.renderError(f,e)})};this.renderResolvedLink=function(d,c){this.statusInput.swapLinkFor(d,c)};a.getDraftData=function(){return null};this._getAttachmentsViewOptions=function(){return{selector:this.selector+" .jive-js-attachment-container"}};this._getMetaImageContainer=function(){return this.getContent().find("div.j-status-input-attach-action-container div.j-meta-image-container")};this.handleImageURLMatch=function(d){this.attachmentsView.showLoadingNotification();this.setDataForURLImage(d);var c=this;this.emitP("imageURLMatch",d,this.$imageFormElem,this.getDraftData()).addCallback(function(f,e){c.renderImageAttachment(e,f)}).addErrback(function(f,e){c.attachmentsView.hideLoadingNotification();c.renderError(f,e)})};this.handleYoutubeURLMatch=function(d){this.attachmentsView.showLoadingNotification();var c=this;this.emitP("youtubeURLMatch",d,this.getDraftData()).addCallback(function(f,e){c.renderVideoAttachment(e,f)}).addErrback(function(f,e){c.renderError(f,e)})};this.renderImageAttachment=function(c,d){this.attachmentsView.add(c,d)};this.renderVideoAttachment=function(c,d){this.attachmentsView.add(c,d)};a.setDataForURLImage=function(c){this.$imageFormElem.find("input[name=imageURL]").val(c)};this.handleFocus=function(d){var c=this;if(this.$actionContainer.is(":hidden")){this._initialStatusInputHeight=this.statusInput.getContainer().height();if(!this.imagesEnabled){this.imgAttachmentBtn.hide()}if(($j.browser.msie&&$j.browser.version<7)){this.$actionContainer.show();this.$actionContainer.addClass("j-act-comment-actions clearfix")}else{this.$actionContainer.addClass("j-act-comment-actions clearfix");this.$actionContainer.css({opacity:0,height:1}).show().animate({height:"24px",opacity:1},200,"linear",function(){$j(this).css("height","auto")})}this.$formElem.closest("article").find("div.j-act-reply-form").addClass("r-active");this.$formElem.closest("article").find("div.eae-reply-avatar").fadeIn("fast")}if(c.getContent().find("#j-js-mb-success").length){c.getContent().find("#j-js-mb-success").fadeOut("fast",function(){$j(this).remove();c.getContent().find(".j-mb-last-update").show()})}this.emit("focus")};this.handleSubmitClick=function(d){if(this.statusInput.getCharCount()!=0||this.attachmentsView.getContent().find("li:not(.j-attached-loading)").length){if(this.maxCharCount&&this.statusInput.getCharCount()>this.maxCharCount){this.renderError(jive.wall.submitErrors({key:"over"}));this.emit("submitError",jive.wall.submitErrors({key:"over"}))}else{$j(".jive-js-error-general",this.$formElem).hide();this.waitingView.disableForm();var c=this;this.emitP("submit",this.getDataFromDom()).addCallback(function(f,e){c.renderResponse(f)}).addErrback(function(f,e){c.renderError(f,e)})}}else{this.renderError(jive.wall.submitErrors({key:"none"}));this.emit("submitError",jive.wall.submitErrors({key:"none"}))}};this.getDataFromDom=function(){throw"getDataFromDom method is abstract. Need to implmenet in subclass"};this.normalizeData=function(){return this.statusInput.getSubmitVals()};this.renderError=function(d,c){this.waitingView.enableForm();$j(".jive-js-error-general",this.$formElem).text(d);$j(".jive-js-error-general",this.$formElem).slideDown(100);setTimeout(function(){$j(".jive-js-error-general",this.$formElem).fadeOut("fast")},3500)};this.renderResponse=function(c){this.waitingView.enableForm();this.attachmentsView.reset()};this.renderResponseCommon=function(e){this.getContent().find("#j-js-mb-success").fadeOut("fast");var d=this.getContent().find(".j-mb-last-update");if(d.length){d.hide();if(e.wallentry.status!="AWAITING_MODERATION"){var f=$j(e.wallentry.message).text();f=$j("<div/>").text(f).html();d.html(jive.statusinput.containers.microbloggingStatusInputLastUpdate({latestStatusUpdate:{text:f,url:e.wallentry.URL,commentcount:0}}))}}var c=$j(jive.statusinput.containers.microbloggingStatusInputSuccess({entry:e.wallentry}));c.hide();c.find(".j-js-mb-success-dismiss").click(function(){c.fadeOut("fast",function(){$j(".j-mb-hint").show();d.show()})});this.getContent().append(c);c.animate({height:"toggle"},{duration:600},function(){if(e.wallentry.meta&&e.wallentry.meta.length>0){c.find(".jive-js-attachment-container").slideDown("fast",function(){$j(this).animate({opacity:1},500)})}});this.resetStatusInput()};this.resetStatusInput=function(){this.statusInput.resetText();this.$actionContainer.hide();this.$formElem.closest("article").find("div.eae-reply-avatar").hide();this.$formElem.closest("article").find("div.j-act-reply-form").removeClass("r-active");var c=this.statusInput.getContainer();c.css("minHeight","24px");c.prev(".jive-js-statusinput-default").show();c.removeClass("j-mb-focused");c.removeAttr("contenteditable")}});