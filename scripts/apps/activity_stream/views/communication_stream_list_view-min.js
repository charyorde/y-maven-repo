jive.namespace("ActivityStream");jive.ActivityStream.CommunicationStreamListView=jive.ActivityStream.StreamListCommonView.extend(function(A,B){this.init=function(C){B.init.call(this,C);this.savedItemLoaded=C.savedItemLoaded;this.earliestItemParentTime=0;this.mobileUI=jive.rte.mobileUI;this.ie7=$j.browser.msie&&$j.browser.version<8;this.loadMoreInProgress=false;this.autoLoadMoreTimesLeft=4;this.autoLoadPxHeight=200;this.viewType=C.viewType;this.newUserMode=C.newUserMode;this.instanceName=C.instanceName;this.listVisible=true;this.itemClicked=false};this.postRender=function(){var G=this,F=G.getContent();var H=F.children("div.j-js-ibx-item"),E=H.length;for(var D=0;D<E;D++){G.initStreamItem($j(H[D]),D,true)}F.unbind();F.bind("click touchend",function(M){var I=$j(M.target),L=I.add(I.parents()),K=I.closest("div.j-js-ibx-item"),J=false;if(K.length&&!G.itemClicked&&G.savedItemLoaded){G.itemClicked=true;var N=new jive.conc.Promise();N.addCallback(function(){G.itemClicked=false});J=G.itemsByDomID[K.attr("id").split("_").slice(0,3).join("_")].handleClick(M,L,G.viewType,N)}else{if(L.filter(".j-js-load-more").length){G.loadMore(I)}}if(J){return true}M.preventDefault()});if(!G.mobileUI&&!G.ie7){$j(document).unbind("click.inboxNav");$j(document).bind("click.inboxNav",function(I){if($j("#jive-nav-link-communications").hasClass("selected")){if(!$j(I.target).closest("#j-communications-list").length){F.removeClass("j-js-focused")}else{F.addClass("j-js-focused")}}});$j(document).unbind("keydown.inboxNav");$j(document).bind("keydown.inboxNav",function(J){if($j("#jive-nav-link-communications").hasClass("selected")&&$j(J.target).is("body, html, #j-js-communications-exp")&&((F.hasClass("j-js-focused")&&G.viewType=="split")||G.viewType=="full")){switch(J.keyCode?J.keyCode:J.which){case 13:if(G.listVisible&&G.viewType=="full"&&G.isKeyNavUnlocked()){var I=F.find("div.j-js-ibx-item.j-act-active");if(I.length){var K=new jive.conc.Promise();K.addCallback(function(){G.unlockKeyNav()});G.forceSelectItem(I,true,true,K)}}J.preventDefault();break;case 27:case 8:if(!G.listVisible&&G.isKeyNavUnlocked()){G.emit("backToList");G.unlockKeyNav()}J.preventDefault();break;case 38:if(G.listVisible){G.selectAdjacentItem(true)}J.preventDefault();break;case 40:if(G.listVisible){G.selectAdjacentItem(false)}J.preventDefault();break;case 37:if(!G.listVisible){G.selectAdjacentItem(true)}J.preventDefault();break;case 39:if(!G.listVisible){G.selectAdjacentItem(false)}J.preventDefault();break}}return true});G.attachInfiScroll()}else{var C=F.find(".j-js-load-more");if(C.length&&!C.find(".j-more-label").length){C.html(jive.eae.inbox.inboxLoadMoreBtn({labelType:"text"}))}}};this.forceSelectItem=function(E,I,D,H){var G=this,C=E.attr("id").split("_").slice(0,3).join("_"),F=G.itemsByDomID[C];if(!H){H=new jive.conc.Promise()}if(F){if(!E.hasClass("j-act-active")){$j("#j-communications-list").children("div.j-js-ibx-item.j-act-active").removeClass("j-act-active");E.addClass("j-act-active")}F.expandClickHandler(null,I,D,H);G.scrollItemIntoView(E)}else{H.emitSuccess()}};this.loadMore=function(C){var D=this,G=new jive.conc.Promise();D.loadMoreInProgress=true;var E=C.closest(".j-js-load-more"),F=E.find(".j-more-label");if(F.length){F.replaceWith(jive.eae.inbox.inboxLoadMoreBtn({labelType:"spinner"}))}E.addClass("j-append-active");D.emit("loadMore",""+D.earliestItemParentTime,function(K){if(K.activityStream4JS.activityContainerList.length){K.streamType=D.streamType;if(D.mobileUI||D.ie7||D.autoLoadMoreTimesLeft==0){K.loadMoreLabelType="text"}else{K.loadMoreLabelType="spinner"}D.data=K.activityStream4JS;var L=$j(jive.eae.inbox.commStreamListItems(K));D.append(L);L.hide();L.fadeIn(2000);E.removeClass("j-append-active");var I=L.filter("div.j-comm-entry"),H=I.length;for(var J=0;J<H;J++){D.initStreamItem($j(I[J]),J,true)}}E.remove();D.loadMoreInProgress=false;D.pokeInfiScroll();G.emitSuccess()});return G};this.selectAdjacentItem=function(E,G){var D=this,C=D.getContent();if(D.isKeyNavUnlocked()||G){var F=C.find("div.j-act-active");var I=[];if(F.length){if(E&&F.prev().length){I=F.prev()}else{if(!E){if(F.next(".j-comm-entry").length){I=F.next()}else{if(F.next(".j-js-load-more").length){if(!D.loadMoreInProgress){D.loadMore(F.next()).addCallback(function(){D.selectAdjacentItem(false,true)})}else{D.unlockKeyNav()}}else{D.unlockKeyNav()}}}else{D.unlockKeyNav()}}}if(I.length){var H=new jive.conc.Promise();H.addCallback(function(){D.unlockKeyNav()});D.forceSelectItem(I,true,(D.viewType=="split"||!D.listVisible),H)}}};this.scrollItemIntoView=function(C){var E=this,D;if(E.viewType=="split"){D=E.getContent();if(C.position().top>=D.height()){D.scrollTop((D.scrollTop()+D.height())+(C.position().top-D.height()))}else{if(C.position().top<=0){D.scrollTop((D.scrollTop()+C.position().top))}}}else{D=$j(window);if(C.offset().top>=D.height()+D.scrollTop()){D.scrollTop((D.scrollTop()+D.height())+(C.offset().top-(D.height()+D.scrollTop())))}else{if(C.offset().top<=D.scrollTop()){D.scrollTop(C.offset().top)}}}};this.isKeyNavUnlocked=function(){var C=this;if(!C.keyNavLocked){C.keyNavLocked=true;return true}else{return false}};this.unlockKeyNav=function(){var C=this;C.keyNavLocked=false};this.initStreamItem=function(M,D,I){var L=this,J=L.getContent(),G=L.data.activityContainerList[D],E=M.attr("id").split("_").slice(0,3).join("_"),F=new jive.ActivityStream.CommunicationStreamItemView({selector:this.selector+"  #"+M.attr("id"),id:M.attr("id"),data:G,i18n:L.i18n,viewingUserData:L.data.viewingUser,streamType:L.streamType,filterType:L.filterType,canCreateMbImage:L.data.canCreateMbImage,canCreateMbVideo:L.data.canCreateMbVideo,newUserMode:L.newUserMode,instanceName:L.instanceName,mbCreationModerated:L.data.mbCreationModerated});L.itemsByDomID[E]=F;if(parseInt(G.parentTimestamp)<L.earliestItemParentTime||L.earliestItemParentTime==0){L.earliestItemParentTime=parseInt(G.parentTimestamp)}F.addListener("replySubmit",function(P,O,N){L.emit("replySubmit",P,O,N)}).addListener("commentSubmit",function(P,O,N){L.emit("commentSubmit",P,O,N)}).addListener("mbCommentSubmit",function(P,O,N){L.emit("mbCommentSubmit",P,O,N)}).addListener("repostSubmit",function(P,O,N){L.emit("repostSubmit",P,O,N)}).addListener("linkURLMatch",function(N,O){L.emit("linkURLMatch",N,O)}).addListener("getLikeData",function(N,P){for(var O=0;O<N.length;O++){L.emit("getLikeData",N[O].type,N[O].id,P)}}).addListener("showReadingPaneData",function(O,N,P){L.emit("showReadingPaneData",O,N,F,P)}).addListener("showReadingPane",function(N){L.emit("showReadingPane",N)}).addListener("getFullContent",function(N,O){L.emit("getFullContent",N,O)}).addListener("getFullReplies",function(N,O,P){L.emit("getFullReplies",N,O,P)}).addListener("showRTE",function(N,O,P){L.emit("showRTE",N,O,P)}).addListener("track",function(N,O){L.emit("track",N,O)}).addListener("untrack",function(N,O){L.emit("untrack",N,O)}).addListener("saveLastViewedItem",function(N,O){L.emit("saveLastViewedItem",N,O)}).addListener("fillInTheGaps",function(N,O,P){L.emit("fillInTheGaps",N,O,P)}).addListener("fillInStreamItem",function(N,R,P,O,Q){L.emit("fillInStreamItem",N,R,P,O,Q)});F.postRender();var C=this.streamListItems.length;for(var H=0;H<C;H++){if(this.streamListItems[H].getID()==E){var K=this.streamListItems.splice(H,1);delete (K);break}}if(I){L.streamListItems.push(F)}else{return F}};this.refresh=function(e){var M=this;e.streamType=M.streamType;e.filterType=M.filterType;if(M.mobileUI||M.ie7){e.loadMoreLabelType="text"}else{e.loadMoreLabelType="spinner"}var P=$j(jive.eae.inbox.commStreamListItems(e)),Y=true,V="",Z=null,d=P.filter("div.j-comm-entry"),T=d.length,K=M.getContent();M.data=e.activityStream4JS;if(!K.children("div.j-js-ibx-item").length){Y=false}for(var b=0;b<T;b++){var C=$j(d[b]),J=M.data.activityContainerList[b],L=C.attr("id"),R=L.split("_").slice(0,3).join("_"),S=false,N=M.getDrawer(),D=N.find("div.j-act-exp-view").attr("data-linkedID"),H="none";if(D){H=D.split("_").slice(0,3).join("_")}if(H&&H==R){N.data("refreshing",true);var U=$j(jive.eae.inbox.expandedCommItemView({activityContainer:J,user:M.data.viewingUser,streamType:"communications",filterType:M.filterType,canCreateMBImage:M.data.canCreateMbImage,canCreateMBVideo:M.data.canCreateMBVideo,mobileUI:M.mobileUI,mbCreationModerated:M.data.mbCreationModerated}));M.emit("refreshReadingPane",U,J,R,function(h,g){if(g.length){for(var f=0;f<g.length;f++){M.itemsByDomID[h].appendSubActivity(g[f])}}N.data("refreshing",false)});V=R;S=true}K.find("div[id^="+R+"]").remove();var I=M.streamListItems.length;for(var X=0;X<I;X++){if(M.streamListItems[X].getIDWithoutContainer()==R){var c=M.streamListItems.splice(X,1)[0];if(!S){delete (c)}else{Z=c}break}}}if($j(P[P.length-1]).hasClass("j-js-load-more")){K.find("div.j-js-ibx-item, a.j-js-load-more").remove();I=M.streamListItems.length;for(X=0;X<I;X++){c=M.streamListItems.splice(0,1);delete (c)}M.autoLoadMoreTimesLeft=4;M.earliestItemParentTime=0}K.prepend(P);$j("#j-js-communications").show();if(d.length&&K.find(".j-act-empty-list").length){K.find(".j-act-empty-list").remove()}var F=[],Q=P.filter("div.j-comm-entry"),E=Q.length;for(var a=0;a<E;a++){var O=$j(Q[a]),W;if(O.attr("id").split("_").slice(0,3).join("_")==V){W=Z;var G=K.find("[id^="+V+"]");if(G.length){G.addClass("j-act-active")}}else{W=M.initStreamItem(O,a,false)}F.push(W)}M.streamListItems=F.concat(M.streamListItems);M.pokeInfiScroll()};this.pokeInfiScroll=function(){var E=this,D=E.getContent();if(!E.mobileUI&&!E.ie7){$j(window).trigger("scroll.inboxAutoLoad");D.trigger("scroll")}else{var C=D.find(".j-js-load-more");if(C.length&&!C.find(".j-more-label").length){C.html(jive.eae.inbox.inboxLoadMoreBtn({labelType:"text"}))}}};this.updateUnreadMarkers=function(K){if(K.length==1&&K[0].id==0&&K[0].objectType==0){return }var R=this,G=R.getContent().find("div[id^=communications]"),E=G.length,S=R.getDrawer().find("div.j-act-exp-view"),N=S.attr("data-linkedID"),L=0,Q=0;if(S.length&&N){L=N.split("_")[1],Q=N.split("_")[2]}for(var J=0;J<E;J++){var P=$j(G[J]),D=P.hasClass("j-act-unread"),F=P.attr("id").split("_")[1],C=P.attr("id").split("_")[2],M=false;for(var I=0,O=K.length;I<O;I++){var H=K[I];if(H.id==C&&H.objectType==F){M=true;break}}if(!D&&M){P.removeClass("j-act-read").addClass("j-act-unread");if(Q&&Q==C&&L==F){S.removeClass("j-act-read").addClass("j-act-unread");Q=0}}else{if(D&&!M){P.removeClass("j-act-unread").addClass("j-act-read");if(Q&&Q==C&&L==F){S.removeClass("j-act-unread").addClass("j-act-read");Q=0}}}}};this.attachInfiScroll=function(){var E=this,D=E.getContent(),C=function(){if(E.viewType=="full"){D.unbind("scroll");$j(window).bind("scroll.inboxAutoLoad",function(){if(E.autoLoadMoreTimesLeft&&D.is(":visible")&&!E.loadMoreInProgress&&$j(window).scrollTop()>=((D.height()+D.offset().top)-$j(window).height()-E.autoLoadPxHeight)&&D.find(".j-js-load-more")){E.autoLoadMoreTimesLeft--;D.find(".j-js-load-more").click()}});$j(window).trigger("scroll.inboxAutoLoad")}else{$j(window).unbind("scroll.inboxAutoLoad");D.scroll(function(){if(E.autoLoadMoreTimesLeft&&!E.loadMoreInProgress&&((D.scrollTop()+D.height())>(D[0].scrollHeight-E.autoLoadPxHeight))&&D.find(".j-js-load-more")){E.autoLoadMoreTimesLeft--;D.find(".j-js-load-more").click()}});D.trigger("scroll")}};if(!jive.onLoadEventComplete){$j(window).load(C)}else{C()}};this.switchViewType=function(C){var E=this,D=E.getContent();E.viewType=C;var F=D.find("div.j-act-active");if(C=="split"){F=D.find("div.j-act-active");if(E.getDrawer().find("div.j-panel-instructions").length&&F.length){E.forceSelectItem(F,true,true)}else{if(F.length){E.scrollItemIntoView(F)}}}else{if(F.length){E.scrollItemIntoView(F)}}E.attachInfiScroll()};this.setListVisible=function(D){var C=this;C.listVisible=D};this.setSavedItemLoaded=function(C){this.savedItemLoaded=C};this.getDrawer=function(){return $j("#j-js-communications-exp")}})