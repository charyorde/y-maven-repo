jive.namespace("ActivityStream");jive.ActivityStream.CommunicationStreamReadingPaneView=jive.AbstractView.extend(function(a,b){this.init=function(c){var d=this;b.init.call(this,c);this.rteOptions=c.rteOptions;this.i18n=c.i18n;this.currentStreamItemView=null;this.mobileUI=this.rteOptions.mobileUI;this.ie7=$j.browser.msie&&$j.browser.version<8;this.delay=(function(){var e=0;return function(g,f){clearTimeout(e);e=setTimeout(g,f)}})();this.viewType=c.viewType};this.getSoyTemplate=function(){return jive.inbox.streamReadingPanes()};this.postRender=function(){var c=this,d=c.getContent();d.delegate(".j-js-mention-reply-dismiss","click",function(){$j(this).closest("div.j-js-mention-reply").fadeOut("fast")});d.bind("click touchend",function(i){var g=false;if(c.currentStreamItemView){var f=$j(i.target),h=f.add(f.parents());if(c.viewType=="full"&&f.is("#j-back-to-list")){c.emitP("backToList").addCallback(function(){d.hide()})}else{if(f.is("a.j-pagination-next")){c.emit("selectAdjacentItem",false)}else{if(f.is("a.j-pagination-prev")){c.emit("selectAdjacentItem",true)}else{g=c.currentStreamItemView.handleClick(i,h)}}}}if(g){return true}i.preventDefault()})};this.refresh=function(j,k,q,i){var n=this,o=[];if(n.currentStreamItemView){var d=[],A=[],g=n.getContent(),v=g.find(".j-sub-activity-items"),D=n.currentStreamItemView;var s=g.find("div.j-act-exp-view"),t=j.attr("data-linkedID");if(t!=s.attr("data-linkedID")){s.attr("data-linkedID",t);n.currentStreamItemView.updateID(t)}var w=j.find(".j-sub-activity-items .j-act-node"),l=w.length;if(k.jiveObject.typeLatestAcclaim){var f=j.find("li.j-act-g-item").show();g.find("ul.j-act-g-list").prepend(f);n.emit("getFullContent",k.jiveObject,function(E){g.find("div.js-full-content-body").html(E.html)});i(q,k.activityList)}else{for(var x=0;x<l;x++){var C=$j(w[x]),c=v.find("div[data-objectid="+C.attr("data-objectid")+"][data-objecttype="+C.attr("data-objecttype")+"]");if(!c.length){var B=C.attr("data-objectid"),m=k.activityList.length;for(var h=0;h<m;h++){var e=k.activityList[h];if(B==k.activityList[h].content.id){o.push(e);if(e.content.typeComment||e.content.typeMessage){A.push(B);n.currentStreamItemView.appendOriginalCommentID(B);n.currentStreamItemView.incrementReplyCounts(1,0,0)}break}}n.currentStreamItemView.incrementReplyCounts(0,1,1);d.push(C)}}if(A.length){var z=new jive.ActivityStream.FullRepliesRequest({originalIDs:A}),r=D.getActivityContainer(),y=(r.jiveObject.typeThread?1:r.jiveObject.objectType),p=(r.jiveObject.typeThread?r.jiveObject.threadID:r.jiveObject.id);n.emit("getFullReplies",{objectType:y,objectID:p},z,function(I){var H=I.items.length,K={},L=d.length,G;for(var J=0;J<H;J++){K[I.items[J].content.id+""]=I.items[J]}for(J=0;J<L;J++){G=d[J];var E=K[G.attr("data-objectid")];if(E&&(E.content.typeComment||E.content.typeMessage)){G.find("div.j-excerpt-full-html-content").html(jive.eae.common.activityContentText({activity:E,noAutoescape:true}));jive.rte.renderedContent.emit("renderedContent",G);var F=G.find(".j-js-liking-control");if(F.length){var M=F.find(".js-acclaim-container");F.html(jive.eae.acclaim.likeControl({canLike:!!M.data("canLike"),liked:E.liked,likeCount:E.likeCount,objectId:E.content.id,objectType:E.content.objectType,showIcon:M.data("showicon"),type:"mini"}))}G.hide();v.append(G);G.show()}else{G.hide();v.append(G);G.show()}}i(q,o)});var u=$j("#j-js-communications-exp").find(".j-act-replycount");if(u.length){u.replaceWith(jive.eae.common.replyCountText({activityContainer:n.currentStreamItemView.getActivityContainer(),streamType:"communications",showCurrentCount:false}))}}else{if(d.length){C=d.shift();C.hide();jive.rte.renderedContent.emit("renderedContent",C);v.append(C);C.show()}i(q,o)}}}else{i(q,o)}};this.showReadingPaneData=function(e,k,d,p){var m=this,j=m.getContent(),l=e.find(".j-sub-activity-items");var q=j.find("div.j-act-exp-view"),c=q.attr("data-linkedID");var o=!!e.find("div.j-act-mb").length,i=!!e.find("div.j-act-share").length,g=!!e.find("div.j-act-dm").length,h=e.find("div.js-full-content-body"),n=e.find("div.js-full-content-container");if((!l.children(".j-act-node").length||i)&&n.length&&!h.html()&&!o&&!g){m.emit("getFullContent",k,function(t){h.html(t.html);jive.rte.renderedContent.emit("renderedContent",h);if(t.extraData.poll){m.initPollView(t.extraData,n)}else{if(t.extraData.questionData&&(t.extraData.questionData.correctAnswer||t.extraData.questionData.helpfulAnswers.length)){var s={open:"open",resolved:"resolved",assumed_resolved:"assumed_resolved"},r=$j(jive.discussions.soy.qDisplayInlineAnswers({question:t.extraData.questionData,questionStateEnum:s,i18n:{correctAnswer:jive.eae.common.jsI18nHelper({key:"forum.thrd.correct_answer.link"}),byWord:jive.eae.common.jsI18nHelper({key:"global.by"}),onWord:jive.eae.common.jsI18nHelper({key:"global.on"}),helpfulAnswers:jive.eae.common.jsI18nHelper({key:"question.helpfulAnswers.text"}),helpfulAnswer:jive.eae.common.jsI18nHelper({key:"forum.thrd.helpful_answer.link"}),seeThisAnswer:jive.eae.common.jsI18nHelper({key:"question.seeThisAnswer.text"})},currentUserPartner:_jive_current_user.partner}));n.append(r)}}n.show();e.find("div.j-act-header-slug").hide();e.find("a.j-js-show-full-content").hide();e.find("a.j-js-hide-full-content").show()})}m.currentStreamItemView=d;if(k.immediateFillInTheGapsPageSize){q.hide();m.resetRTE(j);q.detach();if(c){$j("#"+c+" .j-js-act-content").append(q)}j.append(e);m.currentStreamItemView.getEarlierSubActivities(k.immediateFillInTheGapsPageSize,function(){e.show();p.emitSuccess()})}else{q.hide();m.resetRTE(j);q.detach();if(c){$j("#"+c+" .j-js-act-content").append(q)}j.append(e);e.show();p.emitSuccess()}var f=j.find(".j-pagination-prevnext");if(k.prevArticleExists){f.removeClass("j-prev-disabled").addClass("j-prev-enabled")}else{f.removeClass("j-prev-enabled").addClass("j-prev-disabled")}if(k.nextArticleExists){f.removeClass("j-next-disabled").addClass("j-next-enabled")}else{f.removeClass("j-next-enabled").addClass("j-next-disabled")}};this.showRTE=function(g,c,k){var j=this,h=c.closest("div.j-act-exp-view"),d=h.find("div.j-panel-rte");if(!d.length){var i=$j(jive.eae.common.rtePanel({user:window._jive_current_user,hideGuestURLField:(j.currentStreamItemView.getActivityContainer().jiveObject.typeThread?true:false),externallyVisible:g.objectVisibility}));d=i.find("div.j-panel-rte");h.children("div.j-js-ibx-item").append(i)}if(d.is(":visible")){h.find(".j-act-replyto").show();h.find("div.j-panel-rte").hide();h.find(".jive-comment-error").hide();if(!c.next().hasClass("j-panel-rte-wrap")){var f=h.find("div.j-panel-rte-wrap").detach();c.after(f);var e=f.find("div.j-panel-rte-loading");j.rteSpinner=new jive.loader.LoaderView();j.rteSpinner.appendTo(e);e.show();j.initRTE(h,g,k)}else{k.emitSuccess()}}else{f=h.find("div.j-panel-rte-wrap").detach();c.after(f);e=f.find("div.j-panel-rte-loading");j.rteSpinner=new jive.loader.LoaderView();j.rteSpinner.appendTo(e);e.show();j.initRTE(h,g,k)}};this.slideOpenRTE=function(c){var e=this,g=e.getContent(),f=g.find("div.j-panel-rte"),h=g.find("div.j-panel-rte-wrap"),d=g.find("div.j-panel-rte-loading");d.hide();e.rteSpinner.getContent().remove();e.rteSpinner.destroy();f.css("position","static");f.show("fast",c);if(h.is(":last-child")){$j(window).scrollTop($j(document).height())}};this.initRTE=function(w,r,q){var k=r.idPostfix,s={},o=this,m=null,l=null,v=null,n=null,d=null,x=null,g=null,p=null,h=null,j=null,i=null,t=false;o.resetRTE(w);g=(r.parent.jiveObject.typeThread?"discussionReply":"inlineComment");if(r.type=="sub"){m=r.activity.containerObjectType;l=r.activity.containerObjectID;if(g=="discussionReply"){x=r.parent.jiveObject.threadID;if(r.activity.content.typeMention){n=jive.util.unescapeHTML(r.activity.content.context.subject);d=r.activity.content.context.id}else{n=jive.util.unescapeHTML(r.activity.content.subject);d=r.activity.content.id}t=r.parent.jiveObject.imagesEnabled}else{if(r.parent.jiveObject.typeExternalActivity&&!r.activity.content.typeComment){p=r.objectID;v=r.objectType;t=o.rteOptions.hasImagePerms}else{p=r.parent.jiveObject.id;v=r.parent.jiveObject.objectType;t=o.rteOptions.hasImagePerms;if(r.activity.content.id!=r.parent.jiveObject.id||r.activity.content.objectType!=r.parent.jiveObject.objectType){h=(r.activity.content.typeMention?r.activity.content.context.id:r.activity.content.id)}if(r.parent.jiveObject.versionNumber){j=r.parent.jiveObject.versionNumber}}}i=r.activity.activityUser;w.find("div.j-js-reply-to").html(jive.eae.common.replyingToText({type:"user",object:i,externallyVisible:(r.objectVisibility=="true")}))}else{m=r.parent.container.type;l=r.parent.container.id;i=r.parent.originalAuthor;if(g=="discussionReply"){n=jive.util.unescapeHTML(r.parent.jiveObject.subject);x=r.parent.jiveObject.threadID;d=r.parent.jiveObject.id;t=r.parent.jiveObject.imagesEnabled;w.find("div.j-js-reply-to").html(jive.eae.common.replyingToText({type:"user",object:i,externallyVisible:(r.objectVisibility=="true")}))}else{if(r.parent.jiveObject.typeExternalActivity){p=r.objectID;v=r.objectType;t=o.rteOptions.hasImagePerms;w.find("div.j-js-reply-to").html(jive.eae.common.replyingToText({type:"content",object:{},externallyVisible:(r.objectVisibility=="true")}))}else{p=r.parent.jiveObject.id;v=r.parent.jiveObject.objectType;t=o.rteOptions.hasImagePerms;if(r.parent.jiveObject.versionNumber){j=r.parent.jiveObject.versionNumber}w.find("div.j-js-reply-to").html(jive.eae.common.replyingToText({type:"content",object:r.parent.jiveObject,externallyVisible:(r.objectVisibility=="true")}))}}i=r.parent.originalAuthor}if(r.htmlContent){window._jive_gui_quote_text=jive.DiscussionApp.soy.rteMsgQuote({i18n:{postGuestWroteLabel:jive.i18n.getMsg("post.guest_wrote.label"),postUserWroteLabel:jive.i18n.getMsg("post.user_wrote.label")},userName:typeof((window._jive_current_user))!="undefined"&&(window._jive_current_user.ID==i.id)?i.username:i.displayName,isAnonymous:i.anonymous,msgBody:r.htmlContent})}else{window._jive_gui_quote_text=""}window._jive_video_picker__url="?container="+l+"&containerType="+m;jive.rte.multiRTE=new Array();window.editor=new jive.ext.y.HashTable();var c=null,f=null,e=null,u=null;define(["jive.model.Controller","jive.rte.EntitlementService","jive.rte.ImageService","jive.rte.FormService"],function(A,y,z,C){c=new A();e=new y({objectID:(r.parent.jiveObject.typeThread?r.parent.jiveObject.threadID:r.parent.jiveObject.id),objectType:(r.parent.jiveObject.typeThread?1:r.parent.jiveObject.objectType),entitlement:"VIEW"});f=new z({objectId:-1,objectType:-1,containerId:l,containerType:m});u=new C({$form:w.find("form.j-panel-rte-view"),formSubmitHandler:function(){$j(this).find("input[type=submit]").prop("disabled",true);s.body=o.rteView.getHTML();var D=w.find(".jive-comment-error");if(!s.body.length){D.html(o.i18n.empty_comment).show();$j(this).find("input[type=submit]").prop("disabled",false);return}else{D.hide()}if(g=="discussionReply"){s.subject=n;s.forumThreadID=x;s.ID=d;o.emit("replySubmit",s,function(F){w.find(".j-act-replyto").show();w.find("div.j-panel-rte").slideToggle("fast",function(){if(o.rteView){o.resetRTE(w)}});o.currentStreamItemView.renderReply(k,F,g)},function(G,F){D.html(G).show()})}else{s.ID=p;s.typeID=v;var E=o.currentStreamItemView.getActivityContainer();if(E.activityList.length&&E.activityList[0].content.commentContentResource&&E.activityList[0].content.commentContentResource.objectType==129){s.isBackChannelComment=true}if(h){s.parentCommentID=h}if(j){s.version=j}o.emit("commentSubmit",s,function(F){w.find(".j-act-replyto").show();w.find("div.j-panel-rte").slideToggle("fast",function(){if(o.rteView){o.resetRTE(w)}});o.currentStreamItemView.renderReply(k,F,g)},function(G,F){D.html(G).show()})}}});var B={$element:w.find("textarea.wysiwygtext"),controller:c,preset:"stream-narrow",preferredMode:o.rteOptions.preferredMode,startMode:o.rteOptions.startMode,mobileUI:o.rteOptions.mobileUI,isEditing:o.rteOptions.isEditing,toggleText:jive.i18n.getMsg("rte.toggle_display"),alwaysUseTabText:jive.i18n.getMsg("post.alwaysUseThisEditor.tab"),editDisabledText:jive.i18n.getMsg("rte.edit.disabled"),editDisabledSummary:jive.i18n.getMsg("rte.edit.disabled.desc"),communityName:o.rteOptions.communityName,theme_advanced_resizing:false,height:175,images_enabled:t,onReady:function(){o.slideOpenRTE(function(){o.rteView.focus();o.rteView.autoReposition();q.emitSuccess()})},services:{imageService:f,formService:u,entitlementService:e}};o.rteLocation=w.attr("data-linkedID");o.rteView=new jive.rte.RTEWrap(B)});w.find("a.j-panel-hide-rte-link").unbind();w.find("a.j-panel-hide-rte-link").click(function(y){w.find(".jive-comment-error").hide();w.find(".j-act-replyto").show();o.resetRTE(w);y.preventDefault()})};this.resetRTE=function(c){c.find("div.j-panel-rte").hide();if(this.rteView){this.rteView.destroy();this.rteView=null}if($j("textarea.wysiwygtext",c).length){$j("textarea.wysiwygtext",c).remove()}c.find("div.j-js-reply-to").empty();c.find("form[name=jive-comment-post-form] input[type=submit]").prop("disabled",false);c.find("form[name=jive-comment-post-form]").prepend(jive.eae.common.rteTextArea())};this.collapseReadingPane=function(){var d=this,f=d.getContent(),c=f.find("div.j-act-exp-view"),e=$j(jive.inbox.readingPaneDefault({}));c.remove();$j("#j-communications-list").children("div.j-js-ibx-item").removeClass("j-act-active");f.append(e);d.currentStreamItemView=null};this.getActivityList=function(){return this.getContent().find("div.j-act-ibx-exp-list")};this.initPollView=function(f,d){if(f){if($j.browser.msie){var e={containerType:f.containerType,containerID:f.containerID,widgetID:f.widgetID,moreUrl:f.moreUrl,createUrl:f.createUrl,canCreatePoll:f.canCreatePoll,pollID:f.poll.id,pollIndex:f.poll.index};new jive.PollWidget.Main(e)}if(f.poll.votesCount){var c=d.find(".j-act-poll-votect");c.html(jive.eae.poll.common.voteCount({numOfVotes:f.poll.votesCount}))}}};this.defaultView=function(){var c=this.getContent();c.find("div.j-act-exp-view").show()};this.switchViewType=function(c){var d=this;d.viewType=c};this.hidePane=function(e){var c=this,d=c.getContent();d.hide();if(e){e.emitSuccess()}}});