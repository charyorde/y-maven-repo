jive.namespace("ActivityStream");jive.ActivityStream.ActivityStreamListView=jive.ActivityStream.StreamListCommonView.extend(function(a,b){jive.conc.observable(this);this.init=function(c){var d=this;b.init.call(this,c);this.rteOptions=c.rteOptions;this.earliestItemParentTime=0;this.touchmoving=false;this.updateCount=0;this.ie7=$j.browser.msie&&$j.browser.version<8;this.connectionsInfoClosed=c.connectionsInfoClosed;this.infoType=c.infoType;this.infoUser=c.infoUser;this.streamType=c.streamType;this.loadMoreInProgress=false;this.autoLoadMoreTimesLeft=4;this.autoLoadPxHeight=1000;if(this.streamType!="context"&&!($j.browser.msie&&$j.browser.version<8)){$j(window).bind("scroll.autoLoad",function(){if(d.autoLoadMoreTimesLeft&&d.getContent().is(":visible")&&!d.loadMoreInProgress&&$j(window).scrollTop()>=($j(document).height()-$j(window).height()-d.autoLoadPxHeight)&&d.getContent().find(".j-js-load-more")){d.autoLoadMoreTimesLeft--;d.getContent().find(".j-js-load-more").click()}})}};this.getSoyTemplate=function(c){return jive.eae.activitystream.activityStreamList(c)};this.postRender=function(){var f=this,e=f.getContent(),g=e.children("div.j-act-entry"),d=g.length;for(var c=0;c<d;c++){f.initStreamItem($j(g[c]),c,true)}e.delegate(".j-js-update-btn","click",function(h){f.emitP("updateStream").addCallback(function(i){f.refresh(i)});h.preventDefault()});e.bind("click touchend touchmove",function(l){if(l.type=="touchmove"){f.touchmoving=true}else{if(l.type=="touchend"&&f.touchmoving){f.touchmoving=false}else{var h=$j(l.target),k=h.add(h.parents()),j=h.closest("div.j-act-entry"),i=true;if(j.length){i=f.itemsByDomID[j.attr("id")].handleClick(l,k,f)}else{if(k.filter(".j-js-load-more").length&&!f.loadMoreInProgress&&(!f.maxLoadMoreTimes||(f.numTimesLoadedMore<f.maxLoadMoreTimes))){f.loadMoreInProgress=true;var n=k.filter(".j-js-load-more").first();this.spinner=new jive.loader.LoaderView({size:"small",showLabel:false});this.spinner.appendTo(n);var m=this.spinner;n.find(".j-more-label").hide();f.emit("loadMore",""+f.earliestItemParentTime,function(q){if(q.activityStream4JS.activityContainerList.length){q.streamType=f.streamType;q.filterType=f.filterType;f.data=q.activityStream4JS;f.timepoints=q.activityStream4JS.timepoints;var s=$j(f.getSoyTemplate(q));if(s.filter(".j-act-streaminfo").length){s.splice(0,1)}f.numTimesLoadedMore++;if(s.filter("a.j-js-load-more").length&&f.numTimesLoadedMore==f.maxLoadMoreTimes){s.splice(s.length-1,1);s=s.add(jive.eae.activitystream.maxPagesReached())}f.append(s);s.hide();s.fadeIn(2000);if(m){m.getContent().fadeOut(200,function(){m.getContent().remove();m.destroy()})}n.find(".j-more-label").show();var r=s.filter("div.j-act-entry"),p=r.length;for(var o=0;o<p;o++){f.initStreamItem($j(r[o]),o,true)}if(f.streamType!="context"&&f.streamType!="profile"&&(!f.maxLoadMoreTimes||f.numTimesLoadedMore<3)){f.setUpdatedMarker(e)}}n.remove();f.loadMoreInProgress=false});l.preventDefault()}}if(i){return true}l.preventDefault()}}})};this.initStreamItem=function(e,i,h){var g=this,c=g.data.activityContainerList[i],d=e.attr("id"),f=new jive.ActivityStream.ActivityStreamItemView({selector:g.selector+"  #"+d,id:d,data:c,viewingUserData:g.data.viewingUser,streamType:g.streamType,filterType:g.filterType,rteOptions:g.rteOptions,canCreateMbImage:g.data.canCreateMbImage,canCreateMbVideo:g.data.canCreateMbVideo,mbCreationModerated:g.data.mbCreationModerated});g.itemsByDomID[d]=f;if(parseInt(c.parentTimestamp)<g.earliestItemParentTime||g.earliestItemParentTime==0){g.earliestItemParentTime=parseInt(c.parentTimestamp)}f.addListener("replySubmit",function(l,k,j){g.emit("replySubmit",l,k,j)}).addListener("commentSubmit",function(l,k,j){g.emit("commentSubmit",l,k,j)}).addListener("mbCommentSubmit",function(l,k,j){g.emit("mbCommentSubmit",l,k,j)}).addListener("repostSubmit",function(l,k,j){g.emit("repostSubmit",l,k,j)}).addListener("linkURLMatch",function(j,k){g.emit("linkURLMatch",j,k)}).addListener("getLikeData",function(j,l){for(var k=0;k<j.length;k++){g.emit("getLikeData",j[k].type,j[k].id,l)}}).addListener("getFullContent",function(j,k){g.emit("getFullContent",j,k)}).addListener("getFullReplies",function(j,k,l){g.emit("getFullReplies",j,k,l)}).addListener("hide",function(l,m,k,j){g.emit("hide",l,m,k,j,function(r,s,q,o){var n=q;if(o){n=false}for(var p=0;p<g.streamListItems.length;p++){g.streamListItems[p].determineHidden(r,s,n)}})}).addListener("unhidemenu",function(j,k){g.emit("unhidemenu",j,k)}).addListener("unhide",function(j,k){g.emit("unhide",j,k,function(m,n){for(var l=0;l<g.streamListItems.length;l++){if(n.itemHidden){g.streamListItems[l].determineHidden("item",m,true)}if(n.contextTypeHidden){g.streamListItems[l].determineHidden("type-context",m,true)}if(n.contextHidden){g.streamListItems[l].determineHidden("context",m,true)}}})}).addListener("fillInTheGaps",function(j,k,l){g.emit("fillInTheGaps",j,k,l)}).addListener("fillInStreamItem",function(j,n,l,k,m){g.emit("fillInStreamItem",j,n,l,k,m)});f.postRender();if(h){g.streamListItems.push(f)}else{return f}};this.refresh=function(k){var p=this,c=p.getContent();p.streamType=k.streamType;p.filterType=k.filterType;p.data=k.activityStream4JS;p.timepoints=k.activityStream4JS.timepoints;p.updateCount=0;p.autoLoadMoreTimesLeft=4;p.earliestItemParentTime=0;p.numTimesLoadedMore=0;p.showUpdates(0);c.emptyAndTrash();var n=$j(jive.eae.activitystream.streamMarkup(k));c.prepend(n);var d=p.streamListItems.length;for(var f=0;f<d;f++){var o=p.streamListItems.splice(0,1);delete (o)}var h=n.filter("div.j-act-entry"),l=[],m=h.length;for(var g=0;g<m;g++){var e=p.initStreamItem($j(h[g]),g,false);l.push(e)}p.streamListItems=l.concat(p.streamListItems);if(p.streamType!="context"&&p.streamType!="profile"){p.setUpdatedMarker(c)}};this.removeUpdatedMarkers=function(){var c=this.getContent();$j("#j-as-updated-last").remove();$j("#j-as-updated-prev").remove();c.find("div.j-last-updated").removeClass("j-last-updated");c.find("div.j-prev-updated").removeClass("j-prev-updated")};this.setUpdatedMarker=function(i){var h=[],e=[],f=this,g=function(k){var j=f.itemsByDomID[$j(this).attr("id")].getParentTimestamp();if($j.inArray("all",f.filterType)!=-1&&parseInt(j)){if(parseInt(j)>f.timepoints.prev){h.unshift($j(this))}if(parseInt(j)>f.timepoints.prev2){e.unshift($j(this))}}};i.find("div.j-act-entry").each(g);var c=h.length,d=e.length;if(c){f.removeUpdatedMarkers();if(!(h[0].next().length&&$j(h[0].next()[0]).hasClass("j-js-load-more"))){h[0].append(jive.eae.activitystream.updatedMarker({type:"last"}));h[0].addClass("j-last-updated")}h=[]}if(d&&(d!=c)){if(!(e[0].next().length&&$j(e[0].next()[0]).hasClass("j-js-load-more"))){e[0].append(jive.eae.activitystream.updatedMarker({type:"prev"}));e[0].addClass("j-prev-updated")}e=[]}};this.showUpdates=function(f){var e=this,d=e.getContent(),c=d.find("#j-updates");if(f==0){c.hide();c.html(jive.eae.activitystream.newUpdates({count:f}))}else{c.html(jive.eae.activitystream.newUpdates({count:f}));if(f>0&&e.updateCount==0){c.animate({height:"toggle"},{duration:600})}}e.updateCount=f}});