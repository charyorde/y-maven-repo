jive.namespace("ActivityStream");define("jive.ActivityStream.ActivityStreamControllerMain",["jquery"],function(a){return jive.oo.Class.extend(function(b){jive.conc.observable(this);this.init=function(c){var d=this;jive.ActivityStreamApp=jive.ActivityStreamApp||{};jive.ActivityStreamApp.instance=this;this.ie7=a.browser.msie&&a.browser.version<8;if(this.ie7){a.fx.off=true}this.userId=window._jive_effective_user_id;this.commentServiceOptions={listAction:"",location:"jive-comments",commentMode:"comments",isPrintPreview:false};this.listService=new jive.ActivityStream.StreamSource();this.disscusionService=new jive.DiscussionApp.DiscussionRestSource();this.microbloggingService=new jive.MicroBlogging.MicroBloggingSource();this.liking=new jive.Liking.LikeSource({});this.metaService=new jive.MetaSource();this.draftWallEntry=null;if(c){this.setOptions(c);this.streamList=new jive.ActivityStream.ActivityStreamListView({selector:"#j-stream-item-list"+(this.widgetID?"-"+this.widgetID:""),data:c.data,streamType:this.streamType,filterType:this.filterType,timepoints:c.timepoints,rteOptions:this.rteOptions,widgetID:this.widgetID,connectionsInfoClosed:this.connectionsInfoClosed,infoType:this.infoType,infoUser:this.infoUser});this.attachListHandlers(this.streamList);this.streamList.postRender();this.emit("clearUpdates",this.streamType,this.streamID)}this.asPollHandler=function(e){d.showUpdates(e)};if(this.streamType!="context"&&this.streamType!="profile"){jive.ActivityStream.activityNotifier.addListener("activityStream.poll",this.asPollHandler)}};this.setOptions=function(c){var d=this;d.rteOptions=c.rteOptions;d.mobileUI=c.rteOptions.mobileUI;d.contextObjectType=c.contextObjectType;d.contextObjectID=c.contextObjectID;d.streamType=c.streamType;d.streamID=c.streamID;d.tabViewSelector=c.tabViewSelector;d.getMoreStreamType=c.getMoreStreamType;d.widgetID=c.widgetID;d.filterType=c.filterType?c.filterType:["all"];d.canViewStatusUpdates=c.canViewStatusUpdates;d.recommenderEnabled=c.recommenderEnabled;d.connectionsInfoClosed=c.connectionsInfoClosed;d.infoType=c.infoType;d.infoUser=c.infoUser};this.attachListHandlers=function(d){var c=this;c.getDynamicPaneArea().off().on("click","button.j-js-edit-stream",function(f){c.emitP("loadBuilderView",c.streamID);f.preventDefault()}).on("click","#as-filter-trigger",function(h){var g=a(this),f=a(jive.eae.activitystream.filterMenu());a("a",f).click(function(j){var i=a(this),e=i.text();c.filterStream(i);f.trigger("close");j.preventDefault()});f.popover({context:g});h.preventDefault()}).on("click","#filterlinks a",function(g){var f=a(this);c.filterStream(a(this));a("#filterlinks a").removeClass("j-sub-selected font-color-normal");f.addClass("j-sub-selected font-color-normal");g.preventDefault()}).on("click","#filters-applied a.js-remove-filter",function(f){c.toggleFilterSelectedBar();c.filterType=["all"];if(c.spinner){c.spinner.getContent().remove();c.spinner.destroy()}c.spinner=new jive.loader.LoaderView();c.spinner.prependTo(c.getDynamicPaneArea());var g=new jive.conc.Promise();g.addCallback(function(){c.spinner.getContent().remove();c.spinner.destroy()});c.loadStream(c.streamType,c.streamID,false,g);f.preventDefault()});d.addListener("replySubmit",function(h,g,e){var f=a(h.body).text();c.disscusionService.createMessage(h).addCallback(function(i){i.content.text=f;g(i);jive.switchboard.emit("activity.stream.comment.created")}).addErrback(function(j,i){e(j,i)})}).addListener("commentSubmit",function(i,h,e){c.commentServiceOptions.resourceID=i.ID;c.commentServiceOptions.resourceType=i.typeID;c.commentServiceOptions.contentObject={document:i.ID,version:i.version};var f="comments";if(i.isBackChannelComment){f="backchannel"}c.commentServiceOptions.commentMode=f;c.commentService=new jive.CommentApp.CommentSource(c.commentServiceOptions);var g=new jive.CommentApp.Comment({body:i.body,commentMode:f,parentCommentID:i.parentCommentID,name:i.name,email:i.email,url:i.url});c.commentService.save(g).addCallback(function(j){h(j);jive.switchboard.emit("activity.stream.comment.created")}).addErrback(function(k,j){e(k,j);return false})}).addListener("getLikeData",function(e,g,f){c.liking.getLikeData(e,g).addCallback(function(h){f(e,g,h)})}).addListener("unhidemenu",function(f,g){var e=new jive.ActivityStream.ActivityStreamExclusionInfo({userID:c.userId,objectType:f.objectType,objectID:f.objectID,containerType:f.containerType,containerID:f.containerID,interactedObjectType:f.objectType,interactedObjectID:f.objectID});c.listService.exclusionRules(e).addCallback(function(h){g(h)})}).addListener("hide",function(h,i,f,e,k){var g="exclude";if(!f){g="include"}var j=new jive.ActivityStream.ActivityStreamExclusion({userID:c.userId,excludeAction:g,interactedObjectType:i.objectType,interactedObjectID:i.objectID});if(h=="item"){j.setObjectType(i.objectType);j.setObjectID(i.objectID)}else{if(h=="context"){j.setObjectType(i.containerType);j.setObjectID(i.containerID)}else{if(h=="type-context"){j.setObjectType(i.containerType);j.setObjectID(i.containerID);j.setContentType(i.objectType)}}}c.listService.exclude(h,j).addCallback(function(l){k(h,l,f,e)})}).addListener("loadMore",function(e,f){c.listService.getMore({objectType:c.contextObjectType,objectID:c.contextObjectID,streamSource:c.streamType,streamID:c.streamID||"0",filterType:c.filterType,timestamp:e,includeUpdateCount:false}).addCallback(function(g){f(g)})}).addListener("getFullContent",function(e,g){if(e.containerType&&e.containerID){var f=new jive.PollWidget.WidgetSource({containerType:e.containerType,containerID:e.containerID});f.getPollByID(e.objectID,{success:function(j){if(j){var i={containerType:e.containerType,containerID:e.containerID,widgetID:jive.soy.func.randomString(),moreUrl:"#",createUrl:"#",canCreatePoll:false,poll:j,location:"activity-stream"};var h={html:jive.polls.widget.soy.main(i),extraData:i};g(h)}}})}else{c.listService.getFullContent(e.objectType,e.objectID).addCallback(function(h){g(h)})}}).addListener("getFullReplies",function(e,f,g){c.listService.getFullReplies(e.objectType,e.objectID,f).addCallback(function(h){g(h)})}).addListener("fillInTheGaps",function(e,f,g){c.listService.fillInTheGaps(e.objectType,e.objectID,f).addCallback(function(h){g(h)})}).addListener("fillInStreamItem",function(e,j,g,f,i){var h={streamSource:c.streamType,streamID:c.streamID||"0",timestamp:g,fullContent:false,pageSize:f};c.listService.fillActivity(e,j,h,i)}).addListener("updateStream",function(e){c.spinner=new jive.loader.LoaderView();c.spinner.prependTo(c.getDynamicPaneArea());c.listService.list({objectType:c.contextObjectType,objectID:c.contextObjectID,streamSource:c.streamType,streamID:c.streamID||"0",filterType:c.filterType,timestamp:"0",includeUpdateCount:false}).addCallback(function(f){c.emit("clearUpdates",c.streamType,c.streamID);c.getDynamicPaneArea().find(".j-js-updates-since-refresh").remove();f.filterType=c.filterType;c.spinner.getContent().remove();c.spinner.destroy();e.emitSuccess(f)})})};this.filterStream=function(c){var e=this,d=c.attr("data-filterName");if(a.inArray(d,e.filterType)==-1){e.filterType=[d];if(e.spinner){e.spinner.getContent().remove();e.spinner.destroy()}e.spinner=new jive.loader.LoaderView();e.spinner.prependTo(e.getDynamicPaneArea());var f=new jive.conc.Promise();f.addCallback(function(){e.spinner.getContent().remove();e.spinner.destroy()});e.loadStream(e.streamType,e.streamID,false,f)}};this.toggleFilterSelectedBar=function(d){var e=this,c=a("#filters-applied");if(c.length){if(d){c.fadeOut("fast",function(){if(a.inArray("all",e.filterType)==-1){c.find(".j-act-filter-display-name").text(d);c.fadeIn("fast")}})}else{c.fadeOut("fast")}}};this.loadStream=function(c,f,e,g){var d=this;if(!d.filterType){d.filterType=["all"]}d.listService.list({objectType:d.contextObjectType,objectID:d.contextObjectID,streamSource:c,streamID:f||"0",filterType:d.filterType,timestamp:"0",includeUpdateCount:e||false},g).addCallback(function(h){h.streamType=d.streamType=c;d.streamID=f;h.filterType=d.filterType;h.connectionsInfoClosed=d.connectionsInfoClosed;h.infoType=d.infoType;h.infoUser=d.infoUser;d.streamList.refresh(h);d.getDynamicPaneArea().find(".j-act-header").replaceWith(jive.eae.activitystream.streamSpecificFilters({streamDisplayName:h.streamDisplayName,streamType:c,selectedFilter:d.filterType,recommenderEnabled:d.recommenderEnabled,canViewStatusUpdates:d.canViewStatusUpdates,numUpdatesSinceRefresh:(e?h.numUpdatesSinceRefresh:0)}));if(a.inArray("all",d.filterType)!=-1){d.emit("clearUpdates",c,f)}if(g){g.emitSuccess(h.streamDisplayName)}})};this.showUpdates=function(d){var c=this;if(d.newActivityCounts[c.streamType]&&d.newActivityCounts[c.streamType][c.streamID]&&a.inArray("all",c.filterType)!=-1&&a("#j-activity-page").is(":visible")){c.streamList.showUpdates(d.newActivityCounts[c.streamType][c.streamID])}};this.getDynamicPaneArea=function(){return a("#j-dynamic-pane")};this.tearDown=function(){jive.ActivityStream.activityNotifier.removeListener("activityStream.poll",this.asPollHandler)};this.addActivityStreamListViewListener=function(c,d){this.streamList.addListener(c,d)}})});