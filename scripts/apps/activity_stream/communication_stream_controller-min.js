jive.namespace("ActivityStream");define("jive.ActivityStream.CommunicationStreamControllerMain",["jquery"],function(a){return jive.oo.Class.extend(function(b){this.init=function(g){var d=this;this.ie7=a.browser.msie&&a.browser.version<8;if(this.ie7){a.fx.off=true;a(document).unbind("selectstart.draggable").bind("selectstart.draggable",function(j){if(d.resizingList){j.preventDefault()}})}this.streamType="communications";this.userId=window._jive_effective_user_id;this.rteOptions=g.rteOptions;this.contextObjectType=g.contextObjectType;this.contextObjectID=g.contextObjectID;this.i18n=g.i18n;this.savedRefreshTime=g.savedRefreshTime;this.lastViewedObjectType=g.lastViewedObjectType;this.lastViewedObjectID=g.lastViewedObjectID;this.streamID=g.streamID;this.savedItemLoaded=false;this.filterType=g.filterType;this.queryParam=null;this.dmEnabled=g.dmEnabled;this.viewType=g.viewType;this.listHeight=g.listHeight;this.newUserMode=g.newUserMode;this.draftWallEntry=null;this.commentServiceOptions={listAction:"",location:"jive-comments",commentMode:"comments",isPrintPreview:false};this.$filterLinks=a("#communications-filterlinks");this.$filterMenuButton=a("#communications-filter-trigger");this.clearUnreadSinceLastUpdate();jive.switchboard.addListener("inbox.unread",function(k,j,l){d.addUnreadItem(k,j)});this.disscusionService=new jive.DiscussionApp.DiscussionRestSource();this.microbloggingService=new jive.MicroBlogging.MicroBloggingSource();this.liking=new jive.Liking.LikeSource({});this.metaService=new jive.MetaSource();this.listService=new jive.ActivityStream.StreamSource();this.trackingService=new jive.ActivityStream.BuilderServices();this.readingPaneView=new jive.ActivityStream.CommunicationStreamReadingPaneView({selector:"#j-js-communications-exp",rteOptions:this.rteOptions,viewType:this.viewType,i18n:this.i18n,streamType:this.streamType});this.communicationsList=new jive.ActivityStream.CommunicationStreamListView({selector:"#j-communications-list",data:g.data,i18n:this.i18n,filterType:this.filterType,savedItemLoaded:this.savedItemLoaded,viewType:this.viewType,streamType:this.streamType,newUserMode:this.newUserMode,instanceName:this.rteOptions.communityName});this.menuView=new jive.MenuView(this.buildFilterMenu.bind(d),"#communications-filter-trigger",{darkPopover:true});this.attachListHandlers(this.communicationsList);this.readingPaneView.addListener("replySubmit",function(m,l,j){var k=a(m.body).text();d.disscusionService.createMessage(m).addCallback(function(n){n.content.text=k;l(n)}).addErrback(function(o,n){j(o,n)})}).addListener("commentSubmit",function(n,m,j){d.commentServiceOptions.resourceID=n.ID;d.commentServiceOptions.resourceType=n.typeID;d.commentServiceOptions.contentObject={document:n.ID,version:n.version};var k="comments";if(n.isBackChannelComment){k="backchannel"}d.commentServiceOptions.commentMode=k;d.commentService=new jive.CommentApp.CommentSource(d.commentServiceOptions);var l=new jive.CommentApp.Comment({body:n.body,commentMode:k,parentCommentID:n.parentCommentID});d.commentService.save(l).addCallback(function(o){m(o)}).addErrback(function(p,o){j(p,o)})}).addListener("getFullContent",function(j,l){if(j.containerType&&j.containerID){var k=new jive.PollWidget.WidgetSource({containerType:j.containerType,containerID:j.containerID});k.getPollByID(j.objectID,{success:function(o){if(o){var n={containerType:j.containerType,containerID:j.containerID,widgetID:jive.soy.func.randomString(),moreUrl:"#",createUrl:"#",canCreatePoll:false,poll:o,location:"activity-stream"};var m={html:jive.polls.widget.soy.main(n),extraData:n};l(m)}}})}else{d.listService.getFullContent(j.objectType,j.objectID).addCallback(function(m){l(m)})}}).addListener("getFullReplies",function(j,k,l){d.listService.getFullReplies(j.objectType,j.objectID,k).addCallback(function(m){l(m)})}).addListener("backToList",function(j){d.setListVisible(true)}).addListener("selectAdjacentItem",function(j){d.communicationsList.selectAdjacentItem(j)});a("#filters-applied a.js-remove-filter").click(function(j){d.toggleFilterSelectedBar();if(a.inArray("unread",d.filterType)!=-1){d.filterType=["unread"]}else{d.filterType=["all"]}d.loadStream();j.preventDefault()});a("#j-comm-activity-list .j-js-inbox-pane-toggle").click(function(j){d.changeViewType(a(this));j.preventDefault()});var f=a("#j-communications-list"),c=f.offset();a("#js-ibx-resize").draggable({axis:"y",handle:".js-ibx-resize-ctrl",containment:[c.left,c.top+100,10000000,10000000],revert:false,distance:(d.ie7?0:10),opacity:0.3,zIndex:5000,helper:function(){return jive.eae.inbox.jsDraggableHelper()},start:function(j){d.resizingList=true},stop:function(m,l){var k=a("#j-communications-list"),j=Math.floor(l.position.top-k.position().top);k.height(j);d.listHeight=j;d.listService.saveInboxListHeight(j);d.resizingList=false;d.communicationsList.pokeInfiScroll()}});a("#j-filter-bar input:checkbox").unbind("click").click(function(){var l=a(this),j;l.prop("disabled",true);if(l.is(":checked")){j="unread";d.filterType.push(j);var k=a.inArray("all",d.filterType);if(k!=-1){d.filterType.splice(k,1)}}else{j="all";d.filterType.push(j);var m=a.inArray("unread",d.filterType);if(m!=-1){d.filterType.splice(m,1)}}d.loadStream(function(){l.prop("disabled",false)});d.listService.saveActiveStreamFilter("communications",j)});a("#j-js-inbox-send-dm").click(function(j){if(jive.DirectMessaging){jive.DirectMessaging.create().showModal()}j.preventDefault()});this.communicationsList.postRender();this.readingPaneView.postRender();if(this.lastViewedObjectType&&this.lastViewedObjectID){var i=a("#j-communications-list div.j-comm-entry[id^=communications_"+this.lastViewedObjectType+"_"+this.lastViewedObjectID+"_]");if(i.length){var h=new jive.conc.Promise();h.addCallback(function(){d.savedItemLoaded=true;d.communicationsList.setSavedItemLoaded(true)});this.communicationsList.forceSelectItem(i,g.fromHomeMenu,this.viewType=="split"||g.fromHomeMenu,h)}else{this.readingPaneView.defaultView();this.savedItemLoaded=true;this.communicationsList.setSavedItemLoaded(true)}}else{this.readingPaneView.defaultView();this.savedItemLoaded=true;this.communicationsList.setSavedItemLoaded(true)}var e=a("#personFilter");e.placeHeld();this.autocomplete=new jive.UserPicker.Main({placeholder:e.attr("placeholder"),emailAllowed:false,userAllowed:true,listAllowed:false,browseAllowed:false,resultListAllowed:false,multiple:false,$input:e});this.autocomplete.addListener("selectedUsersChanged",function(j){if(j.changes&&j.changes.added){var k=j.changes.added;d.queryParam=k.id;if(a.inArray("unread",d.filterType)!=-1){d.filterType=["user","unread"]}else{d.filterType=["user"]}a(document).bind("keydown.whileInboxLoading",function(l){switch(l.keyCode?l.keyCode:l.which){case 27:l.preventDefault();break}});d.loadStream(function(){a(document).unbind("keydown.whileInboxLoading")});d.toggleFilterSelectedBar(k.displayName)}});this.commsPollHandler=function(j){d.autoUpdate(j)};jive.ActivityStream.activityNotifier.addListener("activityStream.poll",this.commsPollHandler)};this.toggleFilterSelectedBar=function(e){var c=this,d=a("#filters-applied");if(e){d.fadeOut("fast",function(){if(a.inArray("all",c.filterType)!=-1){c.autocomplete.reset()}else{if(a.inArray("user",c.filterType)==-1){a("#personFilter").hide()}d.find(".j-act-filter-display-name").text(e);d.fadeIn("fast")}})}else{d.fadeOut("fast",function(){c.autocomplete.reset()})}};this.loadStream=function(e){var c=this,d=a("#j-communications-list");c.spinner=new jive.loader.LoaderView();c.spinner.prependTo(c.getDynamicPaneArea());if(c.filterType.length!=1||(a.inArray("all",c.filterType)==-1&&a.inArray("unread",c.filterType)==-1)){a(".j-not-all-read-controls").addClass("j-js-hide-mark-all-read-controls")}else{a(".j-not-all-read-controls").removeClass("j-js-hide-mark-all-read-controls")}if(!c.filterType){c.filterType=["all"]}c.listService.list({objectType:c.contextObjectType,objectID:c.contextObjectID,streamSource:c.streamType,streamID:c.streamID,filterType:c.filterType,queryParam:c.queryParam,timestamp:"0"}).addCallback(function(g){c.hideExpandedView();var f=a(jive.eae.inbox.commStreamList({activityStream:g.activityStream,filterType:c.filterType,mobileUI:c.rteOptions.mobileUI,viewType:c.viewType,listHeight:c.listHeight,newUserMode:c.newUserMode,instanceName:c.rteOptions.communityName}));d.replaceWith(f);c.communicationsList.tearDown();c.communicationsList=new jive.ActivityStream.CommunicationStreamListView({selector:"#j-communications-list",i18n:c.i18n,data:g.activityStream4JS,streamType:"communications",filterType:c.filterType,rteOptions:c.rteOptions,savedItemLoaded:c.savedItemLoaded,viewType:c.viewType,newUserMode:c.newUserMode,instanceName:c.rteOptions.communityName});c.communicationsList.postRender();c.attachListHandlers(c.communicationsList);c.spinner.getContent().remove();c.spinner.destroy();if(e){e()}})};this.attachListHandlers=function(d){var c=this;d.addListener("replySubmit",function(h,g,e){var f=a(h.body).text();c.disscusionService.createMessage(h).addCallback(function(i){i.content.text=f;g(i)}).addErrback(function(j,i){e(j,i)})}).addListener("commentSubmit",function(h,g,e){c.commentServiceOptions.resourceID=h.ID;c.commentServiceOptions.resourceType=h.typeID;c.commentServiceOptions.contentObject={document:h.ID,version:h.version};c.commentService=new jive.CommentApp.CommentSource(c.commentServiceOptions);var f=new jive.CommentApp.Comment({body:h.body,commentMode:"comments",parentCommentID:h.parentCommentID});c.commentService.save(f).addCallback(function(i){g(i)}).addErrback(function(j,i){e(j,i)})}).addListener("linkURLMatch",function(e,f){c.metaService.createLink(e).addCallback(function(g){f.emitSuccess(g)}).addErrback(function(h,g){f.emitError(h,g)})}).addListener("getLikeData",function(e,g,f){c.liking.getLikeData(e,g).addCallback(function(h){f(e,g,h)})}).addListener("loadMore",function(e,f){c.listService.getMore({objectType:c.contextObjectType,objectID:c.contextObjectID,streamSource:c.streamType,streamID:c.streamID,filterType:c.filterType,queryParam:c.queryParam,timestamp:e}).addCallback(function(g){f(g)})}).addListener("track",function(e,f){c.trackingService.addItemsToStream(f,[{type:e.objectType,id:e.objectID}],c.streamID,{})}).addListener("untrack",function(e,f){c.trackingService.removeItemsFromStream(f,[{type:e.objectType,id:e.objectID}],c.streamID,{})}).addListener("getFullContent",function(e,g){if(e.containerType&&e.containerID){var f=new jive.PollWidget.WidgetSource({containerType:e.containerType,containerID:e.containerID});f.getPollByID(e.objectID,{success:function(j){if(j){var i={containerType:e.containerType,containerID:e.containerID,widgetID:jive.soy.func.randomString(),moreUrl:"#",createUrl:"#",canCreatePoll:false,poll:j,location:"activity-stream"};var h={html:jive.polls.widget.soy.main(i),extraData:i};g(h)}}})}else{c.listService.getFullContent(e.objectType,e.objectID).addCallback(function(h){g(h)})}}).addListener("getFullReplies",function(e,f,g){c.listService.getFullReplies(e.objectType,e.objectID,f).addCallback(function(h){g(h)})}).addListener("saveLastViewedItem",function(e,f){c.listService.saveActiveCommunicationsItem(e,f).addCallback(function(){})}).addListener("fillInTheGaps",function(e,f,g){c.listService.fillInTheGaps(e.objectType,e.objectID,f).addCallback(function(h){g(h)})}).addListener("fillInStreamItem",function(e,j,g,f,i){var h={streamSource:c.streamType,streamID:c.streamID,timestamp:g,fullContent:false,pageSize:f};c.listService.fillActivity(e,j,h,i)}).addListener("refreshReadingPane",function(f,e,g,h){c.readingPaneView.refresh(f,e,g,h)}).addListener("showReadingPaneData",function(g,f,e,h){c.loadingStreamItem=true;h.addCallback(function(){if(c.viewType=="full"){c.setListVisible(false)}c.loadingStreamItem=false});c.readingPaneView.showReadingPaneData(g,f,e,h)}).addListener("showReadingPane",function(e){if(c.viewType=="full"){c.setListVisible(false)}e.emitSuccess()}).addListener("showRTE",function(e,f,g){c.readingPaneView.showRTE(e,f,g)}).addListener("backToList",function(){c.setListVisible(true)})};this.attachListEventListener=function(d,c){this.communicationsList.addListener(d,c)};this.autoUpdate=function(d){var c=this;if(!c.loadingStreamItem){if(c.savedRefreshTime){c.lastRefreshTime=Number(c.savedRefreshTime);c.savedRefreshTime=0}if(d.newActivityCounts[c.streamType]&&d.newActivityCounts[c.streamType][c.streamID+""]&&a("#j-comm-activity-list").is(":visible")){this.spinner=new jive.loader.LoaderView({size:"small"});this.spinner.prependTo(a("#j-js-communications"));var e=this.spinner;c.listService.list({objectType:c.contextObjectType,objectID:c.contextObjectID,streamSource:c.streamType,streamID:c.streamID,filterType:c.filterType,queryParam:c.queryParam,timestamp:c.lastRefreshTime+""}).addCallback(function(f){c.lastRefreshTime=f.activityStream.timepoints.last;if(f.activityStream.activityContainerList.length){c.communicationsList.refresh(f)}e.getContent().remove();e.destroy()})}c.updateUnreadMarkers(d.fullCounts.communications.unreadItems)}};this.getLastLoadTime=function(){return Number(Number(this.savedRefreshTime)==0?this.lastRefreshTime:this.savedRefreshTime)};this.hideStream=function(){var c=this;a("#j-js-communications").hide()};this.hideExpandedView=function(){this.readingPaneView.collapseReadingPane()};b.buildFilterMenu=function(){var c=this;var d=a(jive.eae.inbox.filtermenu({dmEnabled:c.dmEnabled}));a("a",d).click(function(h){var f=a(this).attr("data-filterName"),g=a(this).text();if(a.inArray("unread",c.filterType)!=-1){c.filterType=[f,"unread"]}else{c.filterType=[f]}c.loadStream();c.toggleFilterSelectedBar(g);d.trigger("close");h.preventDefault()});return d};this.addUnreadItem=function(d,c){this.unreadSinceLastUpdate.push({objectType:d,objectId:c})};this.getUnreadSinceLastUpdate=function(){return this.unreadSinceLastUpdate};this.clearUnreadSinceLastUpdate=function(){this.unreadSinceLastUpdate=[]};this.updateUnreadMarkers=function(d){var c=this;if(d.length<51){c.communicationsList.updateUnreadMarkers(d)}this.clearUnreadSinceLastUpdate()};this.setListVisible=function(e){var c=this,d=a("#j-js-communications");if(d.length){if(e){d.removeClass("j-list-hidden").addClass("j-list-visible")}else{d.removeClass("j-list-visible").addClass("j-list-hidden");a(window).scrollTop(0)}c.communicationsList.setListVisible(e)}};this.changeViewType=function(e){var c=this,f=e.data("type"),g=a("#j-js-communications"),d=a("#j-communications-list");if(c.viewType!=f){c.viewType=f;if(f=="full"){c.listHeight=d.height();g.removeClass("j-split-view").addClass("j-full-view");d.css("height","100%")}else{c.setListVisible(true);g.removeClass("j-full-view").addClass("j-split-view");d.height(c.listHeight)}c.listService.saveInboxViewType(f);c.readingPaneView.switchViewType(f);c.communicationsList.switchViewType(f);g.find("a.j-js-inbox-pane-toggle").removeClass("j-active");e.addClass("j-active")}};this.homeNavClicked=function(){var c=this;c.setListVisible(true)};this.getDynamicPaneArea=function(){return a("#j-dynamic-pane")};this.tearDown=function(){jive.ActivityStream.activityNotifier.removeListener("activityStream.poll",this.commsPollHandler)}})});