jive.namespace("BookmarkApp");jive.BookmarkApp.Main=jive.oo.Class.extend(function(a){var b=jive.BookmarkApp,c=jQuery;a.init=function(e){var d=this;this.element=e.element;this.bookmark=c.extend({},e.bookmark);this.legacy=e.legacy;this.inProgress={};this.createModalAction=e.createModalAction;c(document).ready(function(){d.bookmarkSource=new jive.BookmarkSource();if(d.element){d.linkView=d.buildLinkView(d.element);jive.switchboard.addListener("bookmark.create",function(f){d.update(f,function(){d.bookmark.id=f.id;d.linkView.updateLink({bookmarked:true,legacy:d.legacy,bookmarkCount:f.bookmarkCount,objectId:f.markedObjectId,objectType:f.markedObjectType})})}).addListener("bookmark.destroy",function(f){d.update(f,function(){delete d.bookmark.id;d.linkView.updateLink({bookmarked:false,legacy:d.legacy,bookmarkCount:f.bookmarkCount,objectId:f.markedObjectId,objectType:f.markedObjectType})})})}else{d.listView=d.buildListView();jive.switchboard.addListener("bookmark.create",function(f){d.listView.updateBookmarkLinks(f)}).addListener("bookmark.destroy",function(f){d.listView.updateUnbookmarkLinks(f)})}})};a.buildLinkView=function(e){var f=new b.LinkView(e),d=this;f.addListener("bookmark",function(){var g=d.key();if(!d.inProgress[g]){d.bookmarkSource.save(d.bookmark).addCallback(function(h){d.bookmark=$j.extend(d.bookmark,{id:h.id,bookmarkCount:h.bookmarkCount});jive.switchboard.emit("bookmark.create",d.bookmark);delete d.inProgress[g]});d.inProgress[g]=true}});f.addListener("unbookmark",function(){var g=d.key();if(!d.inProgress[g]){d.bookmarkSource.destroy(d.bookmark.id).addCallback(function(){--d.bookmark.bookmarkCount;jive.switchboard.emit("bookmark.destroy",c.extend({},d.bookmark));delete d.inProgress[g]});d.inProgress[g]=true}});f.addListener("edit",function(){var g={contentObjectType:d.bookmark.markedObjectType,object:d.bookmark.markedObjectId};d.loadModal(g)});return f};a.buildListView=function(){var e=new b.ListView(),d=this;e.addListener("bookmark",function(g){var f=d.key(g);if(!d.inProgress[f]){d.bookmarkSource.save(g).addCallback(function(h){d.bookmark=$j.extend(g,{id:h.id,bookmarkCount:h.bookmarkCount});jive.switchboard.emit("bookmark.create",d.bookmark);delete d.inProgress[f]});d.inProgress[f]=true}});e.addListener("unbookmark",function(g){var f=d.key(g);if(!d.inProgress[f]){d.bookmarkSource.destroy(g.id).addCallback(function(){--g.bookmarkCount;jive.switchboard.emit("bookmark.destroy",c.extend({},g));delete d.inProgress[f]});d.inProgress[f]=true}});e.addListener("edit",function(f){var g={contentObjectType:f.markedObjectType,object:f.markedObjectId};d.loadModal(g,f)});return e};a.loadModal=function(f,e){var d=this;if(!this.modalOpen){this.modalOpen=true;c.get(d.createModalAction,f,function(g){var h=c(g);c("body").append(h);d.populateModal(h.filter(":first"),e,function(){d.modalOpen=false})})}};a.populateModal=function(e,d,f){e.lightbox_me({onClose:function(){f();e.remove()},onLoad:function(){e.find('input[type="text"], textarea, .jive-js-statusinput').filter(":visible").first().focus();$j('label[for="notes"]').click(function(g){g.preventDefault();$j(this).siblings(".jive-form-element-text").find("div[contenteditable]").first().focus()})}});e.find("form").ajaxForm({cache:false,success:function(){e.trigger("close");jive.switchboard.emit("bookmark.update",c.extend({},d))}});c("html,body").animate({scrollTop:0},500)};a.update=function(d,e){if(d.markedObjectType===this.bookmark.markedObjectType&&d.markedObjectId===this.bookmark.markedObjectId){e()}};a.key=function(d){d=d||this.bookmark;return String(d.markedObjectType)+"-"+String(d.markedObjectId)}});