jive.namespace("UserPicker");jive.UserPicker.View=jive.AbstractView.extend(function(a){jive.conc.observable(this);this.init=function(h,g){this.options=g;var f=this;this.$input=h;if(g.placeholder){this.setPlaceholder(g.placeholder)}else{this.setPlaceholder(jive.UserPicker.soy.inputPlaceholder(g))}this.$input.attr("autocomplete","off");this.$input.parents("form").attr("autocomplete","off");if(g.emailAllowed&&!g.userAllowed){this.$input.addClass("j-user-autocomplete-email")}this.urls={userAutocomplete:_jive_base_url+"/user-autocomplete.jspa"};this.changes={};this.selectPeopleView=new jive.UserPicker.SelectPeopleView();this.selectionCallbacks=g.selectionCallbacks||[];this.messagesView=new jive.UserPicker.Messages(h,g);this.resultStore=new jive.UserPicker.ResultStore();this.showNoPicker=false;this.selectedUsers=[];this.selectedLists=[];h.addClass("jive-chooser-input jive-form-textinput-variable");h.before("<input type='hidden'/>");this.$valueStore=h.prev();this.$valueStore.attr("name",g.userParam||h.attr("name"));h.removeAttr("name");this.$selected=$j('<div class="jive-chooser-list j-result-list j-people-list  clearfix"></div>');if(this.options.resultListAllowed){h.after(this.$selected.hide())}var e=false;if(g.canInvitePartners){e=g.canInvitePartners}var d=false;if(g.canInvitePreprovisioned){d=g.canInvitePreprovisioned}var b=false;if(g.invitePreprovisionedDomainRestricted){b=g.invitePreprovisionedDomainRestricted}var c=$j('<div class="jive-chooser-autocomplete j-result-list j-rc4"></div>');this.chooserView=new jive.UserPicker.ResultListView({$chooser:c,$input:h,emailAllowed:g.emailAllowed,userAllowed:g.userAllowed,listAllowed:g.listAllowed,domains:g.domains,trial:g.trial,canInvitePartners:e,canInvitePreprovisioned:d,invitePreprovisionedDomainRestricted:b,onHide:function(){f.selectBestMatch(false);f.hideTheUserList(true)},onSelect:function(i){f.clickTheSelectedResult(i)}});this.maxSelectedCount=g.maxSelectedCount;this.isRelationshipRestricted=g.relatedMessage?true:false;if(f.options.userAllowed&&g.filterIDs.length===0){f.$browse=$j(jive.UserPicker.soy.renderModalBrowseButton({plural:f.options.multiple}));if(f.options.browseAllowed){h.after(f.$browse);f.$browse.click(function(){f.loadBrowseModal()})}}this.lastAjaxAsk="";this.keyPressReturn=true;this.pasting=false;h.bind("paste",function(){f.pasting=true;jive.conc.nextTick(function(){if($j.trim(h.val()).length>0){f.handlePaste()}else{f.pasting=false}})});h.keydown(function(i){if(f.pasting){return false}else{if(i.shiftKey){f.shiftPressed=true}else{return f.keyPressReturn=f.observeUserAutocompleteQuery(i)}}});h.keypress(function(){if(f.pasting){return false}return f.keyPressReturn});h.keyup(function(i){if(f.pasting){return false}else{if(i.shiftKey){f.shiftPressed=false}else{if(f.keyPressReturn){f.ajaxTheUserList()}}}if(f.isEmptyInput()){f.hideTheUserList()}return f.keyPressReturn});h.focus(function(){f.ajaxTheUserList()});this.setSelectedUsers(f.options.startingUsers.users);this.setSelectedLists(f.options.startingUsers.userlists)};a.selectAction=function(e){var d=this;var b=e.users;d.changes={added:[]};if(b.length>0){var c=b.length;b.forEach(function(f){d.emitP("loadUser",f.userID).addCallback(function(g){c--;if(g&&!d.containsItem(d.selectedUsers,g)){d.changes.added.push(g);d.selectedUsers.push(g);d.refreshSelectedUserListDisplayAndHiddenInput()}if(c===0){d.selectPeopleView.close();d.messagesView.showUserMessages(d.changes);d.emit("selectedUsersChanged",d.getSelectedUsersAndLists())}}).addErrback(function(){c--;if(c===0){d.selectPeopleView.close();d.messagesView.showUserMessages(d.changes);d.emit("selectedUsersChanged",d.getSelectedUsersAndLists())}})})}};this.removeList=function(e,b){var d=this;if(e){var c;if(d.showNoPicker){d.selectedLists=d.selectedLists.map(function(f){if(f.id==e){c=d.cloneList(f);f.excluded=b}return f})}else{d.selectedLists=d.selectedLists.filter(function(f){if(f.id==e){c=d.cloneList(f)}return f.id!=e})}if(b&&c){d.changes={removed:c}}}};this.removeUser=function(d,c,e){var f=this;var b;if(d&&d!=-1){if(f.showNoPicker){f.selectedUsers=f.selectedUsers.map(function(g){if(g.id==d){b=f.cloneUser(g);g.excluded=e}return g})}else{f.selectedUsers=f.selectedUsers.filter(function(g){if(g.id==d){b=f.cloneUser(g)}return g.id!=d})}}else{if(c){f.selectedUsers=f.selectedUsers.filter(function(g){if(g.email==c){b=f.cloneUser(g)}return g.email!=c})}}if(e&&b){f.changes={removed:b}}};a.setPlaceholder=function(b){this.$input.attr("placeholder",b);if(this.$input.placeHeld){this.$input.placeHeld()}};a.refreshSelectedUserListDisplayAndHiddenInput=function(){var f=this;var b=[];var g=[];var e=true;var c=true;var d=false;$j(f.selectedUsers).each(function(j,i){e=e&&i.entitled;i.prop.directMessageActionLinkShown=(typeof(i.prop)!="undefined"?(typeof(i.prop.directMessageActionLinkShown)!="undefined"?i.prop.directMessageActionLinkShown:true):true);i.prop.isVisibleToPartner=(typeof(i.prop)!="undefined"?(typeof(i.prop.isVisibleToPartner)!="undefined"?i.prop.isVisibleToPartner:false):false);c=c&&i.prop.directMessageActionLinkShown;if(!f.containsItem(b,i)&&!i.excluded){if(f.inSelectedCountLimit(g)){b.push(i);if(i.id==-1){g.push(i.email)}else{if(f.options.valueIsUsername){g.push(i.username)}else{g.push(i.id)}}}else{f.removeUser(i.id,i.email,false);d=true}}});$j(f.selectedLists).each(function(j,k){if(!k.excluded){var i=true;$j(k.users).each(function(m,l){i=i&&l.entitled;l.prop.directMessageActionLinkShown=(typeof(l.prop)!="undefined"?(typeof(l.prop.directMessageActionLinkShown)!="undefined"?l.prop.directMessageActionLinkShown:true):true);c=c&&l.prop.directMessageActionLinkShown;if(!f.containsItem(b,l)){if(f.inSelectedCountLimit(g)){b.push(l);if(l.id==-1){g.push(l.email)}else{if(f.options.valueIsUsername){g.push(l.username)}else{g.push(l.id)}}}else{f.removeUser(l.id,l.email,false);d=true}}});k.entitled=i;e=e&&i}});f.messagesView.togglePermissionMessage(e);f.messagesView.toggleRelatedMessage(c);f.messagesView.toggleLimitMessage(d);f.messagesView.hideUserMessages();f.$valueStore.val(g.join(","));if(f.selectedLists.length||f.selectedUsers.length){if(f.options.multiple){f.$selected.html(jive.UserPicker.soy.renderSelectedUsersList({results:{users:f.selectedUsers,userlists:f.selectedLists},message:f.options.message,disabled:f.options.disabled,relationship:f.isRelationshipRestricted})).show()}else{f.$selected.html(jive.UserPicker.soy.renderSelectedUser({results:{users:f.selectedUsers,userlists:f.selectedLists},disabled:f.options.disabled})).show();if(f.selectedUsers.length){f.$input.hide();f.$browse.hide()}}var h;f.$selected.find("li").each(function(){h=$j(this);h.find("a.showConnections").click(function(){var i=this;var j=$j.find("#listContents"+$j(i).closest("li").data("list-id"));$j(j).popover({context:$j(i),putBack:true,destroyOnClose:false,container:f.$selected.closest(".j-modal")});return false});h.find("em a.add, em a.remove").parent().click(function(m){var n=$j(this).closest("li"),l=$j("a.add, a.remove",this),k=l.hasClass("remove"),o=n.data("list-id"),j=n.data("user-id"),i=n.data("user-email");n.closest(".j-modal").find(".js-pop").remove();if(o){f.removeList(o,k)}if(j||i){f.removeUser(j,i,k)}f.emit("selectedUsersChanged",f.getSelectedUsersAndLists());f.refreshSelectedUserListDisplayAndHiddenInput();m.preventDefault()})});if(h){f.$selected.find("ul").scrollTo(h)}}else{f.$selected.html("");f.$selected.hide();f.show()}f.selectionCallbacks.forEach(function(i){i(f.$selected,f.selectedUsers,f.selectedLists)})};a.inSelectedCountLimit=function(b){return !this.maxSelectedCount||b.length<this.maxSelectedCount};this.clickTheSelectedResult=function(e){var f=this;var i=e?$j(e):f.chooserView.findSelectedItem().find("a");var j=i.data("user-id");var g=i.data("user-email");var d=i.data("list-id");var c=f.chooseResult(j,g,d);if(c){var b=(c.prop&&c.prop.matchToken)?c.prop.matchToken:$j.trim(f.$input.val());f.$input.val(f.$input.val().replace(new RegExp(b+"([,;|\\s])?"),""));f.$input.focus();f.refreshSelectedUserListDisplayAndHiddenInput();f.hideTheUserList(!j&&!d);var h={added:[c]};f.messagesView.showUserMessages(h)}};a.chooseResult=function(c,e,h){var f=this;var b;if(c||e){var d=f.resultStore.getUser(c,e);if(d&&!f.containsItem(f.selectedUsers,d)){f.selectedUsers.push(d);f.changes={added:d};f.emit("selectedUsersChanged",f.getSelectedUsersAndLists());b=d}}else{if(h){var g=f.resultStore.getList(h);if(g&&!f.containsItem(f.selectedLists,g)){f.selectedLists.push(g);f.changes={added:g};f.emit("selectedUsersChanged",f.getSelectedUsersAndLists());b=g}}}return b};a.containsItem=function(b,e){var d=this;var c=false;$j(b).each(function(f,g){if(e.id==-1){c=c||(jive.util.equalsIgnoreCaseAndPadding(g.email,e.email))}else{c=c||(g.id==e.id&&g.objectType==e.objectType)}});return c};a.cloneUser=function(b){return{displayName:b.displayName,id:b.id,anonymous:b.anonymous,external:b.external,enabled:b.enabled,visible:b.visible,objectType:b.objectType,username:b.username,email:b.email,entitled:b.entitled,prop:{directMessageActionLinkShown:(typeof(b.prop)!="undefined"?(typeof(b.prop.directMessageActionLinkShown)!="undefined"?b.prop.directMessageActionLinkShown:true):true),isVisibleToPartner:(typeof(b.prop)!="undefined"?(typeof(b.prop.isVisibleToPartner)!="undefined"?b.prop.isVisibleToPartner:false):false)},avatarID:b.avatarID,excluded:(typeof(b.excluded)!="undefined"?b.excluded:false),disabled:(typeof(b.disabled)!="undefined"?b.disabled:false)}};a.cloneList=function(d){var b=this;var c={displayName:d.displayName,id:d.id,objectType:d.objectType,style:d.style,users:[],excluded:(typeof(d.excluded)!="undefined"?d.excluded:false)};$j(d.users).each(function(f,e){c.users.push(b.cloneUser(e))});return c};this.shiv=function(b){if(typeof innerShiv!="undefined"){return innerShiv(b)}else{return b}};this.setSelectedUsers=function(b){if(!b){b=[]}var d=this;$j(b).each(function(e,f){if(!d.containsItem(d.selectedUsers,f)){d.selectedUsers.push(d.cloneUser(f))}});for(var c=0;c<d.selectedUsers.length;c++){if(!d.containsItem(b,d.selectedUsers[c])){d.selectedUsers.splice(c,1);c--}}this.refreshSelectedUserListDisplayAndHiddenInput()};this.setSelectedLists=function(b){if(!b){b=[]}var d=this;$j(b).each(function(e,f){if(!d.containsItem(d.selectedLists,f)){d.selectedLists.push(d.cloneList(f))}});for(var c=0;c<this.selectedLists.length;c++){if(!d.containsItem(b,d.selectedLists[c])){this.selectedLists.splice(c,1);c--}}this.refreshSelectedUserListDisplayAndHiddenInput()};this.getSelectedUsersAndLists=function(c){var b=this;var d=$j.merge([],this.selectedUsers);if(c){b.selectedLists.forEach(function(e){e.users.forEach(function(f){if(!b.containsItem(d,f)){d.push(f)}})})}return{users:d,userlists:this.selectedLists,changes:this.changes}};this.val=function(){return this.$valueStore.val()};a.hideTheUserList=function(b){this.chooserView.hide();this.chooserView.clearHighlight();if(!b){this.$input.val("")}};a.ajaxTheUserList=function(){if(this.lastAjaxAsk!=this.$input.val()&&this.$input.val().length){if(this.$input.val().length>1){this.lastAjaxAsk=this.$input.val();this.emit("autocompleteRequest",this.lastAjaxAsk.replace(";","|"))}}else{if(this.lastAjaxAsk.length&&this.$input.val().length){this.chooserView.highlightFirst();this.chooserView.show()}}return true};a.observeUserAutocompleteQuery=function(c){var b=this;switch(c.keyCode){case $j.ui.keyCode.UP:b.chooserView.highlightPrev();return false;case $j.ui.keyCode.DOWN:b.chooserView.highlightNext();return false;case $j.ui.keyCode.TAB:if(b.$input.val().length>0){b.clickTheSelectedResult();return false}else{return true}case $j.ui.keyCode.SPACE:return b.selectBestMatch(false);case $j.ui.keyCode.COMMA:return b.selectBestMatch(true);case 59:return b.selectBestMatch(true);case 220:return b.selectBestMatch(true);case 186:return b.selectBestMatch(true);case $j.ui.keyCode.ENTER:if(b.$input.val().length>0){b.clickTheSelectedResult()}return false;case $j.ui.keyCode.ESCAPE:b.hideTheUserList();return false;case $j.ui.keyCode.HOME:case $j.ui.keyCode.END:case $j.ui.keyCode.PAGE_UP:if(b.shiftPressed){b.$input.select()}return false;case $j.ui.keyCode.PAGE_DOWN:return false}return true};a.isEmptyInput=function(){return $j.trim(this.$input.val()).length===0};a.selectBestMatch=function(d){var c=this;var e=$j.trim(this.$input.val());if(e&&e.length>0){if(c.chooserView.resultSize()==1){c.clickTheSelectedResult();return false}else{if(c.isValidEmailAddress(e.toLowerCase())){var b=this.chooserView.findSelectedItem();if(jive.util.equalsIgnoreCaseAndPadding(b.find("a").data("user-email"),e)){c.clickTheSelectedResult()}return false}else{if(d){if(c.chooserView.findNameMatches(e).length==1){c.clickTheSelectedResult()}return false}}}}return true};a.handlePaste=function(){var c=this;var b={context:$j(".jive-chooser-browse")};c.showSpinner(b);c.emitP("batchRequest",$j.trim(c.$input.val()).replace(";","|")).addCallback(function(e){if(e.users){c.resultStore.storeResults(e);var d=[];$j.each(e.users,function(j,g){var h=$j.trim(g.prop.matchToken);var k=new RegExp(h+"([,;|\\s])?");if(c.pasteMatches(g,h,e.users)){var f=c.chooseResult(g.id,g.email);if(f){d.push(f)}c.$input.val(c.$input.val().replace(k,""))}});c.$input.val($j.trim($j.trim(c.$input.val()).replace("[,;|]+$","")));if(d.length){c.changes={added:d[0],pasted:d}}c.refreshSelectedUserListDisplayAndHiddenInput();if(e.limitExceeded){c.messagesView.toggleLimitMessage(true)}}}).always(function(){c.pasting=false;c.hideSpinner(b)})};a.pasteMatches=function(b,c,d){return b.prop.matchType=="email"&&jive.util.equalsIgnoreCaseAndPadding(c,b.email)||this.nameMatches(d,c).length===1};a.nameMatches=function(c,b){return c.filter(function(d){return b&&($j.trim(d.username.toLowerCase()).startsWith(b)||jive.util.equalsIgnoreCaseAndPadding(b,d.displayName))})};a.loadBrowseModal=function(){var b=this;b.selectPeopleView.setOptions(b.options).addListener("select"+b.options.name,function(c){b.selectAction(c)}).open();return false};this.setCanInvitePartners=function(c){this.options.canInvitePartners=c;this.refreshSelectedUserListDisplayAndHiddenInput()};this.setDisabled=function(c){this.options.disabled=c;this.refreshSelectedUserListDisplayAndHiddenInput()};this.hide=function(){this.$input.hide();if(this.$browse){this.$browse.hide()}};this.show=function(){if(!this.showNoPicker){this.$input.show();if(this.$browse){this.$browse.show()}}else{this.hide()}};this.setNoPicker=function(c){console.log("setting user picker to be fake read only: "+c);this.showNoPicker=c;this.show()};this.autocompleteResponse=function(b){var c=this;c.resultStore.storeResults(b);c.chooserView.render(b);c.chooserView.highlightFirst()};a.isValidEmailAddress=function(b){return b.match("^([\\w\\.!#$%&*\\+/?\\^`{}\\|~_'=-]+)@([\\w\\.-]+)\\.([\\w\\.-]+)$")}});