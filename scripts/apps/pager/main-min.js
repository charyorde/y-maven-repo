jive.namespace("Pager");jive.Pager.Main=function(g,i,n,q){jive.conc.observable(this);q=$j.extend({showLoadingIndicator:true,updateLocation:true},q||{});var e,d=["updated","created","alpha"],p=[],h={page:1,per_page:15,tags:[]},k=new jive.Pager.MainView(g,q),o=false,j=this;$j.extend(h,n||{});Object.keys(h).map(function(r){p.push(new jive.Pager.Parameter(r,h[r]))});function m(r){var s=p.filter(function(t){return t.key==r}).first();if(!s){s=new jive.Pager.Parameter(r);p.push(s)}return s}function c(r){return m("page").set(r)}function b(){var r={};p.forEach(function(s){if(s.key=="page"){r.start=(m("page").value-1)*m("per_page").value}else{if(s.key=="per_page"){r.range=m("per_page").value;r.numResults=m("per_page").value}else{r[s.key]=s.value}}});return r}function f(){return["#/",p.filter(function(r){return r.value&&(!$j.isArray(r.value)||r.value.length>0)&&r.value!=r.default_value}).sort(function(s,r){return s.key<r.key?-1:(s.key>r.key?1:0)}).map(function(r){if($j.isArray(r.value)){return[r.key,r.value.join("+")]}else{return[r.key,r.value]}}).map(function(r){return r.join("=")}).join("&")].filter(function(r){return r}).join("?")}function l(t,y){function u(){k.update();t.trigger("changed");if(typeof y=="function"){y()}j.emit("load")}k.loading();if($j.isFunction(i)){i(b(),u)}else{var s=i,x=i.indexOf(" "),r;if(x>=0){r=s.slice(x,s.length);s=s.slice(0,x)}var v=$j.ajaxSettings.traditional;$j.ajaxSettings.traditional=true;var w=$j.get(s,b(),function(z){var A;if(r){z=jive.util.withoutScripts(z);A=$j("<div/>").append($j("<div/>").append(z).find(r)).html()}else{A=z}if(window.innerShiv){A=window.innerShiv(A)}$j(g).html(A);u()},"html");w.error(function(){j.emit("serverError",w.status,w.statusText,j.get_parameters());k.stopLoading()});$j.ajaxSettings.traditional=v}}e=$j.sammy(function(){this.get(/^(?:#\/)?$/,function(){var r=this;p.map(function(s){s.unset()});Object.keys(this.params).map(function(s){m(s).set(r.params[s])});if(!o){l(this)}else{o=false}});this.get("#/pages/:page_number",function(){c(this.params.page_number);a.apply(this)});this.get(/^#\/page_sizes\/(\d*)$/,function(){m("per_page").set(this.params.splat[0]||this.params.numResults);c(1);a.apply(this)});this.get("#/sorts/:sort_type",function(){m("sort").set(this.params.sort_type);m("prefix").set(this.params.prefix);c(1);a.apply(this)});this.get("#/with_tags/:tags",function(){var r=m("tags");this.params.tags.split("+").map(function(s){r.add(encodeURIComponent(s))});c(1);a.apply(this)});this.get("#/without_tags/:tags",function(){var r=m("tags");this.params.tags.split("+").map(function(s){r.remove(encodeURIComponent(s))});c(1);a.apply(this)});this.get("#/parameters/",function(){var r=this;Object.keys(this.params).map(function(s){m(s).set(r.params[s])});c(1);a.apply(this)});this.bind("update",function(){l(this)})});function a(){if(e.last_location&&e.last_location==f()){history.back()}else{var r=f();this.redirect(r)}}if(e.getLocation().indexOf("#")<0){o=true}e.run();k.addListener("click",function(s){try{e.runRoute("get",s)}catch(r){if(!r.toString().match(/^404/)){throw (r)}}});this.set_parameters=function(s){var r={};if(typeof(s.page)=="undefined"){c(1)}Object.keys(s).map(function(t){r[t]=m(t).set(s[t])});if(q.updateLocation){e.setLocation(f())}else{l(e)}return r};this.get_parameters=function(){var r={};p.map(function(s){r[s.key]=s.value});return r};this.load_page=function(u,v){var s=p;var r=this.get_parameters();p=[];var t=$j.extend(r,u);if(typeof(u.page)=="undefined"){c(1)}Object.keys(t).map(function(w){m(w).set(t[w])});l(e,function(){p=s;if(typeof v=="function"){v()}})};this.update=function(){e.trigger("update")};this.unload=function(){e.unload();k.unload()};this._app=e};