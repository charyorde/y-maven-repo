jive.namespace("CommentApp");jive.CommentApp.Main=jive.Paginated.extend(function(a){this.init=function(c){var b=this;this.commentMode=c.commentMode;this.defaultSort=c.sort||"datedesc";this.paginate=c.paginate||false;this.pageSize=c.pageSize||25;this.i18n=c.i18n;switch(this.commentMode){case"inline":this.containerID="jive-inlinecomments";break;case"backchannel":this.containerID="jive-authordiscussion";break;default:this.containerID="jive-comments";break}this.commentSource=new jive.CommentApp.CommentSource($j.extend({location:this.containerID},c));this.commentListView=new jive.CommentApp.CommentListView(this.containerID,c);this.commentListView.addListener("sortChange",function(d){b.defaultSort=d;b.update({sort:d})}).addListener("saveComment",function(e,f){var g=new jive.CommentApp.Comment(e),d=this;b.commentSource.save(g).addCallback(function(k){var h="comment-"+k.id;var i=window.location.href.split("#")[0]+"#"+h;f.emitSuccess();if(k.moderated){b.loadComments(null,function(){d.displaySuccess(b.i18n.postSuccessText)})}else{if(window.location.href!=i){var j={};j[h]="";b.locationState.setState(j,"saved comment "+k.id)}else{b.update()}}}).addErrback(function(i,h){f.emitError(i,h)})}).addListener("deleteComment",function(f,e){var d=confirm(b.i18n.confirmDeleteComment),g=new jive.CommentApp.Comment({id:e});if(d){f.remove();b.commentSource.destroy(g.id).addCallback(function(){b.update({comment:[]})})}});$j(document).ready(function(){var d;if(b.paginate){b.pager=b.newPager()}if(!b.paginate||Object.keys(jive.locationState.getEphemeralState()).length<1){b.update()}define(["jive.rte"],$j.noop)})};this.closeForms=function(){this.commentListView.closeForm()};this.renderForm=function(b,d,c){this.commentListView.renderForm(b,d,null,c)};this.addCommentListViewListener=function(b,c){this.commentListView.addListener(b,c)};this.refresh=function(){this.update()};a.newPager=function(){var c;var d={replaceWith:function(){}};jive.conc.observable(d);var b=this;this.initPagination({numResults:this.pageSize,sort:this.defaultSort},{locationState:new jive.LocationState({supportPushState:false}),viewClass:function(){return d},paginationSelector:"body",paramFilter:function(f){var e={};Object.keys(f).forEach(function(g){var h=g.match(/^comment-(.*)$/);if(h){e.comment=h[1];e[g]=c}else{e[g]=f[g]}});return e}});$j("#"+this.containerID).delegate(".js-pagination a[data-page]","click",function(e){var f=parseInt($j(this).attr("data-page"),10);d.emit("page",f);b.commentListView.scrollTo();e.preventDefault()});return this};a.loadPage=function(c){var b=new jive.conc.Promise();this.loadComments(c,function(){b.emitSuccess()});return b};a.update=function(b){if(this.paginate&&b){this.pager.pushState(b)}else{this.loadComments(this.pager?this.pager.getState():b)}};a.loadComments=function(c,d){var b=this;c=c||{};c.sort=c.sort||this.defaultSort;if(!this.paginate){this.commentListView.beforeListLoad()}this.commentListView.showSpinner({context:$j("#"+this.containerID+" .jive-comment-container"),size:"big"});this.commentSource.getAllAsHTML(c).addCallback(function(e){b.commentListView.setContent(e);if($j.isFunction(d)){d(e,"success")}}).always(function(){b.commentListView.hideSpinner()})}});