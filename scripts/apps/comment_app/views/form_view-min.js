jive.namespace("CommentApp");jive.CommentApp.FormView=jive.oo.Class.extend(function(a,b){jive.conc.observable(this);this.init=function(c,d){this._parentCommentID=d.parentCommentID;this._commentMode=d.commentMode;if(!this._postBlock){this._postBlock=$j("#jive-comment-post-block")}this._itemAuthorID="comment-author";this._itemBodyID="commentBody";this._itemEmailID="comment-email";this._itemURLID="comment-url";this._container=$j(c);this._initFormWaitingView(d.i18n);this.rteView=null;this.options=d;this._render()};this.getParentCommentID=function(){return this._parentCommentID};a._initFormWaitingView=function(c){this._formWaitingView=new jive.shared.FormWaitingView(this._container.parents(".jive-js-addReply"),{containerPadding:0})};a.focus=function(){if(this._isAnonymous){$j("#"+this._itemAuthorID).focus()}else{b.focus.call(this)}};a._getValues=function(){return{body:this.rteView.getHTML(),mobileEditor:this.rteView.isMobileOnly(),name:$j("#"+this._itemAuthorID).val(),email:$j("#"+this._itemEmailID).val(),url:$j("#"+this._itemURLID).val(),parentCommentID:this._parentCommentID,commentMode:this._commentMode}};a._postHandler=function(){var c=this;if(c._validateComment()){c._formWaitingView.disableForm();c.emitP("post",c._getValues()).addCallback(function(){c._formWaitingView.enableForm()}).addErrback(function(){c._formWaitingView.enableForm()})}return false};a._validateComment=function(){var c=this._getValues();if(this.options.isAnonymous&&$def(c.name)&&$j.trim(c.name)===""){$j("<p/>",{text:jive.DiscussionApp.soy.replyErrorMessage({key:"forum.thrd.name_required.text"})}).message({style:"error"});return false}else{if(this.options.isAnonymous&&$def(c.email)&&$j.trim(c.email)===""){$j("<p/>",{text:jive.DiscussionApp.soy.replyErrorMessage({key:"forum.thrd.email_required.text"})}).message({style:"error"});return false}else{if($j.trim(c.body)===""){$j("<p/>",{text:jive.DiscussionApp.soy.replyErrorMessage({key:"post.err.pls_enter_body.text"})}).message({style:"error"});return false}else{return true}}}};a._initFormControls=function(d,c){};a._isEdit=function(){return false};a._render=function(){var e=this._template();var j="wysiwyg_id_"+jive.CommentApp.FormView.id;jive.CommentApp.FormView.id++;e.find("textarea").attr("id",j);this._container.append(e);this._initFormControls(this._container,j);var h=this;var c=new jive.rte.EntitlementService({objectID:h.options.resourceID,objectType:h.options.resourceType,entitlement:"VIEW"});var g=new jive.rte.ImageService({objectId:-1,objectType:-1,containerId:h.options.containerID,containerType:h.options.containerType});var f=$j("#"+j).closest("form");var d=new jive.rte.FormService({$form:f,formSubmitHandler:function(){return h._postHandler()}});var i=$j.extend({$element:$j("#"+j),isEditing:this._isEdit,onReady:function(){if(h.options.rteOptions.onReady){h.options.rteOptions.onReady()}jive.conc.nextTick(function(){h.rteView.focus()});if(!h.options.isAnonymous){var k={selector:f,objectType:105,draftObjectType:h.options.resourceType,draftObjectID:h.options.resourceID,editorId:j,pushStateEnabled:false};new jive.draft.Main(k)}},services:{imageService:g,formService:d,entitlementService:c}},this.options.rteOptions);this.rteView=new jive.rte.RTEWrap(i);this._container.find("form").find("[name=cancel]").click(function(){h.emit("cancel",h._getValues());return false})};a._template=function(){return $j("<div></div>").html(this._postBlock.html())};this.remove=function(){var c=this.rteView.getID();if(this.rteView){this.rteView.killYourself();this.rteView.destroy()}window.editor.clear(c);jive.rte.multiRTE=jive.rte.multiRTE.filter(function(d){return d!=c});this._container.find("form").parent().html("");$j(window).unbind("unload",this._unloadCallback);this.emit("remove")}});jive.CommentApp.FormView.id=0;