jive.namespace("CommentApp");jive.CommentApp.CommentListView=jive.AbstractView.extend(function(a){var b=jQuery;jive.conc.observable(this);this.init=function(c,e){var d=this;this.container="#"+c;this.containerID=c;this.isThreaded=e.isThreaded;this.i18n=e.i18n;this.options=e;b(document).ready(function(){b(d.container).delegate("#inline-comment-sort","change",function(){d.emit("sortChange",b(this).val())});d.bindEvents()})};this.getContent=function(){return b(this.container)};this.closeForm=function(){if(this.form){this.form.remove();this.form=null;b(".jive-comment-add-link").show();this.emit("formClosed")}};this.renderForm=function(h,e,g,d){var c=this;this.closeForm();var f=h===jive.CommentApp.EditFormView;if(f){this.hideShowCommentForm(g.getDOMElement(),false)}else{this.hideShowCommentForm(null,false)}b(".jive-comment-add-link").hide();this.form=new h(e,d);e.parent(".jive-rendered-content").removeClass("jive-rendered-content");this.proxyListener(this.form,"post","saveComment",function(i,j){j.addCallback(function(){c.closeForm()}).addErrback(function(l,k){c.displayError(l,k)})});this.proxyListener(this.form,"post","savedComment");this.proxyListener(this.form,"cancel","cancelComment",function(){c.closeForm();c.hideShowCommentForm(null,true)});this.form.addListener("remove",function(){if(f){g.hideCommentEdit()}})};a.renderPostForm=function(f,d){var c;if(!d){d=f;f=null;c=this.newCommentForm()}else{c=this.replyCommentForm(f)}var e=b(c).find(".jive-comment-post");return this.renderForm(jive.CommentApp.FormView,e,f,b.extend({i18n:this.i18n},d))};a.renderEditForm=function(e,c){var d=b(e.getDOMElement());if(!d.is(".jive-comment-edit")){d=d.find(".jive-comment-edit:first")}return this.renderForm(jive.CommentApp.EditFormView,d,e,c)};a.bindEvents=function(){var c=this;function d(i){return b(i).closest(".jive-comment-actions").attr("data-comment-id")}function h(j){var i=b(j).closest("li[id^=comment-]");return(new jive.CommentApp.CommentView(i,b.extend({id:d(j)},c.options)))}function f(i){return b(i).attr("commentusername")}function e(m,i,l,j){var k=b(m);if(k.length===0){window._jive_gui_quote_text=""}else{var n=k.attr("data-isAnonymous").toLowerCase()=="true";i.setQuotedMsg(l,n,(j?k.parents("li:first"):null))}}var g=b(this.container);g.delegate(".jive-comment-actions a:has(.commentEdit)","click",function(l){c.hideShowCommentForm(null,true);var k=d(this);var o=b(this).attr("data-parentID");var n={id:k};if(o){b.extend(n,{inReplyTo:{id:o}})}c.emit("editComment",n);var i=h(this),j=b("#comment-"+o).find("a:has(.commentAdd):first"),m=f(j);e(j,i,m,true);i.showCommentEdit();c.renderEditForm(i,b.extend({id:d(this)},c.options));l.preventDefault()});g.delegate(".jive-comment-actions a:has(.commentDelete)","click",function(i){c.emit("deleteComment",h(this),d(this));i.preventDefault()});g.delegate(".jive-comment-actions a:has(.commentAdd)","click",function(k){var j=d(this);var m={id:0,inReplyTo:{id:j}};c.emit("replyComment",m);var l=f(this),i=h(this);e(this,i,l);c.updateBaseCommentUsername(l);c.renderPostForm(i,b.extend({parentCommentID:d(this)},c.options));k.preventDefault()});g.delegate(".js-add-comment","click",function(i){c.emit("createComment",{id:0});window._jive_gui_quote_text="";c.updateBaseCommentUsername("");c.renderPostForm(c.options);b(".jive-create-comment p.jive-comment-meta").hide();i.preventDefault()})};a.scrollToPermalink=function(){var d=(window.location.hash.match(/^#([^\/].+)$/)||[])[1];var c=d?b(this.container+' a[name="'+d+'"], '+this.container+' [id="'+d+'"]'):b();if(c.length>0){if(!this.getContent().is(":visible")&&window.tabView){window.tabView.setVisibility(this.containerID,true);window.tabView.switchTo(this.containerID)}b.scrollTo(c,200,{offset:{top:-20,left:-200}})}};this.setContent=function(c){var d=b(this.container).html(c);this.scrollToPermalink();jive.rte.renderedContent.emit("renderedContent",d)};this.displayError=function(d,c){if(c==401||c==403||c==4026||c===0){d=jive.i18n.sub(this.i18n.globalLoginRequired,'<a href="'+encodeURI(window.location).replace(/#.*$/,"")+'">',"</a>")}d=d||this.i18n.globalAjaxError;b("#jive-comment-error").html(d).show()};this.displaySuccess=function(c){b("#success-moderation-edit").html('<div><span class="jive-icon-med jive-icon-warn"></span>'+c+"</div>").show();b.scrollTo(b("#success-moderation-edit"),"slow",{offset:{top:-40,left:0}})};this.setPreviewButtonText=function(c){};this.scrollTo=function(d){var c=b(this.container);if(!this.inView(c)){b.scrollTo(b(this.container),d||200,{offset:{top:-30,left:0}})}};a.inView=function(d){var f=b(window).scrollTop(),e=f+b(window).height(),c=b(d).offset().top;return((c>=f)&&(c<=e))};a.hideShowCommentForm=function(c,d){c=c||b(this.container).find(".jive-js-addReply");if(c.length===0){return}if(d){c.fadeOut("fast").remove()}else{c.fadeIn("fast");b.scrollTo(c,"slow",{offset:{top:-100,left:0},axis:"y"})}};a.listElement=function(){var c=b(this.container).find("ul.jive-comment:first");if(c.length===0){c=b("<ul/>",{"class":"jive-comment jive-comment-threaded clearfix jive-comment-indent-0"});b(this.container).find(".jive-comment-container").html(c)}return c};a.append=function(c){this.listElement().append(c)};a.newCommentForm=function(){this.hideShowCommentForm(null,true);var c=b(jive.CommentApp.soy.renderReply({i18n:this.i18n}));this.append(c);return c};a.replyCommentForm=function(f){this.hideShowCommentForm(null,true);var d=b(jive.CommentApp.soy.renderReply({commentID:f.getCommentID(),username:f.username(),i18n:this.i18n}));f.append(d);if(this.isThreaded){var e=f.indent(),c=parseInt(d.parent().css("margin-left"),10);d.css("margin-left",-e-c+"px")}return d};a.getBaseFormElem=function(){return b(this.container).find(".baseCommentForm")};a.updateBaseCommentUsername=function(c){if(!this.isThreaded){this.getBaseFormElem().find(".replyToName").html(c)}};this.beforeListLoad=function(){b(this.container).append('<div class="j-loader-box">'+this.i18n.loading+"</div>")}});