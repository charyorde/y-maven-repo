jive.namespace("StatusInput");if(!jive.StatusInput.StatusInputs){jive.StatusInput.StatusInputs=$Class.extend({init:function(a,b){this._container=$j(a);this._i18n=b.i18n;this.statusInputs={};var c=this;$j(document).asyncReady(function(){c._docReadyInit(b);c.emit("ready")})},getSubmitVals:function(a){return this.getStatusInput(a).getSubmitVals(true)},resetText:function(a){this.getStatusInput(a).resetText()},_docReadyInit:function(a){var b=this;this._container.find(".jive-js-statusinput").each(function(){var c=$j(this).attr("id");b.statusInputs[c]=new jive.StatusInput.StatusInput($j(this),a)})},getStatusInput:function(a){return this.statusInputs[a]}});jive.conc.observable(jive.StatusInput.StatusInputs.prototype);jive.conc.observable(jive.StatusInput.StatusInputs.prototype);jive.StatusInput.StatusInput=$Class.extend({init:function(a,b){b.mobileUI=b.mobileUI||jive.rte.mobileUI;this._container=$j(a);this.mobileUI=b.mobileUI;if(this.mobileUI){this._container=$j("<input type='text' class='rteReplacement'/>");$j(a).before(this._container);$j(a).remove()}this._mobileEditor=b.mobileUI;this._i18n=b.i18n;this._selection=null;this._replacedInitialText=false;this._initDD(b);this._initDDHandlers();this._maxCharCount=b.maxCharCount;this._maxCharCountBeforeWarning=((this._maxCharCount)?(b.maxCharCountBeforeWarn||this._maxCharCount*0.8):0);this._previousMatchReqsSpaceAfter=null;this._previousPasteVal=null;this._previousSanitizedHTML=null;this._supportsDomRange=$j.isFunction(window.getSelection);this._id=this._container.attr("id");var c=this;define(["jive.conc.FreshActionQueue"],function(d){c._actionQueue=new d()});$j(document).bind("keyup mouseup",function(d){d.stopPropagation();switch(d.which){case 1:case 2:case 3:break;case 13:d.preventDefault();break;case 27:c._dd.hide();return;break;default:break}});this._container.bind("keypress",function(d){switch(d.which){case 13:d.preventDefault();if(this._mobileEditor){return false}break}});this.delay=(function(){var d=0;return function(f,e){clearTimeout(d);d=setTimeout(f,e)}})();this._container.bind("keydown",function(g){g.stopPropagation();switch(g.which){case 13:g.preventDefault();break;case 37:if(!$j.browser.msie){if(c._selection._selection.anchorNode&&c._selection._selection.anchorNode.parentNode==c._container[0].firstChild&&c._selection._selection.anchorOffset==0){$j(c._container[0]).html("&nbsp"+$j(c._container[0]).html());c._selection.moveToNodeAndCollapse(c._container[0].firstChild,true,0)}}else{var f=document.selection.createRange(),d=rangy.getSelection();if(f&&f.parentElement()==c._container[0].firstChild&&d.anchorOffset==0){$j(c._container[0]).html("&nbsp"+$j(c._container[0]).html());c._selection.moveToNodeAndCollapse(c._container[0].firstChild,true,0)}}return;break;case 38:case 40:if(c._dd.isVisible()){g.preventDefault()}break;default:break}c.delay(function(){c._selection=new jive.Selection();switch(g.which){case 13:if(this._mobileEditor){return false}if(c._dd.isVisible()){c._dd.hide();return false}if($j.browser.msie&&parseFloat($j.browser.version.charAt(0))<9){var h=document.selection.createRange();h.pasteHTML("<br data-jive-statusinputadd='true' />");h.select();break}var i=document.createElement("br");i.setAttribute("data-jive-statusinputadd","true");var j=document.createTextNode("");c._selection.insertNodeAtRange(i);c._selection.selectNode(i);c._selection.collapseRange(false);c._selection.insertNodeAtRange(j);c._selection.selectNodeContents(j);break;case 27:c._dd.hide();c.emit("escapeKeyPress");return;break;case 32:c._dd.hide();return;break;case 37:case 39:return;break;case 38:return;break;case 40:c._dd.selectItem(0);return;break;default:break}if((c._mobileEditor&&c._container.val().length==0)||(!c._mobileEditor&&c._container.text().length==0)){c._dd.hide();if(c._maxCharCount){c.emit("characterLenMsg","ok",{charCount:c.getCharCount()})}return}c.sanitizeHTML();if(!c._replacedInitialText){c._replacedInitialText=true}c._processToken();if(c._maxCharCount){var e=c.getCharCount();if(e>c._maxCharCountBeforeWarning){if(c.getCharCount()>c._maxCharCount){c.emit("characterLenMsg","error",{charCount:e,charOver:e-c._maxCharCount})}else{c.emit("characterLenMsg","warning",{charCount:e,charLeft:c._maxCharCount-e})}}else{c.emit("characterLenMsg","ok",{charCount:c.getCharCount()})}}},75)});this._container.bind("focus",function(){c.sanitizeHTMLInterval=window.setInterval($j.proxy(c.sanitizeHTML,c),500)});this._container.blur(function(){c._processCompleteToken();c.emit("blur");window.clearInterval(c.sanitizeHTMLInterval)});this._addInstanceToInstanceObj()},_addInstanceToInstanceObj:function(){jive.StatusInput.StatusInput.instances[this._id]=this},_initDD:function(a){this._dd=new jive.StatusInput.StatusInputDropDown(this._container,a)},_initDDHandlers:function(){var a=this;this._dd.addListener("interactionFinished",function(g,f,k){if(g!=null){var j=$j("<div />").html(g.value),i=jive.util.escapeHTML(j.text()),h=j.find("span"),c=$j.extend({"data-jive-statusInputadd":"true",href:g.href,"data-jive-statusInputInteral":"true"},k||{});g.id&&(c.jiveID=g.id);var d=(h.attr("class")||"").split(/\s+/);c["class"]=a._generateIconClass(d);var b=document.createTextNode(" ");var e=a._selection.replaceWordAtRange(i,f||"",{tag:"a",attrs:c});e.parentNode.insertBefore(b,e.nextSibling);a._selection.moveToNodeAndCollapse(b,false,b.nodeValue.length)}a._dd.hide();a._focus(true);a.emit("atMentionFinished",g.id,g.value)})},_generateIconClass:function(c){var b={"jive-icon-blog":"jive-link-blog-small","jive-icon-doctype-compressed":"jive-icon-doctype-compressed-small","jive-icon-discussion":"jive-icon-discussion-small","jive-icon-discussion-bridged":"jive-icon-discussion-bridged-small","jive-icon-discussion-correct":"jive-icon-discussion-correct-small","jive-icon-discussion-question":"jive-icon-discussion-question-small","jive-icon-doctype-acrobat":"jive-icon-doctype-acrobat-small","jive-icon-doctype-document":"jive-icon-doctype-document-small","jive-icon-doctype-image":"jive-icon-doctype-image-small","jive-icon-doctype-presentation":"jive-icon-doctype-presentation-small","jive-icon-doctype-spreadsheet":"jive-icon-doctype-spreadsheet-small","jive-icon-document":"jive-link-wiki-small","jive-icon-external-site":"jive-link-url-small","jive-icon-group":"jive-link-socialgroup-small","jive-icon-poll":"jive-link-poll-small","jive-icon-profile":"jive-link-profile-small","jive-icon-project":"jive-link-project-small","jive-icon-tag":"jive-link-tag-small","jive-icon-space":"jive-link-community-small"},a=$j.map(c,function(d){return d in b?b[d]:null});return a.shift()||""},getContainer:function(){return this._container},getSubmitVals:function(a){if(a){this._truncateNodes()}var b;if(this._mobileEditor){b=jive.util.escapeHTML(this._container.val())}else{b=this._container.html()}b=b.replace(/<\/?br _[^>]*>/gi,"");b=b.replace(/(<\/?)(\w+)([^>]*>)/gi,function(f,e,d,c){return e+d.toLowerCase()+c.replace(/((data-jive-statusInputadd)|(data-jive-truncation-flag))=["']true["']/gi,"")});b=b.replace(/(<\/?[aA]\s+[^>]*href=")([^"]*)("[^>]*>)/gi,function(g,f,e,d){if(g.search(/<\w+[^>]*data-jive-statusinputinteral="true"[^>]*>/gi)!=-1){var c=e.replace(/https?\:\/\//,"").split("/").slice(1).join("/");return f+"/"+c+d}else{return g}});return b},_truncateNodes:function(){if(this.getCharCount()>this._maxCharCount){var g=this._container[0].childNodes;var f=0;var e=false;for(var c=0;c<g.length;c++){var b=g[c];if(e){this._container[0].removeChild(b)}else{var a=$j(b).text().length;if(f+a>this._maxCharCount){var d=this._maxCharCount-f;this._truncateNode(b,d);e=true}f+=a}}}},_truncateNode:function(c,a){if(c.nodeType==3){var d=c.nodeValue;if(d.length<a){return a-d.length}else{c.nodeValue=c.nodeValue.substr(0,a);return 0}}else{var e=c.childNodes;for(var b=0;b<e.length;b++){if(a==0){c.removeChild(e[b])}else{a=this._truncateNode(e[b],a)}}}},truncateAnchors:function(){$j(this._container).find("[data-jive-statusinputadd=true]:not([data-jive-truncation-flag=true],[data-jive-statusinputinteral=true])").each(function(){var a=$j(this);a.contents().filter(function(){return this.nodeType==3}).each(function(){var b=$j(this);b.replaceWith(document.createTextNode(jive.util.truncateStr(b.text())))});a.attr("data-jive-truncation-flag",true)})},sanitizeHTML:function(){var a=this._container.html();if(this._previousSanitizedHTML==a){return}var c=this._container[0].lastChild;if(!$j.browser.msie&&(c==null||c.nodeType==3||c.nodeName&&c.nodeName.toLowerCase()!="br")){var d=document.createElement("br");d.setAttribute("_moz_dirty","");this._container[0].appendChild(d)}this.truncateAnchors();if(!$j.browser.msie){a=a.replace(/<\/?br[^>]*>$/mi,"")}var h=this;this._container.find("a[data-jive-statusinputadd=true]").filter(function(){return $j(this).text()==""}).each(function(){var j=h._selection.getRangeStartContainer();var m=$j(this);if($j(j).parents(m).length>0){var l=m.parent().contents(":not(br)");var o=l.index(m);var n;var k=0;if(o>0){n=l[o-1];k=$j(n).text().length}else{if(o<l.length-1){n=l[o+1]}}if(!n&&m.parent()[0]!==h._container[0]){n=m.parent()[0]}if(n){h._selection.moveToNodeAndCollapse(n,true,k)}}m.remove()});var e=this._container.children("[data-jive-statusInputadd!=true]");if(!$j.browser.msie){e=e.filter(":not(:last)")}e.filter("br").not("[_moz_dirty]").each(function(){$j(this).replaceWith("<br />")});e=e.not("br");if(e.length>0){var b,f=0,g=function(j){return/^style$/i.test(j.nodeName||"")},i=function(j){if(/^(p|div)$/i.test(j.tagName)){return f++>0}return false};e.each(function(){var j=$j(this);if(g(this)){j.remove()}else{if(i(this)){j.before('<br data-statusInputadd="true" />')}b=document.createTextNode(j.text());h._container[0].replaceChild(b,this)}});if(this._selection){this._selection.moveToNodeAndCollapse(b,true,b.nodeValue.length)}}this._previousPasteVal=this._container.text();this._previousSanitizedHTML=this._container.html()},resetText:function(){this._setText("");this._replacedInitialText=false;this.emit("characterLenMsg","ok",{charCount:this.getCharCount()})},handleAtMentionButtonClick:function(){this._replacedInitialText=true;var a=this._selection==null?null:this._selection.getRangeStartContainer();if(this._selection==null||$j(a).parents("#"+this._container.attr("id")).length==0||this._container.contents().length==0){this._createNewSelectionUtil()}else{this._selection.alignRangeWithNearestTextNode(a)}},getCharCount:function(){if(this.mobileUI){return this._container.val().length}else{return this._container.text().length}},_setText:function(a){if(this._mobileEditor){this._container.val(jive.util.unescapeHTML(a))}else{this._container.html(a)}},_focus:function(a){this._container.focus()},_createNewSelectionUtil:function(){var a=false;if($j.browser.msie){if(this._container.contents().length==0){this._selection=null;return}}else{var b=this._container[0].lastChild;if(!b){this.sanitizeHTML();b=this._container[0].lastChild}a=b.nodeName.toLowerCase()=="br"}this._selection=new jive.Selection(this._container[0].lastChild,a)},_getTokens:function(){return jive.StatusInput.StatusInput.Tokens},_getPatterns:function(){return jive.StatusInput.StatusInput.Patterns},_isMatch:function(b,a){return a.search(new RegExp(this._getPatterns()[b],"gi"))>-1},_matchUtil:function(b,a){return a.match(new RegExp(this._getPatterns()[b],"gi"))},_processToken:function(){if(!this._mobileEditor){var a=this._selection.getWordAtRange();if(a===""){this._processCompleteToken()}else{this._processPartialToken(a,this._selection.getRangeStartContainer())}}},_processCompleteToken:function(){if(!this._dd.isVisible()){var a=this._tokenCallbacks||[];a.forEach(function(b){b()});if(a.length<1){this._dd.hide()}this._tokenCallbacks=[]}},_processPartialToken:function(f,d){var c=[],e=this._getTokens(),a=false,b=this;Object.keys(e).forEach(function(g){var h=e[g],i=f.match(h.regExp);if(i){a=true;i.push(d);if(h.complete){c.push(function(){h.complete.apply(b,i)})}if(h.keypress){h.keypress.apply(b,i)}}});if(!a){this._dd.hide()}this._tokenCallbacks=c},_obtainData:function(b){var a,c;if(!jive.StatusInput.StatusInput.dataCache.hasOwnProperty(b)){c=$j.getJSON(b);c.then(function(d){jive.StatusInput.StatusInput.dataCache[b]=d})}else{a=new $j.Deferred();a.resolve(jive.StatusInput.StatusInput.dataCache[b]);c=a.promise()}return c},_obtainSearchData:function(a){return this._obtainData(jive.rest.url("/emention/search/")+encodeURI(a)+"*")}});jive.StatusInput.StatusInput.dataCache={};jive.StatusInput.StatusInput.instances={};$j(document).asyncReady(function(){window.setInterval(function(){jive.StatusInput.StatusInput.dataCache={}},300000)});jive.StatusInput.StatusInput.sanitizeHTMLIntervalHandler=function(){for(var a in jive.StatusInput.StatusInput.instances){jive.StatusInput.StatusInput.instances[a].sanitizeHTML()}};jive.StatusInput.StatusInput.getRegExpsFromPatterns=function(a){var b={};Object.keys(a).forEach(function(c){var d=a[c],e;if($j.isArray(d)){e=d.map(function(f){return"("+f+")"}).join("|")}else{e=d}b[c]=new RegExp(e)});return b};jive.StatusInput.StatusInput.Patterns={mention:"@([^@ ]+)?"};jive.StatusInput.StatusInput.Tokens={mention:{regExp:new RegExp(jive.StatusInput.StatusInput.Patterns.mention,"i"),keypress:function(b,a){var c=this;if(a&&a.length>=2){this._actionQueue.push(this._obtainSearchData(a)).then(function(d){c._dd.renderSearchData(d)})}else{}}}};jive.conc.observable(jive.StatusInput.StatusInput.prototype);jive.StatusInput.renderAttachmentsWrapper=function(b,a,c){if(b.attachments){a.append(jive.statusinput.attachments.renderAttachments({entry:{meta:b.attachments},removable:c}))}else{a.append(jive.statusinput.attachments.renderAttachments($j.extend({},b,{removable:c})))}if(c){a.slideDown("fast",function(){$j(this).animate({opacity:1},500)})}else{a.css("opacity","1").show()}jive.StatusInput.bindAttachment(a.find("ul.j-attached-items"),c)};jive.StatusInput.renderAttachmentWrapper=function(b,a,c){a.append(jive.statusinput.attachments.renderAttachment($j.extend(b,{removable:c})))};jive.StatusInput.bindAttachment=function(b,d){var a=0,c;b.find("li:visible").each(function(){a+=$j(this).outerWidth()});b.css("width",a+"px").data("innerWidth",a);c=b.width()-b.closest(".j-attachment-container").width();if(c>0&&d){b.animate({left:(c*-1-40)},300)}b.find("li a.j-attach-anchor").unbind("hover").hover(function(){$j(this).find(".j-icon-play").stop().fadeTo("fast",0.6)},function(){$j(this).find(".j-icon-play").stop().fadeOut("fast")});b.parent().find(".j-attachment-arrow").unbind().mousedown(function(){try{var g;var i=$j(this).outerWidth()*2;c=b.width()-b.closest(".j-attachment-container").width();var f=parseInt(b.css("left"));if(isNaN(f)){f=0}if($j(this).hasClass("j-attachment-arrow-right")&&c>0){g=f+(c+i);b.stop().animate({left:(-c-i)},g*5,"linear")}else{if(c>0){g=f*-1;b.stop().animate({left:0},g*5,"linear")}}}catch(h){console.log(h)}}).mouseup(function(){b.stop();return false}).click(function(){return false});if(!d){jive.StatusInput.sizeContainer(b.parent().parent())}else{jive.StatusInput.showArrows()}};$j(window).resize((function(){var a;return function(){var b=$j(window).width();if(a&&b!==a){jive.StatusInput.sizeContainer()}a=b}})());jive.StatusInput.sizeContainer=function(b){var a;b=b||$j(document);b.find(".j-attachment-container:visible:has(.j-attached-items)").hide().each(function(){var c=$j(this),d=c.closest(".jive-table-cell-activity"),f=c.closest(".j-wall-repost-content"),g=c.parent(),e;if(d.length>0){e=d.width()}else{if(f.length>0){e=f.width()}else{if(c.closest(".j-wall-form").length>0){e=0}else{if($j.browser.msie){e=g.width()-12}else{e=g.width()}}}}a=c.find(".j-attached-items").data("innerWidth")||Number.POSITIVE_INFINITY;if(e>0){$j(this).width(Math.min(e,a)).show()}else{c.show()}});jive.StatusInput.showArrows(b)};jive.StatusInput.showArrows=function(a){a=a||$j(document);a.find(".j-attached-items:visible").each(function(){var c=$j(this),b=c.parent();if(b.innerWidth()<c.innerWidth()){b.find(".j-attachment-arrow").css("display","block");c.css("margin","0 20px")}else{b.find(".j-attachment-arrow").hide();c.css({margin:"0",left:0})}})}};