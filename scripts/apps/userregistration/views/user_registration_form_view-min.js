jive.namespace("UserRegistration");jive.UserRegistration.RegistrationFormView=jive.AbstractView.extend(function(a){a.init=function(c){var b=this;b.options=c||{};b.inlineValidationFields=["username","email","name","firstname","lastname","password"];b.passwordStrengthView=new jive.UserRegistration.PasswordStrengthView(c);this.passwordStrengthView.addListener("passwordstrength",function(e,d){b.emitP("passwordstrength",e).addCallback(function(f){d.emitSuccess(f)})});if(c.form){b.form=c.form}$j(function(){if(c.page&&c.form){b.initPageForm()}else{var d=$j("#jive-nav-link-reg, #jive-guest-link-reg");d.click(function(f){b.initModalForm();f.preventDefault()})}})};a.initPageForm=function(){var b=this;var c=$j("#jive-user-registration-form");b.setupForm(c);b.passwordStrengthView.initView();b.focusOnFirstInput(c)};a.initModalForm=function(){var b=this;if(!b.form){b.showSpinner();b.emitP("register").addCallback(function(c){b.form=c;b.renderForm();b.passwordStrengthView.initView()}).always(function(){b.hideSpinner()})}else{b.renderForm()}};a.renderForm=function(){var b=this;var c=$j(jive.user.registration.modal(b.form));b.setupForm(c);c.lightbox_me({destroyOnClose:true,closeClick:false,onLoad:function(){b.focusOnFirstInput(c)}})};a.focusOnFirstInput=function(b){b.find(":input:first").focus()};a.setupForm=function(c){var b=this;b.attachInlineValidationHandlers(c);b.attachTermsHandler(c);b.attachSaveHandler(c);b.attachCancelHandler(c);b.determineTimeZone(b.form);b.decorateFields(c);b.attachUsernameCaptchaHandler(c)};a.attachUsernameCaptchaHandler=function(b){b.find(".field[name='username']").change(function(){a.updateRegistrationCaptcha(b)})};a.attachInlineValidationHandlers=function(c){var b=this;$j(b.inlineValidationFields).each(function(d,e){c.find(".field[name='"+e+"']").blur(function(){b.validateSingleField($j(this),e)})});c.find(".field[name='passwordconfirm']").blur(function(){var d=b.findViewFieldByName("password").val();b.confirmPassword(d,$j(this))})};a.attachTermsHandler=function(c){var b=this;c.find("#js-reg-terms-link").click(function(d){window.open($j(this).attr("href"),"jive_terms_and_conditions");d.preventDefault()})};a.attachSaveHandler=function(c){var b=this;c.find("input[name='save']").click(function(d){b.submitForm($j(this));d.preventDefault()})};a.attachCancelHandler=function(c){var b=this;if(b.options.page){c.find("input[name='cancel']").click(function(d){window.history.back();d.preventDefault()})}};a.determineTimeZone=function(c){var b=jstz.determine_timezone().timezone;if(b){c.timeZoneID=b.olson_tz}};a.decorateFields=function(c){var b=c.find("input[data-field-type='url']");b.attr("placeholder","http://");if(b.placeHeld){b.placeHeld()}};a.submitForm=function(c){var b=this;if(c.attr("disabled")!="disabled"){c.attr("disabled","disabled");b.showSpinner();b.gatherFormValues();b.hideGeneralErrors();b.emitP("submit",b.form).addCallback(function(d){if(d.moderated){b.displayModerationMessage()}else{b.attemptLogin(d)}}).addErrback(function(d){$j(d.fields).each(function(e,g){var f=b.findViewFieldByName(g.name);b.updateFieldValue(g,f);b.showFieldErrors(g,f)});b.updateRegistrationCaptcha($j(b.form))}).always(function(){b.hideSpinner();c.removeAttr("disabled")})}};a.updateRegistrationCaptcha=function(b){var d=b.find(".field[name='humanvalidation']");if(d.length>0){var g=b.find(".field[name='username']").val();var f=$j("#js-captcha");var e=f.find("img");var c=$j.deparam.querystring(e.attr("src"));c.username=g;e.attr("src",$j.param.querystring(e.attr("src"),c))}};a.attemptLogin=function(d){var b=this;var e=d.usernameIsEmail?b.findModelFieldByName("email").val:b.findModelFieldByName("username").val;var c={username:e,password:b.findModelFieldByName("password").val};if(d.loginCaptcha){c=$j.extend(c,{captcha:d.loginCaptcha})}b.showSpinner();b.emitP("login",c).addCallback(function(){b.handleLogin()}).addErrback(function(){b.handleLogin()}).always(function(){b.hideSpinner()})};a.handleLogin=function(){var b=this;if(!b.options.page){b.emit("close")}};a.displayModerationMessage=function(){var c=this;var b=(c.options.page)?$j("#jive-register-formblock"):$j("#jive-user-registration-form-modal").find(".jive-modal-content");b.html(jive.user.registration.accountPendingApproval())};a.gatherFormValues=function(){var b=this;var c=$j("#jive-user-registration-form .field");c.each(function(e,g){var f=$j(g);var d=b.findModelFieldByName(f.data("field-name"));if(d){d.val=b.getValFromField(d.type,f)}else{console.warn("No corresponding field in model found for field "+g.name)}})};a.getValFromField=function(d,c){var b=this;try{if(d=="address"){return b.getAddressValue(c)}else{if(d=="boolean"){return b.getBooleanValue(c)}else{if(d=="date"){return b.getDateValue(c)}else{if(b.isCheckbox(c)){return b.getCheckboxValue(c)}else{return $j.trim(c.val())}}}}}catch(f){console.log(f)}return null};a.getAddressValue=function(b){return{street1:b.find("input.street1").val(),street2:b.find("input.street2").val(),city:b.find("input.city").val(),state:b.find("input.state").val(),zip:b.find("input.zip").val(),country:b.find("input.country").val()}};a.getDateValue=function(b){return b.find("input").val()};a.getBooleanValue=function(b){return b.find("input").val()};a.isCheckbox=function(b){return b.attr("type")=="checkbox"};a.getCheckboxValue=function(b){return b.is(":checked")};a.showFieldErrors=function(f,c){var b=this;if(c&&c.length>0){b.hideFieldErrors(f);if(f.errors.length>0){var e=jive.user.registration.errors(f);var d=$j('.j-form-field-errors[data-field-name="'+f.name+'"]');if(d.length==1){d.html(e);d.fadeIn("fast")}else{console.error("No valid error container found for field name "+f.name)}}}else{b.addGeneralError(f)}};a.addGeneralError=function(b){$j("#j-form-errors").closest(".jive-error-box").show();$j(b.errors).each(function(c,d){$j("#j-form-errors").append("<li>"+jive.user.registration.localizedFieldError(d)+"</li>")})};a.hideGeneralErrors=function(){$j("#j-form-errors").closest(".jive-error-box").hide();$j("#j-form-errors").children().remove()};a.hideFieldErrors=function(b){$j('.j-form-field-errors[data-field-name="'+b.name+'"]').fadeOut("fast")};a.updateFieldValue=function(c,b){if(c&&b.length>0){if(c.val){b.val(c.val)}}};a.findViewFieldByName=function(b){return $j("#jive-user-registration-form .field[data-field-name='"+b+"']")};a.findModelFieldByName=function(b){var c=null;$j(this.form.fields).each(function(d,e){if(e.name==b){c=e;return false}});return c};a.validateSingleField=function(e,d){var b=this;var f=e.val();if(f&&f.length>0){f=$j.trim(f);var c=b.findModelFieldByName(d);b.emitP("validate",{name:d,val:b.getValFromField(c.type,e)}).addErrback(function(g){b.showFieldErrors(g,e);b.updateFieldValue(g,e)}).addCallback(function(g){b.hideFieldErrors(g);b.updateFieldValue(g,e)})}};a.confirmPassword=function(c,d){var b=this;var e=d.val();if(e!=c){b.showFieldErrors({name:"passwordconfirm",errors:[{code:4001,message:jive.user.registration.passwordMatchErrorMessage()}]},d)}else{b.hideFieldErrors({name:"passwordconfirm"})}}});