define("jive.Feedback.Main",["jive.Feedback.Feedback","jive.Feedback.FeedbackSource","jive.Feedback.FeedbackEndpointSource","jive.Feedback.FeedbackButton","jive.Feedback.FeedbackForm","jive.Feedback.FeedbackPreview"],function(b,e,f,a,c,d){return jive.oo.Class.extend(function(g){var h=jQuery;g.init=function(j){var i=this;this.isAvailable=false;this.baseFeedbackParams=j;this.feedbackSource=new e();this.endpointSource=new f();this.button=new a();this.button.addListener("click",function(){i.showForm()});this.showButton()};g.showButton=function(){this.hideElements();this.button.show()};g.showForm=function(){var i=this;this.form=this.showComponent(c,i.feedback);this.form.addListener("submit",function(j){i.feedback=i.buildFeedback(j);i.showPreview(i.feedback)}).addListener("close",function(j){i.feedback=i.buildFeedback(j)});this.verifyAvailability().addCallback(function(j){i.isAvailable=j;if(!j){i.showAvailabilityError()}})};g.showPreview=function(j){var k=this.prepareFeedback(j),i=this;this.preview=this.showComponent(d,k);this.preview.addListener("submit",function(){i.preview.showSpinner();if(!i.isAvailable){i.verifyAvailability().addCallback(function(l){if(l){i.submitFeedback(j)}else{i.showAvailabilityError();i.failedToSubmitFeedback()}})}else{i.submitFeedback(j)}})};g.submitFeedback=function(j){var i=this;i.feedbackSource.save(j).addCallback(function(){delete i.feedback;i.preview.success()}).addErrback(function(){i.failedToSubmitFeedback()})};g.failedToSubmitFeedback=function(){var i=this;i.hideElements();jive.conc.nextTick(function(){i.showPreview(i.feedback)})};g.verifyAvailability=function(){var j=new jive.conc.Promise(),i=this;this.endpointSource.findAll().addCallback(function(){j.emitSuccess(true)}).addErrback(function(){j.emitSuccess(false)});return j};g.showAvailabilityError=function(){var i=h(jive.feedback.availabilityError());i.message({style:"error"})};g.showComponent=function(j,n){var m=new j(n),l=false,i=this;this.hideElements();m.show();function k(){if(!l){i.showButton();l=true}m.removeListener("close",k)}m.addListener("close",k);h(document).one("keyup",function(o){if(o.keyCode==27){k()}});return m};g.hideElements=function(){this.button.detach();if(this.form){this.form.remove()}if(this.preview){this.preview.remove()}};g.buildFeedback=function(i){return new b(h.extend({},this.baseFeedbackParams,i))};g.prepareFeedback=function(i){return h.extend({},i,{comments:this.formatText(i.comments)})};g.formatText=function(j){var i=j.split(/\n\s*\n/);return"<p>"+i.map(function(k){return jive.util.escapeHTML(k)}).join("</p><p></p><p>")+"</p>"}})});