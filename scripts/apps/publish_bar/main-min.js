jive.namespace("PublishBar");jive.PublishBar.Main=jive.oo.Class.extend(function(a){jive.conc.observable(this);a.init=function(d){var c=this;this.objectID=d.objectDescriptor?d.objectDescriptor.id:-1;this.objectType=d.objectType||-1;var b=d.initData||{};this.publishBarSource=new jive.PublishBar.PublishBarSource();this.placeViewContainer=$j("#js-publishbar-place-selection");this.organizeContainer=$j("#js-publishbar-organize");this.collaborationContainer=$j("#js-publishbar-collaboration");this.loadingContainer=$j("#js-publishbar-loading");this.visibility=b.visibilityBean.visibility;this.invitationsEnabled=b.visibilityBean.systemInvitationsEnabled;if(this.visibility=="place"&&b.visibilityBean.placeSelected){this.containerID=b.visibilityBean.placeItemBean.id;this.containerType=b.visibilityBean.placeItemBean.type;this.originalContainer={containerID:this.containerID,containerType:this.containerType}}$j("#js-publishbar-select :radio").change(function(){c.setVisibility($j(this).val())});if(b.visibilityBean.placeSelected){this.initPlaceSelectedJavascript(b)}else{this.initVisibilityJavascript(b)}this.spinner=null;jive.acclaim.addListener("beforeFetch",a.setSpinnerVisibility.bind(this,"show"));jive.acclaim.addListener("afterFetch",a.setSpinnerVisibility.bind(this,"hide"))};a.setSpinnerVisibility=function(b){var d=$j("#js-publishbar-changePlace").closest(".j-js-place-view-info").find(".j-js-publish-bar-acclaim-container"),c={inline:true,showLabel:false,size:"small"};d.css("position","relative");if(b==="show"&&!this.spinner){this.spinner=new jive.loader.LoaderView(c);this.spinner.prependTo(d)}else{if(b==="hide"&&this.spinner){this.spinner.destroy();this.spinner=null;d.find(".j-loading-container").remove()}}};a.setVisibility=function(c){var b=this;var d=b.visibility;b.visibility=c;if(d!="place"&&c=="place"&&typeof(b.containerID)!="undefined"){return b.selectPlace(b.containerType,b.containerID)}var f=new jive.loader.LoaderView({showLabel:false,size:"small"});f.appendTo(this.loadingContainer);var e=(b.objectType<0||b.objectID<0)?"view":"edit";this.publishBarSource.get(e,{objectType:b.objectType,objectID:b.objectID,visibility:c}).addCallback(function(g){f.getContent().remove();f.destroy();b.renderVisibilityContainer(g.visibilityBean);b.renderOrganizeContainer(g.organizeBean);b.renderCollaborationContainer(g.optionsBean);b.initVisibilityJavascript(g)})};a.selectPlace=function(f,c){var b=this;var e=new jive.loader.LoaderView({showLabel:false,size:"small"});e.appendTo(this.loadingContainer);var d=(b.objectType<0||b.objectID<0)?"view":"edit";this.publishBarSource.get(d,{objectType:this.objectType,objectID:this.objectID,visibility:"place",containerType:f,containerID:c}).addCallback(function(g){if(f!=14||c!=1){b.containerType=f;b.containerID=c}e.getContent().remove();e.destroy();b.renderPlaceViewContainer(g.visibilityBean.placeItemBean);b.renderOrganizeContainer(g.organizeBean);b.renderCollaborationContainer(g.optionsBean);b.initPlaceSelectedJavascript(g)})};a.renderVisibilityContainer=function(b){this.placeViewContainer.hide().empty();$j("ul#js-publishbar-select li div.j-share-to-option").hide().empty();if(b.showVisibility){$j("#js-publishbar-option-"+b.visibility).empty().append($j(jive.publishbar.visibility($j.extend({communityFeatureVisible:jive.global.communityFeatureVisible},b)))).show()}};a.renderPlaceViewContainer=function(b){$j("ul#js-publishbar-select li div.j-share-to-option").hide().empty();this.placeViewContainer.empty().append($j(jive.publishbar.placeView(b))).show()};a.renderOrganizeContainer=function(c){var b=this.organizeContainer.clone();this.organizeContainer.empty().append($j(jive.publishbar.organize(c)));this.transposeInputs(b,this.organizeContainer)};a.renderCollaborationContainer=function(b){if(b.showOptionsLink){var c=this.collaborationContainer.clone();this.collaborationContainer.empty().append($j(jive.publishbar.collaborationOptions(b))).show();this.transposeInputs(c,this.collaborationContainer)}else{this.collaborationContainer.empty().hide()}};a.transposeInputs=function(d,b){var c=this;$j(d).find("input").each(function(){var e=$j(this);$j(b).find("input#"+e.attr("id")).each(function(){var f=$j(this);if(e.attr("type")=="radio"){}else{c.transposeNonRadioInput(e,f)}})})};a.transposeNonRadioInput=function(d,b){if(b.prop("disabled")){}var c=b.attr("type");if(c=="checkbox"){if(!b||$j(b).closest("li").find("input").length>1){return}b.prop("checked",d.prop("checked"))}else{b.val(d.val())}};a.initVisibilityJavascript=function(c){var b=this;if(c.visibilityBean.privateVisibility){this.initPrivateVisibilityJavascript(c.optionsBean)}else{this.destroyPrivateVisibilityJavascript()}if(c.visibilityBean.placeVisibility){this.initPlaceVisibilityJavascript()}else{if(c.visibilityBean.peopleVisibility){this.initPeopleVisibilityJavascript(c.visibilityBean.users)}else{if(c.visibilityBean.allVisibility){if(c.visibilityBean.personalBlog){this.initAllVisibilityJavascript()}}}}this.initTagJavascript(-1,-1);this.initOptionsJavascript(c.optionsBean);this.manageModerationWarning(c);jive.localexchange.emit("initVisibilityJs",c)};a.initPlaceSelectedJavascript=function(c){var b=this;$j("#js-publishbar-changePlace").click(function(d){b.setVisibility("place");d.preventDefault()});this.initTagJavascript(c.visibilityBean.placeItemBean.type,c.visibilityBean.placeItemBean.id);this.initOptionsJavascript(c.optionsBean);this.manageModerationWarning(c);jive.localexchange.emit("initPlaceSelectedJs",c)};a.initPlaceVisibilityJavascript=function(){var b=this;this.jivePublishBarPlace=new jive.PublishBar.PlaceMain({objectType:this.objectType});this.jivePublishBarPlace.addListener("selectPlace",function(d,c){b.selectPlace(d,c)});$j("#js-publishbar-option-place").find("#js-publishbar-place-input").prop("required","required")};a.initPeopleVisibilityJavascript=function(b){b=b?b:[];this.peopleAutocomplete=new jive.UserPicker.Main({multiple:true,valueIsUsername:true,emailAllowed:this.invitationsEnabled,listAllowed:true,canInvitePartners:true,$input:$j("#js-publishbar-users"),startingUsers:{users:b,userlists:[]},selectionCallbacks:[this.decorateGuestUsers],userMessages:[this.getUserInviteMessage()]});$j("#js-visibility-people").find("input[name='publishBar.users']").prop("required","required")};a.initAllVisibilityJavascript=function(){$j("#js-publishbar-createblog-change").click(function(b){$j("#js-publishbar-createblog-default").hide();$j("#js-publishbar-createblog").show();b.preventDefault()});$j("#js-publishbar-createblog").keypress(function(b){if(b.keyCode==10||b.keyCode==13){b.preventDefault()}})};a.initPrivateVisibilityJavascript=function(b){if(b.authorsBean){$j("#js-publishbar-option-private").append('<input type="hidden" id="private-default-authorPolicy" name="publishBar.authorPolicy" value="'+b.authorsBean.authorPolicySingleValue+'"/>')}};a.destroyPrivateVisibilityJavascript=function(){$j("#js-publishbar-option-private").remove("#private-default-authorPolicy")};a.initTagJavascript=function(d,c){var b=this;this.publishBarTagSetSupport=new PublishBarTagSetSupport($j("#js-publishbar-tag-input"));this.tagAutocomplete=new jive.Filters.TagAutocomplete($j("#js-publishbar-tag-input"),{containerType:d,containerID:c}).addListener("change",function(){b.publishBarTagSetSupport.suggestCategories()})};a.initOptionsJavascript=function(b){if(b.showOptionsLink){this.initCollaborationToggleJavascript()}if(b.showAuthors){this.initDocumentAuthorsJavascript(b.authorsBean)}if(b.showApprovers){this.initDocumentApproversJavascript(b.approversBean.approvers)}if(b.showCommentOptions){this.initCommentOptionsJavascript(b.commentOptionsBean)}if(b.showBlogPostPublishDate){this.initBlogPostPublishDateJavascript(b.blogPostPublishDateBean)}if(b.showPollOptions){this.initPollOptionsJavascript()}};a.initDocumentAuthorsJavascript=function(d){var g=d.authors||[];var f=[];if(this.peopleAutocomplete&&this.peopleAutocomplete.getSelectedUsersAndLists()){var c=this.peopleAutocomplete.getSelectedUsersAndLists().users||[];f=$j.map(c,function(k){var j=false;$j.each(g,function(l,m){if((k.id==-1&&jive.util.equalsIgnoreCaseAndPadding(k.email,k.email))||(k.id==m.id&&k.objectType==m.objectType)){j=true;return true}});if(j){return null}var i=$j.extend(true,{},k);i.excluded=true;return i})}$j.merge(g,f);var b=this;var e={multiple:true,valueIsUsername:true,emailAllowed:b.invitationsEnabled,listAllowed:true,$input:$j("#js-publishbar-docAuthors"),startingUsers:{users:g,userlists:[]}};var h=b.getEntitlementCheckObject();if(h){e=$j.extend(e,{object:h,entitlement:b.getAuthorEntitlementCheckMask(),userMessages:[b.getUserPermissionsMessage()],listMessages:[b.getListPermissionsMessage()]})}this.docAuthorAutocomplete=new jive.UserPicker.Main(e);if(d.forceAuthorList){this.docAuthorAutocomplete.setNoPicker(true);this.peopleAutocomplete.addListener("selectedUsersChanged",function(l){if(l.changes&&l.changes.added){$j("#js-publishbar-docAuthorPolicy-"+d.authorPolicyMultipleValue).prop("checked",true).change();var k=b.docAuthorAutocomplete.getSelectedUsersAndLists(true),i=k.users,j=k.userlists;if(l.changes.added.users){j.push(l.changes.added);b.docAuthorAutocomplete.setLists(j)}else{i.push(l.changes.added);b.docAuthorAutocomplete.setUsers(i)}}})}if(!d.defaultAuthorPolicySelected||d.forceAuthorList){$j("#js-publishbar-docAuthorDetails").show()}else{$j("#js-publishbar-docAuthorDetails").hide()}$j("#js-publishbar-docDefaultAuthorshipPolicy").val(d.defaultAuthorPolicy);$j("#js-publishbar-docAuthorsOption").click(function(){if($j(this).is(":checked")){$j("#js-publishbar-docAuthorDetails").show();if($j('#js-publishbar-docAuthorDetails li:visible input[id="js-publishbar-docAuthorPolicy-'+d.defaultAuthorPolicy+'"]').length==1){$j("#js-publishbar-docAuthorPolicy-"+d.defaultAuthorPolicy).prop("checked",true)}else{$j($j('#js-publishbar-docAuthorDetails li:visible input[name="publishBar.authorPolicy"]')[0]).prop("checked",true)}if(d.forceAuthorList){$j("#js-publishbar-docAuthors-multiple").show()}}else{$j("#js-publishbar-docAuthorDetails").hide();$j("#js-publishbar-docAuthorPolicy-"+d.defaultAuthorPolicy).prop("checked",true);$j("#js-publishbar-docAuthors-multiple").hide()}});$j('#js-publishbar-docAuthorDetails input[name="publishBar.authorPolicy"]').change(function(){if($j(this).is(":checked")&&$j(this).val()==d.authorPolicyMultipleValue){$j("#js-publishbar-docAuthors-multiple").show()}else{$j("#js-publishbar-docAuthors-multiple").hide()}})};a.initDocumentApproversJavascript=function(c){var b=this;c=c?c:[];var e={multiple:true,valueIsUsername:true,listAllowed:true,$input:$j("#js-publishbar-docApprovers"),startingUsers:{users:c,userlists:[]}};var d=b.getEntitlementCheckObject();if(d){e=$j.extend(e,{object:d,entitlement:b.getApproverEntitlementCheckMask(),userMessages:[b.getUserPermissionsMessage()],listMessages:[b.getListPermissionsMessage()]})}window.docApproversAutocomplete=new jive.UserPicker.Main(e);$j("#js-publishbar-docApproversOption").click(function(){if($j(this).is(":checked")){$j("#js-publishbar-docApproversDetails").show();$j("#js-publishbar-docApproversDetails").find("input[name='publishBar.approvers']").prop("required","required")}else{$j("#js-publishbar-docApproversDetails").hide();$j("#js-publishbar-docApproversDetails").find("input[name='publishBar.approvers']").removeProp("required")}})};a.initCommentOptionsJavascript=function(b){$j("#js-publishbar-commentOption").click(function(){if($j(this).is(":checked")){if(b.showAdditionalCommentOptions){$j("#js-publishbar-commentOptionDetails").show()}$j("#js-publishbar-commentStatusNone").prop("checked",true)}else{$j("#js-publishbar-commentOptionDetails").hide();$j("#js-publishbar-commentStatusOpen").prop("checked",true)}})};a.initBlogPostPublishDateJavascript=function(b){if(b.selectedDate){$j("#publishDate").attr("value",b.selectedDate)}else{$j("#publishDate").attr("value",b.defaultDate)}$j("#js-publishbar-blogPublishOption").click(function(){if($j(this).is(":checked")){$j("#js-publishbar-blogPublishDetails").show()}else{$j("#js-publishbar-blogPublishDetails").hide()}})};a.initPollOptionsJavascript=function(){$j("#js-publishbar-pollVoteOptions").click(function(){if($j(this).is(":checked")){$j("#js-publishbar-pollVoteDetails").show()}else{$j("#js-publishbar-pollVoteDetails").hide()}});$j("#js-publishbar-pollVoteDetails").find("input[name='activeMode']").change(function(){if($j("#active-later").is(":checked")){$j(".activeDatePicker").show()}else{$j(".activeDatePicker").hide();$j("#activeDate").val("")}});$j("#js-publishbar-pollVoteDetails").find("input[name='endsMode']").change(function(){if($j("#js-publishbar-pollVoteDetails").find("#ends-never").is(":checked")){$j("#js-publishbar-pollVoteDetails").find(".expiresDatePicker").hide();$j("#js-publishbar-pollVoteDetails").find("#endsDays").val("");$j("#js-publishbar-pollVoteDetails").find("#endsDate").val("")}else{if($j("#js-publishbar-pollVoteDetails").find("#ends-relative").is(":checked")){$j("#js-publishbar-pollVoteDetails").find(".expiresDatePicker").hide();$j("#js-publishbar-pollVoteDetails").find("#endsDate").val("")}else{if($j("#js-publishbar-pollVoteDetails").find("#ends-later").is(":checked")){$j("#js-publishbar-pollVoteDetails").find("#endsDays").val("");$j("#js-publishbar-pollVoteDetails").find(".expiresDatePicker").show()}else{if($j("#js-publishbar-pollVoteDetails").find("#ends-now").is(":checked")){$j("#js-publishbar-pollVoteDetails").find(".expiresDatePicker").hide();$j("#js-publishbar-pollVoteDetails").find("#endsDays").val("");$j("#js-publishbar-pollVoteDetails").find("#endsDate").val("")}}}}})};a.initCollaborationToggleJavascript=function(){$j("#js-publishbar-collab-link").click(function(b){$j(this).find("span.jive-icon-med").toggleClass("jive-icon-arrow-right").toggleClass("jive-icon-arrow-down");$j("#js-publishbar-collab").slideToggle("fast");b.preventDefault()})};a.getEntitlementCheckObject=function(){var b=this;if(b.visibility=="place"){if(b.objectID>0&&b.isPlaceUnchanged()){return{objectID:b.objectID||-1,objectType:b.objectType||-1}}else{return{objectID:b.containerID||-1,objectType:b.containerType||-1}}}else{return null}};a.isPlaceUnchanged=function(){return this.originalContainer&&this.originalContainer.containerID==this.containerID&&this.originalContainer.containerType==this.containerType};a.getAuthorEntitlementCheckMask=function(){return(this.objectID>0&&this.isPlaceUnchanged())?"VIEW":"VIEW_CONTENT"};a.getApproverEntitlementCheckMask=function(){return(this.objectID>0&&this.isPlaceUnchanged())?"VIEW":"VIEW_CONTENT"};a.getUserPermissionsMessage=function(){return{type:"warn",render:function(b){return jive.publishbar.userWithoutPermission(b)}}};a.getListPermissionsMessage=function(){return{type:"warn",render:function(b){return jive.publishbar.listWithoutPermission(b)}}};a.decorateGuestUsers=function(b){var c=b.find('[data-user-id="-1"]');c.append('<span class="jive-icon-sml jive-icon-info">')};a.getUserInviteMessage=function(){return{type:"info",render:function(b){return jive.publishbar.guestInvited({})}}};a.manageModerationWarning=function(c){var b=c?c.visibilityBean.placeItemBean:null;if(b&&b.prop.isModerated){$j("#js-publishbar-moderation-warning").show()}else{$j("#js-publishbar-moderation-warning").hide()}jive.localexchange.emit("placeChanged",b)}});