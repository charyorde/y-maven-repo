jive.namespace("ActivityStream");define("jive.ActivityStream.BuilderController",["jquery"],function(A){return jive.oo.Class.extend(function(B){jive.conc.observable(this);this.init=function(D){var C=this;C.editing=false;C.searchServices=new jive.ActivityStream.SearchServices();C.builderServices=new jive.ActivityStream.BuilderServices()};this.loadStream=function(D,E){var C=this;if(!C.editing){C.builderServices.getInitialViewData({selectedStreamID:D}).addCallback(function(I){C.bidirectional=I.bidirectional;C.currentStreamID=I.selectedStream.configuration.id;C.sortSpecifiedItems(I.selectedStream);var H="suggested";if(!I.initialResultSet.people.length&&!I.initialResultSet.places.length){H="places"}C.searchView=new jive.ActivityStream.BuilderSearchView({searchPage:H});C.searchResultsView=new jive.ActivityStream.BuilderSearchResultsView({searchType:H,selectedStream:I.selectedStream,approvalsEnabled:I.approvalsEnabled,bidirectional:I.bidirectional});C.streamAssocView=new jive.ActivityStream.BuilderStreamAssociationsView({selectedStream:I.selectedStream,bidirectional:I.bidirectional});var G=C.generateMainViewTemplate(I);C.editing=true;if(!A("#j-streambuilder-css-link").length){A("head").append(jive.eae.activitystream.builder.headerCss())}A("#j-dynamic-pane").html(G);C.searchView.postRender();C.searchResultsView.postRender();C.streamAssocView.postRender();C.searchView.addListener("search",function(J,K){if(C.currentSearchPromise){C.currentSearchPromise.cancel();delete C.currentSearchPromise}C.currentSearchPromise=K;C.currentSearchPromise.addCallback(function(M,L){C.searchResultsView.updateResults(M,L);C.streamAssocView.expandToFill()});C.searchServices.search(J,C.currentSearchPromise)});C.searchResultsView.addListener("getItemAssociations",function(J,L,K){C.builderServices.getActivityStreams(J,L).addCallback(function(M){K.emitSuccess(M)})}).addListener("setItemAssociations",function(M,J,K,L,N){if(!M){M=C.currentStreamID}C.builderServices.setItemAssociations(J,M,K,L).addCallback(function(O){N.emitSuccess(O)})}).addListener("removeAllAssociations",function(J,M,L,K){C.builderServices.removeAllAssociations(J,M).addCallback(function(){K.emitSuccess();if(J==3&&M!=window._jive_current_user.ID){setTimeout(function(){jive.switchboard.emit("unfollow.user",jQuery.extend({},{id:M,labelIDs:L}))},200)}}).addErrback(function(O,N){K.emitError(O,N)})}).addListener("getPlaceBreadcrumbBean",function(J,L,K){C.searchServices.getBreadcrumbBean(J,L,K)}).addListener("getFollowersData",function(K,J){C.searchServices.getFollowerList(K,J)});C.streamAssocView.addListener("getItemAssociations",function(J,L,K){C.builderServices.getActivityStreams(J,L).addCallback(function(M){K.emitSuccess(M)})}).addListener("setItemAssociations",function(M,J,K,L,N){C.builderServices.setItemAssociations(J,M,K,L).addCallback(function(O){N.emitSuccess(O);if(K){C.searchResultsView.clearSelections()}})}).addListener("removeAllAssociations",function(J,M,L,K){C.builderServices.removeAllAssociations(J,M).addCallback(function(){K.emitSuccess();if(J==3&&M!=window._jive_current_user.ID){setTimeout(function(){jive.switchboard.emit("unfollow.user",jQuery.extend({},{id:M,labelIDs:L}))},200)}}).addErrback(function(O,N){K.emitError(O,N)})}).addListener("updateStreamConfig",function(J,K){C.builderServices.modifyConfig(J).addCallback(function(){K.emitSuccess()})}).addListener("deleteStream",function(J,K){C.builderServices.deleteStream(J,K).addCallback(function(L){C.emit("removeStream",L);K.emitSuccess()})});var F=A("#j-builder-init");if(F.length){F.find(".js-close-splash").click(function(J){J.preventDefault();J.stopPropagation();A(".j-builder-init").remove();A("#j-builder-help-arrows").show();A(document).one("click",function(){F.remove()})})}if(!I.initialResultSet.people.length&&!I.initialResultSet.places.length){C.searchView.changeSearchPage("places")}E.emitSuccess(I.selectedStream)})}else{C.builderServices.getActivityStream(D).addCallback(function(F){C.currentStreamID=D;C.sortSpecifiedItems(F);C.searchResultsView.updateSelectedStream(F);C.streamAssocView.reload(F);E.emitSuccess(F)})}};this.sortSpecifiedItems=function(C){C.specifiedPeople.sort(function(E,D){return E.displayName>D.displayName});C.specifiedPlaces.sort(function(E,D){return E.subject>D.subject})};this.generateMainViewTemplate=function(C){return A(jive.eae.activitystream.builder.main({viewData:C}))};this.getMainView=function(){return A("#stream-builder")};this.closeBuilder=function(){jive.switchboard.removeListener("associations.destroy");jive.switchboard.removeListener("associations.create");jive.switchboard.removeListener("follow.destroy");jive.switchboard.removeListener("follow.create");jive.switchboard.removeListener("follow.user");jive.switchboard.removeListener("unfollow.user");this.editing=false}})})