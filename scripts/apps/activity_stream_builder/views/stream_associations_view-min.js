jive.namespace("ActivityStream");jive.ActivityStream.BuilderStreamAssociationsView=jive.AbstractView.extend(function(a){this.init=function(b){var c=this;c.currentStream=b.selectedStream;c.bidirectional=b.bidirectional;c.droppableOptions={hoverClass:"bout-to-drop",tolerance:"pointer",activeClass:"drag-in-progress",drop:function(f,g){var e=$j("#j-js-asb-results").find(".ui-multidraggable"),d=[];e.each(function(){var j=$j(this),k=j.data("id"),h=j.data("objecttype"),i=j.find(".j-js-asb-search-item-assocs .j-js-specifics").data("streamids").length;d.push({type:h,id:k,sc:i})});if(d.length){c.addItems(d)}}}};this.getContent=function(){return $j("#current-stream")};this.getContentHeader=function(){return $j("#stream-header")};this.getContentList=function(){return $j("#stream-contents")};this.postRender=function(c){var e=this,d=e.getContent(),b=e.getContentList();b.droppable(e.droppableOptions);d.delegate(".j-js-asb-search-item-assocs","click",function(g){g.preventDefault();var f=$j(this);setTimeout(function(){var j=f.closest(".j-js-specified-item"),h=j.data("objecttype"),n=j.data("id"),l=f.find(".j-js-specifics"),m=l.data("labelsshown"),i=l.data("labeldata"),k="eae.activitystream.builder.followlink.removeall";if(e.bidirectional){k="profile.friends.remove.link"}e.emitP("getItemAssociations",h,n).addCallback(function(p){var o=$j(jive.eae.activitystream.builder.followInStreamsMenu({objectType:h,objectID:n,streams:p,removeAllAssnI18nKey:k}));o.popover({context:f,destroyOnClose:true,putBack:false,closeOtherPopovers:true,closeOnClickSelector:":not(.j-js-asb-search-item-assocs)",onLoad:function(){o.delegate("a.j-js-remove-all-assns","click",function(w){var x=$j(this),q=x.closest(".j-js-follow-in-streams-menu"),v=j.find(".j-js-followers-link"),s=v.data("labelsshown"),y=v.data("labeldata");var r=[];if(s&&y&&y.length){for(var t=0,u=y.length;t<u;t++){if(y[t].targetUserAMember){r.push(y[t].id)}}}e.emitP("removeAllAssociations",q.data("objecttype"),q.data("objectid"),r).addCallback(function(){o.trigger("close")});w.preventDefault()});o.delegate("input","change",function(w){var r=$j(this),v=f.find(".j-js-specifics"),t=v.data("streamids").length,u=r.val(),s=r.is(":checked"),q={};q[h]={};q[h][n]=t;e.emitP("setItemAssociations",u,[{type:h,id:n}],s,q).addCallback(function(){if(s){r.closest("label").addClass("selected")}else{r.closest("label").removeClass("selected");if(u==e.currentStream.configuration.id){o.trigger("close")}}})})}})})},100)});d.delegate(".j-js-remove-item","click",function(l){var f=$j(this),n=f.closest("li.j-js-specified-item"),g=n.data("objecttype"),h=n.data("id");var i=e.search(g,h),k={type:g,id:h},m=0,j={};j[g+""]={};if(g!=3){m=i.prop.followInfo.streamsAssociatedBean.streamIDs.length}else{m=i.prop.connections.streamsAssociatedBean.streamIDs.length}j[g+""][h+""]=m;e.emitP("setItemAssociations",e.currentStream.configuration.id,[k],false,j);l.preventDefault()});d.delegate(".j-js-type-toggle a","click",function(h){var g=$j(this),f=g.data("type");e.switchView(f);h.preventDefault()});d.delegate(".j-js-emails","click",function(g){var f=$j(this);if(f.data("selected")==true){e.currentStream.configuration.receiveEmails=false}else{e.currentStream.configuration.receiveEmails=true}e.emitP("updateStreamConfig",e.currentStream.configuration).addCallback(function(){f.replaceWith(jive.eae.activitystream.builder.emailOption({configuration:e.currentStream.configuration}))});g.preventDefault()});d.delegate(".j-js-delete-stream","click",function(h){var g=e.currentStream.configuration.id,f=$j(jive.eae.activitystream.builder.deleteStreamModal({streamID:g}));f.lightbox_me({destroyOnClose:true,centered:true,onLoad:function(){f.delegate("#stream-delete-submit-button","click",function(k){var j=$j(this),i=j.data("id");e.emitP("deleteStream",i).addCallback(function(){f.trigger("close")});k.preventDefault()})}});h.preventDefault()});jive.switchboard.addListener("associations.destroy",function(f){if(f.configuration.id==e.currentStream.configuration.id){e.removeItemsFromView(f.specifiedPeople.concat(f.specifiedPlaces))}else{e.handleSwitchboardModifies("remove",f)}});jive.switchboard.addListener("associations.create",function(f){if(f.configuration.id==e.currentStream.configuration.id){e.addItemsToView(f)}else{e.handleSwitchboardModifies("create",f)}});jive.switchboard.addListener("follow.destroy",function(f){e.removeItemsFromView([{id:f.objectID,type:f.objectType}])})};this.reload=function(b){var d=this,c=d.getContent();c.fadeOut("fast",function(){d.currentStream=b;c.html(jive.eae.activitystream.builder.streamAssociationList({streamViewBean:b}));c.fadeIn("fast",function(){d.getContentList().droppable(d.droppableOptions)})})};this.search=function(b,c,d,e){var f=this,h=f.currentStream,k=false,g=0;if(b==3){for(var j=h.specifiedPeople.length;g<j;g++){if(h.specifiedPeople[g].id==c&&h.specifiedPeople[g].type==b){if(d){k=h.specifiedPeople.splice(g,1)}else{if(e){h.specifiedPeople[g]=e;k=e}else{k=h.specifiedPeople[g]}}break}}}else{if(b==600||b==700||b==14){for(var j=h.specifiedPlaces.length;g<j;g++){if(h.specifiedPlaces[g].id==c&&h.specifiedPlaces[g].type==b){if(d){k=h.specifiedPlaces.splice(g,1)}else{if(e){h.specifiedPlaces[g]=e;k=e}else{k=h.specifiedPlaces[g]}}break}}}}return k};this.addItems=function(b){var h=this,f={};for(var d=0,c=b.length;d<c;d++){var e=b[d].type+"",g=b[d].id+"";if(!f[e]){f[e]={}}f[e][g]=b[d].sc}h.emitP("setItemAssociations",h.currentStream.configuration.id,b,true,f)};this.addItemsToView=function(d){var m=this,p=m.getContentList(),s,c=d.specifiedPeople,e=d.specifiedPlaces,h=0,f=0;for(var n=0,o=c.length;n<o;n++){if(!m.search(c[n].type,c[n].id,false)){m.currentStream.specifiedPeople.push(c[n]);s=$j(jive.eae.activitystream.builder.specifiedObject({object:c[n],justAdded:true}));p.find("ul.j-js-assoc-list[data-type=people]").prepend(s);var l=p.find("span.j-js-people-count").first(),r=parseInt(l.text());l.html(++r);h++}}for(var k=0,b=e.length;k<b;k++){if(!m.search(e[k].type,e[k].id,false)){m.currentStream.specifiedPlaces.push(e[k]);s=$j(jive.eae.activitystream.builder.specifiedObject({object:e[k],justAdded:true}));p.find("ul.j-js-assoc-list[data-type=places]").prepend(s);var g=p.find("span.j-js-places-count").first(),q=parseInt(g.text());g.html(++q);f++}}if(h&&!f){m.switchView("people")}else{if(!h&&f){m.switchView("places")}}if(h||f){m.flashBgColor(p,1,"#e9f3ff",400)}};this.possiblyUpdateItemData=function(f){var k=this,g=f.specifiedPeople,d=f.specifiedPlaces;for(var c=0,h=g.length;c<h;c++){k.search(g[c].type,g[c].id,false,g[c])}for(var b=0,e=d.length;b<e;b++){k.search(d[b].type,d[b].id,false,d[c])}};this.handleSwitchboardModifies=function(e,c){var f=this,k=f.getContent(),l=c.specifiedPeople.concat(c.specifiedPlaces),q=l.length;for(var h=0;h<q;h++){var p=l[h],m=k.find("li.j-js-specified-item[data-objecttype="+p.type+"][data-id="+p.id+"]");f.search(p.type,p.id,false,p);if(m.length){var o=m.find(".j-js-asb-search-item-assocs .j-js-specifics");if(o.length){var d=o.data("streamids"),n=o.data("assocwithcomms");if(e=="create"){var g;if($j.inArray(c.configuration.id,d)==-1){d.push(c.configuration.id);if(c.configuration.source.toLowerCase()=="communications"){n=c.configuration.id}}}else{var j=$j.inArray(c.configuration.id,d);if(j!=-1){d.splice(j,1);if(c.configuration.source.toLowerCase()=="communications"){n=0}}}var b={streamsAssociatedBean:{associatedWithCommunications:n,streamIDs:d}};o.replaceWith(jive.eae.activitystream.builder.streamsAssociatedButtonDetails({connectionData:b}))}}}};this.flashBgColor=function(c,h,f,b,d){var g=this;if(d==undefined){d=0}if(d<h){var e=c.css("background-color");c.animate({backgroundColor:f},b).animate({backgroundColor:e},b,null,function(){g.flashBgColor(c,h,f,b,d+1)})}else{c.css("background-color","")}};this.removeItemsFromView=function(h){var d=this,g=d.getContentList(),m=h.length;for(var f=0;f<m;f++){var k=h[f],b=d.search(k.type,k.id,true);if(b){if(k.type==3){var e=g.find("span.j-js-people-count").first(),l=parseInt(e.text());e.html(--l)}else{if(k.type==14||k.type==600||k.type==700){var c=g.find("span.j-js-places-count").first(),j=parseInt(c.text());c.html(--j)}}g.find("li.j-js-specified-item[data-objecttype="+k.type+"][data-id="+k.id+"]").remove()}}};this.switchView=function(c){var e=this,b=e.getContentList(),d=b.find(".j-js-type-toggle a[data-type="+c+"]");if(!d.hasClass("j-js-selected")){b.find(".j-js-type-toggle a").removeClass("j-js-selected selected");d.addClass("j-js-selected selected");b.find("ul.j-js-assoc-list:visible").hide();b.find("ul.j-js-assoc-list[data-type="+c+"]").show()}};this.expandToFill=function(){var d=this,b=d.getContentList(),c=$j("#stream-elements").height();if(b.height()<c){b.height(c)}else{b.css("height","")}}});