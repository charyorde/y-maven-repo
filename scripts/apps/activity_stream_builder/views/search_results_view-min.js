jive.namespace("ActivityStream");jive.ActivityStream.BuilderSearchResultsView=jive.AbstractView.extend(function(a){this.init=function(c){var b=this;b.ie7=$j.browser.msie&&$j.browser.version<8;if(b.ie7){$j(document).unbind("selectstart.draggable").bind("selectstart.draggable",function(d){if(b.resizingList){d.preventDefault()}})}b.followerPageCount=20;b.cancelSelectClasses=".j-js-asb-search-item-assocs, .j-js-add-to-current, .j-js-breadcrumb-button, .j-js-followers-link";b.MULTIDRAG_OPTIONS={cancel:b.cancelSelectClasses,revert:false,distance:(b.ie7?0:50),opacity:1,zIndex:5000,helper:function(){return jive.eae.activitystream.builder.jsDraggableHelper({count:b.getContent().find(".ui-multidraggable").length})},cursorAt:{bottom:35,left:-20},start:function(d){b.resizingList=true},stop:function(d){b.resizingList=false}};b.selectedStream=c.selectedStream;b.approvalsEnabled=c.approvalsEnabled;b.bidirectional=c.bidirecitonal};this.getContent=function(){return $j("#j-js-asb-results")};this.postRender=function(){var b=this,c=b.getContent();b.$suggestionsPage=$j("#j-asb-suggested");b.$peoplePlacesPage=$j("#j-asb-people-places");b.$peopleSection=b.$peoplePlacesPage.find(".j-js-people-results");b.$placesSection=b.$peoplePlacesPage.find(".j-js-places-results");jive.switchboard.addListener("associations.destroy",function(d){b.handleSwitchboardModifies("remove",d)});jive.switchboard.addListener("associations.create",function(d){b.handleSwitchboardModifies("create",d)});jive.switchboard.addListener("follow.destroy",function(d){b.handleSwitchboardFollows("remove",d)});jive.switchboard.addListener("follow.create",function(d){b.handleSwitchboardFollows("create",d)});jive.switchboard.addListener("follow.user",function(d){b.handleSwitchboardFollows("create",{objectType:3,objectID:d.id})});c.delegate(".j-js-followers-link","click",function(h){h.stopPropagation();var g=$j(this),d=g.closest(".j-js-search-result"),f=d.data("objecttype"),j=d.data("id"),i={activityType:"follow",objectType:f,objectID:j,count:b.followerPageCount,start:0};b.emitP("getFollowersData",i).addCallback(function(m){var n=b.buildSoyParams(m,i),l=b.renderFollowersModal(n),k={destroyOnClose:true,centered:true},e=l.lightbox_me(k);e.find(".jive-modal-content").endlessScroll({fireDelay:false,callback:function(o){if(n.moreResults){i.start=b.followerPageCount*o;b.emitP("getFollowersData",i).addCallback(function(p){b.appendUsersToFollowersModal(e,p,n)})}}})});h.preventDefault()});c.delegate(".j-js-asb-search-item-assocs","click",function(f){f.preventDefault();var d=$j(this);setTimeout(function(){var e=d.closest(".j-js-search-result"),g=e.data("objecttype"),l=e.data("id"),j=d.find(".j-js-specifics"),k=j.data("labelsshown"),h=j.data("labeldata"),i="eae.activitystream.builder.followlink.removeall";if(b.bidirectional){i="profile.friends.remove.link"}b.emitP("getItemAssociations",g,l).addCallback(function(n){var m=$j(jive.eae.activitystream.builder.followInStreamsMenu({objectType:g,objectID:l,streams:n,removeAllAssnI18nKey:i}));m.popover({context:d,destroyOnClose:true,putBack:false,closeOtherPopovers:true,closeOnClickSelector:":not(.j-js-asb-search-item-assocs)",onLoad:function(){m.delegate("a.j-js-remove-all-assns","click",function(u){var v=$j(this),o=v.closest(".j-js-follow-in-streams-menu"),t=e.find(".j-js-followers-link"),q=t.data("labelsshown"),w=t.data("labeldata");var p=[];if(q&&w&&w.length){for(var r=0,s=w.length;r<s;r++){if(w[r].targetUserAMember){p.push(w[r].id)}}}b.emitP("removeAllAssociations",o.data("objecttype"),o.data("objectid"),p).addCallback(function(){m.trigger("close")});u.preventDefault()});m.delegate("input","change",function(u){var p=$j(this),t=d.find(".j-js-specifics"),r=t.data("streamids").length,s=p.val(),q=p.is(":checked"),o={};o[g]={};o[g][l]=r;b.emitP("setItemAssociations",s,[{type:g,id:l}],q,o).addCallback(function(){if(q){p.closest("label").addClass("selected")}else{p.closest("label").removeClass("selected")}})})}})})},100)});$j("#stream-elements").delegate(".j-js-add-to-current","click",function(n){var d=$j(this),m=d.closest(".j-js-search-result"),h=[],o={},g,j,f;for(var l=0,p=m.length;l<p;l++){var k=$j(m[l]);g=k.data("objecttype"),j=k.data("id"),f=k.find(".j-js-asb-search-item-assocs .j-js-specifics").data("streamids").length;h.push({type:g,id:j});o[g]={};o[g][j]=f}if(h.length){b.emitP("setItemAssociations",null,h,true,o).addCallback(function(){})}n.preventDefault()});c.delegate(b.cancelSelectClasses,"mousedown",function(d){d.stopPropagation()});c.delegate("li.j-js-draggable","mousedown",function(d){$j(d.currentTarget).addClass("mousingdown")});c.delegate("li.j-js-draggable","mouseup",function(d){$j(d.currentTarget).removeClass("mousingdown")});c.delegate("li.j-js-draggable","click",function(d){d.preventDefault()});c.find("li.j-js-draggable").multidraggable(b.MULTIDRAG_OPTIONS)};this.renderFollowersModal=function(b){return $j(jive.soy.acclaim.renderAcclaimModal(b))};this.buildSoyParams=function(b,c){return{activityType:c.activityType,bidirectionalGraph:b.bidirectionalGraph,currentUserID:b.currentUserID,currentUserPartner:b.currentUserPartner,moreResults:b.moreResults,objectID:c.objectID,objectType:c.objectType,totalCount:b.totalCount,users:b.items,youID:b.currentUserID,youPartner:b.currentUserPartner}};this.appendUsersToFollowersModal=function(e,c,h){var i=c&&c.items?c.items:[];if(i.length>0){e.find(".j-js-private-bookmark-notification").remove();var b=e.find(".jive-modal-content tbody:visible");var f=b.parent().attr("id");var g=this.renderFollowersModal($j.extend({},h,{users:i}));var d=g.find("table#"+f+" tr");b.append(d.clone())}};this.handleSwitchboardModifies=function(e,c){var h=this,k=h.getContent(),l=c.specifiedPeople.concat(c.specifiedPlaces),q=l.length;for(var g=0;g<q;g++){var p=l[g],m=k.find("li.j-js-search-result[data-objecttype="+p.type+"][data-id="+p.id+"]:visible");if(m.length){var o=m.find(".j-js-asb-search-item-assocs .j-js-specifics");if(o.length){var d=o.data("streamids"),n=o.data("assocwithcomms");if(e=="create"){var f;if($j.inArray(c.configuration.id,d)==-1){d.push(c.configuration.id);if(h.selectedStream.configuration.id==c.configuration.id){m.addClass("j-in-current-stream")}if(c.configuration.source.toLowerCase()=="communications"){n=c.configuration.id}f=$j(jive.eae.activitystream.builder.jsAddBtnSuccessMessage({type:"new"}))}else{f=$j(jive.eae.activitystream.builder.jsAddBtnSuccessMessage({type:"repeat"}))}if(h.selectedStream.configuration.id==c.configuration.id){m.find(".j-js-add-to-current").after(f);f.slideDown("fast").delay(2000).slideUp("fast",function(){$j(this).remove()})}}else{var j=$j.inArray(c.configuration.id,d);if(j!=-1){d.splice(j,1);if(h.selectedStream.configuration.id==c.configuration.id){m.removeClass("j-in-current-stream")}if(c.configuration.source.toLowerCase()=="communications"){n=0}}}var b={streamsAssociatedBean:{associatedWithCommunications:n,streamIDs:d}};o.replaceWith(jive.eae.activitystream.builder.streamsAssociatedButtonDetails({connectionData:b}))}}}};this.handleSwitchboardFollows=function(e,f){var c=this,d=c.getContent(),h=d.find("li.j-js-search-result[data-objecttype="+f.objectType+"][data-id="+f.objectID+"]:visible");if(h.length){var g=h.find(".j-js-followers-link");if(g.length){var b=g.data("activity-count");if(e=="create"&&(f.objectType!=3||f.objectID!=window._jive_current_user.ID)){g.data("activity-count",b+1);g.html(""+(b+1));g.data("following",true)}else{if(g.data("following")&&(f.objectType!=3||f.objectID!=window._jive_current_user.ID)){g.data("following",false);g.data("activity-count",b-1);g.html(""+(b-1));if(f.objectType==3){if(c.approvalsEnabled){h.removeClass().addClass("j-disabled")}}}h.find(".j-js-asb-search-item-assocs").html(jive.eae.activitystream.builder.streamsAssociatedButtonDetails({connectionData:{streamsAssociatedBean:{streamIDs:[],associatedWithCommunications:false}}}));h.removeClass("j-in-current-stream")}}}};this.updateResults=function(h,f){var d=this,e=f.type;if(e=="suggested"){var g=$j(jive.eae.activitystream.builder.suggestedView({currentStreamID:d.selectedStream.configuration.id,allResults:h}));d.$suggestionsPage.html(g);d.$suggestionsPage.find("li.j-js-draggable").click(function(j){j.preventDefault()}).multidraggable(d.MULTIDRAG_OPTIONS);if(!d.$suggestionsPage.is(":visible")){d.$suggestionsPage.show();d.$peoplePlacesPage.hide()}}else{var c=[],b,i=false;if(e=="people-places"&&(h.people.length==0||(h.people.length==1&&h.people[0].id==window._jive_effective_user_id))&&h.places.length==0&&f.start==0&&f.value==""&&f.subfilters.people=="all"&&f.subfilters.places=="all"){d.$peoplePlacesPage.find("#people-places-search-results").hide();d.$peoplePlacesPage.find(".j-notmuch-here").show()}else{if(e=="people"||e=="people-places"){c=h.people;if(c.length>f.maxResults){i=true;c.splice(f.maxResults,1)}d.$peopleSection.find(".j-js-show-more-results").remove();if(f.start!=0){b=$j(jive.eae.activitystream.builder.searchResultItems({currentStreamID:d.selectedStream.configuration.id,items:c}));d.$peopleSection.find("ul").append(b)}else{b=$j(jive.eae.activitystream.builder.searchResultsSection({currentStreamID:d.selectedStream.configuration.id,type:"people",items:c}));d.$peopleSection.html(b)}if(i){d.$peopleSection.append(jive.eae.activitystream.builder.showMoreResultsButton({type:"people"}))}d.$peopleSection.find("li.j-js-draggable").click(function(j){j.preventDefault()}).multidraggable(d.MULTIDRAG_OPTIONS)}if(e=="places"||e=="people-places"){i=false;c=h.places;if(c.length>f.maxResults){i=true;c.splice(f.maxResults,1)}d.$placesSection.find(".j-js-show-more-results").remove();if(f.start!=0){b=$j(jive.eae.activitystream.builder.searchResultItems({currentStreamID:d.selectedStream.configuration.id,items:c}));d.$placesSection.find("ul").append(b)}else{b=$j(jive.eae.activitystream.builder.searchResultsSection({currentStreamID:d.selectedStream.configuration.id,type:"places",items:c}));d.$placesSection.html(b)}if(i){d.$placesSection.append(jive.eae.activitystream.builder.showMoreResultsButton({type:"places"}))}d.$placesSection.find("li.j-js-draggable").click(function(j){j.preventDefault()}).multidraggable(d.MULTIDRAG_OPTIONS)}d.$peoplePlacesPage.find(".j-notmuch-here").hide();d.$peoplePlacesPage.find("#people-places-search-results").show()}if(!d.$peoplePlacesPage.is(":visible")){d.$suggestionsPage.hide();d.$peoplePlacesPage.show()}}};this.updateSelectedStream=function(c){var b=this;b.selectedStream=c;b.getContent().find("li.j-js-draggable").each(function(){var d=$j(this);d.removeClass("j-in-current-stream");if($j.inArray(c.configuration.id,d.find(".j-js-specifics").data("streamids"))!=-1){d.addClass("j-in-current-stream")}})};this.clearSelections=function(){var b=this,c=b.getContent();c.find("li.j-js-draggable").removeClass("ui-selected ui-multidraggable push mousingdown")}});