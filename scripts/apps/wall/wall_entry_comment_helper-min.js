jive.namespace("Wall");jive.Wall.CommentHelper=function(l){var h=new jive.MicroBlogging.StatusInputs("#statusInputs-"+l.statusInputIdPostfix,{idPostfix:l.statusInputIdPostfix,allowTagCreation:false});var f=l.mobileUI||jive.rte.mobileUI;var i="message-"+l.statusInputIdPostfix;var d=new jive.shared.NotificationView($j("#"+i).parents(".jive-comment-content:first"),{info:".jive-info-box:first",warn:".jive-warn-box:first",error:".jive-error-box:first"});var k=new jive.shared.FormWaitingView($j("#statusInputs-"+l.statusInputIdPostfix).parents(".jive-comment-content"));this.getStatusInputVals=function(){return h.getSubmitVals(i)};this.resetStatusInput=function(){h.resetText(i);for(var m in h.statusInputs){h.statusInputs[m].getContainer().css("minHeight",0)}};var g=this;h.addListener("ready",function(){if(h&&h.getStatusInput(i)){if(f&&l.container.find("a.jive-js-wall-mention-button, a.jive-js-mention-button").length){l.container.find("a.jive-js-wall-mention-button, a.jive-js-mention-button").remove()}h.getStatusInput(i).addListener("characterLenMsg",function(m,n){jive.Wall.EditorView.handleCharacterLenMsg(m,n,l.container)}).addListener("atMentionFinished",function(q,o){if(q&&q.split("-").length==2){var n=q.split("-")[0],p=q.split("-")[1];var m=new jive.rte.EntitlementService({objectID:l.entitlementObjectID||0,objectType:l.entitlementObjectType||0,entitlement:"VIEW"});if(m&&n){m.checkEntitlement(n,p).addCallback(function(r){if(!r){var s="";if(n==3){s=jive.statusinput.mention_warnings.jsI18nHelper({key:"tinymce.jivemention.no_notification"})}else{if(n==700){s=jive.statusinput.mention_warnings.jsI18nHelper({key:"tinymce.jivemention.secret_group"})}else{s=jive.statusinput.mention_warnings.jsI18nHelper({key:"tinymce.jivemention.restricted_content"})}}$j("<p>"+o+" "+s+"</p>").message({style:"warn"})}})}}});l.container.find("a.jive-js-wall-mention-button, a.jive-js-mention-button").click(function(m){h.getStatusInput(i).handleAtMentionButtonClick(m);m.stopPropagation()})}});var a={type:"POST",contentType:"application/json; charset=utf-8",dataType:"json"};this.enableForm=function(){k.enableForm()};this.disableForm=function(){k.disableForm()};this.displayModeration=function(){d.warn(jive.i18n.getMsg("we.form.posted.moderation"))};this.displayError=function(m){d.error(m)};var e=null;function c(n){if(e!=null){n(e)}else{var m=function(o){e=o;n(e)};jive.Wall.CommentHelper.submitCommentDraft(m,l.wallEntryTypeID,l.statusInputIdPostfix)}}this.initMeta=jive.Wall.Main.prototype.initMeta;var b=[],j=l.meta||[];j.forEach(function(m){g.initMeta(m,b,l,l.container,c)})};jive.Wall.CommentHelper.renderCommentFormTemplate=function(d,c){var a=$j.find(".j-inline-comment-wrapper");var b=$j(a).find(".jive-comment-container").attr("data-statusid");if($j(a).find(".comment-form").length<1){$j(a).find("ul").append(jive.wall.commentForm({statusID:b,user:_jive_current_user,canComment:c.canComment,canCreateImage:c.canCreateImage,canAtMention:!jive.rte.mobileUI,visibleToExtCollaborator:c.visibleToExtCollaborator}));jive.Wall.CommentHelper.initComment(b,{wallEntryTypeID:d,entitlementObjectID:c.entitlementObjectID,entitlementObjectType:c.entitlementObjectType})}return false};jive.Wall.CommentHelper.displayModeration=function(a){jive.Wall.CommentHelper.helpers[a].displayModeration()};jive.Wall.CommentHelper.submitComment=function(d,e,b){var f=$j(d).data("status-id")||$j(d).attr("id");jive.Wall.CommentHelper.helpers[f].disableForm();var c=jive.rest.url("/comments");var a=c+"/"+e+"/"+f;$j(function(){$j.ajax({type:"POST",url:a,dataType:"json",data:JSON.stringify(jive.Wall.CommentHelper.getDataParams(f)),contentType:"application/json; charset=utf-8",success:function(g){jive.Wall.CommentHelper.helpers[f].enableForm();jive.Wall.CommentHelper.helpers[f].resetStatusInput();if(!g.moderated){jive.Wall.CommentHelper.reloadComments(f,e,b)}else{jive.Wall.CommentHelper.displayModeration(f)}},error:function(g){jive.Wall.CommentHelper.helpers[f].enableForm();jive.Wall.CommentHelper.helpers[f].displayError(JSON.parse(g.responseText).error.message)}})});return false};jive.Wall.CommentHelper.submitCommentDraft=function(d,b,c){var a={url:jive.rest.url("/comments")+"/"+b+"/"+c+"/draft",data:JSON.stringify(jive.Wall.CommentHelper.getDataParams(c)),success:function(e){e.comment.objectType=jive.Wall.Main.COMMENT_TYPE;e.comment.objectId=e.comment.commentID;d(e.comment)},error:function(f){var e=JSON.parse(f.responseText)},type:"POST",contentType:"application/json; charset=utf-8",dataType:"json"};$j.ajax(a)};jive.Wall.CommentHelper.reloadComments=function(c,b,a){$j.ajax({type:"GET",url:a,dataType:"html",data:{id:c,type:b},success:function(e){var d=$j("#wall-comments-"+c).find("li.comment-form");$j("#wall-comments-"+c).replaceWith(e);$j(d).find(".jive-form-element-textarea").val("");d.appendTo($j("#wall-comments-"+c));jive.Wall.CommentHelper.initComment(c,{wallEntryTypeID:b})},error:function(d){console.log("Failed to reload comments.")}})};jive.Wall.CommentHelper.destroyComment=function(a){$j(jive.wall.deleteCommentConfirmation()).lightbox_me({closeSelector:".jive-modal-close, .close",onLoad:function(){$j("#we-comment-delete-submit-button").click(function(c){var b=jive.rest.url("/comments")+"/"+a;$j.ajax({type:"DELETE",url:b,success:function(d){$j("li#comment-"+a).hide()},error:function(d){jive.Wall.CommentHelper.helpers[formID].displayError(JSON.parse(d.responseText).error.message)}});c.preventDefault()})}});return false};jive.Wall.CommentHelper.getDataParams=function(a){return{comment:{parentCommentID:-1,body:jive.Wall.CommentHelper.helpers[a].getStatusInputVals(),name:$j("#comment-author").val(),email:$j("#comment-email").val(),URL:$j("#comment-url").val(),commentMode:$j("#comment-mode").val()}}};jive.Wall.CommentHelper.helpers={};jive.Wall.CommentHelper.initComment=function(d,b){var c=[{id:"j-wall-meta-image",view:jive.Wall.ImageMetaView,container:"jive-comment-content",service:jive.Wall.ImageMetaSource,viewType:jive.Wall.MetaView.TYPE_STATUS_COMMENT},{id:"j-wall-meta-video-link",view:jive.Wall.ImageMetaView,container:"jive-comment-content",service:jive.Wall.VideoLinkMetaSource,viewType:jive.Wall.MetaView.TYPE_STATUS_COMMENT}];b.meta=c;var a=$j("#wall-comments-"+d).find("li.comment-form");jive.Wall.CommentHelper.helpers[d]=new jive.Wall.CommentHelper($j.extend({statusInputIdPostfix:d,container:a},b))};jive.conc.observable(jive.Wall.CommentHelper.prototype);