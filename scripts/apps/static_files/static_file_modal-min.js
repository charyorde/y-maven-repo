define("jive.staticFileModalView",["jquery","ZeroClipboard"],function(b,a){return jive.AbstractView.extend(function(c,d){this.init=function(f){d.init.call(this,f);var e=this;this.staticFileList=f.staticFiles;this.placeObj=f.placeObj;this.containerType=f.containerType;this.showCopyToClipboardButtons=false;if(swfobject.hasFlashPlayerVersion("9")){this.showCopyToClipboardButtons=true;this.clips={}}this.$modal=$j(jive.staticFileStore.soy.modal({staticFiles:this.staticFileList,postURI:this.placeObj.resources.statics.ref,containerType:this.containerType,showCopyToClipboardButtons:this.showCopyToClipboardButtons}));this.$modal.lightbox_me({destroyOnClose:true,onLoad:function(){jive.rte.renderedContent.emit("renderedContent",e.$modal);var g=e.$modal.find("#j-upload-static-submit-form");if(e.showCopyToClipboardButtons){a.setMoviePath(jive.app.url({path:"/resources/scripts/zeroclipboard/ZeroClipboard.swf"}));e.generateClipClients()}b("#j-static-file-upload-btn").jiveFileButton({name:"j-static-file-upload"}).bind("choose",function(h,i){g.find("input").remove();g.prepend(i);g.submit()});g.on("submit",function(i){i.preventDefault();var j=e.getFilename();var h={dataType:"xml",data:{json:"{'filename': '"+j+"'}"},beforeSubmit:function(m,k,l){if(!getCookie("X-JCAPI-Token")){setCookie("X-JCAPI-Token",_jive_auth_token,null,"/")}if(k.find('input[name="j-static-file-upload"]').val()===""){e.clearFileFromSubmitForm();return false}},success:function(m,k,o){try{var l=b(m).find("body");if(l.length){m=JSON.parse(l.text())}}catch(n){e.displayErrorMessage("unknown");e.clearFileFromSubmitForm()}if(m.error&&m.error.status==409){e.replaceFile(j)}else{if(m.error&&m.error.status==400){if(m.error.context=="maxSize"||m.error.context=="maxCount"){e.displayErrorMessage(m.error.context,m.error.constraint)}else{e.displayErrorMessage("unknown")}e.clearFileFromSubmitForm()}else{e.clearFileFromSubmitForm();e.updateFileList()}}},error:function(l,k,m){e.displayErrorMessage("unknown");e.clearFileFromSubmitForm()}};b(this).ajaxSubmit(h);return false});e.$modal.on("click",".js-delete-static",function(l){l.preventDefault();var i=b(this),j=i.closest(".js-static-file"),h=j.data("id"),k=$j(jive.staticFileStore.soy.deleteFileConfirmation());k.lightbox_me({destroyOnClose:true,centered:true,zIndex:1000,onLoad:function(){k.delegate("#file-delete-submit-button","click",function(n){var m=$j(this);e.emitP("deleteFile",h).addCallback(function(o){k.trigger("close");e.$modal.find("#j-static-file-list-container").replaceWith(jive.staticFileStore.soy.staticFileList({staticFiles:o,showCopyToClipboardButtons:e.showCopyToClipboardButtons}));if(e.showCopyToClipboardButtons){e.generateClipClients()}});n.preventDefault()})}})});if(!e.showCopyToClipboardButtons){e.$modal.on("click",".js-url",function(i){var h=$j(this);e.selectText(h.attr("id"))})}}})};this.clearFileFromSubmitForm=function(){b('#j-upload-static-submit-form input[name="j-static-file-upload"]').remove()};this.updateFileList=function(){var e=this;e.emitP("getList").addCallback(function(f){e.$modal.find("#j-static-file-list-container").replaceWith(jive.staticFileStore.soy.staticFileList({staticFiles:f,showCopyToClipboardButtons:e.showCopyToClipboardButtons}));if(e.showCopyToClipboardButtons){e.generateClipClients()}jive.rte.renderedContent.emit("renderedContent",e.$modal)})};this.replaceFile=function(h){var g=this,e=g.$modal.find('li[data-filename="'+h+'"]').data("id"),f=$j(jive.staticFileStore.soy.replaceFileConfirmation());f.lightbox_me({destroyOnClose:true,centered:true,zIndex:1000,onLoad:function(){f.delegate("#file-replace-submit-button","click",function(j){var i=$j(this);f.trigger("close");g.emitP("deleteFile",e).addCallback(function(k){g.$modal.find("#j-upload-static-submit-form").submit()});j.preventDefault()})}})};this.generateClipClients=function(){var e=this;for(var f in e.clips){e.clips[f].destroy()}e.$modal.find(".js-static-file").each(function(){var g=b(this),h=g.data("id")+"";e.clips[h]=new a.Client();e.clips[h].setText(g.find(".js-url").text());e.clips[h].setHandCursor(true);e.clips[h].setCSSEffects(true);e.clips[h].glue("d_clip_button_"+h,"d_clip_container_"+h);e.clips[h].addEventListener("onComplete",function(i){var j=b("#d_clip_container_"+h);j.parent().find(".js-copied").remove();var k=b(jive.staticFileStore.soy.copiedConfirmation());b("#d_clip_container_"+h).after(k);k.delay(2000).fadeOut("slow",function(){k.remove()})})})};this.getFilename=function(){var e=this,g=e.$modal.find('input[name="j-static-file-upload"]').val();if(g){var h=(g.indexOf("\\")>=0?g.lastIndexOf("\\"):g.lastIndexOf("/"));var f=g.substring(h);if(f.indexOf("\\")===0||f.indexOf("/")===0){f=f.substring(1)}}return f};this.selectText=function(f){var h=document;var i=h.getElementById(f);if(h.body.createTextRange){var e=h.body.createTextRange();e.moveToElementText(i);e.select()}else{if(window.getSelection){var g=window.getSelection();var e=h.createRange();e.selectNodeContents(i);g.removeAllRanges();g.addRange(e)}}};this.displayErrorMessage=function(e,f){$j(jive.staticFileStore.soy.errorMessage({type:e,constraint:f})).message({style:"error"})}})});