jive.namespace("DiscussionApp");jive.DiscussionApp.DiscussionListView=function(r,d){jive.conc.observable(this);var j=this;var b,o,c=this,n=d.i18n,v=0,x,m=1;this._getValues=function(){var G={};b.find("[name='mobileEditor'],[name='containerType'],[name='container'],[name='thread'],[name='reply'],[name='message'],[name='postedFromGUIEditor'],[name='subject'],[name^='message.post'],[name='inlinePost'],[name='imageFile']").each(function(){var I=$j(this).attr("name");if((I in G)){var H=G[I];G[I]=[];if($j.isArray(H)){$j.each(H,function(J,K){G[I].push(K)})}else{G[I].push(H)}G[I].push($j(this).val())}else{G[I]=$j(this).val()}});var F=b.find("[name='ansQuestion']:checked");if(F.length>0){G.ansQuestion=F.val()}return $j.extend(G,{body:o.getHTML()})};function E(){return $j("<div></div>").html($j("#rte-template").html())}function u(H,K){if(o){console.log("reusing RTE",o);o.setHTML("");o.focus()}else{var L="wysiwygtext"+m;++m;H.append(E());H.find("textarea").attr("id",L);var G=new jive.rte.EntitlementService({objectID:d.resourceID,objectType:d.resourceType,entitlement:"VIEW"});var J=new jive.rte.ImageService({objectId:-1,objectType:-1,containerId:d.containerID,containerType:d.containerType});var I=new jive.rte.FormService({$form:$j("#"+L).closest("form"),formSubmitHandler:function(){g();var Q=$j.ajaxSettings.traditional;$j.ajaxSettings.traditional=true;var R=$j("#reply-author");var P=R.val();var O=$j("#reply-email");var N=O.val();var S=j._getValues();if(R.length>0&&$j.trim(P)===""){$j("<p/>",{text:jive.DiscussionApp.soy.replyErrorMessage({key:"forum.thrd.name_required.text"})}).message({style:"error"});return false}else{if(O.length>0&&$j.trim(N)===""){$j("<p/>",{text:jive.DiscussionApp.soy.replyErrorMessage({key:"forum.thrd.email_required.text"})}).message({style:"error"});return false}else{if($j.trim(S.body)===""){$j("<p/>",{text:jive.DiscussionApp.soy.replyErrorMessage({key:"post.err.pls_enter_body.text"})}).message({style:"error"});return false}else{S=$j.extend(S,{name:P,email:N})}}}j._formWaitingView.disableForm();c.emit("saveDiscussion",S,function(){j._formWaitingView.enableForm();$j.ajaxSettings.traditional=Q});return false}});var F=$j("#reply-author").length>0;var M=$j.extend({$element:$j("#"+L),isEditing:false,onReady:function(){if(d.rteOptions.onReady){d.rteOptions.onReady()}jive.conc.nextTick(function(){o.focus()});if(!F){var N={selector:b,objectType:105,draftObjectType:d.resourceType,draftObjectID:d.resourceID,editorId:L,pushStateEnabled:false};new jive.draft.Main(N)}},services:{imageService:J,formService:I,entitlementService:G}},d.rteOptions);o=new jive.rte.RTEWrap(M);b=M.$element.parents("form");b.find(".jive-form-button-cancel").click(function(){s();o.destroy();o=null});e(K)}b.find("[name=message]").val(K.parentDiscussionID);c.emit("formReady",{discussionId:K.resourceID,parentMessageId:K.parentDiscussionID,isReply:K.isReply})}function e(F){j._advEditorLnk=F.advEditorLnk;B().click(function(){a();return false})}function B(){return x.parent().find(".advEditor")}function a(){var F=o.getHTML();if(F!=null&&F.length>0){F="&unsanitaryBody="+encodeURIComponent(F)}j._formWaitingView.disableForm();jive.util.createAndSubmitDynamicForm({url:j._advEditorLnk+F,method:"post"})}function y(F){s();F.setQuotedMsg(F.username,n,F.isAnonymous);var G=$j.extend({parentDiscussionID:F.messageID,advEditorLnk:F.advEditorLnk,isReply:F.isReply,replySubject:F.replySubject,userName:F.username},d);var H=p(F);return u(H,G)}function D(G){var F=$j(G).closest(".jive-thread-message, .j-thread-post, #jive-thread-reply-footer");if(F.length>0){return new jive.DiscussionApp.DiscussionView(F)}else{return null}}function q(){$j(".jive-thread-reply-hidden").closest(".reply").css("background-position","left -55px")}function l(){x.find("a.discussionAdd").live("click",function(){var F=D(this);y(F);return false});q()}function i(F){x.find(".jive-js-addReply #post-error-table > #post-error-subject").html(F).show().parent().slideDown()}function w(){i(jive.i18n.sub(n.globalLoginRequired,'<a href="'+encodeURI(window.location).replace(/#.*$/,"")+'">',"</a>"))}function g(){x.find(".jive-js-addReply #post-error-table").slideUp().find("#post-error-subject").html("").hide()}function f(G,F){$j("#success-moderation-edit").html('<div><span class="jive-icon-med jive-icon-warn"></span>'+G+"</div>").fadeIn("normal",function(){if(F){$j.scrollTo($j("#success-moderation-edit"),"slow",{offset:{top:-20,left:0}})}})}function k(){$j("#success-moderation-edit").hide()}function C(F){var H=!F.isReply?x.find("ul.jive-discussion-replies:first > li:last"):F.getDOMElement().closest("li.reply");var I=true;if(H.length===0&&!F.isReply){H=$j('<ul class="jive-discussion-replies jive-discussion-flat jive-discussion-indent-0"/>');x.append(H);I=false}var G;if(d.isThreaded&&F.isReply){G=H.find("ul.jive-discussion-replies:first > li:last");if(G.length==0){G=$j('<ul class="jive-discussion-replies jive-discussion-flat jive-discussion-indent-1"/>');H.append(G);return G}else{return G.parent()}}else{G=I?H.parent():H;return G}}function p(F){var H=x.find(".jive-js-addReply");if(H.length>0){H.remove();if(o){o.destroy();o=null}}H=$j(jive.DiscussionApp.soy.renderReply({userName:F.username,messageID:F.messageID,i18n:n,anonymous:d.isAnonymous,moderated:d.isModerated}));C(F).append(H);var G=F.indent();$j(".addReply").css("margin-left",-G+"px");j._formWaitingView=new jive.shared.FormWaitingView(x.find(".jive-js-addReply"),{i18n:d.i18n,containerPadding:G,bgCssClass:"jive-form-waiting-disable-bg-discusssions"});H.fadeIn("fast");$j.scrollTo(H,"slow",{offset:{top:-40,left:0}});return H.find(".jive-discussion-post")}function s(){var F=x.find(".jive-js-addReply");var G=F.parent();F.fadeOut("fast",function(){if(G.children().length==0){G.hide()}})}function A(G){o.destroy();o=null;var F=x.find(".jive-content-rating").detach();F.find("script").remove();$j.ajax({url:_jive_base_url+"/inline-message.jspa?message="+G.id,async:false,success:function(H){x.closest(".j-column-wrap-l").replaceWith($j(H));x=$j("#jive-thread-messages-container");jive.rte.renderedContent.emit("renderedContent",x)}});x.find(".jive-content-rating").replaceWith(F);q()}function h(G){G=G||$j("<p>").html(d.i18n.postSuccessText);var F=v<=0;f(G.html(),F);v+=1}function t(){$j("a.localScroll").first().click()}function z(){return x.find("#discussionForm-baseDiscussionForm")}this.displayError=i;this.displayLoginError=w;this.displaySuccess=f;this.hideSuccess=k;this.scrollToLatestMsg=t;this.redisplayReplies=A;this.displayModeratedMessage=h;$j(document).ready(function(){x=$j(r);l()})};