jive.LocationState=jive.oo.Class.extend(function(a){var b=jQuery;jive.conc.observable(this);a.defaults={supportPushState:true,supportFragment:true};a.init=function(c){var f=b.extend({},this.defaults,c||{}),e=location.href,g=this;this.location=e;this.description="";this.manuallyUpdatingHash=false;this.supportPushState=f.supportPushState&&!!(window.history&&window.history.pushState);this.supportFragment=f.supportFragment;var d=[this.supportPushState?"popstate":null,this.supportFragment?"hashchange":null].filter(function(h){return !!h}).join(" ");b(window).bind(d,function(i){var h=location.href;if(g.afterInit||h!==e){g.location=h;if(!g.manuallyUpdatingHash){g.emitChange(g.current(),g.description,h)}g.manuallyUpdatingHash=false}})};this.get=function(c){return this.current()[c]};this.getState=function(){return this.current()};this.getEphemeralState=function(){return b.deparam.fragment()};this.pushState=function(e,c){var d=b.extend(this.current(),e);Object.keys(e).forEach(function(f){if(typeof e[f]=="undefined"||(b.isArray(e[f])&&e[f].length<1)){delete d[f]}});this.setState(d,c)};this.setState=function(f,e,d){var c=this.lastLocation;this.location=this.supportPushState?this.newLocation(f,d):this.newFragment(f,d);this.description=e||"";this.emitChange(f,e,this.location);if(this.location!==c){if(this.supportPushState){history.pushState(this.current(),this.description,this.location)}else{if(this.supportFragment){this.updateLocationHash(this.location)}}}};a.current=function(){var d=this.location.match(/\?/)?b.deparam.querystring(this.location):{},c=this.location.match(/#/)?b.deparam.fragment(this.location):{};return b.extend({},d,c)};a.newLocation=function(d,c){var e;if(!c){e=location.href.split(/[?#]/)[0]}else{e=jive.app.url({path:"/"+c})}return b.param.querystring(e,d)};a.newFragment=function(g,e){var c={},f=b.deparam.querystring(),h;h=location.href.split("#")[0];if(e){g.nPLoc=e}Object.keys(g).forEach(function(i){if(f[i]!==String(g[i])){c[i]=g[i]}});var d=b.param.fragment(h,c);if(/#[^=&]+=$/.test(d)){d=d.substring(0,d.length-1)}return d};a.emitChange=function(e,d,c){if(c!==this.lastLocation){this.emit("change",e,d,c);this.lastLocation=c;this.afterInit=true}else{this.emit("noChange",e,d,c)}};a.updateLocationHash=function(d){var c=this;function e(){c.preserveScrollPosition(d.split("#")[1],function(){c.manuallyUpdatingHash=true;location.href=d})}if(b.browser.msie&&b.browser.version<8){(this.locationHashTimeouts||[]).forEach(function(f){clearTimeout(f)});this.locationHashTimeouts=[];this.locationHashTimeouts.push(setTimeout(function(){c.locationHashTimeouts.push(setTimeout(e,100))},100))}else{e()}};a.preserveScrollPosition=function(c,e){var d;if(c){d=b(window).scrollTop();e();b(window).scrollTop(d)}else{e()}}});jive.locationState=new jive.LocationState();