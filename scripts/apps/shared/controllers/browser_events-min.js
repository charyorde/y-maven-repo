(function(){var A=false;var J=[];var I={};var D=null;var B={isPacemaker:false,handle:null};var E=window._jive_browser_event_polling_delay||30000;var G=new Date().getTime();var F=false;var L=600;(function(){for(var O=0,M=window._jive_browser_event.providers.length;O<M;++O){var N=window._jive_browser_event.providers[O];I[N]=true}})();jive.switchboard.addListener("newListener",function(M){if(I[M]&&J.indexOf(M)<0){J.push(M)}});jive.switchboard.addListener("user.idle",function(M,N){if(A){console.log("user is idle, last activity was "+M+"s ago")}G=Math.max(G,Number(N));if(F&&M==0){if(A){console.log("waking up, resume polling")}H()}});(function(){var P=0;var Q=$j.noop;function M(){if(B.handle){if(B.isPacemaker){window.clearInterval(B.handle);B.isPacemaker=false}else{window.clearTimeout(B.handle)}B.handle=null}}jive.switchboard.addListener("browserWindow.heartbeat",function(){if(B.isPacemaker){return }if(A){console.log("I heard the heartbeat")}M();B.handle=window.setTimeout(function(){if(A){console.log("Cardiac arrest, triggering an election")}B.handle=null;N()},120000)});function O(T){if(T.id<P){return }if(A){console.log("responding to election",T)}P=Math.max(P,T.id);Q();Q=function(){Q=$j.noop;W()};if(D){window.clearTimeout(D);D=null}M();var U=window.setTimeout(function(){if(A){console.log("I am the the winner of the election",T,R)}U=null;W();J=R;C=C||{};D=window.setTimeout(H,E);B.handle=window.setInterval(function(){if(A){console.log("Sending heartbeat")}jive.switchboard.emit("browserWindow.heartbeat")},90000);B.isPacemaker=true},5000);function W(){if(U){if(A){console.log("I concede the election",T)}window.clearTimeout(U);U=null}if(V){jive.switchboard.removeListener("browserWindow.vote",V);V=null}}J=[];var R=window._jive_browser_event.providers.filter(function(X){return jive.switchboard.listeners(X).length>0});var S={previousEvents:C,myEvents:R,tieBreaker:Math.random(),electionId:T.id};C=null;if(A){console.log("submitting my vote",S)}var V=function(X){if(!U){return }if(X.electionId==S.electionId){C=C||X.previousEvents;if(X.tieBreaker>S.tieBreaker){W()}else{R=R.concat(X.myEvents).unique()}}};jive.switchboard.addListener("browserWindow.vote",V);jive.switchboard.emit("browserWindow.vote",S)}jive.switchboard.addListener("browserWindow.elect",O);function N(){var R={since:window._jive_browser_event.since,id:new Date().getTime()+Math.random()};jive.switchboard.emit("browserWindow.elect",R);F=false}$j(window).load(N).unload(function(){jive.switchboard.removeListener("browserWindow.elect",O);N()})})();var K=jive.app.url({path:"/__services/v2/rest/browserEvents/"});var C=null;function H(){D=null;var R=new Date().getTime();var N=((R-G)/1000);if(N>L){if(A){console.log("idle for "+N+"s, going to sleep")}F=true;return }F=false;var M;var P=document.URL;var Q=P.match(/\/inbox|\/welcome|\/activity/g);if(Q!=null){M="all"}else{M="inboxandactions"}var O=window._jive_browser_event.since+"?e="+encodeURIComponent(J.join(","))+"&c="+M;if(A){console.log("idle for "+N+"s, polling server:",O)}$j.ajax({type:"GET",url:K+O,contentType:"application/json",dataType:"json",success:function(Y){if(!(Y&&Y.events)){return }var V=new Date().getTime();E=Y.wait||E;window._jive_browser_event.since=Y.now+R-V;var T={};for(var X=0,S=Y.events.length;X<S;++X){var Z=Y.events[X];var W=Z.providerName+"["+Z.id+"]@"+Z.timestamp;T[W]=true;if(C&&C[W]){continue}if(A){console.log("Distributing event to switchboard",Z.event)}jive.switchboard.emit(Z.providerName,Z.event)}C=T;var U=R+E-V;D=window.setTimeout(H,Math.max(U,5000))},complete:function(){if(D==null){E=Math.min(E*2,3600000);D=window.setTimeout(H,E)}}})}})()