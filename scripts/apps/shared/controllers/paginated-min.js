jive.Paginated=jive.oo.Class.extend(function(a){var c=jQuery,b;a.loadPage=jive.oo._abstract;a.initPagination=function(e,f){var d=this;f=f||{};this.defaultState=c.extend({start:0,numResults:20},e);this.promises=[];this.locationState=f.locationState||jive.locationState;this.paramFilter=f.paramFilter;this.linkViewClass=f.viewClass||jive.PaginationLinks;this.scrollTo=f.scrollTo;this.links=[];this.locationState.addListener("change",function(g){if(d.rollingBack){d.rollingBack=false;return}d.emitChange(g)});c(document).ready(function(){jive.conc.nextTick(function(){var g=d.locationState.getEphemeralState();if(Object.keys(g).length>0){d.emitChange(d.locationState.getState())}});if(c(f.paginationSelector||".j-pagination").length>0){d.links=c(f.paginationSelector||".j-pagination").toArray().map(function(g){return d.buildLinks({element:g})})}else{d.links=[d.buildLinks()]}})};a.pushState=function(i){var e=this.locationState.getState(),f=this.paramFilter?this.paramFilter(e):e,h=new jive.conc.Promise(),d=this;var g=Object.keys(i).reduce(function(l,j){if(d.defaultState.hasOwnProperty(j)&&d.deepEqual(d.defaultState[j],i[j])){l[j]=b}else{l[j]=i[j]}return l},{});Object.keys(f).forEach(function(j){if(f.hasOwnProperty(j)&&typeof f[j]=="undefined"){g[j]=b}});this.lastState=this.locationState.getState();this.locationState.pushState(g);this.promises.push(h);return h};a.getState=function(){return this.normalized(this.locationState.getState())};a.rollback=function(){if(this.lastState){this.rollingBack=true;this.locationState.setState(this.lastState)}};a.normalized=function(g){var e=this.paramFilter?this.paramFilter(g):g,f=c.extend({},this.defaultState,e),d=this;Object.keys(f).forEach(function(h){if(c.isArray(d.defaultState[h])&&!c.isArray(f[h])){f[h]=[f[h]]}else{if(c.isArray(d.defaultState[h])&&f[h].length<1){f[h]=d.defaultState[h]}}});return f};a.emitChange=function(e){var d=this;d.loadPage(d.normalized(e)).addCallback(function(f,g){d.updatePaginationLinks(f,g);d.promises.forEach(function(h){h.emitSuccess()});d.promises=[];c(".js-updatable-link").each(function(){var h=c(this),i=h.data("urlParams");if(i){h.attr("href",location.pathname+"?"+c.param(c.extend(e,i)))}})}).addErrback(function(){d.promises.forEach(function(f){f.emitError()});d.promises=[];d.rollback()})};a.buildLinks=function(f){f=f||{};var e=new this.linkViewClass(c.extend({},f,{params:c.extend({urlParams:this.locationState.getState(),urlPath:location.pathname,pageSize:this.getState().numResults},f.params),scrollTo:this.scrollTo})),d=this;if(!e._paginatedListening){e.addListener("start",function(g){d.setStart(g)});e.addListener("page",function(g){d.setPage(g)});e._paginatedListening=true}return e};a.updatePaginationLinks=function(e,f){var g=this.links,d=this;this.links=g.map(function(){return d.buildLinks({params:{current:e,max:f}})});g.forEach(function(h,j){h.replaceWith(d.links[j])})};a.setStart=function(e){var d=parseInt(e,10)||0;this.pushState({start:d})};a.setPage=function(d){this.setStart(this.pageToStart(d))};a.pageToStart=function(e,d){d=d||this.getState().numResults;return(e-1)*d};a.startToPage=function(e,d){d=d||this.getState().numResults;return(e/d)+1};a.deepEqual=function(e,d){if(c.isArray(e)&&c.isArray(d)){return e.length==d.length&&e.every(function(g,f){return g==d[f]})}else{if(c.isArray(e)||c.isArray(d)){return false}else{return e==d}}}});