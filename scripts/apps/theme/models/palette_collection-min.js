jive.namespace("Theme");define("jive.Theme.PaletteCollection",["jive.Theme.ThemeSource"],function(b){return function a(){var c=jive.conc.observable({}),f=[],g=null,i=null,e=new b();var j=function(k){return $j.extend(true,{},k)};var h=function(k){k=(k||"").toLowerCase();if(!/^custom|predefined$/.test(k)){throw new TypeError("Invalid filter type")}return c.delineateByType()[k]};var d=function(l){var k=f.filter(function(m){return m.paletteID===l});if(k.length===0){throw new Error("Invalid paletteID")}else{if(k.length>1){throw new Error("Multiple palettes were found for paletteID: "+l)}}return k[0]};c.activate=function(l){var k=d(l);g=j(k);return c.emit("paletteChange")};c.delineateByType=function(){var k={custom:[],predefined:[]};f.forEach(function(m){if(m.paletteID>0){var l=m.predefined?k.predefined:k.custom;l.push(m)}});return k};c.getCssValues=function(){return j(g.values)};c.get=function(k){return g.values[k]};c.setCssValues=function(k){$j.each(k,function(l,m){g.values[l]=m});return c.emit("cssChange",k)};c.unsetCssValue=function(){var k={};for(var m=0;m<arguments.length;m++){var l=arguments[m];delete g.values[l];k[l]=""}return c.emit("cssChange",k)};c.getActiveId=function(){return g.paletteID};c.getActiveName=function(){return g.name};c.getCustomPaletteNames=function(){return h("custom").map(function(k){return k.name})};c.getPublished=function(){return j(i)};c.getPublishedId=function(){return c.getPublished().paletteID};c.deletePalette=function(m){var l=$j.Deferred(),k=m===c.getActiveId();e.deletePalette(m).then(function(){if(k){g.paletteID=0;g.name=""}c.refresh().then(l.resolve.bind(l))});return l.promise()};c.publish=function(){var k=$j.Deferred();c.stopPreview().then(function(){c.saveAndPublish(g.name).then(k.resolve.bind(k))});return k.promise()};c.save=function(l){var k=$j.Deferred();g.name=l;if(g.predefined){g.predefined=false}h("custom").some(function(m){if(m.name===g.name){m.values=g.values;g=j(m);return true}});e.save(g).then(function(m){g=j(m);c.refresh().then(k.resolve.bind(k,m))});return k.promise()};c.saveAndPublish=function(l){var k=$j.Deferred();c.save(l).then(function(){e.publish(g.paletteID).then(function(){c.refresh().then(k.resolve.bind(k))})});return k.promise()};c.startPreview=function(l){var k=$j.Deferred();c.save(l).then(function(){e.preview(g.paletteID,"start").then(k.resolve.bind(k))});return k.promise()};c.stopPreview=function(){return e.preview(g.paletteID,"stop")};c.refresh=(function(){var l=false,k;return function(){if(!k){k=$j.Deferred()}if(!l){l=true;$j.when(e.get(),e.getPublishedPalette()).then(function(){f=arguments[0][0];i=arguments[1][0];if(i===null){i=j(h("predefined")[0])}if(g===null){g=j(i)}l=false;k.resolve();k=undefined})}return k}})();return c}});