(function(){var a=new RegExp(/^[\s\f\n\r\t\v\u00A0\u2028\u2029\u0240]$/);tinymce.create("tinymce.plugins.JiveMacrosPlugin",{_cache:new jive.ext.y.HashTable(),cache:function(f,b,d,c){var e=this._cache.get(c);if(!e){e=new jive.ext.y.HashTable();this._cache.put(c,e)}e.put(f,[d,b])},getTitleFor:function(b,d){var c=this._cache.get(b);if(!c){return false}return c.get(d)},deleteMacro:function(h,d){if(window.jiveRTE&&window.jiveRTE.macroEle){d=window.jiveRTE.macroEle;window.jiveRTE.macroEle=null}if($def(h)&&$def(d)){if(d==h.getBody()){return}var f=new tinymce.dom.DOMUtils(h.getBody());var i=f.getParent(d,function(k){return k==h.getBody()||k!=d});if(this.isExactMacro(d)){var e=this.getMacroFor(d);if(e.getMacroType()=="INLINE"){while(d.childNodes.length>0){var g=d.removeChild(d.childNodes[0]);i.insertBefore(g,d)}}else{if(e.getMacroType()=="TEXT"||e.getMacroType()=="INLINE"){while(d.childNodes.length>0){var g=d.removeChild(d.childNodes[0]);if(g.nodeType==3){var j=g.nodeValue;while(j.indexOf("\n")>=0){var b=h.getDoc().createElement("P");b.appendChild(h.getDoc().createTextNode(j.substr(0,j.indexOf("\n"))));i.insertBefore(b,d);if(j.length>j.indexOf("\n")+1){j=j.substr(j.indexOf("\n")+1)}else{j=""}}if(j.length>0){var b=h.getDoc().createElement("P");b.appendChild(h.getDoc().createTextNode(j));i.insertBefore(b,d)}}else{i.insertBefore(g,d)}}}}i.removeChild(d)}else{this.deleteMacro(h,i)}return}var h=tinyMCE.activeEditor;var c=h.selection;this.deleteMacro(h,c.getNode())},getNextSibling:function(b,c){if(c==null){return c}if(c.nextSibling!=null){return c.nextSibling}if(c==b.getBody()&&c.nextSibling==null){return null}return this.getNextSibling(b,this.getParentNode(b,c))},getParentNode:function(b,c){return(new tinymce.dom.DOMUtils(b.getDoc())).getParent(c,function(d){return d==b.getBody()||d!=c})},ageTheNodes:function(g,c,e){function b(h,i){return $j(i).parents().andSelf().filter(function(){var k=$j(this).parent().has(h).length>0,j=$j(this).has(h).length>0;return k&&!j}).get(0)}var d=b(c,g),f=b(g,c);return[d,f]},shouldEndLine:function(b){if(b.nodeType!=3&&(b.tagName.toLowerCase()=="div"||b.tagName.toLowerCase()=="p"||b.tagName.toLowerCase()=="pre"||b.tagName.toLowerCase()=="br")){return true}return false},applyParameterSet:function(d,c,e){if(this.isMacro(d)){if(e.deleteAll){var f=c.getAllowedParameters();for(var b=0;b<f.length;b++){d.removeAttribute("_"+f[b].name)}}for(var b=0;b<e.params.length;b++){d.setAttribute("_"+e.params[b].name,e.params[b].value)}this.removeDuplicateMacros(tinyMCE.activeEditor,false,this.isMacro(d))}},buildMacro:function(f,j,n){if(!$def(j)){j=0}var k=tinyMCE.activeEditor;var e=k.selection;var m=k.getDoc();var d=f.getName();var g;var h=e.isCollapsed();if(f.getMacroType()=="TEXT"){g=m.createElement("pre");g.setAttribute("class","jive_text_macro jive_macro_"+d);g.className="jive_text_macro jive_macro_"+d}else{if(f.getMacroType()=="INLINE"){g=m.createElement("span");g.appendChild(m.createTextNode(d));g.setAttribute("class","jive_macro jive_macro_"+d);g.className="jive_macro jive_macro_"+d}else{g=m.createElement("img");g.setAttribute("class","jive_macro jive_macro_"+d);g.className="jive_macro jive_macro_"+d;var c=window.parent.CS_RESOURCE_BASE_URL+"/images/tiny_mce3/plugins/jiveemoticons/images/spacer.gif";if(!n){g.setAttribute("src",c);g.setAttribute("data-mce-src",c)}else{g.setAttribute("src",n);g.setAttribute("data-mce-src",n)}}}g.setAttribute("jivemacro",d);var l;var i=null;if(!h&&f.getMacroType()=="TEXT"){var b=e.getRng(true);b=k.selectionUtil.splitAtEndpoints(b);b.surroundContents(g)}else{h=true;l=this.getParentNode(k,e.getNode());i=e.getNode();if(l==i){i=null}}if(f.getMacroType()=="TEXT"&&g.childNodes.length==0){g.appendChild(this.createEmptyPara());if(tinymce.isIE&&!tinymce.isIE9){g.firstChild.innerHTML="\ufeff";e.setNode(g.firstChild);e.collapse(true)}}if(j!=null&&j>=0){var o=f.getParameterSets();if(j<o.length){var j=o[j];this.applyParameterSet(g,f,j)}}return g},insertMacro:function(i,d,h,j){var f=i.selection.isCollapsed();var e=this.buildMacro(d,h,j);var k=i.selection.getNode();if(f){if(d.getMacroType().toLowerCase()=="text"){var b=i.selection.getRng(true);var g="body, td, th, pre, li";while(!i.dom.is(b.startContainer,g)){b=i.selectionUtil.splitAtEndpoints(b,g)}b.surroundContents(e);if(e.childNodes.length==0){e.appendChild(this.createEmptyPara())}b.setStart(e,0);b.collapse(true);i.selection.setRng(b)}else{e.setAttribute("id","__sel_me__");i.selection.setNode(e);e=i.getDoc().getElementById("__sel_me__");e.removeAttribute("id")}}this.removeDuplicateMacros(i,false,e);this.fixBodyParagraphs();if(e.childNodes.length&&e.parentNode&&d.getMacroType().toLowerCase()=="text"){b=i.dom.createRng();var c=e;do{c=c.childNodes[c.childNodes.length-1]}while(c.nodeType==1&&c.childNodes.length);b.setStart(c.parentNode,c.childNodes.length);b.collapse(true);i.selection.setRng(b);i.selectionUtil.normalizeSelection();window.focus();i.focus()}return e},execCommand:function(e,l,c){var j=tinyMCE.activeEditor,f,h;if(e.indexOf("mceMacroParamSet")==0){j.undoManager.add();var i=e.substr("mceMacroParamSet".length);f=parseInt(i.substr(0,i.indexOf("_")));var d=parseInt(i.substr(i.indexOf("_")+1));h=jive.rte.macros[f].getParameterSets()[d];var b=j.selection.getNode();var g=j.dom.getParent(b,function(n){return $def(n.attributes.jivemacro)});if(g!=null){this.applyParameterSet(g,jive.rte.macros[f],h);j.selection.select(g)}return true}else{if(e.indexOf("mceAddJiveMacro")==0){j.undoManager.add();var k=e.substr("mceAddJiveMacro".length);h=0;var m=k.indexOf("_");if(m>=0){h=parseInt(k.substr(m+1));k=parseInt(k.substr(0,m))}else{k=parseInt(k)}f=jive.rte.macros[k];if(f.getUrl().length>0){window.jiveRTE={macro:f,paramSet:h};j.windowManager.open({url:CS_BASE_URL+f.getUrl(),width:500,height:400,inline:1},window.jiveRTE)}else{j.plugins.jivemacros.insertMacro(j,f,h)}j.undoManager.add();return true}}return false},isFirst:function(b,c){if(b.childNodes.length==0){return false}return(b.childNodes[0]==c||this.isFirst(b.childNodes[0],c))},isLink:function(b){if(b==null||b.nodeName.toLowerCase()=="body"){return false}if($def(b)&&$obj(b)&&b!=null&&$def(b.nodeType)&&b.nodeType!=3){if(b.nodeName.toLowerCase()=="a"){return b}else{return this.isLink(b.parentNode)}}return false},isMacro:function(b){while(b!=null&&$obj(b)){if(b.nodeName.toLowerCase()=="body"){return false}if($def(b.nodeType)&&b.nodeType==1&&$def(b.attributes.jivemacro)){return b}b=b.parentNode}return false},isExactMacro:function(b){if(b==null||b.nodeName.toLowerCase()=="body"){return false}if(b!=null&&$obj(b)&&$def(b.nodeType)&&b.nodeType==1){if(b.nodeName.toLowerCase()=="pre"){return b}else{if($def(b.attributes.jivemacro)){return b}else{return false}}}return false},getMacroFor:function(c){var d=this.isMacro(c);if(d){var b=d.attributes.jivemacro.nodeValue;return tinymce.activeEditor.plugins.jiveutil.findMacro(b)}if(c.nodeName.toLowerCase()=="pre"){return tinymce.activeEditor.plugins.jiveutil.findMacro("quote")}return null},createMozBR:function(){var b=tinymce.activeEditor.dom;return b.create("br",{_moz_dirty:"",type:"_moz"})},createEmptyPara:function(){var b=tinymce.activeEditor;var d=b.dom;var c=d.create("p",{},tinymce.isIE?"":"<br _moz_dirty='' type='_moz' />");if(tinymce.isIE9){c.appendChild(b.getDoc().createTextNode(""))}return c},findLastKid:function(b){if(b.nodeType==3){return null}if(b.childNodes.length==0){return null}if(this.isMacro(b)||$def(b.tagName)&&b.tagName.toLowerCase()=="table"||$def(b.tagName)&&b.tagName.toLowerCase()=="pre"){return b}return this.findLastKid(b.childNodes[b.childNodes.length-1])},isBR:function(b){if(b.nodeType==3){return false}return b.nodeName.toLowerCase()=="br"},convertDoubleLineBreaksToParagraphs:function(e,l){if(l.nodeType!=1){return}if(!e.dom.isBlock(l)&&l.nodeName.toLowerCase()!="body"){return}if(l.nodeName.toLowerCase()=="pre"){return}if(this.isExactMacro(l)){return}var c;if(l.childNodes.length>0){c=l.childNodes[l.childNodes.length-1]}for(var b=0;b<l.childNodes.length-1;b++){var d=l.childNodes[b];c=l.childNodes[b+1];if(d.nodeType==1&&(d.nodeName.toLowerCase()=="title"||d.nodeName.toLowerCase()=="meta"||d.nodeName.toLowerCase()=="colgroup")){l.removeChild(d);b--}else{if(d.nodeType==1&&(d.nodeName.toLowerCase()=="ol"||d.nodeName.toLowerCase()=="ul")){if(d.childNodes.length==0){l.removeChild(d);b--}}else{if(c.nodeType==1&&(c.nodeName.toLowerCase()=="ol"||c.nodeName.toLowerCase()=="ul")){if(c.childNodes.length==0){l.removeChild(c);b--}}else{if(this.isBR(d)&&this.isBR(c)){var j=e.dom.getParent(d,"li");if(j==null){var h=d.parentNode;var f=h.parentNode;b--;if(h.nodeName.toLowerCase()!="p"){h=d;f=h.parentNode;var g=this.createEmptyPara();this.insertAfter(f,g,h);d.parentNode.removeChild(d);c.parentNode.removeChild(c);c=g}else{var k=e.getDoc().createElement("p");while(c.nextSibling!=null){k.appendChild(c.nextSibling)}this.insertAfter(f,k,h);this.insertAfter(f,this.createEmptyPara(),h);d.parentNode.removeChild(d);c.parentNode.removeChild(c);c=k}}}else{this.convertDoubleLineBreaksToParagraphs(e,d)}}}}}if($def(c)){this.convertDoubleLineBreaksToParagraphs(e,c)}},toXML:function(g,c){if(g.nodeType==3){return g.nodeValue+"\n"}var e="";if(g.nodeName.toLowerCase()=="br"){for(var d=0;d<c;d++){e+="  "}return e+"<BR>\n"}for(var d=0;d<c;d++){e+="  "}e+="<"+g.nodeName+">\n";for(var f=0;f<g.childNodes.length;f++){var b=(g!=g.childNodes[f].parentNode);if(b){e+="<error>\n"}e+=this.toXML(g.childNodes[f],c+1);if(b){e+="</error>\n"}}for(var d=0;d<c;d++){e+="  "}e+="</"+g.nodeName+">\n";return e},cloneNodeWithoutKids:function(e){var d=e.ownerDocument;var b=d.createElement(e.nodeName);for(var c=0;c<e.attributes.length;c++){if(e.attributes[c].value!=null){b.setAttribute(e.attributes[c].name,e.attributes[c].value)}}return b},sanitizeXML:function(h){if(h.nodeType!=1){return}var b=false;var d=[];for(var f=0;f<h.childNodes.length;f++){if(h!=h.childNodes[f].parentNode){b=true}else{d.push(h.childNodes[f]);this.sanitizeXML(h.childNodes[f])}}if(h.nodeName.toLowerCase()!="body"){try{var c=this.cloneNodeWithoutKids(h);for(var f=0;f<d.length;f++){c.appendChild(d[f])}h.parentNode.insertBefore(c,h);h.parentNode.removeChild(h)}catch(g){console.log("error in fixIt: "+g.message)}}},fixBodyParagraphs:function(){var k=tinyMCE.activeEditor;var l=k.getBody();var o=k.selection;var r=k.getDoc();if(tinymce.isIE&&l.innerHTML.toLowerCase()=="<p>&nbsp;</p>"){var m=this;k.undoManager.transparentChange(function(){l.appendChild(m.createEmptyPara());l.removeChild(l.firstChild)});return}this.convertDoubleLineBreaksToParagraphs(k,l);var h=this.findLastKid(l);if(l.childNodes.length>0&&h||l.childNodes.length==0){l.appendChild(this.createEmptyPara())}$j("p .Apple-style-span:only-child",r).filter(function(){return this.nextSibling==null&&this.previousSibling==null}).removeClass("Apple-style-span");var e=$j(".Apple-style-span",r);if(e.length>0){var f=o.getBookmark();e.contents().unwrap();o.moveToBookmark(f)}for(var j=0;j<l.childNodes.length;j++){var s=l.childNodes[j];var g=s.tagName;if(s.nodeType>=5){s.parentNode.removeChild(s);continue}if(typeof(g)!="undefined"){g=g.toLowerCase();if(!tinymce.isIE){if(s.nodeType==1&&g=="p"){if(s.childNodes.length==0){s.appendChild(this.createMozBR(k.getDoc()))}}}}if(s.nodeType==3||$j(s).css("display")=="inline"){if(s.nodeType==3&&(s.nodeValue.length==0||a.test(s.nodeValue))){s.parentNode.removeChild(s);j--}else{if((s.nodeType==3&&!a.test(s.nodeValue))||(s.nodeType!=3&&!k.selectionUtil.isBookmark(s))){var q=null;var n=null;var c=false;if(this.typingInBody){var b=o.getRng(true);if(b.collapsed){q=b.startContainer;if(q==l&&b.startOffset>0){q=l.childNodes[b.startOffset-1]}else{n=b.startOffset}}}var d=k.getDoc().createElement("p");k.getBody().insertBefore(d,s);j++;do{if(this.typingInBody&&s==q){c=true}d.appendChild(s);if(s.nodeType==1&&s.nodeName.toLowerCase()=="br"){break}s=null;if(j<l.childNodes.length){s=l.childNodes[j]}j--}while(s!=null&&(s.nodeType==3||$j(s).css("display")=="inline"));if(c){b=o.getRng(true);if(n!=null){b.setStart(q,n);b.collapse(true)}else{b.selectNode(q);b.collapse(false)}o.setRng(b)}}}}}if(typeof(this.typingInBody)!="undefined"&&this.typingInBody){this.typingInBody=false}},lastNodeChanged:null,lastScrollY:0,ensureParaEndsWithBr:function(c,e){if(tinymce.isIE){return}if(e.childNodes.length==0){e.appendChild(this.createMozBR(c.getDoc()))}else{var d=false;var b=e;while(!d&&b.nodeType==1&&b.childNodes.length>0){var f=b.childNodes[b.childNodes.length-1];if(f.nodeType==1&&f.nodeName.toLowerCase()=="br"){d=true}else{b=f}}if(!d){e.appendChild(this.createMozBR(c.getDoc()))}}},nodeChanged:function(c,b,e,f){if(e.nodeType==1&&e.nodeName.toLowerCase()=="p"){this.ensureParaEndsWithBr(c,e)}var d=this.getMacroFor(e);if(b.get("justifyleft")){if(d!=null){b.get("justifyleft").setDisabled(true);b.get("justifycenter").setDisabled(true);b.get("justifyright").setDisabled(true);b.get("justifyfull").setDisabled(true)}else{b.get("justifyleft").setDisabled(false);b.get("justifycenter").setDisabled(false);b.get("justifyright").setDisabled(false);b.get("justifyfull").setDisabled(false)}}c.plugins.jivemacros.removeDuplicateMacros(c,true,this.isMacro(e))},validateMacroElements:function(h){var g=this.getMacroFor(h);if(!g||!g.usesCustomBackground()){return null}var b=$j(h);var d=this.rte;var f=d.getHiddenContainer();var c=d.getUIDForElement(b);var i=d.getRTEElementFor(c);if(c==null||i&&i.length>1){tinymce.activeEditor.undoManager.transparentChange(function(){var j;if(c==null){j=b}else{j=i.filter(":gt(0)");j.removeClass("_jivemacro_uid"+c)}j.each(function(){var k=d.generateUID();if(c==null){c=k}$j(this).addClass("_jivemacro_uid"+k).attr("_jivemacro_uid",k);f.append($j("<div id='"+k+"' class='richContent'></div>"))})})}var e=f.children("#"+c);if(e.length==0){e=$j("<div id='"+c+"' class='richContent'></div>");f.append(e)}return e},removeDeletedMacros:function(b){var c=this.rte;if(c!=null&&typeof(c)=="object"){var d=c.getHiddenContainer();var e=$j(b.getBody());d.children(".richContent").each(function(){var g=this.id;var f=e.find("._jivemacro_uid"+g);if(f.length==0){c.removeMacroWithUID(g)}})}},fixEmptyTableCells:function(c){var b,d,e;var f=c.getDoc();if(!tinymce.isIE){b=f.getElementsByTagName("td");for(d=0;d<b.length;d++){e=b[d];if(e.childNodes.length==0){e.appendChild(this.createMozBR(f))}}b=f.getElementsByTagName("th");for(d=0;d<b.length;d++){e=b[d];if(e.childNodes.length==0){e.appendChild(this.createMozBR(f))}}}b=f.getElementsByTagName("p");for(d=0;d<b.length;d++){b[d].style.height=""}},removeDuplicateMacros:function(c,f,r){this.removeDeletedMacros(c);var y=c.selection.getNode();var e=this;var q,u,n;var j=this.rte;if(j!=null&&typeof(j)=="object"){var g=$j(c.getBody()).find(".jive_text_macro, .jive_macro");for(u=g.length;u>=0;u--){n=g[u];if(this.isExactMacro(n)){var p=$j(n);var d=p.offset();var o=d.top;var s=d.left;var v=p.height();var m=p.width();var x=e.getMacroFor(n);var k=o+"_"+s+"_"+m+"_"+v;if(p.data("renderedPosition")!=k&&x!=null||x!=null&&!f||x!=null&&x.caresAboutChangeTo&&x.caresAboutChangeTo(j,n,y)){if(n.timeout){continue}var b=function(l,i,h){return function(){l.timeout=null;var w=h.offset();var t=c.plugins.jivemacros.validateMacroElements(l);if(!f&&l==r||!h.data("hasRefreshed")||i.caresAboutChangeTo&&i.caresAboutChangeTo(j,l,y)){i.refresh(j,l);h.data("hasRefreshed",true)}else{if(i!=null&&i.usesCustomBackground()){i.refreshPosition(j,l,t,w)}}}}(n,x,p);n.timeout=b;setTimeout(b,10);p.data("renderedPosition",k)}else{break}}}}},collapseToStart:null,insertAfter:function(d,c,b){if(b.nextSibling){return d.insertBefore(c,b.nextSibling)}else{return d.appendChild(c)}},putCursorAfter:function(d,e){var c=d.dom.createRng();if(e.nodeType==3){c.setStart(e,e.nodeValue.length);c.collapse(true)}else{if(e.nextSibling&&e.nextSibling.nodeType==3){c.setStart(e.nextSibling,0);c.collapse(true)}else{var b="";if(tinymce.isWebKit){b="\ufeff"}var f=d.getDoc().createTextNode(b);e.parentNode.insertBefore(f,e.nextSibling);c.setStart(f,b.length);c.collapse(true)}}d.selection.setRng(c)},putCursorBefore:function(c,e){if(e.previousSibling!=null){var g=e.previousSibling;var f=c.selection;var b;if(f.getSel().getRangeAt){b=f.getSel().getRangeAt(0)}else{b=document.createRange();b.setStart(f.getSel().anchorNode,f.getSel().anchorOffset);b.setEnd(f.getSel().focusNode,f.getSel().focusOffset)}var d=0;while(g.nodeType!=3&&g.nodeType==1&&g.childNodes&&g.childNodes.length!=0){g=g.childNodes[g.childNodes.length-1]}if(g.nodeType==3){d=g.nodeValue.length;b.setStart(g,d);b.setEnd(g,d);c.selection.setRng(b)}else{c.selection.select(g);c.selection.collapse(true)}return}},isLastNodeOf:function(d,c,b){if(c.childNodes.length>0&&c.childNodes[c.childNodes.length-1].nodeType==3&&d.getRng(true).startContainer!=c.childNodes[c.childNodes.length-1]){return false}if(c==b){return true}if(c.nextSibling!=null){return false}return this.isLastNodeOf(c.parentNode,b)},isFirstNodeOf:function(d,c,b){if(c.childNodes.length>0&&c.childNodes[0].nodeType==3&&d.getRng(true).startContainer!=c.childNodes[0]){return false}if(c==b){return true}if(c.previousSibling!=null){return false}return this.isLastNodeOf(c.parentNode,b)},killYourself:function(){clearInterval(this.intervalId)},setRTE:function(b){this.rte=b;this.completeInit()},completeInit:function(){if(this.ed&&this.rte&&!this.initialized){this.initialized=true;var f=this;var c=this.ed;var e=this.rte;if(c.plugins.jivelists){c.plugins.jivelists.onBeforeFixLists.add(function(){f.fixBodyParagraphs()})}if(c.plugins.paste){c.plugins.paste.onPasteComplete.add(function(){f.fixBodyParagraphs()})}setTimeout(function(){f.intervalId=setInterval(function(){try{if(c.destroyed){clearInterval(f.intervalId);return}if(c.selection){var i=c.selection.getNode();var l=c.getWin().scrollY;var k=f.isMacro(i);if(i!=f.lastNodeChanged&&k){f.removeDuplicateMacros(c,false,k)}else{if(l!=f.lastScrollY){f.removeDuplicateMacros(c,true)}}f.lastNodeChanged=i;f.lastScrollY=l}}catch(j){console.log("Error in jivemacros setInterval",j)}},300)},333);c.onMouseUp.add(function(j,l){var k=l.target;if(j.selection.isCollapsed()&&k.nodeName.toLowerCase()=="html"){var i=j.getBody();if(i){if(i.childNodes.length==0){f.fixBodyParagraphs()}while(i.nodeType==1&&i.childNodes.length){i=i.childNodes[i.childNodes.length-1]}}j.selection.select(i);if(i.nodeType==1&&i.nodeName.toLowerCase()=="br"){j.selection.collapse(true)}else{j.selection.collapse()}}});if(c.plugins.jivecontextmenu){var d=c.plugins.jivecontextmenu;var h=new d.MenuItem("removeTextMacro",null,c.getLang("jivemacros.unquote"),{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:12,yOffset:86,width:13,height:11},"mceDeleteJiveMacro");var b=new d.Menu([h],true,false,c.getLang("jivemacros.macro.quote"));var g=new d.MenuItem("textMacroItem",/pre/i,null,{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:58,yOffset:0,width:25,height:22},b);d.addRootItem(g)}if(c.plugins.contextmenu){c.plugins.contextmenu.onContextMenu.add(function(j,p,u){var n,v=c.selection,k=v.getNode()||c.getBody();var r=c.dom.getParent(k,function(i){return i==c.getBody()||f.isExactMacro(i)});if(!f.isExactMacro(r)){r=null}var o=null;var s=-1;var t=false;if(r!=null){for(var q=0;q<jive.rte.macros.length;q++){if(jive.rte.macros[q].getName()==r.attributes.jivemacro.value){o=jive.rte.macros[q];s=q;if(o.getName()=="code"){if(r.attributes.___default_attr.value=="html"){t=true}}}}}window.jiveRTE=new Object();window.jiveRTE.macroEle=r;if(o!=null){f.macro=o;p.removeAll();if(r.nodeName.toLowerCase()=="a"&&(o.getName()=="document"||o.getName()=="blogpost"||o.getName()=="thread"||o.getName()=="message"||o.getName()=="blog"||o.getName()=="community"||o.getName()=="space"||o.getName()=="user"||o.getName()=="project"||o.getName()=="task"||o.getName()=="group")){p.add({title:"jivemacros.unlink",cmd:"mceDeleteJiveMacro"})}else{var x=o.getParameterSets();if(x.length>1){if(o.getName()!="code"||!t){var l=c.getLang("jivemacros.macro."+o.getName()+".presets","jivemacros.presets");n=p.addMenu({title:l,max_height:"200","class":"mceDropDown defaultSkin mceMacroMenu mceListBoxMenu",icon:"jiveMacroPreset"});for(var q=0;q<x.length;q++){if(o.getName()!="code"||x[q].name!="html"){var w=c.getLang("jivemacros.macro."+o.getName()+".preset."+x[q].name,x[q].name);n.add({title:w,cmd:"mceMacroParamSet"+s+"_"+q,icon:"jiveMacro_"+o.getName()+"_"+x[q].name})}}}}if(o.getAllowedParameters().length>0&&o.isShowSettings()){p.add({title:"jivemacros.properties",icon:"jiveMacroProperties",cmd:"mceEditJiveMacro",ui:true})}p.add({title:"jivemacros.remove",icon:"jiveMacroDelete",cmd:"mceDeleteJiveMacro",ui:true})}}else{this.macro=null}})}}},init:function(b,c){this.url=c;this.ed=b;var e=b.plugins.jiveutil.findMacro("emoticon");this.emoticon=e;var d=this;var g=false;b.onKeyUp.addToTop(function(h,i){g=!h.selection.isCollapsed()},this);b.onMouseUp.addToTop(function(h,i){g=!h.selection.isCollapsed()},this);b.onKeyUp.addToTop(function(h,i){if(g&&(i.keyCode==8||i.keyCode==46)){h.undoManager.add(false,true)}},this);b.addCommand("mceJiveMacros",function(){var h=this.controlManager;var i=h.get("jivemacros");i.showMenu()});var f=function(i,h){if(d.rte){d.rte.scrollRichContent(i,h)}};if(b.onScroll){b.onScroll.addToTop(f,this)}if(b.plugins.jivescroll){b.onInit.add(function(h){f(h.plugins.jivescroll.lastScrollX,h.plugins.jivescroll.lastScrollY)},this)}b.addCommand("mceEditJiveMacro",function(){var j=tinyMCE.activeEditor;var k=j.plugins.jivemacros.macro;var h=k.getAllowedParameters().length*28+88;if(k.getUrl().length>0){window.jiveRTE=new Object();window.jiveRTE.macro=k;window.jiveRTE.node=j.dom.getParent(j.selection.getNode(),j.plugins.jivemacros.isExactMacro);var i=j.windowManager.open({url:CS_BASE_URL+k.getUrl(),width:500,height:400,inline:1},{macro:k})}else{j.windowManager.open({url:CS_BASE_URL+"/resources/scripts/tiny_mce3/plugins/jivemacros/macro.htm",width:400,height:h,inline:1},{plugin_url:c,macro:k,cs_resource_base_url:CS_RESOURCE_BASE_URL})}});b.addCommand("mceDeleteJiveMacro",function(){var h=tinyMCE.activeEditor;this.deleteMacro(h,h.selection.getNode())},this);this.initialized=false;b.onSetContent.add(function(h){if(this.initialized){this.fixBodyParagraphs();this.fixEmptyTableCells(h)}},this);b.onInit.add(this.completeInit,this);b.onEvent.add(function(h){return function(){h.plugins.jivemacros.removeDeletedMacros(h)}}(b));b.onNodeChange.add(this.nodeChanged,this);b.onExecCommand.add(function(h,j,i,k){switch(j){case"mceTableSplitCells":case"mceTableMergeCells":case"mceTableInsertRowBefore":case"mceTableInsertRowAfter":case"mceTableDeleteRow":case"mceTableInsertColBefore":case"mceTableInsertColAfter":case"mceTableDeleteCol":case"mceTableCutRow":case"mceTablePasteRowBefore":case"mceTablePasteRowAfter":case"mceTableRowUp":case"mceTableRowDown":case"mceTableColLeft":case"mceTableColRight":h.plugins.jivemacros.lastNodeChanged=null}});b.onKeyPress.addToTop(function(i,h){if(this.collapseToEnd!=null||this.collapseToStart!=null){tinymce.dom.Event.cancel(h)}if(h.which==null||h.which!=0||h.keyCode==8||h.keyCode==46){var j=this.isMacro(i.selection.getNode());if(j){i.dom.setAttrib(j,"_modifiedtitle","true")}}i.selection.lastSelected=i.selection.getNode()},this);b.onKeyDown.addToTop(function(k,j){if((j.keyCode==8||j.keyCode==46)&&!k.selection.isCollapsed()){k.undoManager.add(false,true)}var l=k.selection;var m=k.dom.getParent(l.getNode(),"pre");if(j.keyCode==8&&l.isCollapsed()&&m){var o=k.selectionUtil.atStartOf(m)||k.selectionUtil.isEffectivelyEmpty(m);if(o){k.undoManager.add(false,true);var n=l.getBookmark();k.dom.remove(m,true);l.moveToBookmark(n);k.undoManager.add(false,true);tinymce.dom.Event.cancel(j)}}l.lastSelected=l.getNode();var h=k.getBody();if(h.childNodes.length>0){this.before=l.getNode();if(j.keyCode==13&&m){if(tinymce.isIE&&!tinymce.isIE9){tinymce.dom.Event.cancel(j);var i=l.getSel().createRange();i.text="\n ";i.select()}}}},this);b.onKeyUp.add(function(o,u){var l=o.selection;var r=l.getNode();if(r&&r.nodeName.toLowerCase()=="body"&&!u.ctrlKey&&!u.altKey&&!u.shiftKey&&!u.metaKey&&u.keyCode!=91&&u.keyCode!=92&&u.keyCode!=17&&u.keyCode!=18){this.typingInBody=true;this.fixBodyParagraphs()}if(u.keyCode==8||u.keyCode==46){var s=this.isMacro(r);if(s){o.dom.setAttrib(s,"_modifiedtitle","true")}}o.plugins.jivemacros.removeDuplicateMacros(o,false,this.isMacro(r));if(u.keyCode==90&&(u.ctrlKey||u.metaKey)&&(r&&r.nodeName.toLowerCase()=="body"&&o.selection.lastSelected&&o.selection.lastSelected.nodeName.toLowerCase()!="body")){var q=o.selection.lastSelected;if(q.childNodes.length){q=q.childNodes[q.childNodes.length-1];o.selection.select(q);o.selection.collapse(true)}else{o.selection.select(q);o.selection.collapse()}}if(this.collapseToStart!=null){this.putCursorBefore(o,this.collapseToStart);tinymce.dom.Event.cancel(u);this.collapseToStart=null;return}if(this.collapseToEnd!=null){this.putCursorAfter(o,this.collapseToEnd);tinymce.dom.Event.cancel(u);this.collapseToEnd=null;return}if(this.before!=null&&(u.keyCode==39||u.keyCode==40)){var i=o.dom.getParent(r,"PRE");if(this.before.tagName!="PRE"&&i){if(this.before.childNodes.length==1&&this.before.childNodes[0].tagName=="BR"){var t=o.dom.getParent(this.before,function(p){return function(w){return w==o.getBody()||w!=p}}(this.before));if(t.childNodes[0]==this.before){t.removeChild(this.before);this.before=i;o.nodeChanged(false,true)}}}}o.plugins.jiveemoticons.encodeSmileys(o,r);if(u.keyCode==37||u.keyCode==38){var m=o.dom.getParent(l.getNode(),function(p){return o.plugins.jivemacros.isExactMacro(p)},o.getBody());if(!m){return}var n=this.isFirst(o.getBody(),m);var k=this.isMacro(m);var h=l.getBookmark(BOOKMARKTYPE).start==0||l.getRng(true).startOffset==0;if(n&&k&&h&&l.isCollapsed()){if(u.keyCode==37&&!o.dom.isBlock(m)){m.parentNode.insertBefore(o.getDoc().createTextNode(""),m);return true}else{var j=o.getDoc().createElement("P");var v=o.getDoc().createElement("BR");j.appendChild(v);o.getBody().insertBefore(j,o.getBody().childNodes[0]);o.nodeChanged(false,true);return true}}}},this)},getInfo:function(){return{longname:"Jive Macros",author:"Jive Software",authorurl:"http://jivesoftware.com",infourl:"http://jivesoftware.com",version:tinyMCE.majorVersion+"."+tinyMCE.minorVersion}},generateMacroMenu:function(d,g){var f=tinyMCE.activeEditor;var c=jive.rte.macros[g];var k=c.getParameterSets();var h=f.getLang("jivemacros.macro."+c.getName(),c.getName());if(k.length>1){var b=d.addMenu({title:h,max_height:"200","class":"mceDropDown defaultSkin mceMacroMenu mceListBoxMenu",icon:"jiveMacro_"+c.getName()});for(var e=0;e<k.length;e++){var j=f.getLang("jivemacros.macro."+c.getName()+".preset."+k[e].name,k[e].name);if(k[e].name=="html"&&c.getName()=="code"){d.add({cmd:"mceAddJiveMacro"+g+"_"+e,title:j,max_height:"200",icon:"jiveMacro_"+c.getName()})}else{b.add({title:j,cmd:"mceAddJiveMacro"+g+"_"+e,icon:c.getName()+"_"+k[e].name})}}}else{if(k.length==1){var j=f.getLang("jivemacros.macro."+c.getName()+".preset."+k[0].name,k[0].name);d.add({cmd:"mceAddJiveMacro"+g,title:j,max_height:"200",icon:"jiveMacro_"+c.getName()})}else{d.add({cmd:"mceAddJiveMacro"+g,title:h,max_height:"200",icon:"jiveMacro_"+c.getName()})}}},createControl:function(k,b){switch(k){case"jivemacros":var i=b.createSplitButton("jivemacros",{title:"jivemacros.add",cmd:"mceJiveMacros"});for(var f=0;f<jive.rte.macros.length;f++){if(jive.rte.macros[f].isShowInMacroList()&&jive.rte.macros[f].getName()!="emoticon"&&!jive.rte.macros[f].isButton()){i.onRenderMenu.add(function(c){return function(n,j){var l=tinyMCE.activeEditor;l.plugins.jivemacros.generateMacroMenu(j,c)}}(f))}}return i;case"extra":var e=tinyMCE.activeEditor;for(var f=0;f<jive.rte.macros.length;f++){if(jive.rte.macros[f].isShowInMacroList()&&jive.rte.macros[f].getName()!="emoticon"&&jive.rte.macros[f].isButton()){var g=jive.rte.macros[f];var h=g.getParameterSets();var d=e.getLang("jivemacros.macro."+g.getName(),g.getName());if(h.length>1){var i=b.createSplitButton("extra",{title:d,image:"../jscripts/tiny_mce/plugins/example/img/example.gif",icon:"jiveMacro_"+g.getName(),cmd:"mceAddJiveMacro"+f});i.onRenderMenu.add(function(c){return function(o,j){for(var l=0;l<h.length;l++){var n=e.getLang("jivemacros.macro."+g.getName()+".preset."+h[l].name,h[l].name);j.add({title:n,cmd:"mceAddJiveMacro"+c+"_"+l,icon:g.getName()+"_"+h[l].name})}}}(f));return i}else{var i=b.createButton("extra",{title:d,cmd:"mceAddJiveMacro"+f,icon:"jiveMacro_"+g.getName()});return i}}}}return null}});tinymce.PluginManager.add("jivemacros",tinymce.plugins.JiveMacrosPlugin)})();