(function(){function d(g,f){return g.substr(0,f.length)==f}function e(i,k){var g=$j(k).attr("data-name");var h=$j(k).attr("data-id");var j=i.getDoc().createElement("a");var f;if(h){g=h;f="tag";j.setAttribute("_tag",h)}else{if(g){f="tag";j.setAttribute("_tag",g)}else{g=$j(k).text();f=k.getAttribute("jivemacro");j.setAttribute("___default_attr",k.getAttribute("__default_attr"))}}j.setAttribute("jivemacro",f);j.setAttribute("href","javascript:;");j.setAttribute("data-objectType",k.getAttribute("data-objectType"));j.className="jive_macro jive_macro_"+f;j.appendChild(i.getDoc().createTextNode(g));return j}var a={triggerChar:"@",search:function c(k,h,g,i,n){var f=null;var m=null;if(n.length<2){f=jive.rest.url("/emention/friends");m=jive.statusinput.dropdown.ddFriendsContent}else{f=jive.rest.url("/emention/search/")+encodeURIComponent(n)+"*";m=jive.statusinput.dropdown.ddSearchContent}if(c.lastResults){c.lastResults.reject()}var j=this._makeRequest(f);c.lastResults=j;this._handleResults(j,h,m,g,i);if(n.length<2){var l=this;j.fail(function(){l._handleResults(l._makeRequest(jive.rest.url("/emention/history")),h,jive.statusinput.dropdown.ddHistoryContent,g,i)})}},select:function(g,i,h){var f=i.ed;if(g.hasClass("jive-js-history")){this._handleResults(this._makeRequest(jive.rest.url("/emention/history")),i,jive.statusinput.dropdown.ddHistoryContent)}else{if(g.hasClass("jive-js-friends")){this._handleResults(this._makeRequest(jive.rest.url("/emention/friends")),i,jive.statusinput.dropdown.ddFriendsContent)}else{i.replaceSearchText(f,i.lastInfo.node,i.lastInfo.offset,e(f,g.get(0)),h)}}f.focus()},_makeRequest:function(f){var g=$j.Deferred();$j.ajax({url:f,dataType:"json"}).done(function(h){if(h&&h.mentionCollection&&h.mentionCollection.entries&&h.mentionCollection.entries.length){if(h.mentionCollection.entries.length>7){h.mentionCollection.entries=h.mentionCollection.entries.slice(0,7)}g.resolve(h.mentionCollection.entries)}else{g.reject(h)}}).fail(function(i,h){if(h!="abort"){console.log("ajax error: ",i)}g.reject(i,h)});return g},_handleResults:function(f,j,g,i,k){var h=this;f.done(function(l){var m=g.call(this,{entries:l});j.popOverContents.html(m);if(i!=null&&k!=null){j.positionThePopUp(j.ed,i,k)}j.popOverContents.find("a").click(function(){var n=$j(this);h.select(n,j,false);return false}).attr("href","javascript:;")}).fail(function(){j.hideThePopup()});if(!j.lastPopover){j.hideThePopup()}return f}};var b={triggerChar:"#",search:function c(f,j,h,k,i){if(c.lastResults){c.lastResults.reject()}var g=this._makeRequest(jive.rest.url("/tags/search?query="+encodeURIComponent(i)+"*"));c.lastResults=g;this._handleResults(g,j,jive.statusinput.dropdown.ddTagsContent,i,h,k)},select:function(g,i,h){var f=i.ed;i.replaceSearchText(f,i.lastInfo.node,i.lastInfo.offset,e(f,g.get(0)),h);f.focus()},_makeRequest:function(f){var h=this;var g=$j.Deferred();$j.ajax({url:f,dataType:"json"}).done(function(i){i=h._normalizeTagsData(i);if(i.length>7){i=i.slice(0,7)}g.resolve(i)}).fail(function(j,i){if(i!="abort"){console.log("ajax error: ",j)}g.reject(j,i)});return g},_handleResults:function(f,k,g,j,i,l){var h=this;f.done(function(m){var o=true;for(var p=0;p<m.length;++p){if(m[p].id==j){o=false;break}}var n=g.call(this,{entries:m,currentTagText:j,allowTagCreation:true,shouldCreateTag:o});k.popOverContents.html(n);if(i!=null&&l!=null){k.positionThePopUp(k.ed,i,l)}k.popOverContents.find("a").click(function(){h.select($j(this),k,false);return false}).attr("href","javascript:;")}).fail(function(){k.hideThePopup()});if(!k.lastPopover){k.hideThePopup()}return f},_normalizeTagsData:function(j){var g=[];if(j!=null&&j.tagSearchResult){for(var h=0;h<j.tagSearchResult.length;h++){var f=j.tagSearchResult[h];if(f.found){g.push({html:'<a  class="jive-js-status-input-selectable" href="'+_jive_base_url+"/tags#/?tags="+encodeURIComponent(f.name)+'" data-name="'+jive.util.escapeHTML(f.name)+'"><span class="jive-icon-med jive-icon-tag"></span>'+jive.util.escapeHTML(f.name)+"</a>",id:f.name})}}}return g}};tinymce.create("tinymce.plugins.JiveMentionsPlugin",{rte:null,popOverContents:null,lastInfo:null,lastPosition:null,cancelTheKey:false,ajax:null,outerDom:null,searchTextRegex:null,beforeMentionRegex:null,mentionTypes:null,allTriggerChars:"",setRTE:function(f){this.rte=f;this.completeInit()},positionThePopUp:function(n,j,l){var o=this;var m=$j(j.parentNode).offset();var t=$j("<div></div>");t.css("position","absolute");t.css("left",m.left);t.css("top",m.top);var p=n.plugins.jiveutil.clone($j(j.parentNode),window.parent.document);p.css("visibility","hidden");p.css("margin","0");p.width($j(j.parentNode).width());t.append(p);this.rte.getHiddenContainer().append(t);var f=n.dom.createRng();f.setStart(j.parentNode,0);f.setEnd(j,l);var k=f.toString().replace(/(\s|\u00a0)+$/,"");var s=p.get(0);var r=this.outerDom.createRng();r.setStart(s,0);var i=s.firstChild;while(i){r.setEndAfter(i);var q=r.toString().replace(/(\s|\u00a0)+$/,"");if(d(q,k)){while(r.toString().replace(/(\s|\u00a0)+$/,"")!=k){var h=this._prevCharPos(n.selectionUtil.endPos(r));r.setEnd(h.c,h.off)}r.collapse(false);var g=this.outerDom.create("span",null,"|");r.insertNode(g);p.width($j(j.parentNode).width()+$j(g).width()+10);o._showThePopup($j(g));this.lastPosition=m;t.remove();return this.lastPopover.popOver.position()}i=i.nextSibling}t.remove();return this.lastPosition},_showThePopup:function(f){var g=this;g.hideThePopup();this.lastPopover={context:f,nudge:{left:180},container:this.rte.getPopOverContainer(),clickOverlay:false,addClass:"j-autocomplete j-js-autocomplete j-mention-popover",onClose:function(){g.ed.onPopupClose.dispatch();g.lastPopover=null},returnPopover:true,allowResize:false,focusPopover:false};this.popOverContents.popover(this.lastPopover)},hideThePopup:function(){if(this.lastPopover){this.lastPopover.closeFunc()}},_createPopupIfNeeded:function(){if(!this.lastPopover){this.popOverContents.html('<div class="loading"></div>')}},completeInit:function(){if(this.rte&&this.ed&&!this.initialized){this.initialized=true;var g=this.ed;var i=this.outerDom;g.onPopupClose=new tinymce.util.Dispatcher();if(this.rte.getGutter){var h=i.create("div",{"class":"gutterButton mentionButton"},g.getLang("jivemention.mention_button_lbl"));var f=null;i.bind(h,"mousedown",function(){f=g.selection.getRng(true)});i.bind(h,"click",function(){g.execCommand("jiveAtMention",true,f)});this.rte.getGutter().appendChild(h)}}},execCommand:function(i,h,j){var f=this.ed;if(i=="jiveAtMention"){if(j){f.selection.setRng(j)}f.undoManager.add();var g="@"+f.selection.getContent();f.selection.setContent(g);f.selection.collapse(false);f.focus();f.undoManager.add();return true}return false},addMentionType:function(g){var f=g.triggerChar;if(f&&f.length==1&&(typeof f=="string")){this.mentionTypes[f]=g;this.allTriggerChars+=f;this.searchTextRegex=new RegExp("[^\\s\u00a0"+this.allTriggerChars+"]");this.beforeMentionRegex=new RegExp("\\s|\u00a0|[^\\w"+this.allTriggerChars+"]")}else{throw new Error("invalid trigger character: "+f)}},_getMentionObj:function(f){var g=this.mentionTypes[f];if(g&&f.length==1){return g}return null},init:function(f){this.ed=f;this.outerDom=new tinymce.dom.DOMUtils(document);this.popOverContents=$j("<div class='j-menu'></div>");this.mentionTypes=[];this.addMentionType(a);this.addMentionType(b);function g(h,j){var i;if(this.lastPopover){switch(j.keyCode){case 27:tinymce.dom.Event.cancel(j);this.cancelTheKey=true;this.hideThePopup();return false;break;case 38:this.selectItem(this._getSelectItemIndex()-1);tinymce.dom.Event.cancel(j);this.cancelTheKey=true;return false;break;case 40:this.selectItem(this._getSelectItemIndex()+1);tinymce.dom.Event.cancel(j);this.cancelTheKey=true;return false;break;case 13:tinymce.dom.Event.cancel(j);this.cancelTheKey=true;i=this._getSelectedItem();if(i.length){this.select(i.get(0),false)}else{this.hideThePopup()}return false;break;case 32:i=this._getSelectedItem();if(i.length){tinymce.dom.Event.cancel(j);this.cancelTheKey=true;this.select(i.get(0),true);return false}break;default:break}}}f.onKeyUp.addToTop(this.checkForMentionPopup,this);f.onNodeChange.add(this.checkForMentionPopup,this);f.onKeyUp.addToTop(function(h,i){if(this.cancelTheKey){tinymce.dom.Event.cancel(i);this.cancelTheKey=false;return false}},this);f.onKeyPress.addToTop(function(h,i){if(this.cancelTheKey){tinymce.dom.Event.cancel(i);return false}},this);f.onKeyDown.addToTop(g,this);f.onScroll.add(function(j,i){if(this.lastPopover){if((this.lastPosition.top+20)-i<=0){this.hideThePopup()}var h=$j(f.getContainer()).children("table:first tr.mceIframeRow").height();if((this.lastPosition.top+20)-i>=h){this.hideThePopup()}}},this)},select:function(j,i){var f=this.ed.selection.getRng(true);var h=this._mentionSearch(f);this.lastInfo=h;var g=this._getMentionObj(h.type);if(g){g.select($j(j),this,i)}},checkForMentionPopup:function(g){try{var f=g.selection.getRng(true);var i=this._mentionSearch(f);if(!i){this.lastInfo=null;this.hideThePopup();return}if(this.lastInfo&&this.lastInfo.type==i.type&&this.lastInfo.searchText==i.searchText&&this.lastInfo.node==i.node){return}this.lastInfo=i;var h=this._getMentionObj(i.type);if(h){this._createPopupIfNeeded();h.search(g,this,i.node,i.offset,i.searchText)}}catch(j){console.log("error while checking for mention",j);this.hideThePopup()}},_getSearchText:function(h,j){var i="";while(h.nodeType==3){var f=0;while(j+f<h.nodeValue.length){var g=h.nodeValue.substr(j+f,1);if(this.searchTextRegex.test(g)){i+=g}else{return i}f++}if(h.nextSibling&&h.nextSibling.nodeType==3){h=h.nextSibling;j=0}else{return i}}return i},destroySearchText:function(f,g,h){this.replaceSearchText(f,g,h,f.getDoc().createTextNode(""),false)},replaceSearchText:function(k,u,l,v,y){var o=this;var g=u.nodeValue.substr(l,1);if(this._getMentionObj(g)==null){return}var n=true;var w="";var m=0;var q=false;while(u.nodeType==3){m=0;while(l+m<u.nodeValue.length){var p=u.nodeValue.substr(l+m,1);if(n||this.searchTextRegex.test(p)){w+=p}else{q=true;break}m++;n=false}if(!q&&u.nextSibling&&u.nextSibling.nodeType==3){var s=u.nextSibling;if(l==0){u.parentNode.removeChild(u)}else{u.nodeValue=u.nodeValue.substr(0,l)}u=s;l=0}else{break}}if(l==0&&m==0){u.parentNode.insertBefore(v,u)}else{if(u.nodeValue.length==m&&l==0){u.parentNode.insertBefore(v,u);u.parentNode.removeChild(u)}else{if(l==0){u.parentNode.insertBefore(v,u);u.nodeValue=u.nodeValue.substr(m)}else{var t=u.nodeValue;u.nodeValue=t.substr(0,l);var r=t.substr(l+m);if(r.length>0){var f=k.getDoc().createTextNode(r);u.parentNode.insertBefore(f,u);u.parentNode.insertBefore(v,f);u.parentNode.insertBefore(u,v)}else{u.parentNode.insertBefore(v,u);u.parentNode.insertBefore(u,v)}}}}if(y){var x=k.getDoc().createTextNode(" ");v.parentNode.insertBefore(x,v);v.parentNode.insertBefore(v,x);v=x}k.plugins.jivemacros.putCursorAfter(k,v);k.nodeChanged();var h=o.rte.getEntitlementService();var i=undefined;var j=$j("div.jive-compose-section-visibility");if(j.length&&j.is(":visible")&&!j.find("li.anyone input").is(":checked")){i=j.find(".j-people-list li").map(function(){return $j(this).data("user-id")+""}).get()}if(h&&v.getAttribute&&v.getAttribute("data-objectType")){h.checkEntitlement(v.getAttribute("data-objectType"),v.getAttribute("___default_attr"),i).addCallback(function(z){if(!z){var A="";if(v.getAttribute("data-objectType")==3){A=k.getLang("jivemention.no_notification")}else{if(v.getAttribute("data-objectType")==700){A=k.getLang("jivemention.secret_group_mention")}else{A=k.getLang("jivemention.restricted_content_mention")}}$j("<p>"+$j(v).text()+" "+A+"</p>").message({style:"warn"})}})}this.hideThePopup()},getInfo:function(){return{longname:"Mentions",author:"Jive Software",authorurl:"http://jivesoftware.com",infourl:"http://jivesoftware.com",version:tinyMCE.majorVersion+"."+tinyMCE.minorVersion}},selectItem:function(f){if(!this.lastPopover){return}var g=this._getSelectItems();this.deselectItem();if(f<0||f>=g.length){return}this._selectItemHelper(g[f],true)},deselectItem:function(g){var h=this._getSelectItems();if(g!=null&&(g<0||g>=h.length)){return}var f=g==null?this._getSelectedItem():h[g];if(f.length==0){return}this._selectItemHelper(f);this._selectedIndex=-1},_getSelectItems:function(){return this.lastPopover.popOver.find(".jive-js-status-input-selectable")},_getSelectedItem:function(){return this.lastPopover.popOver.find(".jive-js-status-input-selected")},_getSelectItemIndex:function(f){f=f||this._getSelectedItem()[0];return f?this._getSelectItems().index(f):-1},_getDataItemIndex:function(f){return this.lastPopover.popOver.find(".j-autocomplete-results a").index(f)},_selectItemHelper:function(f,g){if(g){$j(f).addClass("jive-js-status-input-selected").addClass("j-selected")}else{$j(f).removeClass("jive-js-status-input-selected").removeClass("j-selected")}},_withinCodeMacro:function(h){var g=this.ed.dom.getParent(h,"pre");if(g!=null){var f=this.ed.plugins.jivemacros.isMacro(g);if(f&&this.ed.plugins.jivemacros.getMacroFor(g).getName()=="code"){return true}}return null},_prevCharPos:function(f){if(f.c.nodeType==3){if(f.off>0){return{c:f.c,off:f.off-1}}else{return this._prevCharPos({c:f.c.parentNode,off:this.ed.dom.nodeIndex(f.c)})}}else{if(f.c.nodeType==1){if(f.off>0){var g=f.c.childNodes[f.off-1];if(g.nodeType==3){return this._prevCharPos({c:g,off:g.nodeValue.length})}else{return null}}else{return null}}}},_nextCharPos:function(f){if(f.c.nodeType==3){if(f.off<f.c.nodeValue.length-1){return{c:f.c,off:f.off+1}}else{if(f.off==f.c.nodeValue.length-1){return this._nextCharPos({c:f.c,off:f.off+1})}else{return this._nextCharPos({c:f.c.parentNode,off:this.ed.dom.nodeIndex(f.c)+1})}}}else{if(f.c.nodeType==1){if(f.off<f.c.childNodes.length){var g=f.c.childNodes[f.off];if(g.nodeType==3){if(g.nodeValue.length>0){return{c:g,off:0}}else{return this._nextCharPos({c:g,off:0})}}else{return null}}else{return null}}}},_charAt:function(f){if(f&&f.c.nodeType==3){return f.c.nodeValue.substr(f.off,1)}return null},_mentionSearch:function(g){var h=this.ed;if(!g.collapsed){return null}var l=this._prevCharPos(this.ed.selectionUtil.startPos(g));while(l){if(!this.searchTextRegex.test(this._charAt(l))){break}l=this._prevCharPos(l)}if(l==null){return null}var f=this._prevCharPos(l);if(f&&!this.beforeMentionRegex.test(this._charAt(f))){return null}else{if(tinymce.isIE&&!tinymce.isIE9&&!f&&this._charAt(l)=="@"){if(l.c.previousSibling!=null&&!/br|img/i.test(l.c.previousSibling.nodeName)&&!h.dom.isBlock(l.c.previousSibling)){return null}}}if(this._withinCodeMacro(l.c)){return null}if(this._getMentionObj(this._charAt(l))!=null){var j=this;function k(o){var m=h.dom.createRng();var n=j._nextCharPos(o);if(n==null||!j.searchTextRegex.test(j._charAt(n))){return""}m.setStart(n.c,n.off);while(n!=null){m.setEnd(n.c,n.off+1);n=j._nextCharPos(n);if(!j.searchTextRegex.test(j._charAt(n))){break}}return m.toString()}var i={node:l.c,offset:l.off,searchText:k(l),type:this._charAt(l)};return i}return null}});tinymce.PluginManager.add("jivemention",tinymce.plugins.JiveMentionsPlugin)})();