(function(){function a(c){var d=c.startContainer.childNodes[c.startOffset];if(!d){d=c.startContainer}while(d&&(d.nodeType!=1||d.nodeName.toLowerCase()!="a"||tinymce.activeEditor.dom.hasClass(d,"unlinked"))){d=d.parentNode}return d}function b(c){var e=c.startContainer.childNodes[c.startOffset];if(!e){e=c.startContainer}var d=tinymce.activeEditor.dom;while(e&&(e.nodeType!=1||e.nodeName.toLowerCase()!="a"||d.hasClass(e,"unlinked")||d.hasClass(e,"jive_macro"))){e=e.parentNode}return e}tinymce.create("tinymce.plugins.JiveLinkPlugin",{getInfo:function(){return{longname:"Content Picker",author:"Jive Software",authorurl:"http://www.jivesoftware.com",infourl:"http://www.jivesoftware.com/",version:"1.0"}},init:function(c,d){this.ed=c;var e=this;c.onSetContent.add(function(){tinymce.each(c.dom.select("a"),function(f){e.prepOrigContent(f)})});c.onBeforeGetContent.add(function(){tinymce.each(c.dom.select("a"),function(f){c.dom.removeClass(f,"active_link");var h=c.plugins.jivemacros.getMacroFor(f);if(h!=null&&h.getMacroType()=="INLINE"){var g=c.dom.getAttrib(f,"data-orig-content");if(g&&g!=f.innerHTML){c.dom.setAttrib(f,"_modifiedtitle","true")}}});this.lastActive=null},this);c.onNodeChange.add(this.nodeChanged,this);c.onInit.add(function(){e.ready=true;e.completeInit();if(tinymce.isIE9){c.execCommand("AutoUrlDetect",false,false)}})},prepOrigContent:function(c){if(this.ed.dom.getAttrib(c,"data-orig-content")){return}var e=this.ed.plugins.jivemacros.getMacroFor(c);if(e!=null&&e.getMacroType()=="INLINE"){var d=c.innerHTML;this.ed.dom.setAttrib(c,"data-orig-content",d)}},setRTE:function(c){this.rte=c;this.completeInit()},completeInit:function(){if(this.rte&&this.ready&&!this.initialized&&this.rte.getLinkService()){this.initialized=true;var k=this.ed;var h=k.dom;var l=this;k.plugins.paste.onPasteComplete.add(function(){tinymce.each(h.select("a.loading",k.getBody()),function(m){h.removeClass(m,"loading");l.resolveLink(m)})});if(k.plugins.jivecontextmenu){var i=k.plugins.jivecontextmenu;var e=new i.MenuItem("unlinkItem",a,k.getLang("jivelink.unlink"),{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:340,yOffset:90,width:28,height:21},"jiveLinkUnlink");var f=new i.MenuItem("bareUrlLinkItem",b,k.getLang("jivelink.bareUrl"),{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:368,yOffset:90,width:28,height:21},"jiveBareUrlLink");var d=new i.MenuItem("autoResolveLinkItem",b,k.getLang("jivelink.autoResolve"),{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:396,yOffset:90,width:28,height:21},"jiveAutoResolveLink");var j=new i.Menu([e,f,d],true,false,k.getLang("jivelink.menu_hdr"));function c(n,m){j.show(k,m,null,null)}var g=new i.MenuItem("jiveLinkItem",a,null,{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:30,yOffset:0,width:24,height:22},c);i.addRootItem(g)}}},resolveLink:function(e){var d=this.ed;var g=d.dom;if(g.hasClass(e,"jive_macro_appEmbeddedView")){return}var c=g.getAttrib(e,"href");c=d.convertURL(c);var f=this.rte.getLinkService();f.resolve(c).addCallback(function(h){var j,i;i=d.selection.getBookmark();if(h.macroName){g.setAttrib(e,"href","javascript:;");g.setAttrib(e,"title",h.title);g.setAttrib(e,"___default_attr",h.value);g.setAttrib(e,"jivemacro",h.macroName);if(h.isCustomTitle){g.setAttrib(e,"_modifiedtitle","true")}e.className="jive_macro jive_macro_"+h.macroName;j=h.title}else{g.setAttrib(e,"href",h.value);g.setAttrib(e,"title",h.value);e.className="";j=h.title}if(j.length>120){j=j.substring(0,120)+"\u2026"}e.innerHTML="";e.appendChild(d.getDoc().createTextNode(j));d.nodeChanged();d.selection.moveToBookmark(i)}).addErrback(function(h){console.log("resolveLink failed",h,e)})},createControl:function(f,d){switch(f){case"jivelink":var e=d.createButton("jivelink",{title:"jivelink.link_desc",cmd:"mceJiveLink"});return e}return""},execCommand:function(g,l,e){var m;var i=tinyMCE.activeEditor;var h=i.dom;switch(g){case"mceJiveLink":var j=false;var d=i.selection.getContent();var f=i.selection.getNode();m=h.getParent(f,"a");if(m!=null){h.removeClass(m,"active_link");if(i.plugins.jivemacros.isExactMacro(m)){i.plugins.jivemacros.deleteMacro(i,m)}else{i.execCommand("unlink")}return true}else{if(i.selection.getNode()){j=(i.selection.getNode().nodeName.toLowerCase()=="img")||(d&&d.length>0)}i.windowManager.open({url:CS_BASE_URL+"/content-picker!input.jspa?name="+escape(d)+"&instantiatedFromGUIEditor=true",width:700+i.getLang("jivelink.delta_width",0),height:555+i.getLang("jivelink.delta_height",0),inline:"yes"},{editor_id:i.id});return true}break;case"jiveLinkUnlink":m=a(i.selection.getRng(true));var k=/^https?:\/\/(?:[^:]+:[^@])?[\w\.]+(?::\d+)?\S*$/;if(m.childNodes.length==1&&m.firstChild.nodeType==3&&k.test(m.textContent)){h.addClass(m,"unlinked");h.setAttrib(m,"href",null);return true}else{h.remove(m,true);return true}break;case"jiveBareUrlLink":m=b(i.selection.getRng(true));var c=h.getAttrib(m,"href",null);h.remove(m.childNodes,false);m.appendChild(document.createTextNode(c));return true;break;case"jiveAutoResolveLink":m=b(i.selection.getRng(true));this.resolveLink(m);return true;break}return false},lastActive:null,nodeChanged:function(e,j,d,h){if(d==null){return}var g=e.dom.getParent(d,"a");var i=e.controlManager.get("jivelink");if(g!=null){if(i){i.setActive(true)}this.prepOrigContent(g)}else{if(i){i.setActive(false)}var f=this;tinymce.each(e.dom.select("a",d.parentNode),function(l){f.prepOrigContent(l)})}var k=this.lastActive==null||this.lastActive!=d;if(this.lastActive!=null&&this.lastActive!=d){e.dom.removeClass(this.lastActive,"active_link");this.lastActive=null}if(g&&this.lastActive==null){this.lastActive=g;e.dom.addClass(this.lastActive,"active_link")}var c=e.plugins.jivemacros.getMacroFor(d);if(c!=null&&c.getMacroType()=="INLINE"){if(this.lastActive==null||this.lastActive!=d){this.lastActive=e.plugins.jivemacros.isMacro(d);e.dom.addClass(this.lastActive,"active_link")}if(k&&this.lastActive.childNodes.length>0&&!e.dom.getAttrib(this.lastActive,"_modifiedtitle")){e.selection.select(this.lastActive.childNodes[0])}}}});tinymce.PluginManager.add("jivelink",tinymce.plugins.JiveLinkPlugin)})();