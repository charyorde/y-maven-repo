(function(){var a={"image/png":["png"],"image/jpeg":["jpg","jpeg"],"image/gif":["gif"],"image/bmp":["bmp"]};var k=CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/skins/default/img/progress.gif";var f=CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/skins/default/img/dropPosition.png";var j=/^data:(image\/[^;,]+)[^,]*,/;var i=620;function l(n){return tinymce.dom.Event.cancel(n)}function b(n){console.log("fired "+n.type+" on "+n.target.toString(),n)}function g(o){var p=o.selection.getSel();if(p.rangeCount!=null&&p.rangeCount<1){var n=o.dom.createRng();n.setStart(o.getBody(),o.getBody().childNodes.length);n.collapse(true);o.selection.setRng(n)}}function h(o){var n=tinymce.activeEditor;var p=n.dom.create("img");return $j(p).attr("src",o.url).attr("alt",o.name).css({"max-width":i+"px"}).addClass("jive-image")}function m(p){var o=tinymce.activeEditor;var n=o.selection.getRng(true);p.each(function(){n.insertNode(this)})}function e(w,t){var p=null;function s(D){if(p!=null){clearTimeout(p);p=null}if(!D){p=setTimeout(function(){r();p=null},550)}}var B=false;function r(){B=false}var n=new c(w);function C(D){B=true;s(false);if(t.dragstart){return t.dragstart.call(this,D)}}function v(D){B=true;s(false);if(t.drag){return t.drag.call(this,D)}}function u(D){s(false);if(!B){if(t.dragenter){t.dragenter.call(this,D)}n.show();return l(D)}}function y(D){s(false);var E;if(!B){if(t.dragleave){E=t.dragleave.call(this,D)}n.hide()}if(typeof E!="undefined"){return E}}function x(D){s(false);if(!B){if(t.dragover){t.dragover.call(this,D)}g(w);n.keepShowing();return l(D)}}function q(D){s(true);r();if(t.dragend){return t.dragend.call(this,D)}}function o(D){s(true);n.hide();var E;if(!B&&t.drop){E=t.drop.call(this,D)}r();if(typeof E!="undefined"){return E}}function z(E,D){w.dom.bind(w.getDoc(),E,D)}z("dragstart",C);z("drag",v);z("dragenter",u);z("dragover",x);z("dragleave",y);z("dragend",q);z("drop",o);this.reset=r;this.hideDropPos=function A(){n.hide()}}function c(n){var r=null;function p(s){if(r!=null){clearTimeout(r);r=null}if(!s){r=setTimeout(function(){o(n);r=null},100)}}function q(t){var u=$j(".js-dropPosition",t.getBody());if(u.length==0){g(t);var s=t.selection.getRng(true);s.collapse(true);var v=t.dom.create("img");u=$j(v).attr("src",f).addClass("js-dropPosition");s.insertNode(v)}return u}function o(s){$j(".js-dropPosition",s.getBody()).remove()}if(tinymce.isGecko){this.show=function(){p(false);return q(n)};this.keepShowing=function(){this.show()};this.hide=function(){p(true);o(n)}}else{this.show=function(){p(true);return q(n)};this.keepShowing=function(){this.show()};this.hide=function(){p(false)}}}function d(p,r,q,o){var s=q.getImageService();function n(v){r.attr("src",v.url).attr("data-mce-src",v.url)}function u(){console.log("Image REST request failed for %s",p.name,arguments);r.remove()}var t=new jive.conc.Promise();s.scaleClientImage(p.url).addCallback(function(A){var x=j.exec(A);if(x){var z=x[1];x=/\.([^\.]+)$/.exec(p.name);if(x&&a[z]){var y=x[1];y=y.toLowerCase();if($j.inArray(y,a[z])<0){p.name+="."+a[z][0]}}else{p.name+="."+a[z][0]}}p.url=A;n(p);var v=q.getFormService();var w=v.setFormEnabled(false,o.getLang("jiveimage.please_wait"));s.create(p.name,p.url).addCallback(function B(C){r.load(function(){var E=$j(this);E.css({width:"auto",height:"auto","max-width":"","max-height":""});var G=E.width();var D=E.height();if(G>i){var F=i/G;E.css({width:Math.round(F*G)+"px",height:Math.round(F*D)+"px"})}});n(C);t.emitSuccess(r.get(0))}).addErrback(function(){u();t.emitError()}).always(function(){v.setFormEnabled(w)})});return t}tinymce.create("tinymce.plugins.JiveImagePlugin",{getInfo:function(){return{longname:"Image Picker",author:"Jive Software",authorurl:"http://www.jivesoftware.com",infourl:"http://www.jivesoftware.com/",version:"1.0"}},uploadClientImage:function(n,o){o=$j(o);return d({url:o.attr("src"),name:n},o,this.rte,this.ed)},init:function(n){this.ed=n;var o=this;n.onInit.add(function(){if(!n.settings.images_enabled){var t=n.controlManager.get("jiveimage");if(t){t.setDisabled(true)}}else{if(n.plugins.jivecontextmenu){var s=n.plugins.jivecontextmenu;var q=new s.MenuItem("floatLeftItem",null,n.getLang("jiveimage.float_left"),{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:172,yOffset:90,width:28,height:21},"jiveImgFloatLeft");var v=new s.MenuItem("inlineItem",null,n.getLang("jiveimage.inline"),{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:144,yOffset:90,width:28,height:21},"jiveImgInline");var r=new s.MenuItem("floatRightItem",null,n.getLang("jiveimage.float_right"),{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:200,yOffset:90,width:28,height:21},"jiveImgFloatRight");var p=new s.MenuItem("originalSizeItem",null,n.getLang("jiveimage.original_size"),{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:165,yOffset:158,width:28,height:21},"jiveImgOriginalSize");var w=new s.Menu([q,v,r,p],true,false,n.getLang("jiveimage.menu_hdr"));var u=new s.MenuItem("jiveImageItem",/img/i,null,{url:CS_RESOURCE_BASE_URL+"/images/tiny_mce3/themes/advanced/img/iconmaster.gif",xOffset:155,yOffset:0,width:24,height:22},w);s.addRootItem(u)}}n.plugins.paste.onPasteComplete.add(function(){tinymce.each(n.dom.select("img.toUpload",n.getBody()),function(x){n.dom.removeClass(x,"toUpload");if(x.src&&x.src.length>0){var y=n.dom.uniqueId("pastedImage_");o.uploadClientImage(y,x)}else{n.dom.remove(x)}})})},this)},setRTE:function(o){var n=this.ed;this.rte=o;if(o.getImageService()&&o.getFormService()&&!n.settings.rte_image_webonly){if($def(window.FileReader)){this.initDragDrop()}else{if($def(window.FormData)){this.initDragCatch()}}var p=o.getImageService().getSettings();this.objectId=p.objectId;this.objectType=p.objectType}else{function q(t){var s=t.dataTransfer.files;if(s.length>0){for(var r=0;r<s.length;++r){if(/^image\//.test(s[r].type)){t.preventDefault();return false}}}}n.dom.bind(n.getDoc(),"drop",q)}},initDragDrop:function(){var t=this.ed;var u=this;function v(A){var z=h({name:A.name,url:k});m(z);var y=new FileReader();y.onloadend=function(B){var D=B.target.result;var C={name:A.name,url:D};d(C,z,u.rte,t)};y.onerror=function(B){console.log("error reading file: ",B.target)};y.onprogress=function(B){console.log("FileReader progress: "+B.loaded+" of "+B.total)};y.readAsDataURL(A)}function p(z,A){var y=z.toString(16);while(y.length<A){y="0"+y}return y}function n(C){var A=[];for(var B=0;B<C.length;++B){var z=C.charCodeAt(B);var y=z&255;var D=z>>8;A.push("%"+p(y,2)+"%"+p(D,2))}return decodeURIComponent(A.join(""))}function x(B){var z="";var y=null;var C=null;for(var A=0;A<B.length;++A){if(y===null){y=B.charCodeAt(A)}else{C=B.charCodeAt(A);z+=String.fromCharCode((C<<8)|y);y=null}}return z}function r(B){var z="";var y=null;var C=null;for(var A=0;A<B.length;++A){if(C===null){C=B.charCodeAt(A)}else{y=B.charCodeAt(A);z+=String.fromCharCode((C<<8)|y);C=null}}return z}function s(z,A){var B=0;var y=0;do{B=z.indexOf(A,B)+1;++y}while(B>0);--y;return y}function w(B){var A=0;var y=0;for(var z=0;z<B.length;++z){if(B.charCodeAt(z)==0){if(z%2==0){++y}else{++A}}}return A/y}function q(z){var C=s(z,"<");var A=s(z,">");if(Math.abs(C-A)<=1||Math.abs(1-(C/A))<0.05){if(C==0&&A==0){var y=n(z);C=s(y,"<");A=s(y,">");if((C>0&&A>0)&&(Math.abs(C-A)<=1||Math.abs(1-(C/A))<0.05)){return y}else{return z}}else{if(z.length%2==0){var B=s(z,"\x00");if(B<2||B/z.length<0.02){return z}else{if(w(z)>=1){return x(z)}else{return r(z)}}}else{return z}}}return n(z)}function o(y){var B=y.dataTransfer.files;if(B.length>0){for(var A=0;A<B.length;++A){if(/^image\//.test(B[A].type)){v(B[A])}}}else{if($j.inArray("text/html",y.dataTransfer.types)>=0){var z=q(y.dataTransfer.getData("text/html"));t.execCommand("mceInsertClipboardContent",false,{content:z})}else{if($j.inArray("text/plain",y.dataTransfer.types)>=0){var C=$j("<div></div>").text(y.dataTransfer.getData("text/plain")).html();t.execCommand("mceInsertClipboardContent",false,{content:C})}}}if(tinymce.isGecko&&$j.browser.version.substr(0,3)=="1.9"){$j(t.getDoc()).one("DOMNodeInserted",function(D){var E=D.originalEvent.target;E.parentNode.removeChild(E);return false})}return l(y)}new e(t,{drop:o})},initDragCatch:function(){var s=this.ed;var r=s.plugins.jivescroll;var t=this;var v=$j("<div></div>").css({width:"100px",height:"100px",position:"absolute",top:"0",left:"0"}).hide();var o=$j("<form method='POST' name='fileForm' enctype='multipart/form-data' target='asyncIframe'></form>").css({width:"100%",height:"100%"});v.append(o);var q=$j("<input type='file' name='fileInputCtrl' multiple='true' />").css({opacity:"0",width:"100%",height:"100%"}).attr("class","fileMouseCatch");o.append(q);var n=t.rte.getPopOverContainer();n.append(v);function w(C){var E=t.rte.getImageService();var z={name:C.name,url:k};var B=h(z);m(B);var y=t.rte.getFormService();function D(G){B.load(function(){var H=$j(this);H.css({width:"auto",height:"auto","max-width":"","max-height":""})}).attr("src",G.url)}function F(){console.log("Image REST form request failed for %s",z.name,arguments);B.remove()}var A=y.setFormEnabled(false,s.getLang("jiveimage.please_wait"));E.postFile(C).addCallback(D).addErrback(F).always(function(){y.setFormEnabled(A)})}function u(y){v.show().css({left:(y.clientX+r.lastScrollX-50)+"px",top:(y.clientY+r.lastScrollY-50)+"px"})}function p(){v.hide()}var x=new e(s,{dragover:u,dragleave:p});q.change(function(){v.hide();x.hideDropPos();x.reset();$j.each(q.get(0).files,function(){if(/^image\//.test(this.type)){w(this)}});q.val("");this.blur();s.focus()}).bind("click keydown",function(){v.hide();this.blur();return false})},createControl:function(p,n){switch(p){case"jiveimage":var o=n.createButton("jiveimage",{title:"jiveimage.link_desc",cmd:"mceJiveImage"});return o}return""},execCommand:function(q,p,r){var o=this.ed,s;switch(q){case"mceJiveImage":if(o.settings.rte_image_modal_url){o.windowManager.open({url:CS_BASE_URL+tinymce.settings.rte_image_modal_url,width:580+o.getLang("jiveimage.delta_width",0),height:425+o.getLang("jiveimage.delta_height",0),inline:"yes"},{editor_id:o.id,cs_resource_base_url:CS_RESOURCE_BASE_URL,objectId:this.objectId,objectType:this.objectType})}else{o.execCommand("mceAdvImage")}return true;case"jiveInsertImage":this.insertImage(r);return true;case"jiveImgFloatLeft":s=o.selection.getNode();if(/^img$/i.test(s.nodeName)){o.dom.setStyle(s,"float","left")}return true;case"jiveImgFloatRight":s=o.selection.getNode();if(/^img$/i.test(s.nodeName)){o.dom.setStyle(s,"float","right")}return true;case"jiveImgInline":s=o.selection.getNode();if(/^img$/i.test(s.nodeName)){o.dom.setStyle(s,"float","none")}return true;case"jiveImgOriginalSize":s=o.selection.getNode();if(/^img$/i.test(s.nodeName)){o.dom.setStyle(s,"width","");o.dom.setStyle(s,"height","");o.dom.setAttrib(s,"width",null);o.dom.setAttrib(s,"height",null)}return true}return false},insertImage:function(o){var n=this.ed,r=n.dom;var p=o.url;o.url=k;var q=h(o);q.load(function(){var t=$j(this);t.css({"max-width":"","max-height":""});if(tinymce.isIE&&t.attr("width")&&t.attr("height")){t.removeAttr("width").removeAttr("height")}var v=t.width();var s=t.height();if(v>i){var u=i/v;t.css({width:Math.round(u*v)+"px",height:Math.round(u*s)+"px"})}}).attr("src",p);m(q)},handleNodeChange:function(s,q,r,p,n,o){if(q==null){return}do{if(q.nodeName=="IMG"&&tinymce.getAttrib(q,"src")!=""){tinymce.switchClass(s+"_jiveimage","mceButtonSelected");return true}}while((q=q.parentNode));if(o){tinymce.switchClass(s+"_jiveimage","mceButtonNormal");return true}tinymce.switchClass(s+"_jiveimage","mceButtonDisabled");return true}});tinymce.PluginManager.add("jiveimage",tinymce.plugins.JiveImagePlugin)})();