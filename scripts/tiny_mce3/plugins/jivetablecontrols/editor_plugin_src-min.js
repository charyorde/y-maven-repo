(function(){tinymce.create("tinymce.plugins.JiveTableControlsPlugin",{rte:null,$rowopts:null,$colopts:null,$addrows:null,$rowPopover:null,$colPopover:null,$rowline:null,$colline:null,minY:0,minX:0,$node:null,resetMinMaxY:function(a){this.minY=a.plugins.jivescroll.lastScrollY;this.minX=a.plugins.jivescroll.lastScrollX},execCommand:function(e,d,f){var b=this.ed;if(e=="mceTableDuplicateCol"){var a=b.plugins.jiveutil.findColumnBoundsForCell(this.$node);a.each(function(g){$j(this).clone().insertAfter($j(this))});return true}else{if(e=="mceTableDuplicateRow"){var c=this.$node.closest("tr");c.clone().insertAfter(c);return true}}},setRTE:function(a){this.rte=a;this.completeInit()},completeInit:function(){if(this.ed&&this.rte&&!this.initialized){this.initialized=true;var e=this.ed;var k=this.rte;var h=this;e.plugins.jivetable.createSpinnerInput(this.$addrows.find("input.rows"),1,99,1,function(){});var n=function(s){if(s.keyCode==13){h.$addrows.find("input.button").mousedown();return false}};this.$addrows.find("input.rows").keydown(n).keyup(n).keypress(n);if(h.rte){h.$rowline.appendTo(h.rte.getPopOverContainer()).hide();h.$colline.appendTo(h.rte.getPopOverContainer()).hide()}this.$addrows.find("input.button").mousedown(function(){var t=h.$addrows.find("input.rows");t.change();var x=t.val();var s=$j($j(h.$node).closest("table").andSelf().toArray().reverse()).filter("table");if(s.length){var v=s.find("tbody:first tr:last");var w=v.parent();v=v.clone();v.find("td, th").empty();if(!tinymce.isIE){v.find("td, th").append(e.plugins.jivemacros.createMozBR(e.getDoc()))}for(var u=0;u<x;u++){w.append(v.clone())}e.nodeChanged()}e.focus();return false}).click(function(){return false}).mouseup(function(){e.focus();return false});e.onResizingNode.add(function(s){if(h.$node&&h.$node.closest("table").get(0)==s.get(0)){h.showCorners(e,h.$node)}});e.onNodeChange.add(function(t){var s=$j($j(t.selection.getNode()).closest("td,th").andSelf().toArray().reverse()).filter("td,th");if(s.is("td,th")){this.showCorners(t,s)}else{this.hideCorners()}},this);e.onMouseDown.add(function(s){},this);h.resetMinMaxY(e);var i=0;var g=0;var a=false;var m=null;var r=null;var l=null;var p=null;var b=null;var f=null;var o=0;var j=0;var c=0;var q=0;var d=0;this.$rowopts.mousedown(function(u){d=$j(e.getContentAreaContainer()).offset().top;l=null;b=null;i=u.pageX;g=u.pageY;e.plugins.jivemouse.showMouseCatch();c=h.rte.getContentAreaHeight();q=h.rte.getContentAreaWidth();var t=h.$node.closest("tr").offset();r=e.plugins.jiveutil.clone(h.$node.closest("tr"),window.parent.document).wrap("<table/>").closest("table").addClass("temp");r.find("th").each(function(v){$j(this).width(h.$node.closest("tr").find("th:nth("+v+")").outerWidth())});r.find("td").each(function(v){$j(this).width(h.$node.closest("tr").find("td:nth("+v+")").outerWidth())});r.find("td,th").empty();var s={position:"absolute",left:t.left,top:t.top,margin:0,backgroundColor:"#999999",opacity:0.5,width:h.$node.closest("table").outerWidth()+"px",height:h.$node.closest("tr").outerHeight()};if(s.left<h.minX){s.left=h.minX}if(s.left>h.minX+q){s.left=h.minX+q}if(s.top<h.minY+12){s.height+=s.top-h.minY-12;s.top=h.minY+12}if(s.top+s.height>h.minY+c){s.height=h.minY+c-s.top}j=s.top;o=s.height;r.attr("style",h.$node.closest("table").attr("style"));r.css(s);r.find("tr").css("height","auto");r.insertBefore(h.$rowline);h.$rowline.show().css({width:h.$node.closest("table").outerWidth(),top:t.top-2+"px",left:t.left+"px"});m=e.selection.getBookmark();return false});$j(e.getContainer()).parents("body").bind("mousemove.rte",function(w){if(r&&h.$node&&h.$node.closest("table").length){l=h.$node.closest("tr");var v=h.$node.closest("table");var s=(w.pageY-g);r.css("top",j+s+"px");l=null;var t=0;h.$node.closest("tr").parent().children("tr").each(function(y){if(!l){l=$j(this)}var z=Math.abs((r.position().top+r.outerHeight()/2)-$j(this).offset().top);if(y==0||z<t){l=$j(this);t=z}});var x=Math.abs((r.position().top+r.outerHeight()/2)-(v.offset().top+v.outerHeight()));if(x<t){h.$rowline.css("top",v.offset().top+v.outerHeight()-2+"px");a=true}else{h.$rowline.css("top",l.offset().top-2+"px");a=false}var u={top:r.position().top-8,left:r.position().left,height:o-1+16};if(u.left<h.minX){u.left=h.minX}if(u.left>h.minX+q){u.left=h.minX+q}if(u.top<h.minY+12){u.height+=u.top-h.minY-12;u.top=h.minY+12}if(u.top+u.height>h.minY+c){u.height=h.minY+c-u.top}h.trimCorners(u,h.$rowopts);r.css("height",u.height-12);r.css("top",u.top+6)}});$j(e.getContainer()).parents("body").bind("mouseup.rte",function(u){var x=false;var w=h.$node;var v=w?w.closest("table"):$j([]);var t=false;if(r||p){v.find("[colspan], [rowspan]").each(function(){var z=$j(this);var B=z.attr("colspan");var A=z.attr("rowspan");if((B!=null&&B!=1)||(A!=null&&A!=1)){t=true;z.attr("_colspan",B);z.attr("_rowspan",A);var y=[];y.cell=this;e.execCommand("mceTableSplitCells",false,y)}})}if(r&&w&&v.length){e.plugins.jivemouse.hideMouseCatch();h.rte.getPopOverContainer().find(".temp").remove();r=null;h.$rowline.hide();if(l&&a){w.closest("tr").appendTo(l.parent());x=true}else{if(l&&!a){if(w.closest("tr").get(0)!=l.get(0)){w.closest("tr").insertBefore(l)}x=true}}}if(p&&w&&v.length){e.plugins.jivemouse.hideMouseCatch();h.rte.getPopOverContainer().find(".temp").remove();p=null;h.$colline.hide();if(b&&a){var s=e.plugins.jiveutil.findColumnBoundsForCell(w);b=e.plugins.jiveutil.findColumnBoundsForCell(w.nextAll("td:last-child, th:last-child"));if(s.get(0)!=b.get(0)){s.each(function(y){var z=b.filter(":nth("+y+")");if(z.length){$j(this).insertAfter(z)}})}x=true}else{if(b&&!a){var s=e.plugins.jiveutil.findColumnBoundsForCell(w);b=e.plugins.jiveutil.findColumnBoundsForCell(b);if(s.get(0)!=b.get(0)){s.each(function(y){var z=b.filter(":nth("+y+")");if(z.length){$j(this).insertBefore(z)}})}x=true}}}if(t){v.find("[_colspan], [_rowspan]").each(function(){var A=$j(this).attr("_colspan");var z=$j(this).attr("_rowspan");$j(this).removeAttr("_colspan");$j(this).removeAttr("_rowspan");var y=[];y.cell=this;y.numcols=A?A:1;y.numrows=z?z:1;e.execCommand("mceTableMergeCells",false,y)})}if(e.selection){e.selection.moveToBookmark(m)}if(x){e.nodeChanged()}});this.$colopts.mousedown(function(t){l=null;b=null;i=t.pageX;g=t.pageY;e.plugins.jivemouse.showMouseCatch();c=h.rte.getContentAreaHeight();q=h.rte.getContentAreaWidth();f=e.plugins.jiveutil.findColumnFirstCell(h.$node);var u=f.offset();p=$j("<table><tr><td></td></tr></table>").addClass("temp");var s={position:"absolute",left:u.left,top:u.top,margin:0,backgroundColor:"#999999",opacity:0.5,width:f.outerWidth()+"px",height:h.$node.closest("table").outerHeight()};if(s.left<h.minX){s.left=h.minX}if(s.left>h.minX+q){s.left=h.minX+q}if(s.top<h.minY+12){s.height+=s.top-h.minY-12;s.top=h.minY+12}if(s.top+s.height>h.minY+c){s.height=h.minY+c-s.top}j=s.top;o=s.height;p.attr("style",h.$node.closest("table").attr("style"));p.css(s);p.insertBefore(h.$colline);h.$colline.show().css({height:o,top:u.top+"px",left:u.left-2+"px"});m=e.selection.getBookmark();return false});$j(e.getContainer()).parents("body").mousemove(function(y){if(p&&h.$node&&h.$node.closest("table").length){var w=h.$node.closest("table");var s=(y.pageX-i);p.css("left",f.offset().left+s+"px");b=null;var t=0;h.$node.closest("tr").children("td,th").each(function(A){if(!b){b=$j(this)}var B=Math.abs((p.position().left+p.outerWidth()/2)-$j(this).offset().left);if(A==0||B<t){b=$j(this);t=B}});var z=Math.abs((p.position().left+p.outerWidth()/2)-(w.offset().left+w.outerWidth()));if(z<t){h.$colline.css("left",w.offset().left+w.outerWidth()-2+"px");a=true}else{h.$colline.css("left",b.offset().left-2+"px");a=false}var v={top:p.position().top,left:p.position().left,width:p.outerWidth()-1};var x=h.rte.getContentAreaHeight();var u=h.rte.getContentAreaWidth();if(v.top<h.minY){v.top=h.minY}if(v.top>h.minY+x){v.top=h.minY+x}if(v.left<h.minX){v.left=h.minX}if(v.left>h.minX+u){v.left=h.minX+u}h.trimCorners(v,h.$colopts)}});h.$rowopts.find("a.settings").mousedown(function(){if(h.rowOpts){h.rowOpts.closeFunc()}if(h.colOpts){h.colOpts.closeFunc()}h.rowOpts={context:h.$rowopts.find("a.settings"),position:"below",container:h.rte.getPopOverContainer(),clickOverlay:false,addClass:"j-rte-popover js-rowProperties",returnPopover:true,arrowAdjust:0,nudge:{left:30},destroyOnClose:false,darkPopover:true,onClose:function(){h.rowOpts=null}};h.$rowPopover.popover(h.rowOpts);return false}).click(function(){return false});h.$rowPopover.find("a.js-addRowBefore").click(function(){e.execCommand("mceTableInsertRowBefore");h.hidePopover();return false});h.$rowPopover.find("a.js-addRowAfter").click(function(){e.execCommand("mceTableInsertRowAfter");h.hidePopover();return false});h.$rowPopover.find("a.js-deleteRow").click(function(){e.execCommand("mceTableDeleteRow");h.hidePopover();return false});h.$rowPopover.find("a.js-duplicateRow").click(function(){e.execCommand("mceTableDuplicateRow");h.hidePopover();return false});h.$colopts.find("a.settings").mousedown(function(){if(h.rowOpts){h.rowOpts.closeFunc()}if(h.colOpts){h.colOpts.closeFunc()}h.colOpts={context:h.$colopts.find("a.settings"),position:"below",container:h.rte.getPopOverContainer(),clickOverlay:false,addClass:"j-rte-popover js-rowProperties",returnPopover:true,arrowAdjust:0,nudge:{left:30},destroyOnClose:false,darkPopover:true,onClose:function(){h.colOpts=null}};h.$colPopover.popover(h.colOpts);return false}).click(function(){return false}).mouseup(function(){return false});h.$colPopover.find("a.js-addColBefore").click(function(){e.execCommand("mceTableInsertColBefore");h.hidePopover();return false});h.$colPopover.find("a.js-addColAfter").click(function(){e.execCommand("mceTableInsertColAfter");h.hidePopover();return false});h.$colPopover.find("a.js-deleteCol").click(function(){e.execCommand("mceTableDeleteCol");h.hidePopover();return false});h.$colPopover.find("a.js-duplicateCol").click(function(){e.execCommand("mceTableDuplicateCol");h.hidePopover();return false})}},init:function(a){var c=this;c.ed=a;$j.extend(this,{$rowopts:$j("<div class='resizeRowHandle'><div class='propsHandle'><a href='javascript:;' class='settings'></a></div></div>"),$colopts:$j("<div class='resizeColHandle'><div class='propsHandle'><a href='javascript:;' class='settings'></a></div></div>"),$addrows:$j("<div class='addRowsHandle'>Add <input class='rows spin-button'> Rows <input type='button' class='button' value='Go'></div>"),$rowPopover:$j('<div class="j-menu"><ul><li><a href="javascript:;" class="js-addRowBefore">Add Row Above</a></li><li><a href="javascript:;" class="js-addRowAfter">Add Row Below</a></li><li><a href="javascript:;" class="js-deleteRow">Delete Row</a></li><li><a href="javascript:;" class="js-duplicateRow">Duplicate Row</a></li></ul></div>'),$colPopover:$j('<div class="j-menu"><ul><li><a href="javascript:;" class="js-addColBefore">Add Column Left</a></li><li><a href="javascript:;" class="js-addColAfter">Add Column Right</a></li><li><a href="javascript:;" class="js-deleteCol">Delete Column</a></li><li><a href="javascript:;" class="js-duplicateCol">Duplicate Column</a></li></ul></div>'),$rowline:$j("<div class='rowLine'></div>"),$colline:$j("<div class='colLine'></div>")});var b=(function(e,d){return function(g,f){if(e.$node){this.minY=f;this.minX=g;e.showCorners(d,e.$node,e.preserveRatio)}}})(this,a);a.onInit.add(this.completeInit,this);a.onScroll.add(b,this);a.theme.onResize.add(function(){c.resetMinMaxY(a);b(c.minX,c.minY+c.rte.getContentAreaHeight())},this)},killYourself:function(){$j(this.ed.getContainer()).parents("body").unbind(".rte")},hideCorners:function(){this.hidePopover();this.$node=null;this.$rowopts.detach();this.$colopts.detach();this.$addrows.detach();this.opts=null},trimCorners:function(b,d){if(!this.rte){return}var c=this.rte.getContentAreaHeight();var a=this.rte.getContentAreaWidth();if(b.top<this.minY-3){d.detach()}else{if(b.top>this.minY+c){d.detach()}else{if(b.left<this.minX){d.detach()}else{if(b.left>this.minX+a){d.detach()}else{d.insertBefore(this.$rowline)}}}}d.css("top",b.top);d.css("left",b.left);if(b.height){d.height(b.height)}if(b.width){d.width(b.width)}d.css("cursor",b.cursor)},showCorners:function(b,a){var e=this;if(!a||!a.length){return}e.hidePopover();this.resetMinMaxY(b);this.$node=a;var f=this.rte.getContentAreaHeight();var c=this.rte.getContentAreaWidth();function d(){var k=a.closest("tr");var g=a.closest("table");var j=k.offset();var m=g.offset();var l=b.plugins.jiveutil.findColumnFirstCell(a);var i=l.offset();var h={top:j.top-8,left:j.left,height:k.outerHeight()-1+16};if(h.left<e.minX){h.left=e.minX}if(h.left>e.minX+c){h.left=e.minX+c}if(h.top<e.minY+12){h.height+=h.top-e.minY-12;h.top=e.minY+12}if(h.top+h.height>e.minY+f){h.height=e.minY+f-h.top}e.trimCorners(h,e.$rowopts);h={top:i.top,left:i.left,width:l.outerWidth()-1};if(h.left<e.minX&&h.left>e.minX-10){h.left=e.minX}if(h.top<e.minY+12){h.top=e.minY+12}if(h.top>e.minY+f){h.top=e.minY+f}e.trimCorners(h,e.$colopts);h={top:m.top+g.outerHeight()-1,left:m.left};e.trimCorners(h,e.$addrows);e.$addrows.find("input.rows").val(1)}d()},hidePopover:function(b,a){if(this.colOpts){this.colOpts.closeFunc(a);this.colOpts=null}if(this.rowOpts){this.rowOpts.closeFunc(a);this.rowOpts=null}},getInfo:function(){return{longname:"Jive Table Controls",author:"Jive Software",authorurl:"http://jivesoftware.com",infourl:"http://jivesoftware.com",version:tinyMCE.majorVersion+"."+tinyMCE.minorVersion}}});tinymce.PluginManager.add("jivetablecontrols",tinymce.plugins.JiveTableControlsPlugin)})();