(function(){if(!a()){return}var d;var b;var g=0;var h=0;function e(i,j){return{htmlBody:$j(i.contentDocument.body).html()}}function a(){return window.top.appsMarketEnabled}jive.switchboard.addListener("app.install.animation.ended",function(){g=g+1;console.log("apps_have_changed",g);if(b){d.search(b.ed,b.bangPlugin,b.node,b.offset,b.searchText);b=null}});jive.switchboard.addListener("apps_market.apps_have_changed",function(){delete d.entries});function c(l){for(var k=0;k<l.length;k++){var j=$j(l[k]);var m=j.css("z-index");if(m){j.attr("data-z-index",m)}j.css({"z-index":"-1"})}}function f(l){for(var k=0;k<l.length;k++){var j=$j(l[k]);var m=j.attr("data-z-index");if(m){j.css({"z-index":m})}}}d={triggerChar:"!",rte:null,init:function(i){this.rte=i;this._handleResults(this._makeRequest(jive.rest.url("/apps/v1/actions/rte"),""))},search:function(o,i,l,m,q){var j=jive.rest.url("/apps/v1/actions/rte");var p=jive.apps.dropdown.ddAppContent;var n=this._makeRequest(j,q);this._handleResults(n,i,p,l,m,q);if($j.browser.msie&&$j.browser.version<8){var k=$j(".j-publishbar");if(k.length>0){c(k)}else{c($j(".jive-content"))}}},select:function(k,l,n){var j=l.ed,i=this;var m=$j.Deferred();m.done(function(q,o,p){i.insertArtifact(q,p,k,l)});window.top.appContainer.handleRTEActionSelect(k.parent(),e(j,l.lastInfo),m);l.hideThePopup()},insertArtifact:function(n,l,j,k){var i=k.ed;var m=true;if(n.html){k.destroySearchText(i,k.lastInfo.node,k.lastInfo.offset);i.execCommand("mceInsertContent",false,n.html);var p=i.dom;tinymce.each(p.select("a.jive_macro_appEmbeddedView",i.getBody()),function(q){if(!p.getAttrib(q,"jivemacro")){p.setAttrib(q,"jivemacro","appEmbeddedView")}if(!p.getAttrib(q,"jivemacro")){p.setAttrib(q,"__jive_macro_name","appEmbeddedView")}})}else{var o=this._createArtifactFromData(i,j.parent().attr("appUUID"),j.parent().attr("appInstanceUUID"),j.parent().attr("actionId"),n,l);k.replaceSearchText(i,k.lastInfo.node,k.lastInfo.offset,o,m)}i.focus()},uploadArtifactPreviewImage:function(j,i){uploadAppImage({url:previewImageUrl,name:fileName},$img,rte,j);return $img},lookupLabel:function(l){if(this.entries){for(var j=0;j<this.entries.length;++j){var k=this.entries[j];if(k.id===l){return(k.label||"")}}}return""},_createArtifactFromData:function(k,p,i,o,n,m){var l=this;var j=new jive.Apps.RteArtifacts();return j.createArtifact({ed:k,rte:this.rte,appUUID:p,appInstanceUUID:i,actionId:o,data:n,editedContentBean:m,actionLabel:l.lookupLabel(o)})},_makeRequest:function(i,j){if(typeof this.entries==="undefined"||h!=g){return $j.ajax(i,{cache:false,dataType:"json",error:function(l,k){if(k!="abort"){}}})}else{if(j!==""){j=j.replace(/_/g," ");return $j.quickSilverFilter(this.entries,j,7,function(k){return k.filterString})}else{return this.entries}}},_highlightSearchChars:function(n,p){var l=n.split("");var k=p.toLowerCase().split("");var q="";for(var m=0;m<n.length;m++){var j=n.charAt(m);var r=j;var o=j.toLowerCase();if(k[0]==o){r='<span class="j-app-highlight">'+j+"</span>";k.shift()}q+=r}return{replaced:q,remainingSearchText:k.join("")}},_handleResults:function(i,k,l,m,o,n){var j=this;$j.when(i).then(function(p){if(typeof j.entries==="undefined"||h!=g){h=g;j.entries=$j.map(p,function(s){s.filterString=(s.appName+" : "+s.label).toLowerCase();return s})}var r=j.entries==null||j.entries.length<1;if(!l){return}var q=l.call(this,{nonInstalled:r,entries:p,searchText:n});k.popOverContents.html(q);k.popOverContents.find("li").each(function(){var t=$j(this);var u=n.toLowerCase().split("");var y=t.find("em");var w=y.text();var v=t.find("span[class=label]");var x=v.text();var s=j._highlightSearchChars(w,n);y.html(s.replaced);s=j._highlightSearchChars(x,s.remainingSearchText);v.html(s.replaced)});if(m!==null&&o!==null){k.positionThePopUp(k.ed,m,o)}k.popOverContents.find(".j-apps-market-link").click(function(u){var t=$j(this);var s=t.attr("data-filter")||null;if(window.appContainer){window.appContainer.handleMarketContext({experience:"appsCatalog",appFilter:s,actionContributionFilter:"jive/actions/rte"})}k.hideThePopup();b={ed:k.ed,bangPlugin:k,node:m,offset:o,searchText:n};u.preventDefault()});k.popOverContents.find("a").filter(".js-app-action-select-link").click(function(){var s=$j(this);j.select(s,k,false);return false}).attr("href","javascript:;")})}};tinymce.create("tinymce.plugins.JiveAppsPlugin",{rte:null,setRTE:function(i){this.rte=i;d.init(i);this.completeInit()},init:function(j,k){this.ed=j;var i=this;j.plugins.jivemention.addMentionType(d);j.onInit.add(function(){function l(s){return s.nodeType==1&&$j(s).hasClass("jive_macro_appEmbeddedView")}if(j.plugins.jivecontextmenu){var n=j.plugins.jivecontextmenu;function r(w){var t=$j(w);var v=t.data("actionEntry");if(!v){var z=t.attr("__action_id");var y=t.attr("__appuuid");for(var u=0,s=d.entries.length;u<s;++u){var x=d.entries[u];if(x.appUUID==y&&x.id==z){v=x;break}}if(!v){v={_noResult:false}}t.data("actionEntry",v)}return v._noResult===false?null:v}function m(s){if(!d.entries){return null}var u=s.startContainer.childNodes[s.startOffset];if(!u){u=s.startContainer}while(u&&!l(u)){u=u.parentNode}if(u){var t=r(u);if(t){return u}}return null}function p(x,t,v){var w=$j(x.findContextNode(t.selection.getRng(true)));var u=$j("<img/>").attr("src",w.data("actionEntry").icon).css({border:"none",width:"16px",height:"16px"});var y=$j("<div/>").css({"background-color":"#fff",width:"16px",height:"16px",padding:"2px 4px"}).append(u);var s=$j("<a/>").addClass("button").attr("href","javascript:;").css({"float":"left",width:"24px","text-align":"center"}).append(y);y.append(u);return s.append(y).get(0)}function o(s,t){$j("img",t).attr("src",$j(s).data("actionEntry").icon)}var q=new n.MenuItem("appEmbeddedView",m,null,p,"jiveAppReEdit",null,null,null,o);n.addRootItem(q)}},this)},completeInit:function(){if(this.rte&&this.ed&&!this.initialized){this.initialized=true;var j=this.ed;var m=j.dom;var k=new tinymce.dom.DOMUtils(document);var l=k.create("div",{"class":"gutterButton appButton"},j.getLang("jiveapps.edit_app"));var i=null;k.bind(l,"mousedown",function(){i=j.selection.getRng(true)});k.bind(l,"click",function(n){j.execCommand("jiveAppEdit",true,i);n.stopPropagation()});this.rte.getGutter().appendChild(l);j.plugins.paste.onPasteComplete.add(function(){tinymce.each(m.select("a.jive_macro_appEmbeddedView",j.getBody()),function(n){if(!m.getAttrib(n,"href")){m.setAttrib(n,"href","javascript:;")}});tinymce.each(m.select("a.jive-link-app-icon",j.getBody()),function(n){var o=$j(n);if(o.attr("__icon")){o.css("background-image","url('"+o.attr("__icon")+"')")}})});j.onPopupClose.add(function(){if($j.browser.msie&&$j.browser.version<8){f($j(".j-publishbar"));f($j(".jive-content"))}})}},execCommand:function(l,r,k){var o=this.ed;switch(l){case"jiveAppEdit":if(k){o.selection.setRng(k)}o.undoManager.add();var s=/\s/.test(this._charAt(this._prevCharPos(this.ed.selectionUtil.startPos(k))))?"!":" !";var p=s+o.selection.getContent();o.selection.setContent(p);o.selection.collapse(false);o.focus();o.undoManager.add();return true;case"jiveAppReEdit":if(k){var j=$j(k.node);var m=j.data("actionEntry");if(m){var n={offset:0};var i=$j.Deferred();i.done(function(t,u,w){var x=k.node;var v=d._createArtifactFromData(o,m.appUUID,m.appInstanceUUID,m.id,t,w);x.parentNode.insertBefore(v,x);x.parentNode.removeChild(x);$j(v).data("actionEntry",m)});var q=this._buildArtifact(j);window.top.appContainer.handleRTEActionContextEdit(m,e(o,n),q,i)}}}return false},_buildArtifact:function(j){var i=new jive.Apps.RteArtifacts();return i.parseSelectionContextFromArtifact(j)},getInfo:function(){return{longname:"Jive Apps",author:"Jive Software",authorurl:"http://www.jivesoftware.com",infourl:"http://www.jivesoftware.com/",version:"1.0"}},_charAt:function(i){if(i&&i.c.nodeType==3){return i.c.nodeValue.substr(i.off,1)}return null},_prevCharPos:function(i){if(i.c.nodeType==3){if(i.off>0){return{c:i.c,off:i.off-1}}else{return this._prevCharPos({c:i.c.parentNode,off:this.ed.dom.nodeIndex(i.c)})}}else{if(i.c.nodeType==1){if(i.off>0){var j=i.c.childNodes[i.off-1];if(j.nodeType==3){return this._prevCharPos({c:j,off:j.nodeValue.length})}else{return null}}else{return null}}}}});if(!(window._jive_current_user.anonymous||window._jive_current_user.partner)){tinymce.PluginManager.add("jiveapps",tinymce.plugins.JiveAppsPlugin)}})();