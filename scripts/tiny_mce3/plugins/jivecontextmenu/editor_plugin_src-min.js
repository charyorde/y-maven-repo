(function(){function g(k,j){if(k===j){return true}if(k==null||j==null||k.length!==j.length){return false}for(var h=0;h<k.length;++h){if(k[h]!==j[h]){return false}}return true}function f(i){if(i==null){i=/./}return function h(j){var k=j.startContainer.childNodes[j.startOffset];if(!k){k=j.startContainer}while(k&&(k.nodeType!=1||!i.test(k.nodeName))){k=k.parentNode}return k}}var a=f();var d=10;function e(){this._bound=function h(k,j,i){if(j<i){return null}return Math.min(Math.max(k,i),j)};this._positionArrow=function(i){return{top:i.height/2-9}};this._positionMenuLeft=function(t,k,p,o){var s=p.contextPos.left,r=p.contextWidth,q=p.contextMarginLeft,l=k.width,n=p.minX-p.leftSlop,j=p.minX+p.contentAreaW;function u(y,x){return function(){var z=y();if(!z){z=x()}return z}}function v(){if(s+q-l-d>=n){return{left:s+q-l-d,arrowPos:"left"}}if(s+q+p.contextPaddingLeft-l-d>=n){return{left:s+q+p.contextPaddingLeft-l-d,arrowPos:"left"}}}function i(){if(s+r+l+d<=j){return{left:s+r+d,arrowPos:"right"}}if(s+r<=j){return{left:s+r-l-d,arrowPos:"left"}}}function w(){if(s+q>=n){return{left:s+q+d,arrowPos:"right"}}}function m(){return{left:s+r-l-d,arrowPos:"left"}}if($j(p.contextNodes).filter("th,td").length){return u(i,u(v,u(w,m)))()}return u(v,u(i,u(w,m)))()};this._positionMenuTop=function(o,k,n,m){var p=n.cursorPos.top+n.cursorHeight/2,q=n.minY,j=n.minY+n.contentAreaH,r=k.height,i=n.contextPos.top+n.contextMarginTop,l=n.contextPos.top+n.contextMarginTop+n.contextHeight;var t=r/2;var s=this._bound(p,j-t,q+t);return this._bound(s,l,i)-r/2};this.position=function(l,j,n,i){var m=this._positionMenuLeft(l,j,n,i);var k={top:this._positionMenuTop(l,j,n,i),left:m.left};return{menuPos:k,menuDims:l,arrow:this._positionArrow(l),arrowClass:m.arrowPos+"Arrow"}}}function c(){this._superPositionLeft=this._positionMenuLeft;this._positionMenuLeft=function(r,i,n,m){var q=n.contextPos.left,p=n.contextWidth,o=n.contextMarginLeft,j=i.width,l=n.minX-n.leftSlop,h=n.minX+n.contentAreaW;var k=q+o-l;var s=h-(q+p+j);if(k>s&&k>=i.width){return{left:q+o-j-d,arrowPos:"left"}}else{if(k<=s&&s>=i.width){return{left:q+p+d,arrowPos:"right"}}else{return this._superPositionLeft(r,i,n,m)}}}}c.prototype=new e();function b(){var i=tinymce.activeEditor.plugins.jivecontextmenu;function h(k,j){return(k-j)/2}this.position=function(o,n,p,l){var j=h(i.lastPosition.menuDims.height,o.height);var k=0;if(i.$arrow.hasClass("leftArrow")){k=i.lastPosition.menuDims.width-o.width}var m=$j.extend(true,{},i.lastPosition,{menuDims:o});m.menuPos.top+=j;m.menuPos.left+=k;m.menuPos.left=this._bound(m.menuPos.left,p.minX+p.contentAreaW,p.minX-p.leftSlop);return $j.extend(true,m,{arrow:this._positionArrow(m.menuDims)})}}b.prototype=new e();tinymce.create("tinymce.plugins.JiveContextMenuPlugin",{MenuItem:function(m,o,s,r,p,v,u,l,n){var q=tinymce.activeEditor;if(!o){o=f()}else{if(o.constructor==RegExp){o=f(o)}}var k;if(typeof(r)=="string"){k=function(){var w=$j("<a class='button' href='javascript:;' style='float: left; width: auto; height: auto;'></a>");return w.append("<img src='"+r+"' />").get(0)}}else{if(typeof(r)=="function"){k=r}else{var i={backgroundImage:"url("+r.url+")",backgroundPosition:-r.xOffset+"px "+(-r.yOffset)+"px",width:r.width+"px",height:r.height+"px"};if(!v){v=function(w){return{width:r.width,height:r.height}}}k=function(){var x=$j("<a class='button' href='javascript:;' style='float: left;'></a>");x.css(v());var w=$j("<div />").css(i);return x.append(w).get(0)}}}var h;if(typeof(p)=="string"){h=function(x,w){q.execCommand(p,false,{node:x,rng:w});return true}}else{if(typeof(p)=="function"){h=p}else{h=function(x,w){p.show(q,w,null,p.items)}}}if(!v){v=function(w){return{width:20,height:20}}}else{if(typeof(v)=="object"){var t=v;v=function(){return t}}}function j(w){var x=this.findContextNode(w);if(x){var z=0;var y=w.startContainer.childNodes[w.startOffset];if(!y){++z;y=w.startContainer}while(y!=x){y=y.parentNode;++z}return z}return -1}$j.extend(this,{id:m,findContextNode:o,distance:j,title:s,render:k,action:$j.proxy(h,this),getDims:v,mouseenter:u?$j.proxy(u,this):null,mouseleave:l?$j.proxy(l,this):null,displayCallback:n?$j.proxy(n,this):null})},PositionStrategy:e,StaticPositionStrategy:b,MenuDisplayManager:function(i,n){var l=i.plugins.jivecontextmenu;var j=300;this.isVertical=n;var h=new c();var k=new b();var o=i.plugins.jiveutil.arrayEquals;$j.extend(this,{lastItems:null,renderItems:function(p,u,t,q){var s=u.getDOM();var r=t.$menu;if(!o(this.lastItems,q)){this.lastItems=q;s.children().remove();$j.each(q,function(){var x=this;var v=$j(x.render(x,i,t.$menu)).addClass("menuItem_"+x.id);if(u.title!=null&&x.title!=null){function w(y){return function(){t.setItemTitle(y)}}v.mouseenter(w(x.title))}v.click(function(z){if(tinymce.isIE){i.focus()}var y=i.selection.getRng(true);var B=x.findContextNode(y);t.clearHideTimeout();var A=x.action(B,y);if(A!==false){u.tearDownMenu()}if(A===true){u.hide()}return false});if(x.mouseenter){v.mouseenter(x.mouseenter)}if(x.mouseleave){v.mouseleave(x.mouseleave)}s.append(v)})}r.find(".menuItems").hide();s.show();$j.each(q,function(){if(this.displayCallback){var v=this.findContextNode(p);this.displayCallback(v,s.children(".menuItem_"+this.id).get(0))}})},getConstraints:function(y,q,B){var p=y.selection.getRng(true);var x=y.plugins.jivescroll;var A=y.plugins.jivecontextmenu;function s(D){var C=parseFloat(D);return isNaN(C)?0:C}var w=B[0].findContextNode(p);var t=[];$j.each(B,function(){var C=this.findContextNode(p);if(C){t.push(C)}});var z=$j(w);var r=s(z.css("margin-top"));var v=s(z.css("margin-left"));var u=$j(q);return{contentAreaH:A.rte.getContentAreaHeight(),contentAreaW:A.rte.getContentAreaWidth(),minY:x.lastScrollY,minX:x.lastScrollX,leftSlop:40,contextNode:w,contextNodes:t,contextPos:z.position(),contextHeight:z.outerHeight()+r,contextWidth:z.outerWidth()+v,contextMarginTop:r,contextMarginLeft:v,contextPaddingLeft:s(z.css("padding-left")),cursorPos:u.position(),cursorHeight:u.outerHeight(true),cursorPaddingLeft:s(u.css("padding-left"))}},findDimensions:function(u,r){var t={width:0,height:0};if(this.isVertical){$j.each(r,function(){var v=this.getDims();t.width=Math.max(v.width,t.width);t.height+=v.height});t.width+=6;t.height+=(r.length)*6}else{$j.each(r,function(){var v=this.getDims();t.width+=v.width;t.height=Math.max(v.height,t.height)});t.width+=(r.length)*6;t.height+=6}if(u.title!=null&&!this.isVertical){var p="";$j.each(r,function(){if(this.title!=null&&this.title.length>p){p=this.title}});l.setMenuTitle(u.title);var q=l.getTextDims(u.title,p+"m");t.width=Math.max(t.width,q.width+6);t.height+=q.height;l.setItemTitle("");l.$textLabel.show()}else{l.$textLabel.hide()}var s={width:t.width+10,height:t.height+10};return{inner:t,outer:s}},position:function(s,r,v,q){function u(C,y){function B(G,I,F,H){var E=G-F;var D=I-H;return Math.sqrt(E*E+D*D)}var x=C.x,A=C.y,w=y.left,z=y.top;if(B(x,A,w,z)<=j){return false}w+=y.width;if(B(x,A,w,z)<=j){return false}z+=y.height;if(B(x,A,w,z)<=j){return false}w-=y.width;return B(x,A,w,z)>j}var p=l.$menu.filter(":visible").length>0;var t=null;if(p){t=k.position(s,r,v,q)}if(!t){t=h.position(s,r,v,q)}l.$arrow.removeClass().addClass(t.arrowClass+" pointer");return t},clip:function(p,q){if(p.menuPos.top+p.menuDims.height<q.minY-3){return null}else{if(p.menuPos.top>q.minY+q.contentAreaH){return null}else{if(p.menuPos.left+p.menuDims.width<q.minX-q.leftSlop){return null}else{if(p.menuPos.left>q.minX+q.contentAreaW){return null}else{return p}}}}},layoutMenu:function m(u,r,w,q,p){this.renderItems(p.selection.getRng(true),u,l,q);var v=this.getConstraints(p,r,q);var t=this.findDimensions(u,q);var s=this.position(t.inner,t.outer,v,w);return this.clip(s,v)}})},Menu:function(y,u,n,z,q,i,t){if(y==null){y=[]}var l=tinymce.activeEditor.plugins.jivecontextmenu;if(t==null){t=new l.MenuDisplayManager(tinymce.activeEditor,n)}var m=this;var o=l.$menuPopover;var j=l.$menu;var s=l.$arrow;var x=$j("<div class='menuItems'></div>");x.hide();if(q!=null){q=$j.proxy(q,this);o.mouseenter(q)}if(i!=null){i=$j.proxy(i,this);o.mouseleave(i)}l.$menu.append(x);function w(){if(q){o.unbind("mouseenter",q)}if(i){o.unbind("mouseleave",i)}}function p(){o.find(".menuItems").hide();o.hide();w();l.onHideMenu.dispatch(m);l.clearHideTimeout()}function v(C,A,F,B){function D(){var G=[];var H={};$j.each(m.items,function(){H[this.id]=this.distance(A)});G=m.items.slice();if(!u){G.sort(function(J,I){return H[J.id]-H[I.id]})}G=$j.map(G,function(I){return(H[I.id]<0)?null:I});return G}if(B==null){B=D()}if(B.length==0){this.hide()}else{var E=a(A);k(E,F,B,C);l.onShowMenu.dispatch(m)}}function k(D,F,B,A){var E=t.layoutMenu(m,D,F,B,A);if(E){if(o.is(":visible")){var C=false;if(o.has(document.activeElement).length>0){C=true}s.hide().css(E.arrow);o.animate(E.menuPos,{complete:function(){s.show();o.find("a:visible, input:visible").first().focus()}});j.animate(E.menuDims)}else{s.css(E.arrow);o.css(E.menuPos);j.css(E.menuDims);o.show();l.createHideTimeout(A)}l.lastPosition=E}else{m.hide()}}function r(){return x.is(":visible")}function h(){return x}$j.extend(this,{items:y,show:v,hide:p,tearDownMenu:w,title:z,isVisible:r,getDOM:h})},setRootMenu:function(h){this.rootMenu=h},addRootItem:function(h){this.rootMenu.items.push(h)},hideMenu:function(){if(this.rootMenu){this.rootMenu.hide()}this.clearHideTimeout()},setItemTitle:function(h){this.$textLabel.children(".itemTitle").text(h)},setMenuTitle:function(h){this.$textLabel.children(".menuTitle").text(h)},getTextDims:function(j,i){var m=this.$textLabel.children(".itemTitle").text();var l=this.$textLabel.children(".menuTitle").text();this.setMenuTitle(j);this.setItemTitle(i);var k={};var h=this.$textLabel.is(":visible");this.$poc.append(this.$textLabel);this.$textLabel.show().css("opacity","0%").css("position","absolute");k.width=this.$textLabel.outerWidth(true);k.height=this.$textLabel.outerHeight(true);this.$textLabel.css("opacity","").css("position","");if(!h){this.$textLabel.hide()}this.$menu.prepend(this.$textLabel);this.setMenuTitle(l);this.setItemTitle(m);return k},makeFindContextNode:f,rte:null,rootMenu:null,$menuPopover:null,$menu:null,fullPopOverWidth:230,fullPopOverHeight:400,MENU_TIMEOUT:2000,lastPosition:null,theHideTimeout:null,createHideTimeout:function(h){this.clearHideTimeout();var i=this;this.theHideTimeout=setTimeout(function(){i.hideMenu()},this.MENU_TIMEOUT)},clearHideTimeout:function(){if(this.theHideTimeout!=null){clearTimeout(this.theHideTimeout);this.theHideTimeout=null}},setRTE:function(h){this.rte=h;this.completeInit()},completeInit:function(){if(this.rte&&!this.initialized){this.initialized=true;var h=this.rte.getPopOverContainer();h.append(this.$menuPopover);this.$poc=h}},init:function(k){var l=this;this.onShowMenu=new tinymce.util.Dispatcher();this.onHideMenu=new tinymce.util.Dispatcher();var o=null;function m(q){if(q){o=q}else{q=o}if(l.rootMenu&&k.selection){l.rootMenu.hide();l.rootMenu.show(k,k.selection.getRng(true),q)}}function p(){l.hideMenu()}function n(r,q){var s=r.plugins.jivescroll;var t={x:q.clientX+s.lastScrollX,y:q.clientY+s.lastScrollY};l.lastPosition=null;m(t)}k.onClick.add(n);k.addShortcut("alt+c","Context Menu",function(){m();l.clearHideTimeout();l.$menuPopover.find("a").first().focus()});if(tinymce.isIE){k.onMouseUp.add(function(r,q){if(q.target.nodeName.toLowerCase()=="img"){n(r,q)}})}k.onKeyDown.addToTop(function(){if(l.theHideTimeout!=null){p()}});function i(){m()}k.theme.onResize.add(i);$j(window).resize(i);var j=$j(k.getContainer()).children("table:first tr.mceIframeRow");k.onScroll.add(function(s,r){if(this.lastPosition){if((this.lastPosition.menuPos.top+20)-r<=0){p()}else{var q=j.height();if((this.lastPosition.menuPos.top+20)-r>=q){p()}}}},this);k.onInit.add(function(){this.completeInit()},this);this.$menuPopover=$j("<div class='j-pop js-pop j-rte-popover j-table-popover popover'><div class='j-pop-main j-rte'><h3 class='textLabel'><span class='menuTitle'></span><span class='itemTitle'></span></h3></div><span class='pointer'></span></div>");this.$menu=this.$menuPopover.children(".j-pop-main");this.$menuPopover.css("position","absolute").hide();this.$arrow=this.$menuPopover.children(".pointer");this.$textLabel=this.$menu.children(".textLabel");this.$menuPopover.mouseenter(function(){l.clearHideTimeout()}).mouseleave(function(){if(l.rootMenu.isVisible()){l.createHideTimeout(k)}}).keydown(function(q){if(q.keyCode==27){p();k.focus();return false}});var h=new this.Menu([],false,true);this.setRootMenu(h)},getInfo:function(){return{longname:"Jive Context",author:"Jive Software",authorurl:"http://jivesoftware.com",infourl:"http://jivesoftware.com",version:tinyMCE.majorVersion+"."+tinyMCE.minorVersion}}});tinymce.PluginManager.add("jivecontextmenu",tinymce.plugins.JiveContextMenuPlugin)})();