module("Jive @ Mention Plugin",{autostart:false});function mentionSearchAtPos(b,c,d){var a=b.dom.createRng();a.setStart(c,d);a.collapse(true);return b.plugins.jivemention._mentionSearch(a)}test("cursor immediately before @",function(){ed.setContent("<p>first </p>",{format:"raw"});var d=ed.getBody().firstChild.firstChild;var b=ed.getDoc().createTextNode("@second ");var a=ed.getDoc().createTextNode("third");$j("br",ed.getBody()).remove();ed.getBody().firstChild.appendChild(b);ed.getBody().firstChild.appendChild(a);var c=mentionSearchAtPos(ed,b,0);equals(c,null);equals(ed.getContent(),"<p>first @second third</p>")});test("text node ends at space",function(){ed.setContent("<p>first </p>",{format:"raw"});var d=ed.getBody().firstChild.firstChild;var b=ed.getDoc().createTextNode("@second ");var a=ed.getDoc().createTextNode("third");$j("br",ed.getBody()).remove();ed.getBody().firstChild.appendChild(b);ed.getBody().firstChild.appendChild(a);var c=mentionSearchAtPos(ed,b,1);equals(typeof c,"object");equals(c.type,"@");equals(c.searchText,"second");var c=mentionSearchAtPos(ed,b,7);equals(typeof c,"object");equals(c.type,"@");equals(c.searchText,"second");var c=mentionSearchAtPos(ed,b,8);equals(c,null);equals(ed.getContent(),"<p>first @second third</p>")});test("text node ends at @ mention",function(){ed.setContent("<p>first </p>",{format:"raw"});var d=ed.getBody().firstChild.firstChild;var b=ed.getDoc().createTextNode("@second");var a=ed.getDoc().createTextNode(" third");$j("br",ed.getBody()).remove();ed.getBody().firstChild.appendChild(b);ed.getBody().firstChild.appendChild(a);var c=mentionSearchAtPos(ed,b,7);equals(typeof c,"object");equals(c.type,"@");equals(c.searchText,"second");var c=mentionSearchAtPos(ed,a,0);equals(typeof c,"object");equals(c.type,"@");equals(c.searchText,"second");equals(ed.getContent(),"<p>first @second third</p>")});test("@ mention nested inside nodes",function(){ed.setContent("<p>first <span>@awe</span></p>");var a=mentionSearchAtPos(ed,$j(ed.getBody()).find("p").get(0),2);equal(a,null);var a=mentionSearchAtPos(ed,$j(ed.getBody()).find("span").get(0),1);equals(typeof a,"object");equals(a.type,"@");equals(a.searchText,"awe");var a=mentionSearchAtPos(ed,$j(ed.getBody()).find("span").get(0),0);equals(a,null);equals(ed.getContent(),"<p>first <span>@awe</span></p>")});test("@mention w/o surrounding text nodes",function(){ed.setContent("<p>@awe</p>");var a=mentionSearchAtPos(ed,ed.getBody().firstChild,1);equals(typeof a,"object");equals(a.type,"@");equals(a.searchText,"awe");equals(ed.getContent(),"<p>@awe</p>")});test("@ mention split by nodes",function(){ed.setContent("<p>first </p>",{format:"raw"});var d=ed.getBody().firstChild.firstChild;var b=ed.getDoc().createTextNode("@sec");var a=ed.getDoc().createTextNode("ond third");$j("br",ed.getBody()).remove();ed.getBody().firstChild.appendChild(b);ed.getBody().firstChild.appendChild(a);var c=mentionSearchAtPos(ed,b,1);equals(typeof c,"object");equals(c.type,"@");equals(c.searchText,"second");var c=mentionSearchAtPos(ed,a,0);equals(typeof c,"object");equals(c.type,"@");equals(c.searchText,"second");var c=mentionSearchAtPos(ed,a,2);equals(typeof c,"object");equals(c.type,"@");equals(c.searchText,"second");equals(ed.getContent(),"<p>first @second third</p>")});test("@mention positioned for first line of text",function(){ed.plugins.jivemention.hideThePopup(true);ed.setContent("<p>and this is more text @awe</p>");var c=$j(ed.getBody()).find("p");c=c[c.length-1];var b=mentionSearchAtPos(ed,c,1);equals(typeof b,"object");equals(b.type,"@");equals(b.offset,22);equals(b.searchText,"awe");var a=ed.plugins.jivemention.positionThePopUp(ed,b.node,b.offset,b.searchText);near(a.top,35,5,"top offset is correct");near(a.left,84,5,"left offset is correct")});test("@mention positioned on last line of text",function(){ed.plugins.jivemention.hideThePopup(true);ed.setContent("<p></p><p></p><p>and this is more text @awe</p>",{format:"raw"});var b=$j(ed.getBody()).find("p");b=b[b.length-1];var a=mentionSearchAtPos(ed,b,1);equals(typeof a,"object");equals(a.type,"@");equals(a.offset,22);equals(a.searchText,"awe");stop();setTimeout(function(){var c=ed.plugins.jivemention.positionThePopUp(ed,a.node,a.offset,a.searchText);near(c.top,78,5,"top offset is correct");near(c.left,84,5,"left offset is correct");start()},200)});test("@mention positioned after a macro link",function(){ed.plugins.jivemention.hideThePopup(true);ed.setContent('<p><a class="jive_macro default_title jive_macro_document" href="javascript:;" jivemacro="document" ___default_attr="1001">awesome!!</a> @awe</p>');var c=$j(ed.getBody()).find("p");c=c[c.length-1];var b=mentionSearchAtPos(ed,c,2);equals(typeof b,"object");equals(b.type,"@");equals(b.offset,1);equals(b.searchText,"awe");console.log(b);var a=ed.plugins.jivemention.positionThePopUp(ed,b.node,b.offset,b.searchText);near(a.top,35,5,"top offset is correct");near(a.left,43,5,"left offset is correct")});test("@mention positioned in a quote",function(){ed.plugins.jivemention.hideThePopup(true);ed.setContent('<pre class="jive_text_macro jive_macro_quote" jivemacro="quote"><p>@awe</p></pre>');var c=$j(ed.getBody()).find("pre p");c=c[c.length-1];var b=mentionSearchAtPos(ed,c,1);equals(typeof b,"object");equals(b.type,"@");equals(b.offset,0);equals(b.searchText,"awe");var a=ed.plugins.jivemention.positionThePopUp(ed,b.node,b.offset,b.searchText);near(a.top,60,7,"top offset is correct");near(a.left,2,5,"left offset is correct")});test("@mention positioned in a table",function(){ed.plugins.jivemention.hideThePopup(true);ed.setContent('<table border="1" cellpadding="3" cellspacing="0" class="jiveBorder" style="width: 100%; border: 1px solid #000000;"><tbody><tr><th align="center" style="background-color:#6690BC;" valign="middle"><span style="color: #ffffff;"><strong>Header 1</strong></span></th><th align="center" style="background-color:#6690BC;" valign="middle"><span style="color: #ffffff;"><strong>Header 2</strong></span></th></tr><tr><td>asdf asdf asdf @awe</td><td></td></tr><tr><td></td><td></td></tr></tbody></table>');var c=$j(ed.getBody()).find("td");c=c[0];var b=mentionSearchAtPos(ed,c,1);equals(typeof b,"object");equals(b.type,"@");equals(b.offset,15);equals(b.searchText,"awe");var a=ed.plugins.jivemention.positionThePopUp(ed,b.node,b.offset,b.searchText);near(a.top,63,5,"top offset is correct");near(a.left,50,5,"left offset is correct")});test("@mention positioned in a table with _",function(){ed.plugins.jivemention.hideThePopup(true);ed.setContent('<table border="1" cellpadding="3" cellspacing="0" class="jiveBorder" style="width: 100%; border: 1px solid #000000;"><tbody><tr><th align="center" style="background-color:#6690BC;" valign="middle"><span style="color: #ffffff;"><strong>Header 1</strong></span></th><th align="center" style="background-color:#6690BC;" valign="middle"><span style="color: #ffffff;"><strong>Header 2</strong></span></th></tr><tr><td>asdf asdf asdf @awe_some</td><td></td></tr><tr><td></td><td></td></tr></tbody></table>');var c=$j(ed.getBody()).find("td");c=c[0];var b=mentionSearchAtPos(ed,c,1);equals(typeof b,"object");equals(b.type,"@");equals(b.offset,15);equals(b.searchText,"awe_some");var a=ed.plugins.jivemention.positionThePopUp(ed,b.node,b.offset,b.searchText);near(a.top,63,5,"top offset is correct");near(a.left,50,5,"left offset is correct")});test("@mention positioned after long line of text",function(){ed.plugins.jivemention.hideThePopup(true);ed.setContent('<p><a class="jive_macro default_title jive_macro_message" href="javascript:;" jivemacro="message" ___default_attr="1031">How awesome can awesome be?</a><span> </span></p><p> </p><p><span>lsakdfjlskafjlskafjlskadf @</span></p>');var c=$j(ed.getBody()).find("p>span");c=c[c.length-1];var b=mentionSearchAtPos(ed,c,1);equals(typeof b,"object");equals(b.type,"@");equals(b.offset,26);equals(b.searchText,"");var a=ed.plugins.jivemention.positionThePopUp(ed,b.node,b.offset,b.searchText);near(a.top,80,5,"top offset is correct");near(a.left,100,5,"left offset is correct")});