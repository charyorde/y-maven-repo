module("Jive Selection Plugin",{autostart:false});if(!tinymce.isIE){test("normalizeRange, collapsed, start of body",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody();a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);equal(a.startContainer,b,"container");equal(a.startOffset,0,"offset")});test("normalizeRange, collapsed, start of ul",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild;a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer.childNodes[a.startOffset];equal(c.nodeType,1,"should select li node");equal(c.nodeName.toLowerCase(),"li","should be the li")});test("normalizeRange, collapsed, start of li",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer;equal(c.nodeType,3,"should select text node");equal(c.nodeValue,"text","should be the text node with the content 'text'");equal(a.startOffset,0,"should be the beginning of the text node")});test("normalizeRange, collapsed, li[1]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,1);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer;equal(c.nodeType,3,"should select text node");equal(c.nodeValue,"text","should be the text node with the content 'text'");equal(a.startOffset,0,"should be the beginning of the text node")});test("normalizeRange, collapsed, text[0]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild.childNodes[1];a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer;equal(c.nodeType,3,"should select text node");equal(c.nodeValue,"text","should be the text node with the content 'text'");equal(a.startOffset,0,"should be the beginning of the text node")});test("normalizeRange, collapsed, text[1]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild.childNodes[1];a.setStart(b,1);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer;equal(c.nodeType,3,"should select text node");equal(c.nodeValue,"text","should be the text node with the content 'text'");equal(a.startOffset,1,"should be at second spot in the text node")});test("normalizeRange, collapsed, text[-1]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild.childNodes[1];a.setStart(b,4);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer;equal(c.nodeType,3,"should select text node");equal(c.nodeValue,"text","should be the text node with the content 'text'");equal(a.startOffset,4,"should be the start of the text node")});test("normalizeRange, collapsed, after text node",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,2);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer;equal(c.nodeType,3,"should select text node");equal(c.nodeValue,"text","should be the text node with the content 'text'");equal(a.startOffset,4,"should be the start of the text node")});test("normalizeRange, collapsed, start of strong",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild.childNodes[2];a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer;equal(c.nodeType,3,"should select text node");equal(c.nodeValue,"text","should be the text node with the content 'text'");equal(a.startOffset,4,"should be the start of the text node")});test("normalizeRange, collapsed, end of strong",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild.childNodes[2];a.setStart(b,1);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer;equal(c.nodeType,3,"should select text node");equal(c.nodeValue,"bold text","should be the text node with the content 'bold text'");equal(a.startOffset,9,"should be the start of the text node")});test("normalizeRange, collapsed, after b",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,3);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=a.startContainer;equal(c.nodeType,3,"should select text node");equal(c.nodeValue,"bold text","should be the text node with the content 'bold text'");equal(a.startOffset,9,"should be the start of the text node")});test("normalizeRange, collapsed, end of ul",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild;a.setStart(b,1);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);equal(a.startContainer,b,"ul container");equal(a.startOffset,1,"unmoved")});test("normalizeRange, selection, body[0] to body[-1]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody();a.setStart(b,0);a.setEnd(b,1);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(ed.getBody().firstChild.firstChild.childNodes[1],0);c.setEnd(ed.getBody().lastChild.lastChild.lastChild,9);rangeEqual(a,c)});test("normalizeRange, selection, whole body",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody();a.setStart(ed.getBody().firstChild.firstChild.childNodes[1],0);a.setEnd(ed.getBody().lastChild.lastChild,4);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(ed.getBody().firstChild.firstChild.childNodes[1],0);c.setEnd(ed.getBody().lastChild.lastChild.lastChild,9);rangeEqual(a,c)});test("normalizeRange, selection, ul[0] to ul[-1]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild;a.setStart(b,0);a.setEnd(b,1);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(ed.getBody().firstChild.firstChild.childNodes[1],0);c.setEnd(ed.getBody().lastChild.lastChild.lastChild,9);rangeEqual(a,c)});test("normalizeRange, selection, li[1] to li[2]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,1);a.setEnd(b,2);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();var d=b.childNodes[1];c.setStart(d,0);c.setEnd(d,d.nodeValue.length);rangeEqual(a,c)});test("normalizeRange, selection, li[2] to li[3]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,2);a.setEnd(b,3);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();var d=b.childNodes[2].firstChild;c.setStart(d,0);c.setEnd(d,d.nodeValue.length);rangeEqual(a,c)});test("normalizeRange, selection, li[2] to strong[1]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,2);a.setEnd(b.childNodes[2],1);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();var d=b.childNodes[2].firstChild;c.setStart(d,0);c.setEnd(d,d.nodeValue.length);rangeEqual(a,c)});test("normalizeRange, selection, 'bold text'[2] to 'more text'[4]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b.childNodes[2].firstChild,2);a.setEnd(b.childNodes[3],4);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b.childNodes[2].firstChild,2);c.setEnd(b.childNodes[3],4);rangeEqual(a,c)});test("normalizeRange, selection, li[0] to strong[1]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,0);a.setEnd(b.childNodes[2],1);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b.childNodes[1],0);c.setEnd(b.childNodes[2].firstChild,9);rangeEqual(a,c)});test("normalizeRange, selection, body[0] to strong[1]",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b.childNodes[1],0);a.setEnd(b.childNodes[2],1);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b.childNodes[1],0);c.setEnd(b.childNodes[2].firstChild,9);rangeEqual(a,c)});test("normalizeRange, selection, strong[0] to end",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b.childNodes[2].firstChild,0);a.setEnd(b,4);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b.childNodes[2].firstChild,0);c.setEnd(b.lastChild,9);rangeEqual(a,c)});test("normalizeRange, complex formatting, cursor between bold and italic",function(){ed.setContent('<p>text<strong>bold text</strong><em>italic text</em><span data-mce-style="font-size: 12pt;" style="font-size: 12pt;">12 pt text</span><br></p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild.childNodes[1].firstChild;a.setStart(b,b.nodeValue.length);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);equal(a.startContainer.nodeValue,"bold text","collapsed cursor should prefer the previous text node");ok(a.collapsed,"range is collapsed")});test("normalizeRange, complex formatting, cursor between bold and italic, starting in italic text",function(){ed.setContent('<p>text<strong>bold text</strong><em>italic text</em><span data-mce-style="font-size: 12pt;" style="font-size: 12pt;">12 pt text</span><br></p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild.childNodes[2].firstChild;a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);equal(a.startContainer.nodeValue,"bold text","collapsed cursor should prefer the previous text node");ok(a.collapsed,"range is collapsed")});test("normalizeRange, complex formatting, select italic text",function(){ed.setContent('<p>text<strong>bold text</strong><em>italic text</em><span data-mce-style="font-size: 12pt;" style="font-size: 12pt;">12 pt text</span><br></p>');var a=ed.dom.createRng();var c=ed.getBody().firstChild.childNodes[1].firstChild;var b=ed.getBody().firstChild.childNodes[2].firstChild;a.setStart(c,9);a.setEnd(b,11);a=ed.selectionUtil.normalizeRange(a);equal(a.startContainer.nodeValue,"italic text","start should prefer the next text node");equal(a.startOffset,0,"start should prefer the next text node");equal(a.endContainer,a.startContainer,"same node selected");equal(a.endOffset,a.endContainer.nodeValue.length,"end of selection should be end of italic text node")});test("normalizeRange, collapsed, beginning of list item with br",function(){ed.setContent("<p><br /></p>");var a=ed.dom.createRng();var b=ed.getBody().firstChild;a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b,0);c.collapse(true);rangeEqual(a,c)});test("normalizeRange, link, beginning of strongold after link",function(){ed.setContent('<p>text<a href="http://www.google.com/">link</a><strong>bold text</strong></p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild.childNodes[2].firstChild;a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b,0);c.collapse(true);rangeEqual(a,c);ok(a.collapsed,"range is collapsed")});test("normalizeRange, link, end of link",function(){ed.setContent('<p>text<a href="http://www.google.com/">link</a><strong>bold text</strong></p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild.childNodes[1].firstChild;a.setStart(b,4);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b,4);c.collapse(true);rangeEqual(a,c);ok(a.collapsed,"range is collapsed")});test("normalizeRange, link, beginning of link",function(){ed.setContent('<p>text<a href="http://www.google.com/">link</a><strong>bold text</strong></p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild.childNodes[1].firstChild;a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b,0);c.collapse(true);rangeEqual(a,c);ok(a.collapsed,"range is collapsed")});test("normalizeRange, link, end of text before link",function(){ed.setContent('<p>text<a href="http://www.google.com/">link</a><strong>bold text</strong></p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,4);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b,4);c.collapse(true);rangeEqual(a,c);ok(a.collapsed,"range is collapsed")});test("normalizeRange, br, after br mid-p",function(){ed.setContent("<p>text<br />more text</p>");var a=ed.dom.createRng();var b=ed.getBody().firstChild;a.setStart(b,2);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b.childNodes[2],0);c.collapse(true);rangeEqual(a,c);ok(a.collapsed,"range is collapsed")});test("normalizeRange, multiple text nodes in p, selection",function(){ed.setContent("<p>text </p>",{format:"raw"});var a=ed.dom.createRng();var b=ed.getBody().firstChild;while(b.lastChild.nodeType==1){b.removeChild(b.lastChild)}b.appendChild(ed.getDoc().createTextNode("more text "));b.appendChild(ed.getDoc().createTextNode("end text"));a.setStart(b.childNodes[1],2);a.setEnd(b.childNodes[2],0);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b.firstChild,7);c.setEnd(b.firstChild,15);rangeEqual(a,c);equal(a.toString(),"re text ","correct selected text")});test("normalizeRange, cursor after image",function(){ed.setContent('<p>text <img class="jive_macro jive_emote" src="/4.5.5/images/emoticons/happy.png" jivemacro="emoticon" ___jive_emoticon_name="happy" /> more text</p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild;while(b.lastChild.nodeType==1){b.removeChild(b.lastChild)}a.setStart(b.childNodes[2],0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b.lastChild,0);c.collapse(true);rangeEqual(a,c)});test("normalizeRange, cursor before image",function(){ed.setContent('<p>text <img class="jive_macro jive_emote" src="/4.5.5/images/emoticons/happy.png" jivemacro="emoticon" ___jive_emoticon_name="happy" /> more text</p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild;while(b.lastChild.nodeType==1){b.removeChild(b.lastChild)}a.setStart(b,1);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b.firstChild,5);c.collapse(true);rangeEqual(a,c)});test("normalizeRange, cursor before image at start of p",function(){ed.setContent('<p><img class="jive_macro jive_emote" src="/4.5.5/images/emoticons/happy.png" jivemacro="emoticon" ___jive_emoticon_name="happy" /> more text</p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild;while(b.lastChild.nodeType==1){b.removeChild(b.lastChild)}a.setStart(b,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b,0);c.collapse(true);rangeEqual(a,c)});test("normalizeRange, select starts before image at start of p",function(){ed.setContent('<p><img class="jive_macro jive_emote" src="/4.5.5/images/emoticons/happy.png" jivemacro="emoticon" ___jive_emoticon_name="happy" /> more text</p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild;while(b.lastChild.nodeType==1){b.removeChild(b.lastChild)}b.insertBefore(ed.getDoc().createTextNode(""),b.firstChild);a.setStart(b,0);a.setEnd(b,3);a=ed.selectionUtil.normalizeRange(a);var c=ed.dom.createRng();c.setStart(b,0);c.setEnd(b.lastChild,10);rangeEqual(a,c)});test("normalizeRange, select into empty p",function(){ed.setContent("<p>some text</p><p><br /></p>");var a=ed.dom.createRng();a.setStart(ed.getBody().firstChild,0);a.setEnd(ed.getBody().lastChild,0);a=ed.selectionUtil.normalizeRange(a);var b=ed.dom.createRng();b.setStart(ed.getBody().firstChild.firstChild,0);b.setEnd(ed.getBody().lastChild,0);rangeEqual(a,b)});test("normalizeRange, cursor before image in li",function(){ed.setContent('<ul><li>text</li><li><img src="/4.5.5/images/emoticons/happy.png" /></li>');var a=ed.dom.createRng();a.setStart(ed.getBody().firstChild.lastChild,0);a.collapse(true);a=ed.selectionUtil.normalizeRange(a);var b=ed.dom.createRng();b.setStart(ed.getBody().firstChild.lastChild,0);a.collapse(true);rangeEqual(a,b)});if(tinymce.isGecko){test("delete entire h3",function(){ed.setContent("<h3>some text</h3><h3>more text</h3><p>para</p>");var a=ed.dom.createRng();a.setStart(ed.getBody().firstChild.firstChild,0);a.setEnd(ed.getBody().childNodes[1],0);ed.selection.setRng(a);type(ed,8);equal(ed.getContent().replace(/[\r\n]+/g,""),"<h3>more text</h3><p>para</p>")});test("type over entire h3",function(){ed.setContent("<h3>some text</h3><h3>more text</h3><p>para</p>");var a=ed.dom.createRng();a.setStart(ed.getBody().firstChild.firstChild,0);a.setEnd(ed.getBody().childNodes[1],0);ed.selection.setRng(a);type(ed,65);equal(ed.getContent().replace(/[\r\n]+/g,""),"<h3>more text</h3><p>para</p>")})}test("range stability under normalization, first node inner",function(){ed.setContent("<p>one </p>");var d=ed.getBody().firstChild;while(d.lastChild.nodeType==1){d.removeChild(d.lastChild)}var c=ed.getDoc();d.appendChild(c.createTextNode("two "));d.appendChild(c.createTextNode("three"));equal(d.childNodes.length,3,"separate children");var a=c.createRange();a.setStart(d.firstChild,0);a.setEnd(d.firstChild,3);a=ed.selectionUtil.safeNormalize(a);var b=c.createRange();b.setStart(d.firstChild,0);b.setEnd(d.firstChild,3);equal(d.childNodes.length,3,"separate children");rangeEqual(a,b);equal(a.toString(),"one")});test("selection stability under normalization",function(){ed.setContent("<p>one </p>",{format:"raw"});var e=ed.getBody().firstChild;while(e.lastChild.nodeType==1){e.removeChild(e.lastChild)}var d=ed.getDoc();e.appendChild(d.createTextNode("two "));e.appendChild(d.createTextNode("three"));equal(e.childNodes.length,3,"separate children");var b=d.createRange();b.setStart(e.lastChild,1);b.collapse(true);ed.selectionUtil.setSelection(b,true);var a=ed.selection.getRng(true);a=ed.selectionUtil.safeNormalize(a,e);ed.selection.setRng(a);var c=d.createRange();c.setStart(e.firstChild,9);c.collapse(true);equal(e.childNodes.length,1,"one text node");rangeEqual(ed.selection.getRng(),c)});test("range stability under normalization, first node boundaries",function(){ed.setContent("<p>one </p>",{format:"raw"});var d=ed.getBody().firstChild;while(d.lastChild.nodeType==1){d.removeChild(d.lastChild)}var c=ed.getDoc();d.appendChild(c.createTextNode("two "));d.appendChild(c.createTextNode("three"));var a=c.createRange();a.setStart(d.firstChild,0);a.setEnd(d.firstChild,4);a=ed.selectionUtil.safeNormalize(a);var b=c.createRange();b.setStart(d.firstChild,0);b.setEnd(d.firstChild,4);equal(d.childNodes.length,3,"separate children");rangeEqual(a,b);equal(a.toString(),"one ")});test("range stability under normalization, first node start, collapsed",function(){ed.setContent("<p>one </p>",{format:"raw"});var d=ed.getBody().firstChild;while(d.lastChild.nodeType==1){d.removeChild(d.lastChild)}var c=ed.getDoc();d.appendChild(c.createTextNode("two "));d.appendChild(c.createTextNode("three"));var a=c.createRange();a.setStart(d.firstChild,0);a.setEnd(d.firstChild,0);a=ed.selectionUtil.safeNormalize(a);var b=c.createRange();b.setStart(d.firstChild,0);b.setEnd(d.firstChild,0);equal(d.childNodes.length,3,"separate children");rangeEqual(a,b);equal(a.toString(),"")});test("range stability under normalization, first[0] - second[0]",function(){ed.setContent("<p>one </p>",{format:"raw"});var d=ed.getBody().firstChild;while(d.lastChild.nodeType==1){d.removeChild(d.lastChild)}var c=ed.getDoc();d.appendChild(c.createTextNode("two "));d.appendChild(c.createTextNode("three"));var a=c.createRange();a.setStart(d.firstChild,0);a.setEnd(d.firstChild.nextSibling,0);a=ed.selectionUtil.safeNormalize(a);var b=c.createRange();b.setStart(d.firstChild,0);b.setEnd(d.firstChild,4);equal(d.childNodes.length,1,"one child");rangeEqual(a,b);equal(a.toString(),"one ")});test("range stability under normalization, second[0] - second[3]",function(){ed.setContent("<p>one </p>",{format:"raw"});var d=ed.getBody().firstChild;while(d.lastChild.nodeType==1){d.removeChild(d.lastChild)}var c=ed.getDoc();d.appendChild(c.createTextNode("two "));d.appendChild(c.createTextNode("three"));var a=c.createRange();a.setStart(d.firstChild.nextSibling,0);a.setEnd(d.firstChild.nextSibling,3);a=ed.selectionUtil.safeNormalize(a);equal(d.childNodes.length,3,"separate children");var b=c.createRange();b.setStart(d.firstChild.nextSibling,0);b.setEnd(d.firstChild.nextSibling,3);rangeEqual(a,b);equal(a.toString(),"two")});test("range stability under normalization, second[0] - third[3]",function(){ed.setContent("<p>one </p>",{format:"raw"});var d=ed.getBody().firstChild;while(d.lastChild.nodeType==1){d.removeChild(d.lastChild)}var c=ed.getDoc();d.appendChild(c.createTextNode("two "));d.appendChild(c.createTextNode("three"));var a=c.createRange();a.setStart(d.firstChild.nextSibling,0);a.setEnd(d.firstChild.nextSibling.nextSibling,3);a=ed.selectionUtil.safeNormalize(a);var b=c.createRange();b.setStart(d.firstChild,4);b.setEnd(d.firstChild,11);equal(d.childNodes.length,1,"one child");rangeEqual(a,b);equal(a.toString(),"two thr")});test("atStartOf, true",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b.firstChild,0);a.collapse(true);ed.selection.setRng(a);equal(ed.selectionUtil.atStartOf(b),true,"start of span is start of li")});test("atStartOf, true, exact",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b,0);a.collapse(true);ed.selection.setRng(a);equal(ed.selectionUtil.atStartOf(b),true,"start of li is start of li")});test("atStartOf, false",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setStart(b.childNodes[2],0);a.collapse(true);ed.selection.setRng(a);equal(ed.selectionUtil.atStartOf(b),false,"start of strong is not start of li")});test("atEndOf, true",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong><em>more text</em></li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setEnd(b.lastChild.lastChild,b.lastChild.lastChild.nodeValue.length);a.collapse(false);ed.selection.setRng(a);equal(ed.selectionUtil.atEndOf(b),true,"end of em is end of li")});test("atEndOf, true, exact",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setEnd(b,b.childNodes.length);a.collapse(false);ed.selection.setRng(a);equal(ed.selectionUtil.atEndOf(b),true,"end of li is end of li")});test("atEndOf, true, with br",function(){ed.setContent("<ul><li><br /></li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setEnd(b,0);a.collapse(false);ed.selection.setRng(a);equal(ed.selectionUtil.atEndOf(b),true,"ignored terminal br")});test("atEndOf, true, in p with terminal br before list",function(){ed.setContent("<p>para text<br /></p><ul><li>first</li><li>second</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild;a.setStart(b.firstChild,9);a.collapse(true);ed.selection.setRng(a);equal(ed.selectionUtil.atEndOf(b),true,"ignored terminal br")});test("atEndOf, false",function(){ed.setContent("<ul><li><span></span>text<strong>bold text</strong>more text</li></ul>");var a=ed.dom.createRng();var b=ed.getBody().firstChild.firstChild;a.setEnd(b.childNodes[2].firstChild,9);a.collapse(false);ed.selection.setRng(a);equal(ed.selectionUtil.atEndOf(b),false,"end of strong is not end of li")})}test("isForward",function(){ed.setContent("<p>test</p>");var a=ed.dom.createRng();var b=ed.getBody().firstChild;a.setStart(b,0);a.collapse(true);ed.selection.setRng(a);ok(ed.selectionUtil.isForwardSelection(),"collapsed is forward");a.setEnd(b,1);ed.selection.setRng(a);ok(ed.selectionUtil.isForwardSelection(),"uncollapsed forward is forward");var c=ed.selection.getSel();if(c.anchorNode!=null){c.collapse(b,1);c.extend(b,0);ok(!ed.selectionUtil.isForwardSelection(),"uncollapsed backward is not forward")}});test("isBookmark",function(){ed.setContent('<p id="foo">test</p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild;a.setStart(b,0);a.collapse(true);ed.selection.setRng(a);var c=ed.selection.getBookmark();ok(ed.selectionUtil.isBookmark(b.childNodes[0]),"isBookmark on elem");ok(ed.selectionUtil.isBookmark(b.childNodes[0].id),"isBookmark on id");ok(!ed.selectionUtil.isBookmark(b),"isBookmark on non-bookmark elem");ok(!ed.selectionUtil.isBookmark("foo"),"isBookmark on non-bookmark id")});test("removeBookmark",function(){ed.setContent('<p id="foo">test</p>');var a=ed.dom.createRng();var b=ed.getBody().firstChild;a.setStart(b,0);a.setEnd(b,1);ed.selection.setRng(a);var d=ed.selection.getBookmark();ed.selectionUtil.removeBookmark(d);var c=$j(ed.getBody());equal(c.find("p#foo").length,1,"p tag");equal(c.find("p#foo").text(),"test","text");equal(c.find("span").length,0,"0 span tags")});test("adjustForBookmark, include",function(){ed.setContent('<p id="foo">test</p>');var b=ed.dom.createRng();var c=ed.getBody().firstChild;b.setStart(c,0);b.setEnd(c,1);ed.selection.setRng(b);var d=ed.selection.getBookmark();var a=ed.selection.getRng(true);ed.selectionUtil.adjustForBookmark(a,true);ok(ed.selectionUtil.isBookmark(a.startContainer.childNodes[a.startOffset]),"starts with bookmark");ok(ed.selectionUtil.isBookmark(a.endContainer.childNodes[a.endOffset-1]),"ends with bookmark")});test("adjustForBookmark, exclude",function(){ed.setContent('<p id="foo">test</p>');var b=ed.dom.createRng();var c=ed.getBody().firstChild;b.setStart(c,0);b.setEnd(c,1);ed.selection.setRng(b);var d=ed.selection.getBookmark();var a=ed.selection.getRng(true);ed.selectionUtil.adjustForBookmark(a,false);ok(ed.selectionUtil.isBookmark(a.startContainer.childNodes[a.startOffset-1]),"starts after bookmark");ok(ed.selectionUtil.isBookmark(a.endContainer.childNodes[a.endOffset]),"ends before bookmark")});test("getExpandedBlockRange",function(){ed.setContent("<p>one</p><p>two</p>");var b=ed.dom.createRng();var c=ed.getBody().firstChild;b.setStart(c.firstChild,1);b.setEnd(c.nextSibling.firstChild,2);var a=ed.selectionUtil.getExpandedBlockRange(b);var d=ed.dom.createRng();d.setStart(ed.getBody(),0);d.setEnd(ed.getBody(),2);rangeEqual(a,d)});test("getExpandedBlockRange in mostly-empty td",function(){ed.setContent("<table><tbody><tr><td><br /></td><td></td></tr></tbody></table>");var b=ed.dom.createRng();var c=ed.getBody().firstChild.firstChild.firstChild.firstChild;b.setStart(c,0);b.collapse(true);var a=ed.selectionUtil.getExpandedBlockRange(b);var d=ed.dom.createRng();d.setStart(c,0);d.setEnd(c,1);rangeEqual(a,d)});test("getExpandedBlockRange in empty td",function(){ed.setContent("<table><tbody><tr><td><br /></td><td></td></tr></tbody></table>");var b=ed.dom.createRng();var c=ed.getBody().firstChild.firstChild.firstChild.lastChild;b.setStart(c,0);b.collapse(true);var a=ed.selectionUtil.getExpandedBlockRange(b);var d=ed.dom.createRng();d.setStart(c,0);d.setEnd(c,c.childNodes.length);rangeEqual(a,d)});test("splitAtEndpoints, all text in p",function(){ed.setContent("<p>text</p>");var b=ed.dom.createRng();var c=ed.getBody().firstChild;b.setStart(c.firstChild,0);b.setEnd(c.firstChild,4);var a=ed.selectionUtil.splitAtEndpoints(b);var d=ed.dom.createRng();c=ed.getBody();d.setStart(c,0);d.setEnd(c,1);rangeEqual(a,d);checkContent(ed,"<p>text</p>","correct document")});test("splitAtEndpoints, whole element",function(){ed.setContent("<p><strong>first paragraph</strong></p><p>second paragraph</p>");var b=ed.dom.createRng();var c=ed.getBody().firstChild;b.setStart(c.firstChild,0);b.setEnd(c,1);var a=ed.selectionUtil.splitAtEndpoints(b);var d=ed.dom.createRng();c=ed.getBody();d.setStart(c,0);d.setEnd(c,1);rangeEqual(a,d);equal(ed.getContent().replace(/[\r\n]+/g,""),"<p><strong>first paragraph</strong></p><p>second paragraph</p>","correct document")});test("splitAtEndpoints, whole element, just text",function(){ed.setContent("<p><strong>first paragraph</strong></p><p>second paragraph</p>");var b=ed.dom.createRng();var c=ed.getBody().firstChild;b.setStart(c.firstChild.firstChild,0);b.setEnd(c.firstChild.firstChild,15);var a=ed.selectionUtil.splitAtEndpoints(b);var d=ed.dom.createRng();c=ed.getBody().firstChild;d.setStart(c,0);d.setEnd(c,1);rangeEqual(a,d);equal(ed.getContent().replace(/[\r\n]+/g,""),"<p><strong>first paragraph</strong></p><p>second paragraph</p>","correct document")});test("splitAtEndpoints, first word",function(){ed.setContent("<p><strong>first paragraph</strong></p><p>second paragraph</p>");var b=ed.dom.createRng();var c=ed.getBody().firstChild.firstChild.firstChild;b.setStart(c,0);b.setEnd(c,5);var a=ed.selectionUtil.splitAtEndpoints(b);var d=ed.dom.createRng();c=ed.getBody().firstChild;d.setStart(c,0);d.setEnd(c,1);rangeEqual(a,d);equal(ed.getContent().replace(/[\r\n]+/g,""),"<p><strong>first</strong><strong> paragraph</strong></p><p>second paragraph</p>","correct document")});test("splitAtEndpoints, second word, to top",function(){ed.setContent("<p><strong>first paragraph</strong></p><p>second paragraph</p>");var b=ed.dom.createRng();b.setStart(ed.getBody().firstChild.firstChild.firstChild,5);b.setEnd(ed.getBody(),1);var a=ed.selectionUtil.splitAtEndpoints(b);var d=ed.dom.createRng();var c=ed.getBody();d.setStart(c,1);d.setEnd(c,2);rangeEqual(a,d);equal(ed.getContent().replace(/[\r\n]+/g,""),"<p><strong>first</strong></p><p><strong> paragraph</strong></p><p>second paragraph</p>","correct document")});test("splitAtEndpoints in td",function(){ed.setContent("<table><tbody><tr><td>someatextain a TD</td><td></td></tr></tbody></table><p>asdf</p>");var b=ed.dom.createRng();var c=ed.getBody().firstChild.firstChild.firstChild.firstChild;b.setStart(c.firstChild,5);b.setEnd(c.firstChild,9);var a=ed.selectionUtil.splitAtEndpoints(b);var d=ed.dom.createRng();d.setStart(c,1);d.setEnd(c,2);rangeEqual(a,d);var e=ed.dom.create("pre");a.surroundContents(e);checkContent(ed,"<table><tbody><tr><td>somea<pre>text</pre>ain a TD</td><td></td></tr></tbody></table><p>asdf</p>")});