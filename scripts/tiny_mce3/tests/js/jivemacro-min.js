module("Jive Macros",{autostart:false});asyncTest("test create syntax highlight macro",function(){ed.setContent("");ed.focus();ed.selectionUtil.normalizeSelection();fakeMouseEvent($j("a.mce_jivemacros").get(0),"click");fakeMouseEvent($j("td.mceMacroMenu a:first").get(0),"mouseover");fakeMouseEvent($j("span.mce_code_javascript").parent().get(0),"click");equals(ed.selection.getNode().nodeName.toLowerCase(),"p","cursor is in a <p>");var a=ed.selection.getNode().parentNode;equals(a.nodeName.toLowerCase(),"pre","cursor is in a <pre>");ok($j(a).hasClass("jive_text_macro"),"has a jive_text_macro classname");ok($j(a).hasClass("jive_macro_code"),"has a jive_macro_code classname");setTimeout(function(){var b=a.className.match(/_jivemacro_uid_(\d+)/);equals(b.length,2,"correctly matched uid");var e=b[1];var d=ed.plugins.jivemacros.rte;var c=d.getHiddenContainer().find("#_"+e);equals(c.length,1,"found a rich item");if($j(a).offset()&&c.position()){near(c.position().top,$j(a).offset().top,3,"top offset is correct");near(c.position().left,$j(a).offset().left,3,"left offset is correct");near(c.width(),1041,3,"width is correct");near(c.height(),$j(a).height(),3,"height is correct")}else{ok(false,"can't calculate position :(")}start()},300);stop()});asyncTest("test type in syntax highlight macro",function(){ed.setContent("");window.focus();ed.focus();ed.selectionUtil.normalizeSelection();fakeMouseEvent($j("a.mce_jivemacros").get(0),"click");fakeMouseEvent($j("td.mceMacroMenu a:first").get(0),"mouseover");fakeMouseEvent($j("span.mce_code_javascript").parent().get(0),"click");equals(ed.selection.getNode().nodeName.toLowerCase(),"p","cursor is in a <p>");var a=ed.selection.getNode().parentNode;equals(a.nodeName.toLowerCase(),"pre","cursor is in a <pre>");$j(a).html('<p>function(){</p><p>     return "asdf";</p><p>}</p>');ok($j(a).hasClass("jive_text_macro"),"has a jive_text_macro classname");ok($j(a).hasClass("jive_macro_code"),"has a jive_macro_code classname");setTimeout(function(){var b=a.className.match(/_jivemacro_uid_(\d+)/);equals(b.length,2,"correctly matched uid");var e=b[1];var d=ed.plugins.jivemacros.rte;var c=d.getHiddenContainer().find("#_"+e);equals(c.length,1,"found a rich item");equals(c.find("pre").text(),'function(){ \n     return "asdf"; \n} \n',"correct source to highlight");equals(c.find("li").length,3,"3 lines of source are highlighted");if($j(a).offset()&&c.position()){near(c.position().top,$j(a).offset().top,3,"top offset is correct");near(c.position().left,$j(a).offset().left,3,"left offset is correct");near(c.width(),1041,3,"width is correct");near(c.height(),$j(a).height(),3,"height is correct")}else{ok(false,"can't calculate position:(")}start()},300);stop()});asyncTest("test empty lines in syntax highlight macro",function(){ed.setContent("");window.focus();ed.focus();ed.selectionUtil.normalizeSelection();fakeMouseEvent($j("a.mce_jivemacros").get(0),"click");fakeMouseEvent($j("td.mceMacroMenu a:first").get(0),"mouseover");fakeMouseEvent($j("span.mce_code_javascript").parent().get(0),"click");equals(ed.selection.getNode().nodeName.toLowerCase(),"p","cursor is in a <p>");var a=ed.selection.getNode().parentNode;equals(a.nodeName.toLowerCase(),"pre","cursor is in a <pre>");$j(a).html("<p></p><p></p><p></p>");ok($j(a).hasClass("jive_text_macro"),"has a jive_text_macro classname");ok($j(a).hasClass("jive_macro_code"),"has a jive_macro_code classname");setTimeout(function(){var b=a.className.match(/_jivemacro_uid_(\d+)/);equals(b.length,2,"correctly matched uid");var e=b[1];var d=ed.plugins.jivemacros.rte;var c=d.getHiddenContainer().find("#_"+e);equals(c.length,1,"found a rich item");equals(c.find("pre").text()," \n \n \n","correct source to highlight");equals(c.find("li").length,3,"3 lines of source are highlighted");if($j(a).offset()&&c.position()){near(c.position().top,$j(a).offset().top,3,"top offset is correct");near(c.position().left,$j(a).offset().left,3,"left offset is correct");near(c.width(),1041,3,"width is correct");near(c.height(),$j(a).height(),3,"height is correct")}else{ok(false,"can't calculate position :(")}start()},300);stop()});asyncTest("test wide content in syntax highlight macro",function(){ed.setContent("");window.focus();ed.focus();ed.selectionUtil.normalizeSelection();fakeMouseEvent($j("a.mce_jivemacros").get(0),"click");fakeMouseEvent($j("td.mceMacroMenu a:first").get(0),"mouseover");fakeMouseEvent($j("span.mce_code_javascript").parent().get(0),"click");equals(ed.selection.getNode().nodeName.toLowerCase(),"p","cursor is in a <p>");var a=ed.selection.getNode().parentNode;equals(a.nodeName.toLowerCase(),"pre","cursor is in a <pre>");$j(a).html("<p>asfdklkj asdfklkasdfj lkasfj lkas jflkas faskdfj lasf lkas flkasjf klasj fklas fjkakls faklsdf lads aklj fklas fkl sdklja fklas fklas dfkl asf kals dfjlkasj flkas dfljasdf ksadfj lajksd fklasdj flkasdf jaslkdf laksdfj alksdf lkasdf lkas fjlkas jflkafs lksa l and awesome!</p><p>klasfj lkas flkas f</p><p>askldfj laksfj lkas jf</p>");ok($j(a).hasClass("jive_text_macro"),"has a jive_text_macro classname");ok($j(a).hasClass("jive_macro_code"),"has a jive_macro_code classname");setTimeout(function(){var b=a.className.match(/_jivemacro_uid_(\d+)/);equals(b.length,2,"correctly matched uid");var e=b[1];var d=ed.plugins.jivemacros.rte;var c=d.getHiddenContainer().find("#_"+e);equals(c.length,1,"found a rich item");equals(c.find("li").length,3,"3 lines of source are highlighted");if($j(a).offset()&&c.position()){near(c.position().top,$j(a).offset().top,3,"top offset is correct");near(c.position().left,$j(a).offset().left,3,"left offset is correct");near(c.width(),1977,10,"width is correct");near(c.height(),$j(a).height(),3,"height is correct")}else{ok(false,"can't calculate position :(")}start()},300);stop()});asyncTest("test select text to syntax highlight macro",function(){ed.setContent("<p>asfdklkj asdfklkasdfj lkasfj lkas jflkas faskdfj lasf lkas flkasjf klasj fklas fjkakls faklsdf lads aklj fklas fkl sdklja fklas fklas dfkl asf kals dfjlkasj flkas dfljasdf ksadfj lajksd fklasdj flkasdf jaslkdf laksdfj alksdf lkasdf lkas fjlkas jflkafs lksa l and awesome!</p><p>klasfj lkas flkas f</p><p>askldfj laksfj lkas jf</p>");var a=ed.dom.createRng();a.setStart(ed.getBody().firstChild.firstChild,0);a.setEnd(ed.getBody().childNodes[2],1);ed.selection.setRng(a);window.focus();ed.focus();ed.selectionUtil.normalizeSelection();fakeMouseEvent($j("a.mce_jivemacros").get(0),"click");fakeMouseEvent($j("td.mceMacroMenu a:first").get(0),"mouseover");fakeMouseEvent($j("span.mce_code_javascript").parent().get(0),"click");equals(ed.selection.getNode().nodeName.toLowerCase(),"p","cursor is in a <p>");var b=ed.selection.getNode().parentNode;equals(b.nodeName.toLowerCase(),"pre","cursor is in a <pre>");ok($j(b).hasClass("jive_text_macro"),"has a jive_text_macro classname");ok($j(b).hasClass("jive_macro_code"),"has a jive_macro_code classname");setTimeout(function(){var c=b.className.match(/_jivemacro_uid_(\d+)/);equals(c.length,2,"correctly matched uid");var f=c[1];var e=ed.plugins.jivemacros.rte;var d=e.getHiddenContainer().find("#_"+f);equals(d.length,1,"found a rich item");equals(d.find("li").length,3,"3 lines of source are highlighted");if($j(b).offset()&&d.position()){near(d.position().top,$j(b).offset().top,3,"top offset is correct");near(d.position().left,$j(b).offset().left,3,"left offset is correct");near(d.width(),1977,10,"width is correct");near(d.height(),$j(b).height(),3,"height is correct")}else{ok(false,"can't calculate position :(")}start()},300);stop()});asyncTest("two macros, each with unique id",function(){ed.setContent("");window.focus();ed.focus();ed.selectionUtil.normalizeSelection();fakeMouseEvent($j("a.mce_jivemacros").get(0),"click");fakeMouseEvent($j("td.mceMacroMenu a:first").get(0),"mouseover");fakeMouseEvent($j("span.mce_code_javascript").parent().get(0),"click");equals(ed.selection.getNode().nodeName.toLowerCase(),"p","cursor is in a <p>");var c=ed.selection.getNode().parentNode;equals(c.nodeName.toLowerCase(),"pre","cursor is in a <pre>");var d=$j(c).next();var b=ed.dom.createRng();b.setStart(d.get(0).firstChild,0);b.setEnd(d.get(0).firstChild,0);ed.selection.setRng(b);ed.selectionUtil.normalizeSelection();fakeMouseEvent($j("a.mce_jivemacros").get(0),"click");fakeMouseEvent($j("td.mceMacroMenu a:first").get(0),"mouseover");fakeMouseEvent($j("span.mce_code_javascript").parent().get(0),"click");var a=ed.selection.getNode().parentNode;equals(a.nodeName.toLowerCase(),"pre","cursor is in a <pre> again");ok($j(c).hasClass("jive_text_macro"),"has a jive_text_macro classname");ok($j(c).hasClass("jive_macro_code"),"has a jive_macro_code classname");setTimeout(function(){var f=c.className.match(/_jivemacro_uid_(\d+)/);equals(f.length,2,"correctly matched uid");var j=f[1];f=a.className.match(/_jivemacro_uid_(\d+)/);equals(f.length,2,"correctly matched uid");var i=f[1];var h=ed.plugins.jivemacros.rte;var g=h.getHiddenContainer().find("#_"+j);var e=h.getHiddenContainer().find("#_"+i);equals(g.length,1,"found a rich item");equals(e.length,1,"found a rich item");ok(i!=j,"uids are not equal");if($j(c).offset()&&$j(a).offset()&&g.position()&&e.position()){near(g.position().top,$j(c).offset().top,3,"top offset is correct");near(g.position().left,$j(c).offset().left,3,"left offset is correct");near(g.width(),1041,3,"width is correct");near(g.height(),$j(c).height(),3,"height is correct");near(e.position().top,$j(a).offset().top,3,"top offset is correct");near(e.position().left,$j(a).offset().left,3,"left offset is correct");near(e.width(),1041,3,"width is correct");near(e.height(),$j(a).height(),3,"height is correct")}else{ok(false,"can't calculate position :(")}start()},300);stop()});asyncTest("two macros with duplicate ids, deduplicated",function(){ed.setContent('<body><pre class="jive_text_macro jive_macro_code _jivemacro_uid_1305580994948554" jivemacro="code" _jivemacro_uid="_1305580994948554" ___default_attr="javascript"><p> </p></pre>\n<p> </p>\n<pre class="jive_text_macro jive_macro_code _jivemacro_uid_1305580994948554" jivemacro="code" _jivemacro_uid="_1305580994948554" ___default_attr="javascript"><p> </p></pre>\n<p> </p></body>');window.focus();ed.focus();ed.selectionUtil.normalizeSelection();var c=$j(ed.getBody()).find("pre:first").get(0);var b=$j(ed.getBody()).find("pre:last").get(0);var a=c.className.match(/_jivemacro_uid_(\d+)/);equals(a.length,2,"correctly matched uid");var e=a[1];a=b.className.match(/_jivemacro_uid_(\d+)/);equals(a.length,2,"correctly matched uid");var d=a[1];ok(d==e,"uids are equal :(");fakeMouseEvent(ed.getBody().firstChild,"click");setTimeout(function(){var g=c.className.match(/_jivemacro_uid_(\d+)/);equals(g.length,2,"correctly matched uid");var k=g[1];g=b.className.match(/_jivemacro_uid_(\d+)/);equals(g.length,2,"correctly matched uid");var j=g[1];var i=ed.plugins.jivemacros.rte;var h=i.getHiddenContainer().find("#_"+k);var f=i.getHiddenContainer().find("#_"+j);equals(h.length,1,"found a rich item");equals(f.length,1,"found a rich item");ok(j!=k,"uids are not equal");if($j(c).offset()&&$j(b).offset()&&h.position()&&f.position()){near(h.position().top,$j(c).offset().top,3,"top offset is correct");near(h.position().left,$j(c).offset().left,3,"left offset is correct");near(h.width(),1041,3,"width is correct");near(h.height(),$j(c).height(),3,"height is correct");near(f.position().top,$j(b).offset().top,3,"top offset is correct");near(f.position().left,$j(b).offset().left,3,"left offset is correct");near(f.width(),1041,3,"width is correct");near(f.height(),$j(b).height(),3,"height is correct")}else{ok(false,"can't calculate position :(")}start()},300);stop()});