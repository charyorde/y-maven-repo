JsMockito.Integration.QUnit();JsHamcrest.Integration.QUnit();function makeTestDoc(){ed.setContent("<p>some paragraph text</p><ul><li>a list item</li><li>another list item</li></ul><pre>some text in a pre tag</pre><table><tbody><tr><td>a table cell</td><td>a table cell</td></tr><tr><td>a table cell</td><td>a table cell</td></tr></tbody></table><p>Some text. <img src='slickspeed/logo.png' /> Some more text.</p>");this.pElem=ed.getBody().firstChild;this.ulElem=ed.getBody().childNodes[1];this.preElem=ed.getBody().childNodes[2];this.tableElem=ed.getBody().childNodes[3];this.imgElem=ed.getBody().childNodes[4].childNodes[1];this.firstLi=this.ulElem.firstChild;this.firstCell=this.tableElem.firstChild.firstChild.firstChild;this.contextPlugin=ed.plugins.jivecontextmenu;$j.fx.off=true}module("MenuItem",{setup:makeTestDoc,teardown:function(){this.contextPlugin.hideMenu();this.contextPlugin.lastPosition=null;$j.fx.off=false}});test("Wiring, regexp, string and object literal callbacks",function(){var i=/ul/i;var b="slickspeed/logo.png";var f=mockFunction("actionFn");var g={width:20,height:20};var d=mockFunction("mouseEnter");var h=mockFunction("mouseLeave");var e=mockFunction("onDisplay");var c=new this.contextPlugin.MenuItem("testId",i,"test title",b,f,g,d,h,e);equal(c.id,"testId");var a=ed.dom.createRng();a.setStart(this.firstLi,0);a.collapse(true);equal(c.distance(a),2);equal(c.findContextNode(a),this.ulElem);equal(c.title,"test title");ok(0<=c.render().firstChild.src.indexOf("/resources/scripts/tiny_mce3/tests/slickspeed/logo.png"));c.action();verify(f).call(c);deepEqual(c.getDims(),{width:20,height:20});c.mouseenter();verify(d).call(c);c.mouseleave();verify(h).call(c);c.displayCallback();verify(e).call(c)});test("Wiring, minimal callbacks, object renderer",function(){var e=/ul/i;var c={url:"http://url/",xOffset:10,yOffset:20,width:30,height:40};var b=mockFunction("actionFn");var a=new this.contextPlugin.MenuItem("testId",e,"test title",c,b);var d=a.render();equal(/url\("?(.*?)"?\)/.exec(d.firstChild.style.backgroundImage)[1],"http://url/");equal(d.firstChild.style.backgroundPosition,"-10px -20px");equal(d.firstChild.style.width,"30px");equal(d.firstChild.style.height,"40px");deepEqual(a.getDims(),{width:30,height:40})});test("Wiring, function callbacks everywhere",function(){var g=mockFunction("fcn");var e=mockFunction("render");var d=mockFunction("actionFn");var c=mockFunction("getDims");when(c)().thenReturn({width:20,height:20});var a=mockFunction("mouseEnter");var f=mockFunction("mouseLeave");var h=mockFunction("onDisplay");var b=new this.contextPlugin.MenuItem("testId",g,"test title",e,d,c,a,f,h);equal(b.id,"testId");equal(b.distance(this.pElem),-1,"distance is -1");verify(g)(sameAs(this.pElem));equal(b.findContextNode(this.ulElem),null,"findContextNode on UL is null");verify(g)(sameAs(this.ulElem));equal(b.title,"test title");b.render();verify(e)();b.action();verify(d).call(b);deepEqual(b.getDims(),{width:20,height:20});verify(c)();b.mouseenter();verify(a).call(b);b.mouseleave();verify(f).call(b);b.displayCallback();verify(h).call(b)});module("Menu",{setup:makeTestDoc,teardown:function(){this.contextPlugin.hideMenu();this.contextPlugin.lastPosition=null;$j.fx.off=false}});function mockMenuItem(a,h){if(!a){a="testId"}if(!h){h=a+"_title"}var k=mockFunction("fcn");var b=mockFunction("render");var f=mockFunction("actionFn");var i=mockFunction("getDims");var e=mockFunction("mouseEnter");var j=mockFunction("mouseLeave");var c=mockFunction("displayCallback");var g=new ed.plugins.jivecontextmenu.MenuItem(a,k,h,b,f,i,e,j,c);delete g.id;delete g.title;var d=mock(g);d.id=a;d.title=h;when(d).render(anything()).thenReturn(ed.dom.create("span",{id:a}));when(d).getDims().thenReturn({width:20,height:20});return d}test("trivialities",function(){var b=mockMenuItem();var a=[b];var c=new this.contextPlugin.Menu(a,false,false);deepEqual(c.items,a);equal(c.isVisible(),false);equal(c.getDOM().get(0).className,"menuItems")});test("wiring",function(){var f=mockMenuItem("a");var g=mockMenuItem("b");var i=mockMenuItem("c");when(f).findContextNode(anything()).thenReturn(this.pElem);when(f).distance(anything()).thenReturn(1);when(g).distance(anything()).thenReturn(2);when(i).distance(anything()).thenReturn(3);var e=[g,f,i];var d=mockFunction("menuMouseEnter");var h=mockFunction("menuMouseLeave");var a=ed.dom.createRng();a.setStart(this.pElem,0);a.collapse(true);var b=new this.contextPlugin.Menu(e,false,false,"menu title",d,h);b.show(ed,a,{x:10,y:10});var c="";b.getDOM().children().each(function(){c+=this.id});equal(c,"abc");verify(f,times(3)).findContextNode(anything());verify(f).distance(sameAs(a));verify(f).render(sameAs(f),sameAs(ed),sameAs(this.contextPlugin.$menu));verify(f).displayCallback(anything());this.contextPlugin.$menuPopover.mouseenter();verify(d,once())(anything());this.contextPlugin.$menuPopover.mouseleave();verify(h,once())(anything());b.getDOM().find("#a").click();verify(f).action(anything());b.hide();this.contextPlugin.$menuPopover.mouseenter();this.contextPlugin.$menuPopover.mouseleave();verifyNoMoreInteractions(d,h)});module("Jive Context Menu Plugin",{setup:makeTestDoc,teardown:function(){this.contextPlugin.hideMenu();this.contextPlugin.lastPosition=null;$j.fx.off=false}});asyncTest("nothing in p-tag",1,function(){var a=this;click(this.pElem,function(){ok(!a.contextPlugin.rootMenu.isVisible(),"root menu shouldn't show");start()})});asyncTest("menu shows in list item",1,function(){var a=this;click(this.firstLi,function(){ok(a.contextPlugin.rootMenu.isVisible(),"root menu should show");start()})});asyncTest("menu shows in pre tag",1,function(){var a=this;click(this.preElem,function(){ok(a.contextPlugin.rootMenu.isVisible(),"root menu should show");start()})});asyncTest("menu shows in table",1,function(){var a=this;click(this.firstCell,function(){ok(a.contextPlugin.rootMenu.isVisible(),"root menu should show");start()})});asyncTest("menu shows in img",function(){var a=this;click(this.imgElem,function(){ok(a.contextPlugin.$menuPopover.is(":visible"),"$menu is visible");ok(a.contextPlugin.rootMenu.isVisible(),"root menu should show");start()})});asyncTest("menu transition and rendering in list item",function(){var a=this;click(this.firstLi,function(){ok(a.contextPlugin.rootMenu.isVisible(),"root menu should show");click(a.contextPlugin.$menuPopover.find(".menuItems:visible :first").get(0),function(){equal(a.contextPlugin.$menuPopover.find(".menuItems:visible").children().length,4,"4 list style items visible");equal(a.contextPlugin.$menuPopover.find(".menuItems:visible .menuItem_defaultListStyle").length,1,"default list style item is visible");equal(a.contextPlugin.$menuPopover.find(".menuItems:visible .menuItem_diListStyle").length,1,"disc list style item is visible");equal(a.contextPlugin.$menuPopover.find(".menuItems:visible .menuItem_cListStyle").length,1,"circle list style item is visible");equal(a.contextPlugin.$menuPopover.find(".menuItems:visible .menuItem_sListStyle").length,1,"square list style item is visible");start()})})});