module("Jive Utility Plugin",{autostart:false});test("Formatter - remove format around link 2",function(){var a;a=ed.dom.createRng();ed.getBody().innerHTML='<p><span style="font-size: 18pt;">asdf <a class="jive_macro default_title jive_macro_user _jivemacro_uid_13056727656977177" href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001">Mr User 2</a><span> asdf</span></span></p>';a.setStart(ed.dom.select("p")[0],0);a.setEnd(ed.dom.select("p")[0],1);ed.selection.setRng(a);ed.execCommand("mceRemoveFullFormat");equals(ed.getContent(),'<p>asdf <a href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001" data-orig-content="Mr User 2">Mr User 2</a> asdf</p>');equals(ed.selection.getStart().nodeName,"P")});test("Formatter - remove format around link 3",function(){var a;a=ed.dom.createRng();ed.getBody().innerHTML='<p><span style="font-size: 18pt;">asdf <a class="jive_macro default_title jive_macro_user _jivemacro_uid_13056727656977177" href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001">Mr User 2</a><span> asdf</span></span></p>';a.setStart(ed.getBody(),0);a.setEnd(ed.getBody(),1);ed.selection.setRng(a);ed.execCommand("mceRemoveFullFormat");equals(ed.getContent(),'<p>asdf <a href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001" data-orig-content="Mr User 2">Mr User 2</a> asdf</p>');equals(ed.selection.getStart().nodeName,"P")});test("Formatter - remove format around link 4",function(){var a;a=ed.dom.createRng();ed.getBody().innerHTML='<p><span style="font-size: 18pt;">asdf <a class="jive_macro default_title jive_macro_user _jivemacro_uid_13056727656977177" href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001" data-orig-content="Mr User 2">Mr User 2</a><span> asdf</span></span></p>';a.setStart($j(ed.getBody()).find("span:first").get(0),0);a.setEnd($j(ed.getBody()).find("span:first").get(0),3);ed.selection.setRng(a);ed.execCommand("mceRemoveFullFormat");equals(ed.getContent(),'<p>asdf <a href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001" data-orig-content="Mr User 2">Mr User 2</a> asdf</p>');equals(ed.selection.getStart().nodeName,"P")});asyncTest("Formatter - remove format around link 5",function(){var a;a=ed.dom.createRng();ed.getBody().innerHTML='<p><span style="font-size: 18pt;">asdf <a class="jive_macro default_title jive_macro_user _jivemacro_uid_13056727656977177" href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001" data-orig-content="Mr User 2">Mr User 2</a><span> asdf</span></span></p>';ed.nodeChanged();setTimeout(function(){a.setStart($j(ed.getBody()).find("a:first").get(0),0);a.setEnd($j(ed.getBody()).find("a:first").get(0),1);ed.selection.setRng(a);ed.execCommand("mceRemoveFullFormat");equals(ed.getContent(),'<p><span style="font-size: 18pt;">asdf </span><a href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001" data-orig-content="Mr User 2">Mr User 2</a><span style="font-size: 18pt;"><span> asdf</span></span></p>');equals(ed.selection.getStart().nodeName,"A");start()},300);stop()});test("Formatter - remove format around link 6",function(){var a;a=ed.dom.createRng();ed.getBody().innerHTML='<p><span style="font-size: 18pt;">asdf <a class="jive_macro default_title jive_macro_user _jivemacro_uid_13056727656977177" href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001">Mr User 2</a><span> asdf</span></span></p>';a.setStart($j(ed.getBody()).find("span:first").get(0),1);a.setEnd($j(ed.getBody()).find("span:first").get(0),2);ed.selection.setRng(a);ed.execCommand("mceRemoveFullFormat");equals(ed.getContent(),'<p><span style="font-size: 18pt;">asdf </span><a href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001" data-orig-content="Mr User 2">Mr User 2</a><span style="font-size: 18pt;"><span> asdf</span></span></p>');equals(ed.selection.getStart().nodeName,"A")});test("Formatter - remove format around link 7",function(){var a;a=ed.dom.createRng();ed.getBody().innerHTML='<p><span style="font-size: 18pt;">asdf <a class="jive_macro default_title jive_macro_user _jivemacro_uid_13056727656977177" href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001">Mr User 2</a><span> asdf</span></span></p>';a.setStart($j(ed.getBody()).find("a:first").get(0).firstChild,0);a.setEnd($j(ed.getBody()).find("a:first").get(0).firstChild,9);ed.selection.setRng(a);ed.execCommand("mceRemoveFullFormat");equals(ed.getContent(),'<p><span style="font-size: 18pt;">asdf </span><a href="javascript:;" jivemacro="user" _jivemacro_uid="_13056727656977177" ___default_attr="2001" data-orig-content="Mr User 2">Mr User 2</a><span style="font-size: 18pt;"><span> asdf</span></span></p>');equals(ed.selection.getStart().nodeName,"A")});test("allow encoding for normal text",function(){ed.setContent("<p>first </p>",{format:"raw"});var c=ed.getBody().firstChild.firstChild;var b=ed.getDoc().createTextNode("@second ");var a=ed.getDoc().createTextNode("third");ed.getBody().firstChild.appendChild(b);ed.getBody().firstChild.appendChild(a);equals(ed.plugins.jiveutil.shouldEncodeHuh(ed,b),true,"text node is encodable");equals(ed.getContent(),"<p>first @second third</p>")});test("allow encoding for most macros",function(){ed.setContent("<p>first </p>",{format:"raw"});var c=ed.getBody().firstChild.firstChild;var b=ed.getDoc().createElement("a");b.setAttribute("jivemacro","document");var a=ed.getDoc().createTextNode("link text");b.appendChild(a);$j(ed.getBody()).find("br").remove();ed.getBody().firstChild.appendChild(b);equals(ed.plugins.jiveutil.shouldEncodeHuh(ed,b),true,"link node is a macro");equals(ed.plugins.jiveutil.shouldEncodeHuh(ed,a),true,"link text is in a macro");equals(ed.getContent(),'<p>first <a jivemacro="document">link text</a></p>\n<p></p>')});test("allow encoding for non existent macros",function(){ed.setContent("<p>first </p>",{format:"raw"});var c=ed.getBody().firstChild.firstChild;var b=ed.getDoc().createElement("a");b.setAttribute("jivemacro","foothebar");var a=ed.getDoc().createTextNode("link text");b.appendChild(a);$j(ed.getBody()).find("br").remove();ed.getBody().firstChild.appendChild(b);equals(ed.plugins.jiveutil.shouldEncodeHuh(ed,b),true,"link node is a macro");equals(ed.plugins.jiveutil.shouldEncodeHuh(ed,a),true,"link text is in a macro");equals(ed.getContent(),'<p>first <a jivemacro="foothebar">link text</a></p>\n<p></p>')});test("DON'T allow encoding for code macros",function(){ed.setContent("<p>first </p>",{format:"raw"});var c=ed.getBody().firstChild.firstChild;var b=ed.getDoc().createElement("pre");b.setAttribute("jivemacro","code");var a=ed.getDoc().createTextNode("pre text");b.appendChild(a);$j(ed.getBody()).find("br").remove();ed.getBody().appendChild(b);equals(ed.plugins.jiveutil.shouldEncodeHuh(ed,b),false,"pre node is a macro");equals(ed.plugins.jiveutil.shouldEncodeHuh(ed,a),false,"pre text is in a macro");equals(ed.getContent(),'<p>first</p>\n<pre jivemacro="code">pre text</pre>\n<p></p>',"correct document")});test("don't trim text inside inline",function(){ed.setContent("<p><span>first </span><span>second </span></p>");equals(ed.getContent(),"<p><span>first </span><span>second </span></p>");ed.setContent("<p><span> first</span><span> second</span></p>",{format:"raw"});equals(ed.getContent(),"<p><span> first</span><span> second</span></p>");ed.setContent("<p><span> first </span><span> second </span></p>",{format:"raw"});equals(ed.getContent(),"<p><span> first </span><span> second </span></p>")});test("test walking through kids",function(){ed.setContent("<p>first </p>",{format:"raw"});var g=ed.getBody().firstChild.firstChild;var d=ed.getDoc().createElement("pre");d.setAttribute("jivemacro","code");var c=ed.getDoc().createTextNode("link text");d.appendChild(c);var b=ed.getDoc().createTextNode("link text");d.appendChild(b);$j(ed.getBody()).find("br").remove();ed.getBody().appendChild(d);var f=ed.getDoc().createElement("p");ed.getBody().appendChild(f);var e=[d,c,b];var a=0;ed.plugins.jiveutil.walkDOMTreeKids(d,g,function(h){equals(h,e[a],"found expected node");a++});equals(a,e.length,"visited all nodes");equals(ed.getContent(),'<p>first</p>\n<pre jivemacro="code">link textlink text</pre>\n<p></p>')});test("test walking through kids",function(){ed.setContent("<p>first </p>",{format:"raw"});var g=ed.getBody().firstChild.firstChild;var d=ed.getDoc().createElement("pre");d.setAttribute("jivemacro","code");var c=ed.getDoc().createTextNode("link text");d.appendChild(c);var b=ed.getDoc().createTextNode("link text");d.appendChild(b);$j(ed.getBody()).find("br").remove();ed.getBody().appendChild(d);var f=ed.getDoc().createElement("p");ed.getBody().appendChild(f);var e=[d,c];var a=0;ed.plugins.jiveutil.walkDOMTreeKids(d,c,function(h){equals(h,e[a],"found expected node");a++});equals(a,e.length,"visited all nodes");equals(ed.getContent(),'<p>first</p>\n<pre jivemacro="code">link textlink text</pre>\n<p></p>')});test("test walking through tree",function(){ed.setContent("<p>first </p>",{format:"raw"});var g=ed.getBody().firstChild.firstChild;var d=ed.getDoc().createElement("pre");d.setAttribute("jivemacro","code");var c=ed.getDoc().createTextNode("link text");d.appendChild(c);var b=ed.getDoc().createTextNode("link text");d.appendChild(b);$j(ed.getBody()).find("br").remove();ed.getBody().appendChild(d);var f=ed.getDoc().createElement("p");ed.getBody().appendChild(f);var e=[d,c,b,f];var a=0;ed.plugins.jiveutil.walkDOMTree(d,f,function(h){equals(h,e[a],"found expected node");a++});equals(a,e.length,"visited all nodes");equals(ed.getContent(),'<p>first</p>\n<pre jivemacro="code">link textlink text</pre>\n<p></p>')});test("test walking through tree",function(){ed.setContent("<p>first </p>",{format:"raw"});var g=ed.getBody().firstChild.firstChild;var d=ed.getDoc().createElement("pre");d.setAttribute("jivemacro","code");var c=ed.getDoc().createTextNode("link text");d.appendChild(c);var b=ed.getDoc().createTextNode("link text");d.appendChild(b);$j(ed.getBody()).find("br").remove();ed.getBody().appendChild(d);var f=ed.getDoc().createElement("p");ed.getBody().appendChild(f);var e=[c,b,f];var a=0;ed.plugins.jiveutil.walkDOMTree(c,f,function(h){equals(h,e[a],"found expected node");a++});equals(a,e.length,"visited all nodes");equals(ed.getContent(),'<p>first</p>\n<pre jivemacro="code">link textlink text</pre>\n<p></p>')});test("test walking through tree",function(){ed.setContent("<p>first </p>",{format:"raw"});var g=ed.getBody().firstChild.firstChild;var d=ed.getDoc().createElement("pre");d.setAttribute("jivemacro","code");var c=ed.getDoc().createTextNode("link text");d.appendChild(c);var b=ed.getDoc().createTextNode("link text");d.appendChild(b);$j(ed.getBody()).find("br").remove();ed.getBody().appendChild(d);var f=ed.getDoc().createElement("p");ed.getBody().appendChild(f);var e=[g,d,c,b,f];var a=0;ed.plugins.jiveutil.walkDOMTree(g,f,function(h){equals(h,e[a],"found expected node");a++});equals(a,e.length,"visited all nodes");equals(ed.getContent(),'<p>first</p>\n<pre jivemacro="code">link textlink text</pre>\n<p></p>')});test("test walking through tree",function(){ed.setContent("<p>first </p>",{format:"raw"});var g=ed.getBody().firstChild;var h=ed.getBody().firstChild.firstChild;var d=ed.getDoc().createElement("pre");d.setAttribute("jivemacro","code");var c=ed.getDoc().createTextNode("link text");d.appendChild(c);var b=ed.getDoc().createTextNode("link text");d.appendChild(b);$j(ed.getBody()).find("br").remove();ed.getBody().appendChild(d);var f=ed.getDoc().createElement("p");ed.getBody().appendChild(f);var e=[g,h,d,c,b,f];var a=0;ed.plugins.jiveutil.walkDOMTree(g,f,function(i){equals(i,e[a],"found expected node");a++});equals(a,e.length,"visited all nodes");equals(ed.getContent(),'<p>first</p>\n<pre jivemacro="code">link textlink text</pre>\n<p></p>')});test("test getting length of text",function(){ed.setContent("<p>first </p>",{format:"raw"});var c=ed.getBody().firstChild;var d=ed.getBody().firstChild.firstChild;var b=ed.getDoc().createTextNode("link text");var a=ed.getDoc().createTextNode("foothebar");$j(ed.getBody()).find("br").remove();c.appendChild(b);c.appendChild(a);equals(ed.plugins.jiveutil.textLengthIn(c),24,"found all text");equals(ed.getContent(),"<p>first link textfoothebar</p>")});test("test getting length of text",function(){ed.setContent("<p>first <span>foothebar</span></p>");var c=ed.getBody().firstChild;var a=$j(ed.getBody()).find("span").get(0);$j(ed.getBody()).find("br").remove();equals(ed.plugins.jiveutil.getNodeAt(ed.getBody().firstChild,0),c,"found correct node");equals(ed.plugins.jiveutil.getNodeAt(ed.getBody().firstChild,5),c,"found correct node");equals(ed.plugins.jiveutil.getNodeAt(ed.getBody().firstChild,6),a,"found correct node");equals(ed.plugins.jiveutil.getNodeAt(ed.getBody().firstChild,7),a,"found correct node");equals(ed.plugins.jiveutil.getNodeAt(ed.getBody().firstChild,14),a,"found correct node");equals(ed.plugins.jiveutil.getNodeAt(ed.getBody().firstChild,15),null,"found correct node");equals(ed.plugins.jiveutil.getNodeAt(ed.getBody().firstChild,16),null,"found correct node");equals(ed.getContent(),"<p>first <span>foothebar</span></p>")});test("test getting column nodes",function(){ed.setContent("<table><tr><td>asdf</td><td><table><tr><td>asdf</td><td>qwer</td></tr><tr><td>asdf</td><td>qwer</td></tr><tr><td>asdf</td><td>qwer</td></tr></table></td></tr><tr><td>asdf</td><td>qwer</td></tr></table>");var a=ed.getBody().firstChild;var c=$j(ed.getBody()).find("table table td:first");var b=ed.plugins.jiveutil.findColumnBoundsForCell(c);equals(b.length,3,"found all cells in column");equals($j(ed.getBody()).find("table table tr:nth(0) td:nth(0)").get(0),b.get(0),"correct cell");equals($j(ed.getBody()).find("table table tr:nth(1) td:nth(0)").get(0),b.get(1),"correct cell");equals($j(ed.getBody()).find("table table tr:nth(2) td:nth(0)").get(0),b.get(2),"correct cell")});