if(!this.JSON){JSON=function(){function f(n){return n<10?"0"+n:n}Date.prototype.toJSON=function(){return this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z"};var m={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};function stringify(value,whitelist){var a,i,k,l,r=/["\\\x00-\x1f\x7f-\x9f]/g,v;switch(typeof value){case"string":return r.test(value)?'"'+value.replace(r,function(a){var c=m[a];if(c){return c}c=a.charCodeAt();return"\\u00"+Math.floor(c/16).toString(16)+(c%16).toString(16)})+'"':'"'+value+'"';case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}if(typeof value.toJSON==="function"){return stringify(value.toJSON())}a=[];if(typeof value.length==="number"&&!(value.propertyIsEnumerable("length"))){l=value.length;for(i=0;i<l;i+=1){a.push(stringify(value[i],whitelist)||"null")}return"["+a.join(",")+"]"}if(whitelist){l=whitelist.length;for(i=0;i<l;i+=1){k=whitelist[i];if(typeof k==="string"){v=stringify(value[k],whitelist);if(v){a.push(stringify(k)+":"+v)}}}}else{for(k in value){if(typeof k==="string"){v=stringify(value[k],whitelist);if(v){a.push(stringify(k)+":"+v)}}}}return"{"+a.join(",")+"}"}}return{stringify:stringify,parse:function(text,filter){var j;function walk(k,v){var i,n;if(v&&typeof v==="object"){for(i in v){if(Object.prototype.hasOwnProperty.apply(v,[i])){n=walk(i,v[i]);if(n!==undefined){v[i]=n}else{delete v[i]}}}}return filter(k,v)}if(/^[\],:{}\s]*$/.test(text.replace(/\\["\\\/bfnrtu]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof filter==="function"?walk("",j):j}throw new SyntaxError("parseJSON")}}}()}(function(){function map(arr,fun){var len=arr.length;if(typeof fun!="function"){throw new TypeError()}var res=new Array(len);var thisp=arguments[2];for(var i=0;i<len;i++){if(i in arr){res[i]=fun.call(thisp,arr[i],i,arr)}}return res}function filter(arr,fun){var len=arr.length;if(typeof fun!="function"){throw new TypeError()}var res=new Array();var thisp=arguments[2];for(var i=0;i<len;i++){if(i in arr){var val=arr[i];if(fun.call(thisp,val,i,arr)){res.push(val)}}}return res}function slice(obj,start,end,step){var len=obj.length,results=[];end=end||len;start=(start<0)?Math.max(0,start+len):Math.min(len,start);end=(end<0)?Math.max(0,end+len):Math.min(len,end);for(var i=start;i<end;i+=step){results.push(obj[i])}return results}function expand(obj,name){var results=[];function walk(obj){if(name){if(name===true&&!(obj instanceof Array)){results.push(obj)}else{if(obj[name]){results.push(obj[name])}}}for(var i in obj){var val=obj[i];if(!name){results.push(val)}else{if(val&&typeof val=="object"){walk(val)}}}}if(name instanceof Array){if(name.length==1){return obj[name[0]]}for(var i=0;i<name.length;i++){results.push(obj[name[i]])}}else{walk(obj)}return results}function distinctFilter(array,callback){var outArr=[];var primitives={};for(var i=0,l=array.length;i<l;++i){var value=array[i];if(callback(value,i,array)){if((typeof value=="object")&&value){if(!value.__included){value.__included=true;outArr.push(value)}}else{if(!primitives[value+typeof value]){primitives[value+typeof value]=true;outArr.push(value)}}}}for(i=0,l=outArr.length;i<l;++i){if(outArr[i]){delete outArr[i].__included}}return outArr}var JSONQuery=function(query,obj){tokens=[];var depth=0;var str=[];query=query.replace(/"(\\.|[^"\\])*"|'(\\.|[^'\\])*'|[\[\]]/g,function(t){depth+=t=="["?1:t=="]"?-1:0;return(t=="]"&&depth>0)?"`]":(t.charAt(0)=='"'||t.charAt(0)=="'")?"`"+(str.push(t)-1):t});var prefix="";function call(name){prefix=name+"("+prefix}function makeRegex(t,a,b,c,d){return str[d].match(/[\*\?]/)||c=="~"?"/^"+str[d].substring(1,str[d].length-1).replace(/\\([btnfr\\"'])|([^\w\*\?])/g,"\\$1$2").replace(/([\*\?])/g,".$1")+(c=="~"?"$/i":"$/")+".test("+a+")":t}query.replace(/(\]|\)|push|pop|shift|splice|sort|reverse)\s*\(/,function(){throw new Error("Unsafe function call")});query=query.replace(/([^<>=]=)([^=])/g,"$1=$2").replace(/@|(\.\s*)?[a-zA-Z\$_]+(\s*:)?/g,function(t){return t.charAt(0)=="."?t:t=="@"?"$obj":(t.match(/:|^(\$|Math|true|false|null)$/)?"":"$obj.")+t}).replace(/\.?\.?\[(`\]|[^\]])*\]|\?.*|\.\.([\w\$_]+)|\.\*/g,function(t,a,b){var oper=t.match(/^\.?\.?(\[\s*\^?\?|\^?\?|\[\s*==)(.*?)\]?$/);if(oper){var prefix="";if(t.match(/^\./)){call("expand");prefix=",true)"}call(oper[1].match(/\=/)?"map":oper[1].match(/\^/)?"distinctFilter":"filter");return prefix+",function($obj){return "+oper[2]+"})"}oper=t.match(/^\[\s*([\/\\].*)\]/);if(oper){return".concat().sort(function(a,b){"+oper[1].replace(/\s*,?\s*([\/\\])\s*([^,\\\/]+)/g,function(t,a,b){return"var av= "+b.replace(/\$obj/,"a")+",bv= "+b.replace(/\$obj/,"b")+";if(av>bv||bv==null){return "+(a=="/"?1:-1)+";}\nif(bv>av||av==null){return "+(a=="/"?-1:1)+";}\n"})+"})"}oper=t.match(/^\[(-?[0-9]*):(-?[0-9]*):?(-?[0-9]*)\]/);if(oper){call("slice");return","+(oper[1]||0)+","+(oper[2]||0)+","+(oper[3]||1)+")"}if(t.match(/^\.\.|\.\*|\[\s*\*\s*\]|,/)){call("expand");return(t.charAt(1)=="."?",'"+b+"'":t.match(/,/)?","+t:"")+")"}return t}).replace(/(\$obj\s*(\.\s*[\w_$]+\s*)*)(==|~)\s*`([0-9]+)/g,makeRegex).replace(/`([0-9]+)\s*(==|~)\s*(\$obj(\s*\.\s*[\w_$]+)*)/g,function(t,a,b,c,d){return makeRegex(t,c,d,b,a)});query=prefix+(query.charAt(0)=="$"?"":"$")+query.replace(/`([0-9]+|\])/g,function(t,a){return a=="]"?"]":str[a]});var executor=eval("1&&function($,$1,$2,$3,$4,$5,$6,$7,$8,$9){var $obj=$;return "+query+"}");for(var i=0;i<arguments.length-1;i++){arguments[i]=arguments[i+1]}return obj?executor.apply(this,arguments):executor};if(typeof namespace=="function"){namespace("json::JSONQuery",JSONQuery)}else{window.JSONQuery=JSONQuery}})();(function(f){f.cloudkit=f.cloudkit||{};var d=function(p,k,m){var n={};var o={};var l=k;var j=function(){return(new Date).getTime()+"-"+Math.floor(Math.random()*10000)};var i=function(){o=m;o.id=j()};n.save=function(q){if(!(typeof m==="undefined")){return i()}f.ajax({type:"POST",url:p,data:JSON.stringify(k),contentType:"application/json",dataType:"json",processData:false,complete:function(r,s){if(r.status==201){o=JSON.parse(r.responseText);o.id=j();q.success()}else{q.error(r.status)}}})};n.update=function(q,r){var s=o.id;f.ajax({type:"PUT",url:o.uri,data:JSON.stringify(f.extend(l,q)),contentType:"application/json",dataType:"json",beforeSend:function(t){t.setRequestHeader("If-Match",o.etag)},processData:false,complete:function(t,u){if(t.status==200){o=JSON.parse(t.responseText);o.id=s;l=f.extend(l,q);r.success()}else{r.error(t.status)}}})};n.destroy=function(q){var r=o.id;f.ajax({type:"DELETE",url:o.uri,dataType:"json",beforeSend:function(s){s.setRequestHeader("If-Match",o.etag)},processData:false,complete:function(s,t){o=JSON.parse(s.responseText);o.id=r;if(s.status==200){o.deleted=true;q.success()}else{q.error(s.status)}}})};n.json=function(){return l};n.id=function(){return o.id};n.uri=function(){return o.uri};n.isDeleted=function(){return(o.deleted==true)};n.attr=function(q,r){if(typeof l[q]!="undefined"){switch(typeof r){case"undefined":return l[q];break;case"function":return l[q]=r.apply(l[q]);break;default:return l[q]=r}}else{if(typeof o[q]!="undefined"){return o[q]}}};return n};var h=function(l){var j={};var i=function(m){return l+m.id()};var k=function(o){var m=i(o);f.data(window,m,o);var n=f.data(window,l+"index")||[];n.push(m);f.data(window,l+"index",n)};j.create=function(m,n){resource=d(l,m);resource.save({success:function(){k(resource);n.success(resource)},error:function(o){n.error(o)}})};j.createFromRemote=function(m,n){resource=d(l,m,n);resource.save();k(resource);return resource};j.all=function(n){var m=[];var o=f.data(window,l+"index");f(o).each(function(q,r){var p=f.data(window,r);if(!p.isDeleted()){m.push(p)}});return m};j.get=function(m){return f.data(window,l+m)};j.query=function(n){var o=[];var m=this;f(this.all()).each(function(r,s){json=f.extend(s.json(),{___id___:s.id()});o.push(json)});var p=JSONQuery(n,o);var q=[];f(p).each(function(r,s){q.push(m.get(s.___id___))});return q};return j};var a=[];var e={};var c=function(i){f.ajax({type:"GET",url:"/cloudkit-meta",complete:function(j,k){data=JSON.parse(j.responseText);if(j.status==200){a=data.uris;i.success()}else{if(j.status>=400){i.error(j.status)}else{i.error("unexpected error")}}}})};var b=function(j){f.data(window,j+"index",[]);var i=j.replace(/^\//,"");e[i]=h(j)};var g=function(i,j){if(i==a.length){j.success();return}f.ajax({type:"GET",url:a[i]+"/_resolved",dataType:"json",processData:false,complete:function(k,p){if(k.status==200){var o=JSON.parse(k.responseText).documents;var l=a[i].replace(/^\//,"");for(var m=0;m<o.length;m++){var n=o[m];e[l].createFromRemote(JSON.parse(n.document),{uri:n.uri,etag:n.etag,last_modified:n.last_modified})}g(i+1,j)}else{j.error(k.status)}}})};f.fn.extend(f.cloudkit,{boot:function(i){a=[];e=[];c({success:function(){f(a).each(function(j,k){b(k)});g(0,{success:function(){i.success()},error:function(j){i.error(j)}})},error:function(j){i.error(j)}})},collections:function(){return e},collection:function(i){return this.collections()[i]}})})(jQuery);