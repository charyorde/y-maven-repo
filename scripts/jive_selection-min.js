if(!jive.Selection){jive.Selection=$Class.extend({init:function(b,a,e,d,c){this._supportsDomRange=$j.isFunction(window.getSelection);this._selection=jive.Selection.getSelection(d,c);if(b!=null){if(this._supportsDomRange){if(this._selection.rangeCount==0){this._selection.addRange(jive.Selection.createRangeAtNode(b,c))}}this._doc=c;this._win=d;this._range=this.getRangeAt(0);this.moveToNodeAndCollapse(b,a,e)}else{this._range=this.getRangeAt(0)}},getSelection:function(){return this._selection},getRangeAt:function(a){return jive.Selection.getRangeAt(this._selection,a,this._doc)},makeRangeTheSelection:function(){if(!this._supportsDomRange){this._selection.empty();this._range.select()}else{if(this._selection.rangeCount>0){this._selection.removeAllRanges()}this._selection.addRange(this._range)}},rangeInsertNode:function(d){if(!this._supportsDomRange){var a=this.getRangeStartContainer();var c=this.getRangeStartOffset();var b=a.parentNode;if(a.nodeType==3){var g=new String(a.nodeValue);var f=document.createTextNode(g.substring(0,c));var e=document.createTextNode(g.substring(c));b.insertBefore(f,a);b.insertBefore(d,a.nextSibling);b.insertBefore(e,d.nextSibling);b.removeChild(a);this.moveToNodeAndCollapse(d,true)}else{b.insertBefore(d,a.nextSibling)}}else{this._range.insertNode(d)}},setRangeStart:function(b,a){if(!this._supportsDomRange){this._setRangeStartEndHelper(b,a,false)}else{this._range.setStart(b,a)}},setRangeEnd:function(a,b){if(!this._supportsDomRange){this._setRangeStartEndHelper(a,b,true)}else{this._range.setEnd(a,b)}},getRangeStartContainer:function(){if(!this._supportsDomRange){return this._getIERangeContainerHelper(true).container}else{return this._range.startContainer}},getRangeEndContainer:function(){if(!this._supportsDomRange){return this._getIERangeContainerHelper(false).container}else{return this._range.endContainer}},getRangeStartOffset:function(){if(!this._supportsDomRange){return this._getIERangeContainerHelper(true).offset}else{return this._range.startOffset}},getRangeEndOffset:function(){if(!this._supportsDomRange){return this._getIERangeContainerHelper(false).offset}else{return this._range.endOffset}},getWordAtRange:function(){return this._wordAtRangeCommon()},replaceWordAtRange:function(c,b,a){return this._wordAtRangeCommon(c,b,a)},_wordAtRangeCommon:function(e,a,b){var q=this.getRangeStartContainer();var k=jive.Selection.replaceNbspWithWhitespace(q.nodeValue);if(this.alignRangeWithNearestTextNode(q)){q=this.getRangeStartContainer();k=q.nodeValue}if(e==null){if(this._normalizeTextNode(q,this.getRangeStartOffset())){k=q.nodeValue;this._range.collapse(true);this.makeRangeTheSelection()}}var i=this.getRangeStartOffset();var o=new String(k).substring(0,i);var g=new String(k).substring(i);var f=/\S+$/,p=/^\S+/;if(e!=null&&e.length>0){a=a||"";b=b||{tag:"txt"};var l=a+e;o=o.replace(f,"");g=g.replace(p,"");if((g==null||g.length==0)&&b.tag!="txt"){g=" "}var c;if(b.tag=="txt"){c=document.createTextNode(l)}else{c=document.createElement(b.tag);for(var n in b.attrs){c.setAttribute(n,b.attrs[n])}c.innerHTML=l}var h=q.parentNode;if(o!=null&&o.length>0){h.insertBefore(document.createTextNode(o),q)}h.insertBefore(c,q);var j=null;if(g!=null&&g.length>0){j=document.createTextNode(g);h.insertBefore(j,q)}h.removeChild(q);var d=j==null?c:j;this.moveToNodeAndCollapse(d);return c}else{o=o.match(f);g=g.match(p);var m=(o==null?"":o)+(g==null?"":g);return m}},_normalizeTextNode:function(d,h){h=h||0;if(d==null||!d.nodeValue||jive.Selection.replaceNbspWithWhitespace(d.nodeValue).search(/\S+/)==-1){return false}var c="";var a=d.parentNode;function g(k){var j=k?d.previousSibling:d.nextSibling;while(j!=null&&j.nodeType==3&&jive.Selection.replaceNbspWithWhitespace(j.nodeValue).search(/\S+/)>-1){if(k){c=j.nodeValue+c}else{c+=j.nodeValue}var i=k?j.previousSibling:j.nextSibling;a.removeChild(j);j=i}}g(true);var f=c.length+h;c+=d.nodeValue;g(false);if(c!=d.nodeValue){if(!this._supportsDomRange){var e=this._range.duplicate();var b=document.createTextNode(c);a.replaceChild(b,d);this._range=e.duplicate();this._range.moveStart("character",f)}else{d.nodeValue=c;this.setRangeStart(d,f)}this._range.collapse(true);this.makeRangeTheSelection();return true}return false},insertNodeAtRange:function(b,c){var a=typeof b=="string"?document.createTextNode(b):b;c=c||0;if(this._supportsDomRange){this._range.collapse(true)}this.rangeInsertNode(a);if(a.nodeType==3){if(!this._normalizeTextNode(a,c)){if(!this._supportsDomRange){this._range.moveStart("character",c);this._range.collapse(true)}else{this.setRangeStart(b,c)}this.makeRangeTheSelection()}}},selectNode:function(a){this._range.selectNode(a)},collapseRange:function(a){this._range.collapse(!!a)},selectNodeContents:function(a){if(!this._supportsDomRange){var d=this.getRangeStartOffset()*-1;var c=this._range.duplicate();c.moveToElementText(c.parentElement());c.setEndPoint("StartToEnd",this._range);var b=c.text.length;this._range.moveStart("character",d);this._range.moveEnd("character",b);this._range.select()}else{this.getSelection().selectAllChildren(a)}},moveToNodeAndCollapse:function(b,a,c){if(a){this.setRangeStart(b,c)}else{this.setRangeEnd(b,c)}this._range.collapse(a);this.makeRangeTheSelection()},alignRangeWithNearestTextNode:function(a){a=a||this.getRangeStartContainer();if(a.nodeType!=3){var f=$j(a).contents();if(f.length>0){var c=this.getRangeStartOffset();var e=f.get(c);if(e.nodeType==3){this.init(d,false);return true}else{return this.alignRangeWithNearestTextNode(e)}}else{f=$j(a).parent().contents();var g=f.index(a);var b=false;var d=f.filter(function(h){return h<g&&this.nodeType==3}).last();if(d.length==0){d=f.filter(function(h){return h>g&&this.nodeType==3}).first();b=true}if(d.length>0){this.init(d[0],b,b?0:d[0].length);return true}else{if(f.length){d=f.first();this.init(d[0],b,b?0:d[0].length);return true}else{throw ("alignRangeWithNearestTextNode Failed to find a text node to align with.")}}}}return false},_getIERangeContainerHelper:function(c){var g=c?this._getIERangeStartOffsetHelper():this._getIERangeEndOffsetHelper();var a=this._range.parentElement();var e=0;var f=a.childNodes;if(f.length==0){return a}for(var d=0;d<f.length;d++){var h=f[d];var b=$j(h).text().length;if(b==0&&h.nodeName=="BR"){b=2}if(g<=e+b){return{container:h,offset:g-e}}else{e+=b}}return{container:h,offset:e};throw ("Error jive.selection._getIERangeContainerHelper could not find range container")},_getIERangeStartOffsetHelper:function(){var a=this._range.duplicate();a.moveToElementText(a.parentElement());a.setEndPoint("EndToStart",this._range);return a.text.length},_getIERangeEndOffsetHelper:function(){return this._range.text.length+this._getIERangeStartOffsetHelper()},_setRangeStartEndHelper:function(h,k,g){var n=h.nodeType==3;var l=n?h.parentNode:h;var i=this._range.duplicate();i.moveToElementText(l);k=k||0;var c=$j(h).parent().contents();var p=c.index(h);var a;if(n){a=c.slice(0,p).text().length+k}else{a=c.slice(0,p+k).text().length}i.moveStart("character",a);var f;var e;if(n){f=p+1;e=jive.Selection.replaceNbspWithWhitespace($j(h).text()).substring(k)}else{f=p+k+1;e=jive.Selection.replaceNbspWithWhitespace(c.slice(p+k))}var o=new RegExp("(.*)"+e);function j(){return new String(i.text).replace(new RegExp(c.slice(f).text()+"$"),"")}var b=j();var d=0;while(b!=e){b=j();var m=b.match(o);if(m!=null&&m.length==2){i.moveStart("character",m[1].length)}else{throw ("jive.Selection _setRangeStartEndHelper failed to setRange Start or End")}d++;if(d==10){throw ("jive.Selection _setRangeStartEndHelper failed to setRange Start or End")}}if(g){this._range.setEndPoint("EndToStart",i)}else{this._range.setEndPoint("StartToStart",i)}}});jive.Selection.getSelection=function(b,a){if(!b){b=window}if(!a){a=document}if(b.getSelection){return b.getSelection()}else{if(a.all){return a.selection}else{if(a.getSelection){return a.getSelection()}}}throw ("jive.Selection.getSelector Error: unable to obtain seleciton object")};jive.Selection.getRangeAt=function(b,a,c){if(!c){c=document}if(b.getRangeAt){return b.getRangeAt(a)}else{if(c.selection){return b.createRange()}}throw ("jive.Selection.getRangeAt Error: unable to obtain seleciton object")};jive.Selection.moveCursorAfter=function(b,c){if(!c){c=document}var d=c.createElement("span");d.setAttribute("data-jive-statusinputadd","true");d.innerHTML="&nbsp;";b.parentNode.insertBefore(d,b);b.parentNode.insertBefore(b,d);var a=new jive.Selection(d,true);b.parentNode.removeChild(d)};jive.Selection.createRangeAtNode=function(b,c){if(!c){c=document}if(c.createRange){var a=c.createRange();a.selectNodeContents(b);return a}else{if(b.createRange){return b.createRange()}}throw ("jive.Selection.createRange Error: unable to obtain range object")};jive.Selection.replaceNbspWithWhitespace=function(a){return String(a).replace(/\xA0/g," ")}};